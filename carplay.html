<!DOCTYPE html>
<html lang="ar" dir="rtl" style="
    zoom: 93%;
">
<head>
    <link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#000000">
 
<!-- لتغطية الشاشة بالكامل مع حواف النوتش -->
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Cache Control Meta Tags -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>تطبيق الطقس - واجهة CarPlay</title>
    <!-- Tailwind CSS CDN for utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons for modern, customizable SVG icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Font Awesome for additional icons (e.g., Trip log) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <!-- Chart.js for the new weekly forecast chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- YouTube Iframe API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        /* Import Amiri Quran font for Adhkar text */
        @import url('https://fonts.googleapis.com/css2?family=Amiri+Quran:wght@400;700&display=swap');
        /* NEW: Import Amiri font for Thuluth-like style */
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');

/* --- START: Last Watched & History Styles --- */

/* --- START: Last Watched Carousel (2.5 items) Styles --- */
#last-watched-container {
    width: 100%;
    max-width: 600px; /* Optional: constrain max width for larger screens */
  
    padding-bottom: 1rem;
    margin-bottom: 1rem;
}

.last-watched-carousel-wrapper {
    position: relative;
    width: 237%;
}
.last-watched-carousel-wrapper {
    direction: ltr;
}
/* NEW: Carousel Navigation Buttons */
.carousel-nav-button {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
    background-color: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: none; /* Hidden by default */
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}
.carousel-nav-button:hover {
    background-color: rgba(0, 0, 0, 0.6);
    transform: translateY(-50%) scale(1.1);
}
.carousel-nav-button.prev {
    right: 10px;
     width: 70px;
     height: 70px;
    
}
.carousel-nav-button.next {
     right: 73px;
     width: 70px;
     height: 70px;
}
/* This is the scrollable viewport */
.last-watched-slides-container {
    display: flex;
    gap: 1rem; /* The space between cards */
    overflow-x: auto; /* This enables horizontal scrolling */
    scroll-snap-type: x mandatory; /* This enables snapping behavior */
    -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    padding: 0.5rem 1rem; /* Adds some vertical and horizontal padding */
    clip-path: inset(-5px -10px -5px -10px); /* Prevents padding from clipping box-shadow */
    scrollbar-width: none; /* Hides scrollbar for Firefox */
}
/* Hides scrollbar for Chrome, Safari, and Opera */
.last-watched-slides-container::-webkit-scrollbar {
    display: none;
}
div#youtube-suggestions {
    overflow: clip;
}
.last-watched-slide {
    flex: 0 0 45%; /* Each slide is ~45% of the container. 2 slides = 90% + gap, leaving the 3rd one partially visible. */
    scroll-snap-align: start; /* Each card will snap to the start of the container when scrolling stops */
    scroll-snap-stop: always; /* Ensures it stops precisely on each snap point */
}

.last-watched-slide .glass-surface {
    width: 100%;
}

/* Ensure text doesn't wrap and overflow awkwardly */
.last-watched-slide h3, .last-watched-slide p {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
/* --- END: Last Watched Carousel Styles --- */
.resume-play-button {
    background-color: rgba(99, 102, 241, 0.8); /* Indigo color */
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.2s;
    border: none;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.resume-play-button:hover {
    background-color: rgba(79, 70, 229, 1);
}

.youtube-video-card.is-watched .video-title {
    color: #a5b4fc; /* Lighter, muted color for watched videos */
}

/* --- END: Last Watched & History Styles --- */

/* --- START: Bookmark Styles --- */
.bookmark-button {
    position: absolute;
    top: 8px;
    left: 8px; /* For RTL layout */
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    z-index: 5;
}
.bookmark-button:hover {
    background-color: rgba(99, 102, 241, 1); /* Indigo */
}
.bookmark-button.saved-d {
    color: #60a5fa; /* Blue 400 */
}
.bookmark-button.saved-m {
    color: #f472b6; /* Pink 400 */
}
.bookmark-button.saved-both {
    background: linear-gradient(45deg, #60a5fa, #f472b6);
    color: white;
}

.favorites-menu {
    position: fixed; /* Use fixed to break out of scrolling containers */
    background-color: rgba(30, 41, 59, 0.9);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.75rem;
    padding: 0.5rem;
    z-index: 150; /* High z-index */
    display: none;
    min-width: 150px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}
.favorites-menu.show {
    display: block;
}
.favorites-menu button {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.5rem 0.75rem;
    text-align: right;
    font-size: 0.9rem;
    color: white;
    background-color: transparent;
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: background-color 0.2s;
}
.favorites-menu button:hover {
    background-color: rgba(71, 85, 105, 0.7);
}

.remove-favorite-button {
    position: absolute;
    top: 8px;
    left: 8px;
    background-color: rgba(220, 38, 38, 0.7); /* Red */
    color: white;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    z-index: 5;
}
.remove-favorite-button:hover {
    background-color: rgba(185, 28, 28, 1);
}
/* --- END: Bookmark Styles --- */

div#tv{display:none;}
div#geolocation-error-overlay {
    display: none !important;
}
button#back-to-search-floating-button {
    Z-INDEX: 99999;
}

.search-results-nav {
    width: 50%;
    justify-self: center;
}

.w-full.grid.grid-cols-3.items-center.p-2.sticky.bottom-0.bg-black\/40.backdrop-blur-sm.flex-shrink-0 {
    WIDTH: 50%;
    JUSTIFY-SELF: CENTER;
}



 .flex.flex-wrap.justify-center.gap-2.w-full {zoom: 0.85;}

 .tabs-container.flex.p-1.rounded-full.bg-black\/20.self-center {
    bottom: 51px;
    left: 99px;
    position: fixed;
}

button#back-to-playlists-bottom-button-search {
    position: sticky;
    justify-self: anchor-center;
}
        /* Import Inter font for a modern, clean look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Default background gradient - UPDATED: black parts are wider, animation is 3x slower */
            background: linear-gradient(-45deg, #000000 0%, #000000 30%, #00FFFF 35%, #000000 60%, #4B0082 65%, #8A2BE2 70%, #FF00FF 75%, #000000 100%);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite; /* Animation duration decreased to 15s */
            transition: background-image 0.5s ease; /* Smooth transition for background changes */
            min-height: 100vh; /* Ensure body takes full viewport height */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* Prevent body scroll */
        }
        
div#hourly-forecast-container {
    min-height: 93px;
}
button#tab-tarteel {
    display: none;
}

        body.animation-paused {
            animation-play-state: paused !important;
        }
        body.video-playing {
            animation-duration: 75s !important; /* 80% slower animation */
        }
.bg-black2 {
    background-image: linear-gradient(45deg, #000000, #6f6f6f39)!important;
}
        img.max-w-full.max-h-full.object-contain { max-width: 50%;
    mix-blend-mode: hard-light;
}
        /* Ensure RTL direction for specific elements if needed */
        div#youtube-video-list-view, div#youtube-search-results-view {
            direction: rtl;
        }
        div#youtube-readers-section {
            direction: rtl;
        }
        /* Define different background themes for customization */
        body.theme-gradient-1 {
            background: linear-gradient(-45deg, #000000 0%, #000000 30%, #00FFFF 35%, #000000 60%, #4B0082 65%, #8A2BE2 70%, #FF00FF 75%, #000000 100%);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        body.theme-gradient-2 {
            background: linear-gradient(-45deg, #4CAF50, #8BC34A, #FFEB3B, #FFC107);
            background-size: 400% 400%;
            animation: gradient 75s ease infinite reverse;
        }
        body.theme-dark-blue {
            background-color: #1a202c; /* Dark blue-gray */
            background-image: none;
            animation: none;
        }
        body.theme-purple-haze {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: 100% 100%;
            animation: none;
        }

        div#quran-quick-access {
            display: none !important;
        }

        .h-full {
            height: 97% !important;
        }

        /* NEW GLASS SURFACE CSS - Enhanced for liquid 3D effect and "drop glass" */
        .glass-surface {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            transition: opacity 0.26s ease-out;
            border-radius: 1.5rem; /* Ensure rounded corners */
        }
        .glass-surface__filter {
            width: 100%;
            height: 100%;
            pointer-events: none;
            position: absolute;
            inset: 0;
            opacity: 0;
            z-index: -1;
        }

        div#youtube-search-results-view {
    overflow: scroll;
}

.glass-surface.glass-surface--svg.youtube-video-card.navigable.grid-item {
    direction: ltr!important;
}

        .glass-surface__content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: inherit;
            position: relative;
            z-index: 1;
        }
        div#geares {
    height: 114px;
}

div#\33 d-screen-weather-widget {
    height: 115px;
    width: 116px;
}
        .glass-surface--svg {
            /* Adjusted background for a more pronounced "drop" effect */
            background: light-dark(hsl(0 0% 100% / var(--glass-frost, 0.1)), /* Slightly more opaque background */
                hsl(0 0% 0% / var(--glass-frost, 0.2))); /* Darker opaque background for dark mode */
            
            /* Enhanced backdrop-filter for stronger blur and saturation */
            backdrop-filter: var(--filter-id, url(#glass-filter)) blur(10px) saturate(2.0) brightness(1.1); /* Reduced blur, saturation, and brightness for sharper effect */
            -webkit-backdrop-filter: blur(10px) saturate(2.0) brightness(1.1); /* Webkit prefix */

            /* More pronounced box-shadow for a "dropped" effect */
            box-shadow:
                0 0 5px 2px rgba(255, 255, 255, 0.1) inset, /* Inner light glow */
                0 0 15px 6px rgba(0, 255, 255, 0.15) inset, /* Inner cyan glow */
                0px 8px 30px rgba(17, 17, 26, 0.1), /* Stronger outer shadow */
                0px 16px 60px rgba(17, 17, 26, 0.15), /* Even stronger outer shadow */
                0px 24px 80px rgba(17, 17, 26, 0.2), /* Deepest outer shadow */
                inset 0 0 20px 8px rgba(0,0,0,0.3), /* Deeper inner shadow for depth */
                inset 0 0 25px 10px rgba(0,0,0,0.2), /* Even deeper inner shadow */
                0 0 20px rgba(255, 255, 255, 0.15); /* Added subtle outer white glow for "shine" */
            border: 1px solid rgba(255, 255, 255, 0.3); /* Added a subtle white border */
        }
        
        /* Fallback for browsers not supporting backdrop-filter - also enhanced */
        .glass-surface--fallback {
            background: rgba(255, 255, 255, 0.35); /* More opaque fallback */
            backdrop-filter: blur(15px) saturate(2.0) brightness(1.2); /* Stronger fallback blur/saturate */
            -webkit-backdrop-filter: blur(15px) saturate(2.0) brightness(1.2);
            border: 1px solid rgba(255, 255, 255, 0.4); /* Stronger border */
            box-shadow:
                0 10px 40px 0 rgba(31, 38, 135, 0.3), /* Stronger fallback shadow */
                0 4px 20px 0 rgba(31, 38, 135, 0.2),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.5),
                inset 0 -1px 0 0 rgba(255, 255, 255, 0.3);
        }
        @media (prefers-color-scheme: dark) {
            .glass-surface--fallback {
                background: rgba(255, 255, 255, 0.15); /* Dark mode fallback */
                backdrop-filter: blur(15px) saturate(2.0) brightness(1.3);
                -webkit-backdrop-filter: blur(15px) saturate(2.0) brightness(1.3);
                border: 1px solid rgba(255, 255, 255, 0.3);
                box-shadow:
                    inset 0 1px 0 0 rgba(255, 255, 255, 0.3),
                    inset 0 -1px 0 0 rgba(255, 255, 255, 0.2);
            }
        }
        @supports not (backdrop-filter: blur(10px)) {
            .glass-surface--fallback {
                background: rgba(255, 255, 255, 0.5); /* Strongest fallback for no backdrop-filter */
                box-shadow:
                    inset 0 1px 0 0 rgba(255, 255, 255, 0.6),
                    inset 0 -1px 0 0 rgba(255, 255, 255, 0.4);
            }
            .glass-surface--fallback::before {
                content: '';
                position: absolute;
                inset: 0;
                background: rgba(255, 255, 255, 0.2); /* More opaque overlay */
                border-radius: inherit;
                z-index: -1;
            }
        }
        
        /* TV Remote Focus Style */
        .navigable:focus, .navigable.tv-focus {
            outline: 3px solid #0A84FF !important; /* Use !important to override other outlines */
            box-shadow: 0 0 20px rgba(10, 132, 255, 0.7) !important; /* Use !important */
            transform: scale(1.03);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }



        /* Keyframe animation for the background gradient */
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Styles for individual app screens */
        .app-screen {
            display: none; /* Hidden by default */
            animation: fadeIn 0.5s ease-in-out; /* Fade-in transition */
            width: 100%;
            height: 100%;
            flex-direction: column;
            border-radius: 1.5rem; /* Ensure app screens have rounded corners */
        }
        .app-screen.active {
            display: flex; /* Display when active */
        }
        
        /* Fade-in animation for screen transitions */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Styling for iframes to fit their containers */
        .full-iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 1.5rem;
        }

        .homebtn{display:none}

        /* Floating Button Styles - Positioned and styled for glass effect */
        #floating-media-button,
        #back-to-playlists-bottom-button,
        #back-to-playlists-bottom-button-search,
        #floating-keyboard-button,
        #start-trip-floating-button { 
            position: fixed;
            background-color: rgba(138, 8, 6, 0.5); /* Purple glass */
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 9999px; /* Pill shape */
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            z-index: 100; /* Above everything else */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        /* UPDATED: Clear Search Button style */
        #clear-search-button {
            background-color: rgba(220, 38, 38, 0.6); /* Red glass */
            color: white;
            padding: 0.75rem;
            border-radius: 9999px; /* Pill shape */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        #floating-media-button:hover,
        #back-to-playlists-bottom-button:hover,
        #floating-keyboard-button:hover,
        #clear-search-button:hover,
        #start-trip-floating-button:hover {
            transform: scale(1.05); /* Only scale, no translate */
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        /* Specific positioning for floating buttons */
        #floating-media-button { bottom: 1rem; right: 1rem; }
        #floating-keyboard-button {
            bottom: 1rem;
            right: 8rem; /* Adjusted to be next to media button */
            display: none; /* Hidden by default */
        }
        #floating-keyboard-button.active-keyboard {
            background-color: #90EE90; /* Chrome Green */
            color: black; /* Black icon */
        }
        #floating-keyboard-button.inactive-keyboard {
            background-color: #FF0000; /* Red */
            color: white; /* White icon */
        }

        #back-to-playlists-bottom-button, #back-to-playlists-bottom-button-search {
            bottom: 1rem;
            left: 50%;
        
            display: none; /* Hidden by default */
        }

        #start-trip-floating-button {
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #10B981; /* Green color */
            display: none; /* Hidden by default */
        }

        /* NEW: Style for the minimized video player button */
        #floating-minimized-video-button {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            background-color: rgba(245, 158, 11, 0.7); /* Amber/Yellow color */
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 9999px; /* Pill shape */
            display: none; /* Hidden by default */
            align-items: center;
            gap: 0.75rem;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            z-index: 105;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 250px; /* Prevent it from getting too wide */
        }
        #floating-minimized-video-button .minimized-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        /* Top bar positioning and transition */
        .top-bar {
            top: 1rem;
            transition: opacity 0.3s ease;
        }

        /* Main CarPlay interface container adjustments */
        #carplay-main-interface {
    position: fixed;
    top: 0%;
    left: 0%;
    width: 100vw;
    height: 100vh;
    transition: all 0.5s ease-in-out;
    border-radius: 2rem;
}

        /* Pseudo-fullscreen class for the CarPlay interface */
        #carplay-main-interface.carplay-pseudo-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            margin: 0;
            border-radius: 0;
            z-index: 99; /* Ensure it's above other content but below the floating button */
            max-width: 100vw; /* When fullscreen, it should take full width */
        }

        /* Shrink content when in pseudo-fullscreen mode for better fit */
        #carplay-main-interface.carplay-pseudo-fullscreen #digital-time {
            font-size: 2.2rem !important;
        }
        #carplay-main-interface.carplay-pseudo-fullscreen #weather-temp-main {
            font-size: 4rem !important;
        }

        /* Scrollbar styling for better aesthetics */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }

        /* Active app icon styling */
        .app-icon.active {
            background-color: #6b22ff; /* Purple */
            color: white;
            transform: scale(1.1);
        }

        /* Gemini-like Chat Styling */
        .chat-message {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 1.5rem; /* More rounded */
            margin-bottom: 0.75rem;
            word-wrap: break-word;
            font-size: 0.9rem; /* Slightly smaller font for chat */
        }

        .chat-message.user {
            background-color: #4f46e5; /* Blue */
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.5rem; /* Pointy bottom right */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .chat-message.ai {
            background-color: #2d3748; /* Darker gray */
            color: white;
            margin-right: auto;
            border-bottom-left-radius: 0.5rem; /* Pointy bottom left */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        #ai-input {
            border-radius: 2rem; /* Fully rounded pill shape */
            padding: 0.75rem 1.25rem;
            background-color: rgba(255, 255, 255, 0.15); /* Lighter glass */
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }
        #ai-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        #ai-input:focus {
            background-color: rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.4), 0 0 0 2px rgba(147, 51, 234, 0.5);
        }
        
        /* YouTube Video Card Styling (List View and Search Results) - UPDATED */
        .youtube-video-card, .youtube-search-card {
            display: flex;
            flex-direction: row;
            align-items: flex-start; /* CHANGED to align items to the top */
            padding: 0.75rem;
            border-radius: 1rem;
            background-color: rgba(255, 255, 255, 0.05);
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
            width: 100%;
            box-sizing: border-box;
            cursor: pointer;
            gap: 1rem;
        }
        .youtube-video-card:hover, .youtube-search-card:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        .youtube-video-card .thumbnail-container {
            position: relative;
            width: 180px;  /* INCREASED */
            height: 101.25px; /* INCREASED (16:9 ratio) */
            flex-shrink: 0;
            overflow: hidden; /* Important for progress bar */
        }

        .glass-surface.glass-surface--svg.p-4.rounded-3xl.text-center.flex.flex-col.items-center.justify-center.navigable.grid-item {
    height: 169px;
}
        /* NEW: Styles for Watched Progress Bar */
        .watched-progress-bar-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: rgba(255, 255, 255, 0.3);
        }
        .watched-progress-bar {
            height: 100%;
            background-color: #ef4444; /* Red color */
            border-radius: 0 2px 2px 0;
        }

        /* NEW: Style for Watched Badge */
        .watched-badge {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .youtube-video-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.5rem;
        }
        .video-duration {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 0.75rem;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .video-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
            overflow: hidden;
            flex-grow: 1;
            min-width: 0;
        }
        .video-title {
            font-size: 1rem;
            font-weight: 600;
            color: white;
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .video-meta {
            display: flex;
            flex-direction: column;
            font-size: 1.2rem;
            color: #8dffd8;
            font-weight: bold;
        }

        /* NEW: Explicit scrollbar for search results */
        #search-results-container::-webkit-scrollbar {
            width: 8px;
            display: block; /* Ensure it's always displayed */
        }
        #search-results-container::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }
        #search-results-container::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.5);
            border-radius: 10px;
        }
        
        /* YouTube Reader Card Styling (Suggestions) - UPDATED */
        .youtube-reader-card {
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.75rem;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.2s ease-in-out;
            border-radius: 1.25rem;
            background-color: rgba(255, 255, 255, 0.05);
        }
        .youtube-reader-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            background-color: rgba(255, 255, 255, 0.1);
        }
        .youtube-reader-card img {
            width: 100px; /* MODIFIED: Increased size */
            height: 100px; /* MODIFIED: Increased size */
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
        }
        .youtube-reader-card h3 {
            font-size: 1.1rem; /* MODIFIED: Increased font size */
            font-weight: 600;
            color: white;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 95%;
            margin-bottom: 1rem; /* MODIFIED: Increased margin */
        }
        .youtube-reader-card.selected {
            background-color: #9333ea !important;
            box-shadow: 0 0 15px rgba(147, 51, 234, 0.8);
            transform: translateY(-5px) scale(1.05);
        }
        /* UPDATED: Reader container is now a grid */
        .reader-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* MODIFIED: Responsive columns */
            overflow-y: auto;
            padding-bottom: 1rem;
            gap: 1.25rem; /* MODIFIED: Increased gap */
            direction: ltr;
            max-height: 45vh; /* MODIFIED: Increased height */
            width: 100%; /* MODIFIED: Ensure full width */
        }
        .reader-container::-webkit-scrollbar { display: block; }
        .reader-container { -ms-overflow-style: auto; scrollbar-width: thin; }


        /* YouTube Suggestion Buttons (for Surahs) - UPDATED */
        .youtube-suggestion-button {
            color: white;
            padding: 0.25rem 0.75rem; /* Zoomed out padding */
            border-radius: 9999px;
            font-size: 0.75rem; /* Zoomed out font */
            font-weight: bold;
            transition: background-color 0.2s ease, transform 0.1s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            /* NEW: Switched to inline-flex for variable width */
            display: inline-flex;
            width: auto;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            position: relative;
            overflow: hidden; /* Keep overflow hidden on the button itself */
        }
        .youtube-suggestion-button:hover {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .youtube-suggestion-button:active {
            transform: translateY(0);
        }
        
        /* NEW: Style for the Surah name text to handle long names */
        .surah-name-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: right; /* Align text to the right for RTL */
        }

        /* NEW: Badge for Juz number */
        .youtube-suggestion-button .juz-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 9999px;
            background-color: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
            flex-shrink: 0; /* Prevent badge from shrinking */
            line-height: 1;
            position: relative; /* Allow z-index */
            z-index: 2; /* Ensure it's on top */
        }

        /* YouTube Suggestion Category Tag */
        .youtube-suggestion-category-tag {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
            margin-bottom: 0.5rem;
            align-self: flex-start;
        }
        /* NEW: Surah Buttons Scrollable Container */
        .surah-buttons-scrollable {
            max-height: 77%;
            overflow-y: auto;
            padding-right: 8px; 
            padding-left: 8px; 
        }
        .surah-buttons-scrollable::-webkit-scrollbar { width: 6px; }
        .surah-buttons-scrollable::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 10px; }
        .surah-buttons-scrollable::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.4); border-radius: 10px; }
        
        /* NEW: Styling for Tabs in Media Screen */
        .tabs-container {
            display: flex;
            gap: 0.5rem;
            padding: 0.25rem;
            border-radius: 9999px; /* pill shape */
            background-color: rgba(0, 0, 0, 0.2);
            align-self: center; /* Center the tab bar */
            margin-bottom: 1rem;
        }
        .tab-button {
            padding: 0.5rem 1.25rem;
            background-color: transparent;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 600;
            font-size: 0.9rem;
            border: none;
            border-radius: 9999px; /* pill shape */
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .tab-button.active {
            color: white;
            background-color: rgba(147, 51, 234, 0.6); /* Purple */
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .tab-content {
            width: 100%;
            height: 100%;
        }
        .tab-content.hidden {
            display: none;
        }


        /* Dashboard Logo Effect */
        .metallic-logo-effect {
            width: 300px;
            height: auto;
            margin-bottom: 1rem;
            filter: grayscale(100%) brightness(30%);
        }

        /* Car Dashboard Specific Styles */
        .car-dashboard-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .gauge-container.absolute-pos {
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .gauge-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 0.25rem;
        }

        .speed-display {
            font-size: 2.5rem;
            line-height: 1;
        }

        .rpm-display {
            font-size: 1.2rem;
            line-height: 1;
        }

        .gear-indicator {
            font-size: 4rem;
            font-weight: bold;
            color: #10b981;
        }

        div#youtube-suggestions {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

.glass-surface.glass-surface--svg.p-3.rounded-2x1.text-center.flex.items-center.gap-3.navigable.grid-item {
    height: 122px;
}.glass-surface.glass-surface--svg.p-3.rounded-2x1.text-center.flex.items-center.gap-3.navigable.grid-item {}

div#\33 d-screen-gear {
    font-size: 2.7rem;
}

/* NEW: Style for direction indicator */
div#\33 d-screen-dir {
    font-size: 2.7rem;
}


div#youtube-readers-section {
    height: 100%;
}

.reader-container {
    max-width: 100% !important;
    max-height: 100% !important;
} 

section#screen-Media {
    height: 101%!important;
    padding: 0px!important;
    overflow-y: auto;
}

div#youtube-readers-section {
    height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.7);
            box-shadow: inset 0 0 15px rgba(0,0,0,0.7);
            overflow: hidden;
            position: relative;
        }
        .car-cam-360-container img {
            height: 160%;
            width: 100%; 
            object-fit: cover;
        }
        .car-cam-360-controls {
            position: absolute;
            bottom: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 20;
        }
        .car-cam-360-controls button {
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .car-cam-360-controls button:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }


        /* Digital Clock Styles (Apple iOS 19 style) */
        #digital-time {
            font-size: 1.8rem;
            font-weight: 800;
            color: white;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: baseline;
            gap: 0.2rem;
            direction: ltr; /* FIX: Enforce LTR for correct HH:MM:SS order */
        }
        #digital-time span {
            transition: opacity 0.3s ease;
        }
        #digital-time .hours { opacity: 1; }
        #digital-time .minutes { opacity: 0.8; }
        #digital-time .seconds { opacity: 0.4; }

        /* Updated #digital-date styles based on user request */
        #digital-date {
            font-size: 1.2rem;
            color: rgb(255 255 255 / 99%);
            font-weight: bold;
            text-align: center;
            line-height: 1.4;
        }
        /* Countdown to Azan */
        .countdown-azan {
            color: cyan !important;
        }
        /* Countdown to Iqama */
        .countdown-iqama {
            color: orange !important;
        }
        /* Count-up after Iqama */
        .countdown-up {
            color: #98FB98 !important; /* PaleGreen, close to lightmint */
        }


        /* Settings Range Input Styling */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]:hover { opacity: 1; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #9333ea;
            cursor: pointer;
            box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.5);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #9333ea;
            cursor: pointer;
            box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.5);
        }

        /* Animated Weather Icon Styles */
        @keyframes pulse-float {
            0% { transform: scale(1) translateY(0px); opacity: 1; }
            50% { transform: scale(1.05) translateY(-2px); opacity: 0.9; }
            100% { transform: scale(1) translateY(0px); opacity: 1; }
        }
        #dashboard-weather-icon, #weather-icon {
            animation: pulse-float 3s ease-in-out infinite alternate;
            transition: transform 0.3s ease-in-out;
        }

        /* Electronic Quran specific styles */
        .quran-text {
            font-family: 'Amiri Quran', serif;
            font-size: 2rem;
            line-height: 2.5;
            text-align: center;
            direction: rtl;
            padding: 0rem 1rem;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 1rem;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            overflow-y: auto;
            max-height: 80%;
        }

        .quran-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            justify-content: center;
        }
        .quran-control-button {
            background-image: linear-gradient(to right, #6366f1, #8b5cf6);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: bold;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .quran-control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        /* NEW: Weather Screen Scroll Override */
        #screen-Weather {
            overflow-y: auto !important; /* Force scrolling */
        }
        #screen-Weather::-webkit-scrollbar { width: 6px; }
        #screen-Weather::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 10px; }
        #screen-Weather::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.4); border-radius: 10px; }

        /* Weather section content to take full width and height */
        #screen-Weather > div {
            width: 100%;
            height: 100%;
            max-width: none;
        }
        #screen-Weather .glass-surface {
            flex-grow: 1;
        }
        
        /* Video Pop-up Container Styles */
        #video-popup-container {
            position: fixed;
            bottom: 6rem;
            right: 1rem;
            width: 320px;
            height: 180px;
            background-color: rgba(0, 0, 0, 0.9);
            border-radius: 1rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 110;
            display: none;
            flex-direction: column;
            overflow: hidden;
            resize: both;
            min-width: 200px;
            min-height: 112px;
            cursor: grab;
        }
        #video-popup-container.active { display: flex; }
        #video-popup-player-container {
            width: 100%;
            height: 100%;
            border-radius: 1rem;
            overflow: hidden;
        }

        div#digital-date-line2 {
            font-size: 1.4em;
        }

        .video-popup-controls {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
            z-index: 120;
        }
        .video-popup-controls button {
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .video-popup-controls button:hover { background-color: rgba(0, 0, 0, 0.8); }

        /* Responsive adjustments for smaller screens (mobile first) */


        /*only add here*/
        /* --- START: Athkar App Styles --- */
        .athkar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4 columns */
            gap: 1rem;
            padding: 1rem;
        }

        /* NEW: 5-column grid for monthly reminders */
        .athkar-grid-monthly {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* 5 columns */
            gap: 1rem;
            padding: 1rem;
        }

        .athkar-item {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.25rem;
            padding: 1.5rem;
            text-align: center;
            font-family: 'Amiri Quran', serif; /* Use the special font */
            font-size: 1.4rem;
            line-height: 1.8;
            color: white;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .athkar-item:hover, .athkar-item.tv-focus {
            transform: scale(1.03);
            box-shadow: 0 0 20px rgba(147, 51, 234, 0.5);
            background-color: rgba(147, 51, 234, 0.3);
        }

        .athkar-item .repetition {
            font-size: 1rem;
            font-family: 'Inter', sans-serif; /* Use regular font for repetition text */
            color: #a5b4fc; /* Light indigo */
            margin-top: 0.5rem;
            font-style: italic;
        }

        .athkar-item.header {
            background-color: rgba(20, 184, 166, 0.3);
            font-size: 1.8rem;
            font-weight: bold;
        }

         .athkar-color-1 { border-color: rgba(59, 130, 246, 0.7); box-shadow: 0 0 20px rgba(59, 130, 246, 0.4); background-color: rgba(59, 130, 246, 0.15); } /* Blue */
        .athkar-color-2 { border-color: rgba(16, 185, 129, 0.7); box-shadow: 0 0 20px rgba(16, 185, 129, 0.4); background-color: rgba(16, 185, 129, 0.15); } /* Emerald */
        .athkar-color-3 { border-color: rgba(249, 115, 22, 0.7); box-shadow: 0 0 20px rgba(249, 115, 22, 0.4); background-color: rgba(249, 115, 22, 0.15); } /* Orange */
        .athkar-color-4 { border-color: rgba(139, 92, 246, 0.7); box-shadow: 0 0 20px rgba(139, 92, 246, 0.4); background-color: rgba(139, 92, 246, 0.15); } /* Violet */
        .athkar-color-5 { border-color: rgba(236, 72, 153, 0.7); box-shadow: 0 0 20px rgba(236, 72, 153, 0.4); background-color: rgba(236, 72, 153, 0.15); } /* Pink */


        /* Responsive grid for Athkar */
        @media (max-width: 1024px) {
            .athkar-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .athkar-grid-monthly {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .athkar-grid {
                grid-template-columns: 1fr;
            }
            .athkar-grid-monthly {
                grid-template-columns: repeat(2, 1fr);
            }
            .athkar-item {
                font-size: 1.2rem;
                padding: 1rem;
            }
        }
        /* --- END: Athkar App Styles --- */
        @media (max-width: 768px) {
            body {
                overflow-y: auto;
            }

               nav.w-20.sm\:w-24.bg-black\/20.flex.flex-col.items-center.justify-start.pt-8.p-2.space-y-4.border-l.border-white\/10.flex-shrink-0.transition-opacity.\30 \.3s.ease.grid-container {
    flex-direction: row-reverse;
    inline-size: -webkit-fill-available;}
            .top-bar {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
                top: 0.5rem;
            }

            div#bottom-left-controls {
    DISPLAY: NONE;
}

            #carplay-main-interface {
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                flex-direction: column;
                border-radius: 0;
            }

            main {
                order: 1;
                height: 100%; /* Take full height of the flex container */
                padding-bottom: 64px; /* Add padding for the nav bar */
            }

            nav {
                order: 2; /* Move nav to bottom of flex container */
                position: fixed; /* Make it a floating dock */
                bottom: 0;
                left: 0;
                width: 100%;
                height: 64px; /* A standard dock height */
                flex-direction: row;
                justify-content: space-around;
                align-items: center;
                background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent black */
                backdrop-filter: blur(15px);
                -webkit-backdrop-filter: blur(15px);
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                z-index: 200;
                padding: 0;
                gap: 0.5rem;
            }
            
            nav .app-icon {
                flex-grow: 1;
                border-radius: 0;
                height: 100%;
                width: auto;
            }

            .app-screen {
                padding: 1rem;
            }

            .dashboard-main-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
                height: auto;
            }

            .dashboard-main-grid > div {
                height: auto !important;
                width: 100%;
            }

            .car-cam-360-container {
                height: 200px;
            }

            /* Media Screen Mobile Zoom and Layout */
            #screen-Media {
                zoom: 0.9;
                padding: 1rem 0.5rem;
            }

            .reader-container {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 0.75rem;
            }

            .youtube-reader-card img, .youtube-reader-card .w-\[100px\] {
                width: 75px;
                height: 75px;
            }
             .youtube-reader-card h3 {
                font-size: 0.9rem;
                margin-bottom: 0.5rem;
            }

            .youtube-video-card img, .youtube-search-card img {
                width: 90px;
                height: 50.625px; /* Maintain 16:9 aspect ratio */
                margin-right: 0.5rem;
            }
            .youtube-video-card h3, .youtube-search-card h3 {
                font-size: 0.85rem;
            }

            /* Move floating buttons above the new bottom dock */
            #floating-media-button,
            #back-to-playlists-bottom-button,
            #back-to-playlists-bottom-button-search,
            #floating-keyboard-button,
            #start-trip-floating-button {
                padding: 0.75rem 1rem;
                font-size: 0.8rem;
                gap: 0.25rem;
                bottom: 75px; /* 64px dock + 11px margin */
            }
            #floating-media-button { right: 1rem; }
            #floating-keyboard-button {
                right: 5.5rem;
            }
            #back-to-playlists-bottom-button, #back-to-playlists-bottom-button-search {
                left: 50%;
                transform: translateX(-50%);
            }
            #start-trip-floating-button {
                 left: 50%;
                transform: translateX(-50%);
            }
            #bottom-left-controls {
                 bottom: 75px;
            }

            #video-popup-container {
                width: 90%;
                height: auto;
                min-width: unset;
                min-height: unset;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                bottom: unset;
                right: unset;
            }
        }

        /* UPDATED: Media Query for 16:9 aspect ratio screens in portrait mode (e.g., 1080x1920) */
        @media screen and (aspect-ratio: 9/16) and (orientation: portrait) {
            body {
                justify-content: flex-start; /* Align content to the top */
                padding-top: 4rem; /* Add padding to avoid notch/top bar */
                overflow-y: auto; /* Allow scrolling on tall screens */
            }

            #carplay-main-interface {
                height: auto; /* Allow content to determine height */
                min-height: 95vh;
                width: 98vw;
                top: 1rem;
                left: 1%;
                flex-direction: column; /* Stack sidebar and main content */
            }
            
            nav {
                flex-direction: row;
                width: 100%;
                height: auto;
                justify-content: center;
                gap: 0.5rem;
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
                order: 2; /* Move nav to bottom */
            }
            
            main {
                order: 1; /* Move main content to top */
            }

            .dashboard-main-grid {
                grid-template-columns: 1fr; /* Force single column */
                grid-template-rows: 1fr 1fr 1fr auto; /* Adjust rows for vertical layout */
                gap: 1rem;
            }

            /* Ensure all grid items in dashboard are visible and take full width */
            .dashboard-main-grid > div {
                grid-column: 1 / -1 !important;
                grid-row: auto !important;
            }

            .flex.flex-col.gap-4.md\:gap-6.col-span-1.row-start-1.grid-container {
                flex-direction: row; /* Side-by-side clock and weather */
                gap: 1rem;
            }
            .flex.flex-col.gap-4.md\:gap-6.col-span-1.row-start-1.grid-container > div {
                flex-grow: 1;
            }
section#screen-Weather {
    zoom: 0.6;
}
            #screen-Media {
                padding: 0rem 1rem;
            }

            .reader-container {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                max-height: 60vh; /* Allow more vertical scroll */
            }

            .youtube-suggestion-button {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }

            #youtube-surah-section .grid {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            }
        }
        
        /* NEW: Responsive padding toggle */
        @media (min-width: 768px) {
            body.small-padding .md\:p-6 {
                padding: 1.5rem !important;
            }
        }


div#bottom-left-controls {
    left: 90px!important;
}
        img.w-full.h-full.object-cover.rounded-lg.opacity-80 {
            position: fixed;
        }
        /* Prayer Times Specific Styles */
        .prayer-times-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            margin-top: 1rem;
        }
        .prayer-time-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            font-size: 0.9rem;
            min-width: 80px;
            text-align: center;
            transition: background-color 0.3s ease;
        }
        /* UPDATED: Current prayer is green */
        .prayer-time-item.current-prayer {
            background-color: rgba(16, 185, 129, 0.4); /* Greenish */
            font-weight: bold;
            border: 1px solid #10B981;
        }
        /* UPDATED: Next prayer is orange */
        .prayer-time-item.next-prayer {
            background-color: rgba(251, 146, 60, 0.3); /* Orangey */
            border: 1px solid #fb923c;
        }
        .prayer-name {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            margin-bottom: 0.2rem;
        }
        .prayer-time {
            color: white;
            font-size: 1rem;
        }

        /* --- START: Islamic Daily Reminders Styles (MODIFIED) --- */

.reminders-grid {
    display: grid;
    grid-template-columns: repeat(2, 48%); /* عمودين بعرض 48% لكل منهما */
    justify-content: center; /* توسيط العمودين في الحاوية */
    gap: 1rem;
    width: 100%;
    height: 100%;
    align-content: center; 
    padding: 1rem; 
}

.reminder-item {
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 1.25rem;
    padding: 0.8rem 1rem; /* تعديل الحشو */
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: flex-start;
    gap: 0.75rem; /* تقليل المسافة */
    transition: all 0.3s ease;
    cursor: pointer;
    height:80%;
}

.reminder-item .icon {
    color: rgba(255, 255, 255, 0.5); 
    flex-shrink: 0; /* لمنع الأيقونة من الانكماش */
    /* تصغير حجم الأيقونة لتتناسق مع النص */
    width: 1.6rem !important;
    height: 1.6rem !important;
}

.reminder-item .text {
    font-size: 1.2rem; /* تصغير حجم الخط */
    font-weight: 600;
    color: rgba(255, 255, 255, 0.7);
    text-align: right; /* لضمان محاذاة النص لليمين */
}

/* كود الحالة النشطة يبقى كما هو لأنه ممتاز */
.reminder-item.active {
    background-color: rgba(20, 184, 166, 0.3); 
    border-color: rgba(45, 212, 191, 0.7);
    box-shadow: 0 0 20px rgba(20, 184, 166, 0.5);
}

.reminder-item.active .icon {
    color: #5eead4; 
}

.reminder-item.active .text {
    color: #ffffff; 
}

/* NEW: Upcoming reminder glow */
.reminder-item.upcoming {
    background-color: rgba(249, 115, 22, 0.2); /* Orange transparent bg */
    border-color: rgba(251, 146, 60, 0.6);   /* Orange border */
    box-shadow: 0 0 20px rgba(249, 115, 22, 0.4); /* Orange glow */
}
.reminder-item.upcoming .icon {
    color: #fdba74; /* Light orange icon */
}
.reminder-item.upcoming .text {
    color: #ffffff; /* White text for contrast */
}

/* ▼▼▼ NEW: Completed reminder style ▼▼▼ */
.reminder-item.completed {
    background-color: rgba(107, 114, 128, 0.15); /* Grayish transparent bg */
    border-color: rgba(107, 114, 128, 0.3);
    opacity: 0.7; /* Make it more faded */
}
.reminder-item.completed .icon {
    color: #4ade80; /* Green check icon */
}
.reminder-item.completed .text {
    color: rgba(255, 255, 255, 0.5); /* Faded text */
}


/* ▼▼▼ NEW: Missed and Dropdown Styles ▼▼▼ */
.reminder-item.missed {
    background-color: rgba(239, 68, 68, 0.2); /* Red transparent bg */
    border-color: rgba(248, 113, 113, 0.6);   /* Red border */
    box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); /* Red glow */
}
.reminder-item.missed .icon {
    color: #fca5a5; /* Light red icon */
}
.reminder-item.missed .text {
    color: #ffffff; /* White text for contrast */
}

/* Dropdown menu for reminders */
.reminder-status-dropdown {
    position: absolute;
    top: 90%; /* Position slightly overlapping the icon */
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(30, 41, 59, 0.9); /* slate-800 with transparency */
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.75rem;
    padding: 0.5rem;
    z-index: 50;
    display: none; /* Hidden by default */
    min-width: 120px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}
.reminder-status-dropdown.show {
    display: block;
}
.reminder-status-dropdown button {
    display: block; width: 100%; padding: 0.5rem 0.75rem; text-align: right; font-size: 0.9rem; color: white; background-color: transparent; border: none; border-radius: 0.5rem; cursor: pointer; transition: background-color 0.2s;
}
.reminder-status-dropdown button:hover {
    background-color: rgba(71, 85, 105, 0.7); /* slate-600 with transparency */
}
/* ▲▲▲ END: New Styles ▲▲▲ */


/* --- END: Islamic Daily Reminders Styles (MODIFIED) --- */
        /* OBD-II Specific Styles */
        .obd-data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            width: 100%;
        }
        .obd-data-card {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }
        .obd-data-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #10b981;
            margin-bottom: 0.25rem;
        }
        .obd-data-card .label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        /* التغييرات المطلوبة للشاشات الأوسع */
        @media (min-width: 992px) {
            .carousel-nav-button.prev {
                display: flex;
            }
            body{
              background:url('https://dmusera.netlify.app/tvbg1@1.5x.png')!important;
                background-size:cover!important;
            }

            /* NEW: Date widget styles */
            #full-date-widget-container {
                display: flex !important; /* Make it visible */
                flex-direction: column;
                align-items: center;
                justify-content: center;
                color: white;
                text-shadow: 0 1px 3px rgba(0,0,0,0.5);
                padding: 0.2rem; /* Increased padding */
                background-color: rgba(0,0,0,0.2);
                border-radius: 1rem;
                backdrop-filter: blur(5px);
                -webkit-backdrop-filter: blur(5px);
                margin-bottom: 0.4rem; /* Add some space below it */
                font-family: 'Amiri', serif; /* Apply Thuluth-like font */
            }
            #full-date-widget-container p { margin: 0; }
            #gregorian-date { font-size: 1.6rem; font-weight: 700; } /* Increased font size and made bold */
            #hijri-date { font-size: 1.6rem; opacity: 0.9; font-weight: 700;padding:0px;margin:0px} /* Increased font size and made bold */

            /* NEW: Larger clock on desktop */
            #digital-time {
                font-size: 3rem !important;
            }


            /* --- START: Hide Elements in TV UI --- */

/* إخفاء العناصر المطلوبة في واجهة التلفاز */
[data-app="Map"],                  /* إخفاء أيقونة خريطة الـ 3D من شريط التنقل */
            #car-360-image {
                visibility: hidden;
            }
            div#tv{display:block;background:#00000050}
            div#map{display:none;}
            


        .car-cam-360-controls.grid-container>button {
    display: none;
}

            .car-cam-360-container {
                background-image: url('https://cdn.salla.sa/ePoPG/896b46ef-2021-4ffb-8ee6-d1010f51a8fd-333.4375x500-651XvkaPHg7Xk9VDEAzv8nBS2uEA58WWVa64rmnk.jpg');
                background-size: cover;
                background-position: center center;
                background-repeat: no-repeat;
            }
            /* إخفاء شعار لكزس على الشاشات الأوسع */
            img[src*="Lexus-Logo.wine.svg"] {
                display: none !important;
            }
        }
        
        /* NEW: Show next button on even wider screens */
        @media (min-width: 1080px) {
            .carousel-nav-button.next {
                display: flex;
            }
        }
    </style>
</head>
<body class="animated-bg text-white overflow-hidden theme-gradient-1">
    <!-- SVG Filter Definition for Liquid Glass Effect -->
    <svg style="position: absolute; width: 0; height: 0; overflow: hidden;">
        <defs>
            <filter id="glass-filter" colorInterpolationFilters="sRGB" x="0%" y="0%" width="100%" height="100%">
                <feImage x="0" y="0" width="100%" height="100%" preserveAspectRatio="none" result="map" 
                    href="data:image/svg+xml,%3Csvg viewBox='0 0 400 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3ClinearGradient id='red-grad' x1='100%25' y1='0%25' x2='0%25' y2='0%25'%3E%3Cstop offset='0%25' stop-color='%230000'/%3E%3Cstop offset='100%25' stop-color='red'/%3E%3C/linearGradient%3E%3ClinearGradient id='blue-grad' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%230000'/%3E%3Cstop offset='100%25' stop-color='blue'/%3E%3C/defs%3E%3Crect x='0' y='0' width='400' height='200' fill='black'/%3E%3Crect x='0' y='0' width='400' height='200' rx='20' fill='url(%23red-grad)'/%3E%3Crect x='0' y='0' width='400' height='200' rx='20' fill='url(%23blue-grad)' style='mix-blend-mode: difference'/%3E%3Crect x='1.4' y='1.4' width='397.2' height='197.2' rx='20' fill='hsl(0 0% 50% / 0.93)' style='filter:blur(11px)'/%3E%3C/svg%3E"/>
                
                <feDisplacementMap in="SourceGraphic" in2="map" id="redchannel" scale="300" xChannelSelector="R" yChannelSelector="G" result="dispRed" />
                <feColorMatrix in="dispRed" type="matrix" values="1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0" result="red" />
                
                <feDisplacementMap in="SourceGraphic" in2="map" id="greenchannel" scale="310" xChannelSelector="R" yChannelSelector="G" result="dispGreen" />
                <feColorMatrix in="dispGreen" type="matrix" values="0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 1 0" result="green" />
                
                <feDisplacementMap in="SourceGraphic" in2="map" id="bluechannel" scale="320" xChannelSelector="R" yChannelSelector="G" result="dispBlue" />
                <feColorMatrix in="blue" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0" result="blue" />
                
                <feBlend in="red" in2="green" mode="screen" result="rg" />
                <feBlend in="rg" in2="blue" mode="screen" result="output" />
                
                <feGaussianBlur in="output" stdDeviation="5" />
            </filter>
        </defs>
    </svg>

    <div class="w-full h-screen flex flex-col items-center justify-center p-4 sm:p-6">
        
        <!-- Top Bar: Wifi, 5G, Current Time -->
        <div class="w-full max-w-7xl flex justify-between items-center text-white/80 text-sm px-4 py-2 absolute top-4 left-1/2 -translate-x-1/2 z-10 top-bar">
            <div class="flex items-center gap-2">
              
            </div>
           
        </div>

        <!-- Lexus Logo Fixed at Top Center -->
        <img src="https://dmusera.netlify.app/Lexus-Logo.wine.svg" width="200px" alt="Lexus Logo" class="fixed top-2 left-1/2 -translate-x-1/2 h-12 z-[1000] opacity-80" style="filter: invert(1) grayscale(100%) brightness(200%);" />

        <!-- Main CarPlay Interface Container -->
        <div id="carplay-main-interface" class="flex flex-row shadow-2xl rounded-3xl overflow-hidden bg-black/20 border border-white/10">
            
            <!-- Main content area for app screens -->
            <main class="flex-1 flex flex-col h-full">
                
                <!-- Dashboard Screen -->
                <section id="screen-Dashboard" class="app-screen p-4 md:p-6 flex-col h-full">
                    <!-- UPDATED: Dashboard layout changed -->
                    <div class="dashboard-main-grid grid grid-cols-1 md:grid-cols-3 grid-rows-[80%_20%] gap-4 md:gap-6 h-full w-full grid-container">
                        <!-- Map Widget (Now first) -->
                        <div id="map" class="rounded-3xl relative overflow-hidden flex items-center justify-center glass-surface glass-surface--svg p-1 col-span-1 row-start-1 navigable grid-item" tabindex="0">
                            <div id="dashboard-google-map" class="full-iframe"></div>
                             <!-- NEW: Geolocation Error Overlay -->
                             <div id="geolocation-error-overlay" class="hidden absolute top-0 left-0 w-full h-full bg-black/70 text-white flex-col items-center justify-center text-center p-4 z-10 rounded-3xl">
                                <i data-lucide="map-pin-off" class="w-12 h-12 text-red-500 mb-4"></i>
                                <h3 class="font-bold text-lg mb-2">خدمة تحديد المواقع معطلة</h3>
                                <p class="text-sm text-white/80">يرجى تمكين أذونات الموقع في إعدادات المتصفح لهذا الموقع للاستفادة من ميزات الخريطة.</p>
                            </div>
                            <div class="absolute bottom-4 left-4 flex gap-2">
                                <button id="get-my-location-button-dashboard" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full transition-colors duration-200 flex items-center justify-center text-sm navigable grid-item" tabindex="0" title="تحديث الموقع">
                                    <i data-lucide="map-pin" class="w-5 h-5"></i>
                                </button>
                                <button id="go-to-home-1-button" class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-full transition-colors duration-200 flex items-center justify-center text-sm navigable grid-item" tabindex="0" title="الذهاب الى المنزل 1">
                                    <i data-lucide="home" class="w-5 h-5"></i>
                                </button>
                                <button id="go-to-home-2-button" class="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-full transition-colors duration-200 flex items-center justify-center text-sm navigable grid-item" tabindex="0" title="الذهاب الى المنزل 2">
                                    <i data-lucide="building-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>

                        <!-- 360 Camera View (Stays in middle) -->
                        <div class="glass-surface glass-surface--svg p-2 flex flex-col items-center justify-center text-center car-cam-360-container col-span-1 row-start-1 navigable grid-item" tabindex="0">
                            <img id="car-360-image" src="https://dmusera.netlify.app/es350gb.png" alt="عرض الكاميرا 360 درجة للسيارة" class="w-full h-full object-contain rounded-lg opacity-80">
                            <div class="car-cam-360-controls grid-container">
                                <input type="file" id="upload-360-image-input" accept="image/*" class="hidden" />
                                <button id="upload-360-image-button" class="navigable grid-item" tabindex="0">
                                    <i data-lucide="upload" class="w-4 h-4"></i> تحميل صورة
                                </button>
                                <button id="reset-360-image-button" class="navigable grid-item" tabindex="0">
                                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i> إعادة تعيين
                                </button>
                            </div>
                        </div>
                        
                        <!-- Weather and Clock/Prayer Widgets (Now third) -->
                        <div class="flex flex-col gap-4 md:gap-6 col-span-1 row-start-1 grid-container">
                             <div id="full-date-widget-container" class="hidden">
        </div>
                            <div class="glass-surface glass-surface--svg p-4 flex-grow flex flex-col items-center justify-center text-center navigable grid-item" tabindex="0">
                               
                                <div id="weather-widget-container" class="w-full h-full flex flex-col items-center justify-center">
                                    <img id="dashboard-weather-icon" src="" alt="Weather Icon" class="w-20 h-20 text-white mb-2" />
                                    <p class="text-5xl font-extrabold mb-1" id="dashboard-weather-temp">--°C</p>
                                    <p class="text-xl font-semibold text-white/80 mb-2" id="dashboard-weather-desc">--</p>
                                    <p class="text-md text-white/60" id="dashboard-weather-location">--</p>
                                </div>
                            </div>
                            <div class="glass-surface glass-surface--svg p-4 flex-grow flex flex-col items-center justify-center text-center navigable grid-item" tabindex="0">
                                <div id="digital-clock-widget" class="w-full h-full flex flex-col items-center justify-center text-center">
                                    <div id="digital-time">
                                        <span class="hours">00</span>:<span class="minutes">00</span>:<span class="seconds">00</span>
                                    </div>
                                    <div id="digital-date">
                                        <div id="digital-date-line1">  </div>
                                        <div id="digital-date-line2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Prayer Times Row (Stays at bottom) -->
                        <div class="glass-surface glass-surface--svg p-4 flex flex-col items-center justify-center text-center col-span-full row-start-2 navigable grid-item" tabindex="0">
                            <div id="prayer-times-container" class="prayer-times-row grid-container">
                                <!-- Prayer times will be loaded here by JavaScript -->
                                <p class="text-white/70 col-span-full">جاري تحميل أوقات الصلاة...</p>
                            </div>
                        </div>


                        <div id="tv" class="glass-surface glass-surface--svg p-4 flex flex-col items-center justify-center text-center car-cam-360-container col-span-1 row-start-1 navigable grid-item" tabindex="0"></div>


                    </div>
                </section>

                <!-- Media (YouTube) Screen -->
                <section id="screen-Media" class="app-screen p-4 md:p-6 flex-col items-center h-full relative">
                    <!-- NEW: Floating "Back to Search" Button -->
                    <button id="back-to-search-floating-button" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-5 rounded-full shadow-lg z-50 flex items-center gap-2 navigable grid-item" tabindex="0" style="display: none;">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        <span>العودة إلى البحث</span>
                    </button>

                    <div class="w-full flex flex-col gap-4">
                        <!-- Search Row -->
                        <div class="w-full flex flex-row items-center gap-2 grid-container flex-shrink-0">
                            <button id="youtube-search-button" class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-full transition-colors duration-200 flex items-center justify-center navigable grid-item" tabindex="0">
                                <i data-lucide="search"></i>
                            </button>
                            <button id="clear-search-button" class="navigable grid-item" tabindex="0">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                            <input type="text" id="youtube-search-input" placeholder="ابحث في يوتيوب..." class="flex-grow p-3 rounded-full bg-white/10 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500 navigable grid-item" tabindex="0" readonly="true" />
                        </div>
                        
                        <div id="youtube-suggestions" class="w-full flex-grow flex flex-col">
    
    <div id="last-watched-container" class="hidden">
        </div>

    <div id="suggestions-content" class="flex flex-col gap-4 w-full">
        </div>

</div>
                        
                    </div>

                    <div id="youtube-video-list-view" class="hidden flex-col items-center justify-center h-full w-full absolute top-0 left-0 p-4 overflow-y-auto gap-4 flex-grow bg-black/50 backdrop-blur-sm">
                        <button id="back-to-playlists-from-videos" class="absolute top-4 left-4 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-full transition-colors duration-200 flex items-center gap-2 text-sm navigable grid-item z-10" tabindex="0">
                            <i data-lucide="arrow-left" class="w-4 h-4"></i> العودة
                        </button>
                        <h2 class="text-3xl font-bold mb-4 text-center w-full pt-12">فيديوهات قائمة التشغيل</h2>
                        <div id="video-list-container" class="flex flex-col gap-4 w-full grid-container"></div>
                        <button id="back-to-playlists-bottom-button" class="mt-4 bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-full transition-colors duration-200 flex items-center justify-center gap-2 text-base navigable grid-item" tabindex="0">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i> العودة إلى البحث
                        </button>
                    </div> 

                    <div id="youtube-search-results-view" class="hidden flex-col h-full w-full absolute top-0 left-0 bg-black/50 backdrop-blur-sm">
                      
                        <div id="search-results-container" class="flex flex-col gap-4 w-full p-4 overflow-y-auto flex-grow grid-container"></div>
                        
                        <!-- NEW: Bottom navigation container -->
                        <div class="w-full grid grid-cols-3 items-center p-2 sticky bottom-0 bg-black/40 backdrop-blur-sm flex-shrink-0 search-results-nav">
                            <!-- Previous Button container -->
                            <div class="flex justify-start">
                                <button id="previous-item-button" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-full transition-all duration-200 flex items-center justify-center gap-2 text-sm navigable grid-item" style="display: none;" tabindex="0"></button>
                            </div>
                            <!-- Back Button container -->
                            <div class="flex justify-center">
                                <button id="back-to-playlists-bottom-button-search" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-full transition-all duration-200 flex items-center justify-center gap-2 text-sm navigable grid-item" tabindex="0">
                                    <i data-lucide="arrow-left" class="w-5 h-5"></i> العودة إلى البحث
                                </button>
                            </div>
                            <!-- Next Button container -->
                            <div class="flex justify-end">
                                <button id="next-item-button" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-full transition-all duration-200 flex items-center justify-center gap-2 text-sm navigable grid-item" style="display: none;" tabindex="0"></button>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Radio Screen -->
                <section id="screen-Radio" class="app-screen items-center justify-center h-full w-full p-4 md:p-6">
                   <iframe class="full-iframe" style="zoom: 0.5;" title="Quran Reciters" src="https://quran.com/radio" allow="geolocation"></iframe>
                </section>

                <!-- Athkar Screen -->
                <section id="screen-Athkar" class="app-screen p-4 md:p-6 flex-col items-center h-full">
                    <div class="tabs-container flex p-1 rounded-full bg-black/20 self-center mb-4">
                        <button id="tab-sabah" class="tab-button navigable grid-item tv-focus active" tabindex="0">أذكار الصباح</button>
                        <button id="tab-masaa" class="tab-button navigable grid-item" tabindex="0">أذكار المساء</button>
                        <button id="tab-monthly" class="tab-button navigable grid-item" tabindex="0">التذكيرات الشهرية</button>
                    </div>
                    <div id="athkar-content-container" class="w-full flex-grow overflow-y-auto">
                        <!-- Morning Athkar Panel -->
                        <div id="athkar-sabah-content" class="tab-content athkar-grid"><div class="athkar-item navigable grid-item athkar-color-1" tabindex="0"><p>آية الكرسي</p><span class="repetition">(مرة واحدة)</span></div><div class="athkar-item navigable grid-item athkar-color-2" tabindex="0"><p>اللهم أعني على ذكرك وشكرك وحسن عبادتك.</p></div><div class="athkar-item navigable grid-item athkar-color-3" tabindex="0"><p>المعوذات: سورة الإخلاص، سورة الفلق، سورة الناس</p><span class="repetition">(٣ مرات)</span></div><div class="athkar-item navigable grid-item athkar-color-4" tabindex="0"><p>حسبي الله لا إله إلا هو عليه توكلت وهو رب العرش العظيم</p><span class="repetition">(٧ مرات)</span></div><div class="athkar-item navigable grid-item athkar-color-5" tabindex="0"><p>اللهم بك أصبحنا، وبك أمسينا، وبك نحيا، وبك نموت، وإليك النشور.</p></div><div class="athkar-item navigable grid-item athkar-color-1" tabindex="0"><p>بسم الله الذي لا يضر مع اسمه شيء في الأرض ولا في السماء وهو السميع العليم</p><span class="repetition">(٣ مرات)</span></div><div class="athkar-item navigable grid-item athkar-color-2" tabindex="0"><p>يا حي يا قيوم برحمتك أستغيث، أصلح لي شأني كله ولا تكلني إلى نفسي طرفة عين.</p></div><div class="athkar-item navigable grid-item athkar-color-3 col-span-2" tabindex="0"><p>اللهم عالم الغيب والشهادة فاطر السماوات والأرض، رب كل شيء ومليكه، أشهد أن لا إله إلا أنت، أعوذ بك من شر نفسي، ومن شر الشيطان وشركه، وأن أقترف على نفسي سوءاً أو أجره إلى مسلم.</p></div><div class="athkar-item navigable grid-item athkar-color-4 col-span-2" tabindex="0"><p>سيد الاستغغار: اللهم أنت ربي لا إله إلا أنت، خلقتني وأنا عبدك، وأنا على عهدك ووعدك ما استطعت، أعوذ بك من شر ما صنعت، أبوء لك بنعمتك علي، وأبوء بذنبي فاغفر لي، فإنه لا يغفر الذنوب إلا أنت.</p></div><div class="athkar-item navigable grid-item athkar-color-5 col-span-4" tabindex="0"><p>اللهم إني أسألك العفو والعافية في الدنيا والآخرة، اللهم إني أسألك العفو والعافية في ديني ودنياي وأهلي ومالي، اللهم استر عوراتي وآمن روعاتي، اللهم احفظني من بين يدي ومن خلفي وعن يميني وعن شمالي ومن فوقي، وأعوذ بعظمتك أن أغتال من تحتي.</p></div><div class="athkar-item navigable grid-item athkar-color-1 col-span-4" tabindex="0"><p>أصبحنا وأصبح الملك لله، والحمد لله، لا إله إلا الله وحده لا شريك له، له الملك وله الحمد وهو على كل شيء قدير. رب أسألك خير ما في هذا اليوم وخير ما بعده، وأعوذ بك من شر ما في هذا اليوم وشر ما بعده، رب أعوذ بك من الكسل وسوء الكبر، رب أعوذ بك من عذاب في النار وعذاب في القبر.</p></div></div>
                        <!-- Evening Athkar Panel -->
                        <div id="athkar-masaa-content" class="tab-content athkar-grid hidden"><div class="athkar-item navigable grid-item header col-span-4" tabindex="0"><p>أذكار المساء ()</p></div><div class="athkar-item navigable grid-item athkar-color-1" tabindex="0"><p>آية الكرسي</p><span class="repetition">(مرة واحدة)</span></div><div class="athkar-item navigable grid-item athkar-color-2" tabindex="0"><p>اللهم أعني على ذكرك وشكرك وحسن عبادتك.</p></div><div class="athkar-item navigable grid-item athkar-color-3" tabindex="0"><p>المعوذات: سورة الإخلاص، سورة الفلق، سورة الناس</p><span class="repetition">(٣ مرات)</span></div><div class="athkar-item navigable grid-item athkar-color-4" tabindex="0"><p>حسبي الله لا إله إلا هو عليه توكلت وهو رب العرش العظيم</p><span class="repetition">(٧ مرات)</span></div><div class="athkar-item navigable grid-item athkar-color-5" tabindex="0"><p>اللهم بك أمسينا، وبك أصبحنا، وبك نحيا، وبك نموت، وإليك المصير.</p></div><div class="athkar-item navigable grid-item athkar-color-1" tabindex="0"><p>بسم الله الذي لا يضر مع اسمه شيء في الأرض ولا في السماء وهو السميع العليم</p><span class="repetition">(٣ مرات)</span></div><div class="athkar-item navigable grid-item athkar-color-2" tabindex="0"><p>يا حي يا قيوم برحمتك أستغيث، أصلح لي شأني كله ولا تكلني إلى نفسي طرفة عين.</p></div><div class="athkar-item navigable grid-item athkar-color-3" tabindex="0"><p>اللهم ما أمسى بي من نعمة أو بأحد من خلقك فمنك وحدك لا شريك لك، فلك الحمد ولك الشكر.</p></div><div class="athkar-item navigable grid-item athkar-color-4 col-span-2" tabindex="0"><p>سيد الاستغغار: اللهم أنت ربي لا إله إلا أنت، خلقتني وأنا عبدك، وأنا على عهدك ووعدك ما استطعت، أعوذ بك من شر ما صنعت، أبوء لك بنعمتك علي، وأبوء بذنبي فاغفر لي، فإنه لا يغفر الذنوب إلا أنت.</p></div><div class="athkar-item navigable grid-item athkar-color-5 col-span-4" tabindex="0"><p>اللهم إني أسألك العفو والعافية في الدنيا والآخرة، اللهم إني أسألك العفو والعافية في ديني ودنياي وأهلي ومالي، اللهم استر عوراتي وآمن روعاتي، اللهم احفظني من بين يدي ومن خلفي وعن يميني وعن شمالي ومن فوقي، وأعوذ بعظمتك أن أغتال من تحتي.</p></div><div class="athkar-item navigable grid-item athkar-color-1 col-span-4" tabindex="0"><p>أمسينا وأمسى الملك لله، والحمد لله، لا إله إلا الله وحده لا شريك له، له الملك وله الحمد وهو على كل شيء قدير. رب أسألك خير ما في هذه الليلة وخير ما بعدها، وأعوذ بك من شر ما في هذه الليلة وشر ما بعدها، رب أعوذ بك من الكسل وسوء الكبر، رب أعوذ بك من عذاب في النار وعذاب في القبر.</p></div></div>
                        <!-- NEW: Monthly Reminders Panel -->
                        <div id="athkar-monthly-content" class="tab-content athkar-grid-monthly hidden">
                            <div class="athkar-item navigable grid-item header col-span-5" tabindex="0"><p>تذكيرات وأعمال شهرية</p></div>
                            <div class="athkar-item navigable grid-item athkar-color-1" tabindex="0"><p>الصدقة الشهرية</p></div>
                            <div class="athkar-item navigable grid-item athkar-color-2" tabindex="0"><p>صيام الأيام البيض</p><span class="repetition">(١٣، ١٤، ١٥)</span></div>
                            <div class="athkar-item navigable grid-item athkar-color-3" tabindex="0"><p>قراءة سورة الكهف</p><span class="repetition">(كل جمعة)</span></div>
                            <div class="athkar-item navigable grid-item athkar-color-4" tabindex="0"><p>صلة الرحم</p></div>
                            <div class="athkar-item navigable grid-item athkar-color-5" tabindex="0"><p> حفظ القرأن </p></div>
                            <div class="athkar-item navigable grid-item athkar-color-1 col-span-2" tabindex="0"><p>جلسة محاسبة للنفس</p></div>
                            <div class="athkar-item navigable grid-item athkar-color-2" tabindex="0"><p>التخطيط للشهر الجديد</p></div>
                            <div class="athkar-item navigable grid-item athkar-color-3 col-span-2" tabindex="0"><p>تعلم مسألة فقهية جديدة</p></div>
                        </div>
                    </div>
                </section>

                <!-- Reciters Screen -->
                <section id="screen-Reciters" class="app-screen items-center justify-center h-full w-full p-4 md:p-6">
                   <iframe class="full-iframe" title="Quran Reciters" style="zoom: 0.78;" src="https://quran.com/reciters" allow="geolocation"></iframe>
                </section>

                <!-- Weather Screen -->
                <section id="screen-Weather" class="app-screen p-4 md:p-6 flex-col items-center justify-start h-full">
                  
                    <div class="w-full h-full flex flex-col gap-4 flex-grow">
                        <!-- Hourly Forecast -->
                        <div id="hourly-forecast-container" class="grid grid-cols-7 gap-2 w-full glass-surface glass-surface--svg p-3 rounded-3xl">
                            <!-- JS will populate this -->
                            <div class="text-center text-white/70 col-span-7">جاري تحميل التوقعات...</div>
                        </div>
                        <!-- Location Temperatures -->
                        <div id="location-temps-container" class="grid grid-cols-2 sm:grid-cols-4 gap-4 w-full flex-grow">
                            <!-- JS will populate this -->
                            <div class="text-center text-white/70 col-span-full">جاري تحميل البيانات الجديدة...</div>
                        </div>
                    </div>
                </section>

                <!-- 3D Screen (Formerly Map Screen) -->
                <section id="screen-Map" class="app-screen p-4 md:p-6 flex-col h-full items-center justify-center relative">
                    <div class="w-full h-full bg-black2 rounded-3xl flex items-center justify-center p-1 overflow:hidden">
                        <iframe title="LEXSUS ES" frameborder="0" allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true" allow="autoplay; fullscreen; xr-spatial-tracking" xr-spatial-tracking execution-while-out-of-viewport execution-while-not-rendered web-share WIDTH="80%" HEIGHT="80%" src="https://sketchfab.com/models/17ed331fd31f491fa3907156f0b0b55e/embed?autostart=1&preload=1&annotations_visible=0&annotation=0&annotation_cycle=6&transparent=1&ui_theme=dark"> </iframe>
                    </div>
                    <!-- Right side widget -->
                    <div id="3d-screen-weather-widget" class="absolute top-8 right-8 p-4 rounded-2xl text-center flex items-center gap-3 z-10 navigable grid-item" tabindex="0">
                        <!-- MODIFIED: Replaced icon with user-provided SVG -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="thermometer" class="lucide lucide-thermometer w-8 h-8 text-red-400"><path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"></path></svg>
                        <span class="text-3xl font-bold" id="3d-screen-weather-temp">--°C</span>
                    </div>
                    <!-- NEW: Left side widgets -->
                    <div id="3d-screen-info-widgets" class="absolute top-8 left-8 flex flex-col gap-3 z-10">
                        <div class="p-3 rounded-2xl text-center flex items-center gap-3 navigable grid-item" tabindex="0">
                            <i data-lucide="moon" class="w-7 h-7 text-cyan-300"></i>
                            <div>
                                <div class="text-sm text-white/70">الصلاة القادمة</div>
                                <div class="text-xl font-bold" id="3d-screen-next-prayer">--</div>
                            </div>
                        </div>
                        <div class="p-3 rounded-2xl text-center flex items-center gap-3 navigable grid-item" tabindex="0">
                            <i data-lucide="gauge-circle" class="w-7 h-7 text-green-400"></i>
                            <div>
                                <div class="text-sm text-white/70">السرعة</div>
                                <div class="text-xl font-bold" id="3d-screen-speed">-- km/h</div>
                            </div>
                        </div>
                         <div id="geares" class="p-3 rounded-2xl text-center flex items-center gap-3 navigable grid-item" tabindex="0">
                            <i data-lucide="parking-circle" class="w-7 h-7 text-orange-400"></i>
                            <div>
                                <div class="text-sm text-white/70">القير</div>
                                <div class="text-xl font-bold" id="3d-screen-gear">--</div>
                            </div>
                        </div>
                        <!-- NEW: Direction Widget -->
                        <div class="p-3 rounded-2xl text-center flex items-center gap-3 navigable grid-item" tabindex="0">
                            <i data-lucide="compass" class="w-7 h-7 text-blue-300"></i>
                            <div>
                                <div class="text-sm text-white/70">الاتجاه</div>
                                <div class="text-xl font-bold" id="3d-screen-dir">--</div>
                            </div>
                        </div>
                    </div>
                    <!-- NEW: Sticky Directional Controls -->
                    <div id="direction-controls-3d" class="absolute top-1/2 -translate-y-1/2 right-8 grid grid-cols-3 gap-2 w-[120px] z-10">
                        <button class="glass-surface glass-surface--svg p-2 rounded-full w-10 h-10 flex items-center justify-center text-sm font-bold navigable grid-item" tabindex="0">NW</button>
                        <button class="glass-surface glass-surface--svg p-2 rounded-full w-10 h-10 flex items-center justify-center text-sm font-bold navigable grid-item" tabindex="0">N</button>
                        <button class="glass-surface glass-surface--svg p-2 rounded-full w-10 h-10 flex items-center justify-center text-sm font-bold navigable grid-item" tabindex="0">NE</button>
                        <button class="glass-surface glass-surface--svg p-2 rounded-full w-10 h-10 flex items-center justify-center text-sm font-bold navigable grid-item" tabindex="0">W</button>
                        <div class="w-10 h-10"></div> <!-- Spacer -->
                        <button class="glass-surface glass-surface--svg p-2 rounded-full w-10 h-10 flex items-center justify-center text-sm font-bold navigable grid-item" tabindex="0">E</button>
                        <button class="glass-surface glass-surface--svg p-2 rounded-full w-10 h-10 flex items-center justify-center text-sm font-bold navigable grid-item" tabindex="0">SW</button>
                        <button class="glass-surface glass-surface--svg p-2 rounded-full w-10 h-10 flex items-center justify-center text-sm font-bold navigable grid-item" tabindex="0">S</button>
                        <button class="glass-surface glass-surface--svg p-2 rounded-full w-10 h-10 flex items-center justify-center text-sm font-bold navigable grid-item" tabindex="0">SE</button>
                    </div>
                </section>

                <!-- Electronic Quran App Screen -->
                <section id="screen-Quran" class="app-screen p-4 md:p-6 flex-col items-center justify-center h-full relative">
                   <div id="quran-quick-access" class="mt-4 bg-black/30 p-4 rounded-xl flex flex-col gap-3 items-end z-20 glass-surface glass-surface--svg w-full max-w-md">
                        <button id="quran-go-button" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full transition-colors duration-200 flex items-center gap-2 text-sm self-center navigable grid-item" tabindex="0"></button>
                    </div>
                    <div class="w-full h-full glass-surface glass-surface--svg p-4 rounded-xl flex flex-col items-center flex-grow" style="height: 100%!important;">
                        <iframe id="quran-iframe" class="full-iframe" src="https://quran.com/?lang=ar" lang="ar" title="القرآن الكريم" frameborder="0" allow="fullscreen; picture-in-picture"></iframe>
                    </div>
                </section>

            </main>

            <!-- Navigation Dock (Left Sidebar) -->
            <nav class="w-20 sm:w-24 bg-black/20 flex flex-col items-center justify-start pt-8 p-2 space-y-4 border-l border-white/10 flex-shrink-0 transition-opacity 0.3s ease grid-container">
                <button data-app="Dashboard" class="app-icon navigable grid-item" tabindex="0">
                    <i data-lucide="layout-grid"></i>
                </button>
                <button data-app="Media" class="app-icon navigable grid-item" tabindex="0">
                    <i data-lucide="play-circle"></i>
                </button>
                 <button data-app="Radio" class="app-icon navigable grid-item" tabindex="0">
                    <i data-lucide="radio"></i>
                </button>
                <button data-app="Athkar" class="app-icon navigable grid-item" tabindex="0">
                    <i data-lucide="book-heart"></i>
                </button>
                <button data-app="Reciters" class="app-icon navigable grid-item" tabindex="0"> 
                    <i data-lucide="users"></i> 
                </button>
                <button data-app="Weather" class="app-icon navigable grid-item" tabindex="0"> 
                    <i data-lucide="cloud-sun"></i> 
                </button>
                <button data-app="Map" class="app-icon navigable grid-item" tabindex="0">
                    <i data-lucide="map"></i> 
                </button>
                <button data-app="Quran" class="app-icon navigable grid-item" tabindex="0">
                    <i data-lucide="book-open"></i>
                </button>
            </nav>
        </div>
    </div>

    <!-- Floating UI Elements -->
    <button id="floating-media-button" class="glass-surface glass-surface--svg rounded-full navigable grid-item" tabindex="0">
        <i data-lucide="youtube" class="w-6 h-6"></i>
    </button>
    <button id="floating-keyboard-button" class="glass-surface glass-surface--svg rounded-full navigable grid-item" tabindex="0">
        <i data-lucide="keyboard" class="w-6 h-6"></i>
    </button>
    <button id="start-trip-floating-button" class="glass-surface glass-surface--svg rounded-full navigable grid-item" tabindex="0">
        <i data-lucide="map-pin" class="w-6 h-6"></i> بدء الرحلة
    </button>

    <!-- NEW: Minimized Video Button -->
    <button id="floating-minimized-video-button" class="navigable grid-item" tabindex="0">
        <i data-lucide="arrow-up-right" class="w-5 h-5 flex-shrink-0"></i>
        <span class="minimized-title">...</span>
    </button>

    <!-- NEW: Bottom Left Controls -->
    <div id="bottom-left-controls" class="fixed bottom-4 left-4 flex flex-row gap-2 z-[100] grid-container">
        <button id="pause-animation-button" class="glass-surface glass-surface--svg rounded-full p-3 navigable grid-item" tabindex="0" title="إيقاف/تشغيل الحركة">
            <i data-lucide="pause" class="w-5 h-5"></i>
            <i data-lucide="play" class="w-5 h-5 hidden"></i>
        </button>
        <button id="zoom-in-button" class="glass-surface glass-surface--svg rounded-full p-3 navigable grid-item" tabindex="0" title="تكبير">
            <i data-lucide="zoom-in" class="w-5 h-5"></i>
        </button>
        <button id="zoom-out-button" class="glass-surface glass-surface--svg rounded-full p-3 navigable grid-item" tabindex="0" title="تصغير">
            <i data-lucide="zoom-out" class="w-5 h-5"></i>
        </button>
        <button id="remove-cache-button" class="glass-surface glass-surface--svg rounded-full p-3 navigable grid-item" tabindex="0" title="مسح ذاكرة التخزين المؤقت">
            <i data-lucide="trash-2" class="w-5 h-5"></i>
        </button>
    </div>

    <!-- Video Pop-up Container -->
    <div id="video-popup-container">
        <div id="video-popup-player-container"></div>
        <div class="video-popup-controls grid-container">
            <button id="video-popup-close-button" title="إغلاق الفيديو" class="navigable grid-item" tabindex="0">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
    </div>

    <script>

// دالة جديدة لتحديث ودجت التاريخ الكامل في شاشة الحاسوب/التلفاز
function updateFullDateWidget() {
    const dateWidgetContainer = document.getElementById('full-date-widget-container');
    if (!dateWidgetContainer) return;

    const today = new Date();
    // نجعل السنة 2025 لتتوافق مع بيانات أوقات الصلاة لديك
    today.setFullYear(2025);

    const gregorianDate = new Intl.DateTimeFormat('ar-OM', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    }).format(today);

    const hijriDate = new Intl.DateTimeFormat('ar-OM-u-ca-islamic', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    }).format(today);

    dateWidgetContainer.innerHTML = `
        <p id="gregorian-date">${gregorianDate}</p>
        <p id="hijri-date">${hijriDate}</p>
    `;
}

// REPLACE the current displayLastWatchedVideo function with this one
async function displayLastWatchedVideo() {
    const lastWatchedContainer = document.getElementById('last-watched-container');
    const history = getWatchedHistory();
    
    // Sort by timestamp to show the most recently watched videos first
    const videoIds = Object.keys(history)
        .sort((a, b) => (history[b].lastWatchedTimestamp || 0) - (history[a].lastWatchedTimestamp || 0))
        .slice(0, 3);

    if (videoIds.length === 0) {
        lastWatchedContainer.classList.add('hidden');
        return;
    }

    try {
        const videoDetails = await fetchVideosDetails(videoIds);
        if (!videoDetails || videoDetails.length === 0) {
            lastWatchedContainer.classList.add('hidden');
            return;
        }

        // REVERSE the array so the most recent video is last in the list, ready to be scrolled to.
        videoDetails.reverse();

        const slidesHTML = videoDetails.map(video => {
            const videoData = {
                id: video.id,
                title: video.snippet.title,
                thumbnail: video.snippet.thumbnails.medium.url,
                channelTitle: video.snippet.channelTitle
            };
            const lastVideoInfo = history[videoData.id];
            const progressPercent = (lastVideoInfo && lastVideoInfo.progress > 0 && lastVideoInfo.duration > 0) 
                ? (lastVideoInfo.progress / lastVideoInfo.duration) * 100 
                : 0;

            return `
                <div class="last-watched-slide">
                    <div class="glass-surface glass-surface--svg p-3 rounded-2xl w-full">
                        <div class="flex items-center gap-4">
                            <img src="${videoData.thumbnail}" class="w-28 h-auto rounded-lg flex-shrink-0">
                            <div class="flex flex-col gap-2 flex-grow min-w-0">
                                <h3 class="font-bold text-lg leading-tight">${videoData.title}</h3>
                                <p class="text-sm text-white/70">${videoData.channelTitle}</p>
                                <div class="w-full bg-white/20 rounded-full h-1.5 mt-1">
                                    <div class="bg-red-500 h-1.5 rounded-full" style="width: ${progressPercent}%"></div>
                                </div>
                                <button class="resume-play-button self-start navigable grid-item" onclick="showVideoPopup('${videoData.id}')">
                                    <i data-lucide="play" class="w-4 h-4"></i>
                                    استئناف
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        const viewAllCardHTML = `
            <div class="last-watched-slide">
                <div class="glass-surface glass-surface--svg p-3 rounded-2xl w-full h-full flex flex-col items-center justify-center text-center cursor-pointer navigable grid-item" id="view-all-history-card">
                    <div class="w-16 h-16 rounded-full bg-white/10 flex items-center justify-center mb-3">
                        <i data-lucide="history" class="w-8 h-8 text-white"></i>
                    </div>
                    <h3 class="font-bold text-lg">عرض الكل</h3>
                    <p class="text-sm text-white/70">مشاهدة كل السجل</p>
                </div>
            </div>
        `;

        // Simplified structure for the new scroll-snap container
        lastWatchedContainer.innerHTML = `
            <h2 class="text-xl font-bold mb-3 text-white/90 text-center">متابعة المشاهدة</h2>
            <div class="last-watched-carousel-wrapper">
                 <div class="last-watched-slides-container">
                   
                     <div class="last-watched-slide">
                <div class="glass-surface glass-surface--svg p-3 rounded-2xl w-full h-full flex flex-col items-center justify-center text-center cursor-pointer navigable grid-item" id="istory-card">
                    <div class="w-16 h-16 rounded-full bg-white/10 flex items-center justify-center mb-3">
                       
                    </div>
                  
                </div>
            </div>
             ${slidesHTML}
             ${viewAllCardHTML}
                   
                </div>
                <button id="last-watched-prev" class="carousel-nav-button prev navigable grid-item" tabindex="0"><i data-lucide="chevron-left" class="w-8 h-8"></i></button>
                <button id="last-watched-next" class="carousel-nav-button next navigable grid-item" tabindex="0"><i data-lucide="chevron-right" class="w-8 h-8"></i></button>
            </div>
        `;

        

        lastWatchedContainer.classList.remove('hidden');
        lucide.createIcons();
        
        // NEW: Add event listener for the view all card
        const viewAllCard = document.getElementById('view-all-history-card');
        if (viewAllCard) {
            viewAllCard.addEventListener('click', showAllWatchedHistory);
        }
        
        // Scroll to the last item on load
        setTimeout(() => {
            const slidesContainer = document.querySelector('.last-watched-slides-container');
            if (slidesContainer) {
                // To show the last item (most recent) in an LTR container, scroll all the way to the right.
                slidesContainer.scrollLeft = slidesContainer.scrollWidth;
            }
        }, 0); // Use a timeout of 0 to run this after the browser has rendered the elements

        // NEW: Event listeners for carousel navigation
        const slidesContainer = lastWatchedContainer.querySelector('.last-watched-slides-container');
        const prevButton = lastWatchedContainer.querySelector('#last-watched-prev');
        const nextButton = lastWatchedContainer.querySelector('#last-watched-next');

        if (slidesContainer && prevButton && nextButton && slidesContainer.querySelector('.last-watched-slide')) {
            const scrollAmount = slidesContainer.querySelector('.last-watched-slide').offsetWidth + 16; // 16 is the gap

            prevButton.addEventListener('click', () => {
                slidesContainer.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
            });

            nextButton.addEventListener('click', () => {
                slidesContainer.scrollBy({ left: scrollAmount, behavior: 'smooth' });
            });
        }

    } catch (error) {
        console.error("Error fetching details for last watched videos:", error);
        lastWatchedContainer.classList.add('hidden');
    }
}

        // Initialize Lucide icons after they are loaded
        lucide.createIcons();

        // --- API Keys ---
        const YOUTUBE_API_KEY = 'AIzaSyBYThRM6tVnzgFgdHOUAN6DN8jQd54OKeg'; 
        const AI_ASSISTANT_API_KEY = 'AIzaSyBMmtON9ww4dJxMHrl1wKyWTvI0ipJXJws'; 
        const WEATHER_API_KEY = '7acefc26deee4904a2393917252207'; 
        const GOOGLE_MAPS_API_KEY = 'AIzaSyBRqAHJ2elbE_Z7NXXYC50XZpqi6HbG6Rk';

const JSONBIN_API_KEY = '$2a$10$SYrYv.ct8hiMU9YeUxEQ.ecRkOrTqs.TDchJRV3wW.aKJnDXy2oVy';
const JSONBIN_BIN_ID_REMINDERS = '68e3800cae596e708f07cf32';
const JSONBIN_ACCESS_KEY_REMINDERS = '$2a$10$J8o3WrPtnqmKAd///uDw6.BOWnGIBekHFOImbeEZZwsJ/h/XPbVUy';

// NEW: JSONBin IDs for Favorites
const JSONBIN_BIN_ID_FAV_M = '68e4ac20d0ea881f4098138c';
const JSONBIN_BIN_ID_FAV_D = '68e4ac2e43b1c97be95d24af';
let favoritesD = [];
let favoritesM = [];

        // NEW: Tarteel AI Channel ID
        const TARTEEL_CHANNEL_ID = 'UCr0J18R8lK0m7oK4eL0jXQg'; // @TarteelArabic channel ID
        const TARTEEL_CHANNEL_IMAGE = 'https://yt3.googleusercontent.com/pUYEmNtUgk7zmyKXVwzTyYCfli0AavVRgAomZITpyh3i6HT0mk35CCJv32Ra79-gKk276qSeYfw=s900-c-k-c0x00ffffff-no-rj';

        // --- Global App State Management ---
        let appState = {
            currentTime: '',
            mapLocation: { lat: 17.0151, lon: 54.0924, zoom: 17 },
            weather: { temperature: null, description: null, uvIndex: null, iconUrl: '', location: 'Salalah, Oman' },
            car: { speed: 0, rpm: 0, fuel: 0, temp: 0, gear: 'P', direction: '--' }, // Added direction
            prayerTimes: { Fajr: '--:--', Dhuhr: '--:--', Asr: '--:--', Maghrib: '--:--', Isha: '--:--', nextPrayer: null, nextPrayerIqamaTime: null, currentPrayer: null },
            hasShownGeolocationError: false,
            mapZoomChangedByUser: false,
            dashboardReturnCounter: 0,
            custom360Image: localStorage.getItem('custom360Image') || null,
            currentLocation: null,
            previousLocation: null, // For tracking movement
            destinationSet: false,
            isVideoPlayerMinimized: false // NEW state for minimized player
        };
        let googleMapsPromise = null;
        let currentFontSize = 16; // Base size in pixels
        const fontSizeStep = 1; // Change by 1px
        const maxFontSize = 20; // Max size (125%)
        const minFontSize = 12; // Min size (75%)

        // --- Home Locations ---
        // UPDATED: Coordinates for Home 1 and Home 2
        const HOME1_COORDS = { lat: 17.081667, lng: 54.159722 }; // 17°04'54.0"N 54°09'35.0"E
        const HOME2_COORDS = { lat: 17.048560, lng: 54.159616 };

        // --- DOM Element References ---
        const appButtons = document.querySelectorAll('button[data-app]');
        const appScreens = document.querySelectorAll('.app-screen');
        const sidebarIcons = document.querySelectorAll('.app-icon');
        const quranQuickAccess = document.getElementById('quran-quick-access');
        const youtubeSearchInput = document.getElementById('youtube-search-input');
        const youtubeSearchButton = document.getElementById('youtube-search-button');
        const youtubeSuggestionsDiv = document.getElementById('youtube-suggestions');
        const youtubeVideoListView = document.getElementById('youtube-video-list-view'); 
        const videoListContainer = document.getElementById('video-list-container'); 
        const youtubeSearchResultsView = document.getElementById('youtube-search-results-view');
        const searchResultsContainer = document.getElementById('search-results-container');
        const backToPlaylistsFromVideosButton = document.getElementById('back-to-playlists-from-videos'); 
        const backToPlaylistsBottomButton = document.getElementById('back-to-playlists-bottom-button');
        const backToPlaylistsBottomButtonSearch = document.getElementById('back-to-playlists-bottom-button-search');
        const previousItemButton = document.getElementById('previous-item-button');
        const nextItemButton = document.getElementById('next-item-button');
        const videoPopupContainer = document.getElementById('video-popup-container');
        const videoPopupPlayerContainer = document.getElementById('video-popup-player-container');
        const videoPopupCloseButton = document.getElementById('video-popup-close-button');
        const quranIframe = document.getElementById('quran-iframe');
        const floatingMediaButton = document.getElementById('floating-media-button');
        const floatingKeyboardButton = document.getElementById('floating-keyboard-button');
        const floatingMinimizedVideoButton = document.getElementById('floating-minimized-video-button');
        const backToSearchFloatingButton = document.getElementById('back-to-search-floating-button'); // NEW
        const clearSearchButton = document.getElementById('clear-search-button');
        const startTripFloatingButton = document.getElementById('start-trip-floating-button');
        const prayerTimesContainer = document.getElementById('prayer-times-container');
        const digitalHoursSpan = document.querySelector('#digital-time .hours');
        const digitalMinutesSpan = document.querySelector('#digital-time .minutes');
        const digitalSecondsSpan = document.querySelector('#digital-time .seconds');
        const digitalDateLine1 = document.getElementById('digital-date-line1');
        const digitalDateLine2 = document.getElementById('digital-date-line2');
        let dashboardGoogleMap, dashboardGoogleMarker, directionsService, directionsRenderer;
        let watchId;
        const getMyLocationButtonDashboard = document.getElementById('get-my-location-button-dashboard');
        const goToHome1Button = document.getElementById('go-to-home-1-button');
        const goToHome2Button = document.getElementById('go-to-home-2-button');
        const car360Image = document.getElementById('car-360-image');
        const upload360ImageInput = document.getElementById('upload-360-image-input');
        const upload360ImageButton = document.getElementById('upload-360-image-button');
        const reset360ImageButton = document.getElementById('reset-360-image-button');
        const carplayMainInterface = document.getElementById('carplay-main-interface');
        const pauseAnimationButton = document.getElementById('pause-animation-button');
        const zoomInButton = document.getElementById('zoom-in-button');
        const zoomOutButton = document.getElementById('zoom-out-button');
        const removeCacheButton = document.getElementById('remove-cache-button');
        const default360ImageSrc = "https://dmusera.netlify.app/es350gb.png";
        let currentPlayingPlaylistId = '', activeMediaView = 'suggestions', currentPlayingVideoId = '', selectedReaderName = '', popupPlayer, isYouTubeApiReady = false, searchMode = 'reciter_surah', progressInterval = null;
        let lastSuccessfulSearchQuery = null; // NEW: To store the last search query
        let initialLocationFetched = false;

        const juzArabicNames = ["الأول", "الثاني", "الثالث", "الرابع", "الخامس", "السادس", "السابع", "الثامن", "التاسع", "العاشر", "الحادي عشر", "الثاني عشر", "الثالث عشر", "الرابع عشر", "الخامس عشر", "السادس عشر", "السابع عشر", "الثامن عشر", "التاسع عشر", "العشرون", "الحادي والعشرون", "الثاني والعشرون", "الثالث والعشرون", "الرابع والعشرون", "الخامس والعشرون", "السادس والعشرون", "السابع والعشرون", "الثامن والعشرون", "التاسع والعشرون", "الثلاثون"];

        // --- Utility Functions ---
        function showMessageBox(message) { const box = document.createElement('div'); box.style.cssText = `position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0, 0, 0, 0.8); color: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.5); z-index: 1000; text-align: center; max-width: 80%; font-size: 1.1rem;`; box.innerHTML = `<p>${message}</p><button style="margin-top: 15px; padding: 8px 15px; background-color: #9333ea; border: none; border-radius: 5px; color: white; cursor: pointer;">إغلاق</button>`; document.body.appendChild(box); box.querySelector('button').addEventListener('click', () => document.body.removeChild(box)); }

        async function showAllWatchedHistory() {
            const history = getWatchedHistory();
            const videoIds = Object.keys(history)
                .sort((a, b) => (history[b].lastWatchedTimestamp || 0) - (history[a].lastWatchedTimestamp || 0));

            if (videoIds.length === 0) {
                showMessageBox('لا يوجد سجل مشاهدة.');
                return;
            }

            try {
                // Fetch details in chunks to avoid long URLs
                const allVideoDetails = [];
                for (let i = 0; i < videoIds.length; i += 50) {
                    const chunk = videoIds.slice(i, i + 50);
                    const details = await fetchVideosDetails(chunk);
                    if(details) {
                        allVideoDetails.push(...details);
                    }
                }
                
                if (allVideoDetails.length > 0) {
                    searchResultsContainer.innerHTML = '<h2 class="text-3xl font-bold mb-4 text-center w-full text-white col-span-full">سجل المشاهدة</h2>'; // Add a title
                    
                    // Sort details according to original sorted videoIds
                    const sortedDetails = allVideoDetails.sort((a, b) => {
                        const aTimestamp = history[a.id]?.lastWatchedTimestamp || 0;
                        const bTimestamp = history[b.id]?.lastWatchedTimestamp || 0;
                        return bTimestamp - aTimestamp;
                    });
                    
                    sortedDetails.forEach(video => {
                        const videoData = {
                            id: video.id,
                            title: video.snippet.title,
                            thumbnail: video.snippet.thumbnails.medium.url,
                            channelTitle: video.snippet.channelTitle,
                            viewCount: formatViewCount(video.statistics.viewCount),
                            publishedAt: formatTimeAgo(video.snippet.publishedAt),
                            duration: formatDuration(video.contentDetails.duration)
                        };
                        searchResultsContainer.appendChild(createVideoCard(videoData));
                    });

                    youtubeSuggestionsDiv.style.display = 'none';
                    youtubeVideoListView.classList.add('hidden');
                    youtubeSearchResultsView.classList.remove('hidden');
                    activeMediaView = 'searchResults'; // Reuse this view
                    backToPlaylistsBottomButton.style.display = 'none';
                    backToPlaylistsBottomButtonSearch.style.display = 'flex';
                    previousItemButton.style.display = 'none'; // No next/prev for history
                    nextItemButton.style.display = 'none';

                    lucide.createIcons();
                    updateNavigableElements();
                    setTimeout(() => {
                        const firstResult = searchResultsContainer.querySelector('.grid-item');
                        if (firstResult) setFocus(firstResult);
                    }, 100);
                } else {
                     showMessageBox('لا يوجد سجل مشاهدة.');
                }

            } catch (error) {
                console.error("Error fetching all history details:", error);
                showMessageBox('حدث خطأ أثناء تحميل سجل المشاهدة.');
            }
        }
        
        // --- NEW: Watched History Helpers ---
        function getWatchedHistory() {
            return JSON.parse(localStorage.getItem('youtubeWatchedHistory')) || {};
        }

        function updateVideoProgress(videoId, currentTime, duration) {
            if (!videoId || !duration) return;
            const history = getWatchedHistory();
            history[videoId] = { progress: currentTime, duration: duration, lastWatchedTimestamp: Date.now() };
            localStorage.setItem('youtubeWatchedHistory', JSON.stringify(history));
        }

        function markVideoAsWatched(videoId) {
            if (!videoId) return;
            const history = getWatchedHistory();
            // Using a special value to indicate fully watched
            history[videoId] = { progress: -1, duration: 1, lastWatchedTimestamp: Date.now() };
            localStorage.setItem('youtubeWatchedHistory', JSON.stringify(history));
            // Also update the card in the UI if it's visible
            const card = document.querySelector(`.youtube-video-card[data-video-id="${videoId}"]`);
            if(card) {
                // Remove progress bar if it exists
                const progressBar = card.querySelector('.watched-progress-bar-container');
                if(progressBar) progressBar.remove();
                // Add watched badge if it doesn't exist
                if(!card.querySelector('.watched-badge')) {
                    const badge = document.createElement('div');
                    badge.className = 'watched-badge';
                    badge.textContent = 'تمت المشاهدة';
                    card.querySelector('.thumbnail-container').appendChild(badge);
                }
            }
        }
        
        function updateUI() { 
            document.getElementById('dashboard-weather-temp').textContent = appState.weather.temperature !== null ? `${appState.weather.temperature.toFixed(1)}°C` : '--°C'; 
            document.getElementById('dashboard-weather-desc').textContent = appState.weather.description || '--'; 
            document.getElementById('dashboard-weather-icon').src = appState.weather.iconUrl || 'https://placehold.co/64x64/000000/FFFFFF?text=X'; 
            document.getElementById('dashboard-weather-location').textContent = appState.weather.location; 
            document.getElementById('3d-screen-weather-temp').textContent = appState.weather.temperature !== null ? `${appState.weather.temperature.toFixed(1)}°C` : '--°C';
            const uvEl = document.getElementById('weather-uv'); 
            if (uvEl) { uvEl.textContent = appState.weather.uvIndex !== null ? appState.weather.uvIndex : '--'; uvEl.style.color = getUvIndexColor(appState.weather.uvIndex); } 
            car360Image.src = appState.custom360Image || default360ImageSrc; 
            startTripFloatingButton.style.display = appState.destinationSet ? 'flex' : 'none'; 
        }

        // --- App Switching and Navigation Logic ---
        const appOrder = ['Dashboard', 'Media', 'Radio', 'Athkar', 'Reciters', 'Weather', 'Map', 'Quran'];
        let currentAppIndex = 0;

        function switchApp(appName) {
            const newIndex = appOrder.indexOf(appName);
            if (newIndex === -1) return;
            currentAppIndex = newIndex;

            appScreens.forEach(s => s.classList.remove('active'));
            sidebarIcons.forEach(i => i.classList.remove('active'));
            const screen = document.getElementById(`screen-${appName}`);
            if (screen) screen.classList.add('active');
            const icon = document.querySelector(`.app-icon[data-app="${appName}"]`);
            if (icon) icon.classList.add('active');

            if (appName === 'Dashboard' && appState.mapZoomChangedByUser) {
                appState.dashboardReturnCounter++;
                if (appState.dashboardReturnCounter >= 2 && dashboardGoogleMap) {
                    dashboardGoogleMap.setZoom(appState.mapLocation.zoom);
                    appState.mapZoomChangedByUser = false;
                    appState.dashboardReturnCounter = 0;
                    showMessageBox('تم إعادة تعيين تكبير الخريطة إلى الافتراضي.');
                }
            } else if (appName !== 'Dashboard' && !appState.mapZoomChangedByUser) {
                appState.dashboardReturnCounter = 0;
            }
            handleMediaViewSwitch(appName);
            quranQuickAccess.style.display = (appName === 'Quran') ? 'flex' : 'none';
            startTripFloatingButton.style.display = (appName === 'Map' && appState.destinationSet) ? 'flex' : 'none';
            if (document.activeElement && document.activeElement.closest('nav')) {
                setTimeout(() => {
                    const firstItem = screen.querySelector('.grid-item');
                    if (firstItem) setFocus(firstItem);
                }, 100);
            }
        }

        function navigateToNextApp() {
            currentAppIndex = (currentAppIndex + 1) % appOrder.length;
            switchApp(appOrder[currentAppIndex]);
        }

        function navigateToPrevApp() {
            currentAppIndex = (currentAppIndex - 1 + appOrder.length) % appOrder.length;
            switchApp(appOrder[currentAppIndex]);
        }

        function handleMediaViewSwitch(appName) {
            floatingMediaButton.style.display = (appName === 'Media') ? 'none' : 'flex';
            floatingKeyboardButton.style.display = (appName === 'Media') ? 'flex' : 'none';
            clearSearchButton.style.display = (appName === 'Media') ? 'flex' : 'none';
            
            if (appName === 'Media') {
                floatingKeyboardButton.classList.toggle('active-keyboard', !youtubeSearchInput.readOnly);
                floatingKeyboardButton.classList.toggle('inactive-keyboard', youtubeSearchInput.readOnly);
                
                // Logic to show the correct view
                youtubeVideoListView.classList.add('hidden');
                youtubeSearchResultsView.classList.add('hidden');
                youtubeSuggestionsDiv.style.display = 'flex'; // Make suggestions visible

                if (activeMediaView === 'videoList' && currentPlayingPlaylistId) {
                    youtubeVideoListView.classList.remove('hidden');
                } else if (activeMediaView === 'searchResults') {
                    youtubeSearchResultsView.classList.remove('hidden');
                } else {
                    // Default to suggestions view
                    resetYoutubeSearchUI();
                }
            } else {
                 youtubeSuggestionsDiv.style.display = 'none';
            }
        }
        appButtons.forEach(b => b.addEventListener('click', () => switchApp(b.dataset.app)));
        sidebarIcons.forEach(el => el.classList.add('w-16', 'h-16', 'rounded-2xl', 'flex', 'items-center', 'justify-center', 'transition-all', 'duration-300', 'ease-in-out'));
        
        // --- YouTube/Media Functions (REFACTORED) ---
        function onYouTubeIframeAPIReady() { isYouTubeApiReady = true; }
        
        function createVideoCard(video) {
            const card = document.createElement('div');
            card.className = 'glass-surface glass-surface--svg youtube-video-card navigable grid-item';
            card.tabIndex = 0;
            card.dataset.videoId = video.id;

            // Get watched history for this video
            const history = getWatchedHistory();
            const watchedInfo = history[video.id];
            let progressHTML = '';

            if (watchedInfo) {
                if (watchedInfo.progress === -1) { // Fully watched
                    progressHTML = `<div class="watched-badge">تمت المشاهدة</div>`;
                } else if (watchedInfo.progress > 0 && watchedInfo.duration > 0) {
                    const progressPercent = (watchedInfo.progress / watchedInfo.duration) * 100;
                    progressHTML = `<div class="watched-progress-bar-container"><div class="watched-progress-bar" style="width: ${progressPercent}%"></div></div>`;
                }
            }
            
            const isSavedD = favoritesD.some(fav => fav.id === video.id);
            const isSavedM = favoritesM.some(fav => fav.id === video.id);
            let bookmarkClass = '';
            if (isSavedD && isSavedM) bookmarkClass = 'saved-both';
            else if (isSavedD) bookmarkClass = 'saved-d';
            else if (isSavedM) bookmarkClass = 'saved-m';

            card.innerHTML = `
                <div class="video-details">
                    <h3 class="video-title">${video.title}</h3>
                    <div class="video-meta">
                        <span>${video.channelTitle}</span>
                        <span>${video.viewCount} مشاهدة • ${video.publishedAt}</span>
                    </div>
                </div>
                <div class="thumbnail-container relative">
                    <img src="${video.thumbnail}" alt="${video.title}" class="w-[180px] h-[101.25px] object-cover rounded-md ml-4 flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/180x101';">
                    <span class="video-duration">${video.duration}</span>
                    ${progressHTML}
                    <button class="bookmark-button ${bookmarkClass}" data-video-id="${video.id}"><i data-lucide="bookmark" class="w-5 h-5"></i></button>
                </div>
            `;
            card.addEventListener('click', () => showVideoPopup(video.id));
             card.querySelector('.bookmark-button').addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent card click event from firing
                showFavoritesMenu(e.currentTarget, video);
            });
            return card;
        }

        async function fetchVideosDetails(videoIds) {
            const response = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails,statistics&id=${videoIds.join(',')}&key=${YOUTUBE_API_KEY}`);
            const data = await response.json();
            return data.items;
        }

        function formatDuration(isoDuration) {
            const regex = /PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/;
            const matches = isoDuration.match(regex);
            const hours = matches[1] ? parseInt(matches[1]) : 0;
            const minutes = matches[2] ? parseInt(matches[2]) : 0;
            const seconds = matches[3] ? parseInt(matches[3]) : 0;
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function formatViewCount(views) {
            if (views >= 1000000) return `${(views / 1000000).toFixed(1)} مليون`;
            if (views >= 1000) return `${(views / 1000).toFixed(0)} ألف`;
            return views;
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return `قبل ${Math.floor(interval)} سنوات`;
            interval = seconds / 2592000;
            if (interval > 1) return `قبل ${Math.floor(interval)} أشهر`;
            interval = seconds / 86400;
            if (interval > 1) return `قبل ${Math.floor(interval)} أيام`;
            interval = seconds / 3600;
            if (interval > 1) return `قبل ${Math.floor(interval)} ساعات`;
            interval = seconds / 60;
            if (interval > 1) return `قبل ${Math.floor(interval)} دقائق`;
            return `قبل ${Math.floor(seconds)} ثوان`;
        }
        
        async function searchYouTubeVideos(query) {
            if (YOUTUBE_API_KEY.startsWith('YOUR_')) return showMessageBox('خطأ: لم يتم تعيين مفتاح YouTube API.');
            try {
                const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&key=${YOUTUBE_API_KEY}&maxResults=50`);
                const data = await res.json();
                if (data.items && data.items.length > 0) {
                    const videoIds = data.items.map(item => item.id.videoId);
                    const videoDetails = await fetchVideosDetails(videoIds);
                    
                    lastSuccessfulSearchQuery = query; // NEW: Save the last successful query
                    searchResultsContainer.innerHTML = '';
                    videoDetails.forEach(video => {
                        const durationSeconds = video.contentDetails.duration.match(/\d+/g).map(Number).reduce((acc, time, i, arr) => acc + time * (arr.length === 3 ? [3600, 60, 1][i] : (arr.length === 2 ? [60, 1][i] : 1)), 0);
                        if (durationSeconds <= 61) return;

                        const videoData = {
                            id: video.id,
                            title: video.snippet.title,
                            thumbnail: video.snippet.thumbnails.medium.url,
                            channelTitle: video.snippet.channelTitle,
                            viewCount: formatViewCount(video.statistics.viewCount),
                            publishedAt: formatTimeAgo(video.snippet.publishedAt),
                            duration: formatDuration(video.contentDetails.duration)
                        };
                        searchResultsContainer.appendChild(createVideoCard(videoData));
                    });
                    
                    youtubeSuggestionsDiv.style.display = 'none';
                    youtubeVideoListView.classList.add('hidden');
                    youtubeSearchResultsView.classList.remove('hidden');
                    activeMediaView = 'searchResults';
                    backToPlaylistsBottomButton.style.display = 'none';
                    backToPlaylistsBottomButtonSearch.style.display = 'flex';
                    backToSearchFloatingButton.style.display = 'flex'; // NEW: Show the floating button
                    // The back button is now inside a container, so we don't hide/show it directly
                    updateNavigationButtons(query); // NEW: Update navigation buttons
                    setTimeout(() => { const firstResult = searchResultsContainer.querySelector('.grid-item'); if (firstResult) setFocus(firstResult); }, 100);
                } else {
                    showMessageBox('لم يتم العثور على نتائج بحث لـ: ' + query);
                }
            } catch (err) {
                console.error('Error searching YouTube videos:', err);
                showMessageBox('حدث خطأ أثناء البحث في يوتيوب.');
            }
        }
        
        function showVideoPopup(videoId, startOverride = null) {
            const start = startOverride !== null ? startOverride : (() => {
                const history = getWatchedHistory();
                const watchedInfo = history[videoId];
                // إذا كان المستخدم قد شاهد أكثر من 5 ثوانٍ، استأنف التشغيل، وإلا ابدأ من الصفر
                return (watchedInfo && watchedInfo.progress > 5) ? watchedInfo.progress : 0;
            })();
    
            // UPDATED: Pause background animations and update control button icon
            document.body.classList.add('animation-paused');
            const playIcon = pauseAnimationButton.querySelector('[data-lucide="play"]');
            const pauseIcon = pauseAnimationButton.querySelector('[data-lucide="pause"]');
            if (playIcon && pauseIcon) {
                playIcon.classList.remove('hidden'); // Show play icon (indicating animations are paused)
                pauseIcon.classList.add('hidden');
            }

            if (!isYouTubeApiReady) return setTimeout(() => showVideoPopup(videoId, start), 100);
            currentPlayingVideoId = videoId;
            videoPopupContainer.style.display = 'flex'; // Ensure it's visible
            videoPopupContainer.classList.add('active');
            // Hide the minimized button when showing the main player
            floatingMinimizedVideoButton.style.display = 'none';
            appState.isVideoPlayerMinimized = false;
            if (popupPlayer) {
                popupPlayer.loadVideoById({ videoId, startSeconds: start });
            } else {
                videoPopupPlayerContainer.innerHTML = '<div id="video-popup-player"></div>';
                popupPlayer = new YT.Player('video-popup-player', {
                    height: '100%', width: '100%', videoId,
                    playerVars: { 
                        'autoplay': 1, 
                        'controls': 1, 
                        'start': Math.floor(start),
                        'origin': 'https://dmusera.netlify.app'
                    },
                    events: { 
                        'onReady': (e) => e.target.playVideo(),
                        'onStateChange': onPlayerStateChange 
                    }
                });
            }
            setTimeout(() => setFocus(videoPopupCloseButton), 100);
        }

        function hideVideoPopup() {
            if (progressInterval) clearInterval(progressInterval); // Stop tracking progress
            
            // UPDATED: Resume background animations and update control button icon
            document.body.classList.remove('animation-paused');
            const playIcon = pauseAnimationButton.querySelector('[data-lucide="play"]');
            const pauseIcon = pauseAnimationButton.querySelector('[data-lucide="pause"]');
            if (playIcon && pauseIcon) {
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden'); // Show pause icon (indicating animations are playing)
            }

            if (popupPlayer?.stopVideo) popupPlayer.stopVideo();
            videoPopupContainer.classList.remove('active');
            videoPopupContainer.style.display = 'none'; // Also hide with style
            // Ensure the minimized button is also hidden when fully closing
            floatingMinimizedVideoButton.style.display = 'none';
            appState.isVideoPlayerMinimized = false;
            const screen = document.querySelector('.app-screen.active');
            if (screen) {
                const item = screen.querySelector('.grid-item');
                if (item) setFocus(item);
            }
        }
        
        // NEW: Functions to minimize and restore the video popup
        function minimizeVideoPopup() {
            if (!videoPopupContainer.classList.contains('active')) return;
            videoPopupContainer.style.display = 'none';
            floatingMinimizedVideoButton.style.display = 'flex';
            
            const videoData = popupPlayer.getVideoData();
            const titleElement = floatingMinimizedVideoButton.querySelector('.minimized-title');
            if(titleElement) titleElement.textContent = videoData.title || '...';

            appState.isVideoPlayerMinimized = true;
            // Focus the restore button for accessibility
            setFocus(floatingMinimizedVideoButton);
        }

        function restoreVideoPopup() {
            if (!appState.isVideoPlayerMinimized) return;
            videoPopupContainer.style.display = 'flex';
            floatingMinimizedVideoButton.style.display = 'none';
            appState.isVideoPlayerMinimized = false;
             // Return focus to the close button inside the player
            setFocus(videoPopupCloseButton);
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                // When video starts playing, set quality to 144p ('tiny')
                popupPlayer.setPlaybackQuality('tiny');

                // Start tracking progress
                progressInterval = setInterval(() => {
                    const videoId = popupPlayer.getVideoData().video_id;
                    const currentTime = popupPlayer.getCurrentTime();
                    const duration = popupPlayer.getDuration();
                    updateVideoProgress(videoId, currentTime, duration);
                }, 5000); // Save progress every 5 seconds

            } else if (event.data == YT.PlayerState.ENDED) {
                if (progressInterval) clearInterval(progressInterval);
                const videoId = popupPlayer.getVideoData().video_id;
                markVideoAsWatched(videoId);
            } else {
                 if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
            }
        }

        function handleFullScreenChange() {
            if (popupPlayer && typeof popupPlayer.getPlayerState === 'function' && popupPlayer.getPlayerState() === YT.PlayerState.PLAYING) {
                const isFullScreen = document.fullscreenElement === popupPlayer.getIframe() || document.webkitFullscreenElement === popupPlayer.getIframe();
                if (isFullScreen) {
                    popupPlayer.setPlaybackQuality('hd720');
                } else {
                    popupPlayer.setPlaybackQuality('large'); // 'large' for 480p
                }
            }
        }

        // This function is duplicated, removing one instance.
        
        // NEW: Function to handle next/previous navigation buttons
        function updateNavigationButtons(currentQuery) {
            // Reset and hide buttons by default
            previousItemButton.style.display = 'none';
            nextItemButton.style.display = 'none';
            previousItemButton.onclick = null;
            nextItemButton.onclick = null;

            // --- Case 1: Surah Navigation ---
            const surahMatch = currentQuery.match(/سورة (.+)/);
            if (surahMatch && surahMatch[1]) {
                const currentSurah = surahMatch[1].trim();
                const currentIndex = youtubeSurahSuggestions.indexOf(currentSurah);

                if (currentIndex !== -1) {
                    const baseQuery = currentQuery.substring(0, currentQuery.indexOf('سورة'));

                    // Previous Surah Button
                    if (currentIndex > 0) {
                        const prevSurah = youtubeSurahSuggestions[currentIndex - 1];
                        previousItemButton.innerHTML = `<i data-lucide="arrow-left"></i> ${prevSurah}`;
                        previousItemButton.style.display = 'flex';
                        previousItemButton.onclick = () => searchYouTubeVideos(`${baseQuery} سورة ${prevSurah}`);
                    }

                    // Next Surah Button
                    if (currentIndex < youtubeSurahSuggestions.length - 1) {
                        const nextSurah = youtubeSurahSuggestions[currentIndex + 1];
                        nextItemButton.innerHTML = `${nextSurah} <i data-lucide="arrow-right"></i>`;
                        nextItemButton.style.display = 'flex';
                        nextItemButton.onclick = () => searchYouTubeVideos(`${baseQuery} سورة ${nextSurah}`);
                    }
                    lucide.createIcons();
                    return;
                }
            }

            // --- Case 2: Juz Navigation ---
            const juzMatch = currentQuery.match(/الجزء (.+)/);
            if (juzMatch && juzMatch[1]) {
                const currentJuz = juzMatch[1].trim();
                const currentIndex = juzArabicNames.indexOf(currentJuz);

                if (currentIndex !== -1) {
                    const baseQuery = currentQuery.substring(0, currentQuery.indexOf('الجزء')).trim();

                    // Previous Juz Button
                    if (currentIndex > 0) {
                        const prevJuz = juzArabicNames[currentIndex - 1];
                        previousItemButton.innerHTML = `<i data-lucide="arrow-left"></i> الجزء ${prevJuz}`;
                        previousItemButton.style.display = 'flex';
                        previousItemButton.onclick = () => searchYouTubeVideos(`${baseQuery} الجزء ${prevJuz}`.trim());
                    }

                    // Next Juz Button
                    if (currentIndex < juzArabicNames.length - 1) {
                        const nextJuz = juzArabicNames[currentIndex + 1];
                        nextItemButton.innerHTML = `الجزء ${nextJuz} <i data-lucide="arrow-right"></i>`;
                        nextItemButton.style.display = 'flex';
                        nextItemButton.onclick = () => searchYouTubeVideos(`${baseQuery} الجزء ${nextJuz}`.trim());
                    }
                    lucide.createIcons();
                    return;
                }
            }

            // --- Case 3: Reciter-Only Navigation ---
            const reciters = youtubeReaderSuggestions.filter(r => r.name !== "ربط الآيات").map(r => r.name);
            const reciterIndex = reciters.indexOf(currentQuery.trim());

            if (reciterIndex !== -1) {
                // Previous Reciter Button
                if (reciterIndex > 0) {
                    const prevReciter = reciters[reciterIndex - 1];
                    previousItemButton.innerHTML = `<i data-lucide="arrow-left"></i> ${prevReciter}`;
                    previousItemButton.style.display = 'flex';
                    previousItemButton.onclick = () => {
                        searchMode = 'reciter_only'; // Preserve mode
                        searchYouTubeVideos(prevReciter);
                    };
                }

                // Next Reciter Button
                if (reciterIndex < reciters.length - 1) {
                    const nextReciter = reciters[reciterIndex + 1];
                    nextItemButton.innerHTML = `${nextReciter} <i data-lucide="arrow-right"></i>`;
                    nextItemButton.style.display = 'flex';
                    nextItemButton.onclick = () => {
                        searchMode = 'reciter_only'; // Preserve mode
                        searchYouTubeVideos(nextReciter);
                    };
                }
                lucide.createIcons();
                return;
            }
        }

         const youtubeReaderSuggestions = [             {"name":"الرقية", "image":"https://imgs.search.brave.com/afZfY6pdMu-EfuTtrt2hNKEW9TsUAnPOX2QnIlIFi1c/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9jZG4u/YXJhYnNzdG9jay5j/b20vdXBsb2Fkcy92/ZWN0b3JzLzIzMDQx/L3J1cWF5YS1hbi1h/cmFiaWMtbmFtZS1m/b3ItcHJldmlldy0y/MzA0MS53ZWJw"},
{"name":"محمد ايوب","image":"https://dmusera.netlify.app/512px-Muhammad_Ayyub.webp"},{"name":"علي جابر","image":"https://dmusera.netlify.app/ali-jaber.webp"},{"name":"محمد الغزالي","image":"https://imgs.search.brave.com/QWUpKrFCLEvXilcNhgSRM6xKPjTlBtGA-BAsH9sN-Tc/rs:fit:200:200:1:0/g:ce/aHR0cHM6Ly9hci5p/c2xhbXdheS5uZXQv/dXBsb2Fkcy9hdXRo/b3JzLzUwNjEuanBn"},{"name":"مشاري العفاسي","image":"https://dmusera.netlify.app/512px-%D0%9C%D0%B8%D1%88%D0%B0%D1%80%D0%B8_%D0%A0%D0%B0%D1%88%D0%B8%D0%B4.webp"},{"name":"عبدالله القرافي","image":"https://yt3.googleusercontent.com/mHTg3RIX-a3NAR22lAnOvSq3-U_KBcL_Ax4FTNirc3flsb5OU8RWksKu6X8Ush9JhO0EOxxAwQY=s160-c-k-c0x00ffffff-no-rj"},{"name":"اسلام صبحي","image":"https://imgs.search.brave.com/Sq4qNywnl1HmDjSuxWTshlQ8yV9fplcVnUoiErGC-38/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9tZWRp/YS51bml0ZWRtdXNs/aW13b3JsZC5jb20v/aW1nLzIzLzEyLzIz/LzEyNDk1LmpwZw"},{"name":"احمد النفيس","image":"https://dmusera.netlify.app/ahmednafes.jpg"},{"name":"ياسر الدوسري","image":"https://dmusera.netlify.app/Yasser_Al-Dosari.jpg"},
{"name":"ربط الآيات","image":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PHBhdGggZD0iTTEwIDEzYTUgNSAwIDAgMCA3LjU0LjU0bD MtM2E1IDUgMCAwIDAtNy4wNy03LjA3bC0xLjcyIDEuNzIiLz48cGF0aCBkPSJNMTQgMTFhNSA1IDAgMCAwLTcuNTQtLjU0bC0zIDNhNSA1IDAgMCAwIDcuMDcgNy4wN2wxLjcyLTEuNzIiLz48L3N2Zz4="}, {"name":"ربط الآيات","image":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PHBhdGggZD0iTTEwIDEzYTUgNSAwIDAgMCA3LjU0LjU0bDMtM2E1IDUgMCAwIDAtNy4wNy03LjA3bC0xLjcyIDEuNzIiLz48cGF0aCBkPSJNMTQgMTFhNSA1IDAgMCAwLTcuNTQtLjU0bC0zIDNhNSA1IDAgMCAwIDcuMDcgNy4wN2wxLjcyLTEuNzIiLz48L3N2Zz4="}
        ];
        const youtubeReaderSuggestions2 = [             {"name":"الرقية", "image":"https://imgs.search.brave.com/afZfY6pdMu-EfuTtrt2hNKEW9TsUAnPOX2QnIlIFi1c/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9jZG4u/YXJhYnNzdG9jay5j/b20vdXBsb2Fkcy92/ZWN0b3JzLzIzMDQx/L3J1cWF5YS1hbi1h/cmFiaWMtbmFtZS1m/b3ItcHJldmlldy0y/MzA0MS53ZWJw"}, {"name":"محفوف -BYMAHFOOF", "image":"https://yt3.googleusercontent.com/obc8dOfYmoZe50tvHCJNZgbLAnJAKb-YPSUnguahWqJ-Jm12At_lV8CjfPPuhAsM9i2K26QK=s160-c-k-c0x00ffffff-no-rj"},{"name":"مزامير الفرقان - ياسر الدوسري","image":"https://yt3.googleusercontent.com/ATOVX4RIsbt20_VS0Ly0bNkm5NPCoseg-S28jEEFsMBhHxBRUGXWW1dFOSuKG5p1_Sx8C8fMqFs=s160-c-k-c0x00ffffff-no-rj"},{"name":"عبدالله الشحري","image":"https://yt3.ggpht.com/KZblM_WDIfUaDyB0wmNZOfVDogOhHThprmFyzLL3AkvnLcKqFmhoJ00nsKHKCXizM94hGy1DSdo=s176-c-k-c0x00ffffff-no-rj-mo"},
           {"name":"ترتيل-@TarteelArabic","image":"https://yt3.googleusercontent.com/pUYEmNtUgk7zmyKXVwzTyYCfli0AavVRgAomZITpyh3i6HT0mk35CCJv32Ra79-gKk276qSeYfw=s900-c-k-c0x00ffffff-no-rj"},
             {"name":"قناة اخضر", "image":"https://yt3.ggpht.com/CNJHtl9UOLJwzpGI6_8meaFK6-nWkaXABqu4cXfx2oZnTZmvYgHANXoOY-IpGlNk2U9I5nbIX9I=s176-c-k-c0x00ffffff-no-rj-mo"},
            {"name":"اذاعة مختلف", "image":"https://yt3.ggpht.com/73c3-iw_Lubnz8tI6uxN17s1p8kOvwwsF5tatPe3JYAw_SRKeJfjprdH2wxHGPz3UHBM9NDxzs0=s176-c-k-c0x00ffffff-no-rj-mo"},
            {"name":"Qtratel", "image":"https://yt3.googleusercontent.com/4op5oT580d20t3w4i4dWjZmfT1YkVSDok-MVlx-c1--EaYt-wZuw1tebFOc-iQ_XRMfUIO0gYA=s160-c-k-c0x00ffffff-no-rj"},
             {"name":"Mohamed abubakr", "image":"https://yt3.ggpht.com/yp7xPPh1JotsxKkOMos1KWumw7UFFibydMnoPzhP100gsUGWnDXRTAhdV88gd6coAPkXQ5n1Rw=s176-c-k-c0x00ffffff-no-rj-mo"},
            {"name":"بودكاست", "image":"https://yt3.googleusercontent.com/0Vs32Zwp0qjXovZuV0kCCxCkKkCdTpAn_9_tky7mxQUM69EIrWK_oJawKy_fKpzL1KZN0LG7=s160-c-k-c0x00ffffff-no-rj"},
            {"name":"ربط الآيات","image":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PHBhdGggZD0iTTEwIDEzYTUgNSAwIDAgMCA3LjU0LjU0bDMtM2E1IDUgMCAwIDAtNy4wNy03LjA3bC0xLjcyIDEuNzIiLz48cGF0aCBkPSJNMTQgMTFhNSA1IDAgMCAwLTcuNTQtLjU0bC0zIDNhNSA1IDAgMCAwIDcuMDcgNy4wN2wxLjcyLTEuNzIiLz48L3N2Zz4="}
        ];
        
        const youtubeSurahSuggestions = ["الفاتحة","البقرة","آل عمران","النساء","المائدة","الأنعام","الأعراف","الأنفال","التوبة","يونس","هود","يوسف","الرعد","إبراهيم","الحجر","النحل","الإسراء","الكهف","مريم","طه","الأنبياء","الحج","المؤمنون","النور","الفرقان","الشعراء","النمل","القصص","العنكبوت","الروم","لقمان","السجدة","الأحزاب","سبأ","فاطر","يس","الصافات","ص","الزمر","غافر","فصلت","الشورى","الزخرف","الدخان","الجاثية","الأحقاف","محمد","الفتح","الحجرات","ق","الذاريات","الطور","النجم","القمر","الرحمن","الواقعة","الحديد","المجادلة","الحشر","الممتحنة","الصف","الجمعة","المنافقون","التغابن","الطلاق","التحريم","الملك","القلم","الحاقة","المعارج","نوح","الجن","المزمل","المدثر","القيامة","الإنسان","المرسلات","النبأ","النازعات","عبس","التكوير","الانفطار","الانشقاق","المطففين","البروج","الطارق","الأعلى"];
        const surahToJuzMap = {"الفاتحة":1,"البقرة":1,"آل عمران":3,"النساء":4,"المائدة":6,"الأنعام":7,"الأعراف":8,"الأنفال":9,"التوبة":10,"يونس":11,"هود":11,"يوسف":12,"الرعد":13,"إبراهيم":13,"الحجر":14,"النحل":14,"الإسراء":15,"الكهف":15,"مريم":16,"طه":16,"الأنبياء":17,"الحج":17,"المؤمنون":18,"النور":18,"الفرقان":18,"الشعراء":19,"النمل":19,"القصص":20,"العنكبوت":20,"الروم":21,"لقمان":21,"السجدة":21,"الأحزاب":21,"سبأ":22,"فاطر":22,"يس":22,"الصافات":23,"ص":23,"الزمر":23,"غافر":24,"فصلت":24,"الشورى":25,"الزخرف":25,"الدخان":25,"الجاثية":25,"الأحقاف":26,"محمد":26,"الفتح":26,"الحجرات":26,"ق":26,"الذاريات":27,"الطور":27,"النجم":27,"القمر":27,"الرحمن":27,"الواقعة":27,"الحديد":27,"المجادلة":28,"الحشر":28,"الممتحنة":28,"الصف":28,"الجمعة":28,"المنافقون":28,"التغابن":28,"الطلاق":28,"التحريم":28,"الملك":29,"القلم":29,"الحاقة":29,"المعارج":29,"نوح":29,"الجن":29,"المزمل":29,"المدثر":29,"القيامة":29,"الإنسان":29,"المرسلات":29,"النبأ":30,"النازعات":30,"عبس":30,"التكوير":30,"الانفطار":30,"الانشقاق":30,"المطففين":30,"البروج":30,"الطارق":30,"الأعلى":30};
        const juzColors =  [
  // 🔵 Blues
  "#2563eb", // Strong Blue
  "#3b82f6", // Blue
  "#0ea5e9", // Sky Blue
  "#0891b2", // Deep Cyan
  "#06b6d4", // Cyan
  "#14b8a6", // Teal
  "#0d9488", // Dark Teal

  // 🟣 Purples / Violets
  "#6366f1", // Indigo
  "#4f46e5", // Deep Indigo
  "#6d28d9", // Royal Violet
  "#8b5cf6", // Violet
  "#a855f7", // Purple
  "#9333ea", // Electric Purple
  "#c026d3", // Magenta
  "#d946ef", // Fuchsia

  // 🌸 Pinks / Rose
  "#ec4899", // Pink
  "#be185d", // Dark Pink
  "#f43f5e", // Rose
  "#fb7185", // Coral

  // 🔴 Reds
  "#ef4444", // Red
  "#dc2626", // Crimson

  // 🟠 Oranges
  "#ea580c", // Burnt Orange
  "#f97316", // Orange

  // 🟡 Yellows / Gold
  "#f59e0b", // Amber
  "#139c7e", // tealy
  "#c99716", // Gold
  "#7a6510", // dark gold
  "#ca8a04", // Dark Mustard

  // 🟢 Greens
  "#22c55e", // Green
  "#16a34a", // Strong Green
  "#10b981", // Emerald
  "#059669", // Dark Emerald

  // ⚫ Dark / Neutral
  "#1e293b", // Slate Dark
];
        function resetYoutubeSearchUI() {
            const suggestionsContent = document.getElementById('suggestions-content');
            if (suggestionsContent) {
                suggestionsContent.innerHTML = ''; // Clear old suggestions
                suggestionsContent.classList.remove('hidden'); //  تأكد من إظهاره مجدداً
            }
            
            // إصلاح: إزالة قسم السور بشكل صريح إذا كان موجوداً
            const existingSurahSection = document.getElementById('youtube-surah-section');
            if (existingSurahSection) {
                existingSurahSection.remove();
            }
            
            youtubeSuggestionsDiv.style.display = 'flex';
            selectedReaderName = '';
            youtubeSearchInput.value = '';

            if (lastSuccessfulSearchQuery) {
                backToSearchFloatingButton.style.display = 'flex';
            } else {
                backToSearchFloatingButton.style.display = 'none';
            }

            displayLastWatchedVideo(); // This will populate #last-watched-container
            populateYoutubeSuggestions(); // This will populate #suggestions-content
        }
        
        function handleReaderOrToolClick(selection, tabContainer, tabsContentContainer) {
            if (selection === "الكلمات الصعبة في") {
                selectedReaderName = ''; // Clear reader name
                youtubeSearchInput.value = 'الكلمات الصعبة في ';
            } else if (selection === "JUST_SURAH") {
                selectedReaderName = ''; 
                youtubeSearchInput.value = '';
            } else {
                selectedReaderName = selection;
                youtubeSearchInput.value = selection + ' ';
            }

            // Hide the tabs and show surahs
            tabContainer.style.display = 'none';
            tabsContentContainer.style.display = 'none';
            showSurahSuggestions();
            setTimeout(() => {
                const firstSurahButton = document.querySelector('#youtube-surah-section .grid-item');
                if (firstSurahButton) setFocus(firstSurahButton);
            }, 100);
        }



        function populateYoutubeSuggestions() {
            const suggestionsContent = document.getElementById('suggestions-content');
            if (!suggestionsContent) return;
            suggestionsContent.innerHTML = '';
            suggestionsContent.className = 'flex flex-col gap-4 w-full'; 

            // 1. Create Tab Structure
            const tabContainer = document.createElement('div');
            tabContainer.className = 'tabs-container flex p-1 rounded-full bg-black/20 self-center';

            const recitersTabButton = document.createElement('button');
            recitersTabButton.id = 'tab-reciters';
            recitersTabButton.className = 'tab-button navigable grid-item';
            recitersTabButton.tabIndex = 0;
            recitersTabButton.textContent = 'القراء';

            const channTabButton = document.createElement('button');
            channTabButton.id = 'tab-channels';
            channTabButton.className = 'tab-button navigable grid-item';
            channTabButton.tabIndex = 0;
            channTabButton.textContent = 'قنوات';

            // NEW: Tarteel AI Tab Button
            const tarteelTabButton = document.createElement('button');
            tarteelTabButton.id = 'tab-tarteel';
            tarteelTabButton.className = 'tab-button navigable grid-item';
            tarteelTabButton.tabIndex = 0;
            tarteelTabButton.textContent = 'ترتيل-@TarteelArabic';

            const toolsTabButton = document.createElement('button');
            toolsTabButton.id = 'tab-tools';
            toolsTabButton.className = 'tab-button navigable grid-item';
            toolsTabButton.tabIndex = 0;
            toolsTabButton.textContent = 'أدوات';

            const savedTabButton = document.createElement('button');
            savedTabButton.id = 'tab-saved';
            savedTabButton.className = 'tab-button navigable grid-item';
            savedTabButton.tabIndex = 0;
            savedTabButton.textContent = 'الفيديوهات المحفوظة';

            tabContainer.appendChild(recitersTabButton);
            tabContainer.appendChild(channTabButton); // Add Tarteel AI tab
            tabContainer.appendChild(toolsTabButton);
            tabContainer.appendChild(savedTabButton);

            const tabsContentContainer = document.createElement('div');
            tabsContentContainer.id = 'tabs-content-container';
            tabsContentContainer.className = 'flex-grow w-full overflow-y-auto';

            // 2. Create Content Panels
            const recitersContent = document.createElement('div');
            recitersContent.id = 'tab-content-reciters';
            recitersContent.className = 'tab-content';
            const readerButtonsContainer = document.createElement('div');
            readerButtonsContainer.className = 'reader-container';
            recitersContent.appendChild(readerButtonsContainer);

            // Create Channels Content Panels
            const channContent = document.createElement('div');
            channContent.id = 'tab-content-channels';
            channContent.className = 'tab-content hidden';
            const channButtonsContainer = document.createElement('div');
            channButtonsContainer.className = 'reader-container';
            channContent.appendChild(channButtonsContainer);
            
            // NEW: Tarteel AI Content Panel
            const tarteelContent = document.createElement('div');
            tarteelContent.id = 'tab-content-tarteel';
            tarteelContent.className = 'tab-content hidden h-full flex flex-col items-center';
            tarteelContent.innerHTML = `
                <div class="flex flex-col items-center mb-4">
                    <img src="${TARTEEL_CHANNEL_IMAGE}" alt="Tarteel AI Logo" class="w-24 h-24 rounded-full mb-3 border-2 border-purple-400">
                    <h2 class="text-2xl font-bold">@TarteelArabic</h2>
                    <p class="text-gray-400">أحدث الفيديوهات من قناة ترتيل</p>
                </div>
                <div id="tarteel-videos-container" class="grid-container w-full overflow-y-auto" style="height: calc(100% - 150px);">
                    <p class="text-center col-span-full">جاري تحميل الفيديوهات...</p>
                </div>
            `;


            const toolsContent = document.createElement('div');
            toolsContent.id = 'tab-content-tools';
            toolsContent.className = 'tab-content hidden';
            const toolsButtonsContainer = document.createElement('div');
            toolsButtonsContainer.className = 'reader-container'; 
            toolsContent.appendChild(toolsButtonsContainer);

            const savedContent = document.createElement('div');
            savedContent.id = 'tab-content-saved';
            savedContent.className = 'tab-content hidden h-full';
            savedContent.innerHTML = `
                <div class="w-full h-full flex flex-col items-center">
                    <div class="tabs-container flex p-1 rounded-full bg-black/30 self-center mt-2 mb-4" style="position: relative; top: 30px; z-index: 10;">
                        <button id="tab-saved-d" class="tab-button active navigable grid-item" tabindex="0">D user Tab</button>
                        <button id="tab-saved-m" class="tab-button navigable grid-item" tabindex="0">M user Tab</button>
                    </div>
                    <div id="tab-content-saved-d" class="tab-content w-full flex-grow overflow-y-auto pt-12">
                         <div id="favorites-d-grid" class="flex flex-col gap-4 w-full p-2 grid-container"></div>
                    </div>
                    <div id="tab-content-saved-m" class="tab-content hidden w-full flex-grow overflow-y-auto pt-12">
                        <div id="favorites-m-grid" class="flex flex-col gap-4 w-full p-2 grid-container"></div>
                    </div>
                </div>
            `;

            // 3. Populate Content Panels
            const recitersList = youtubeReaderSuggestions.filter(r => r.name !== "ربط الآيات");
            recitersList.forEach(reader => {
                const card = document.createElement('div');
                card.className = 'youtube-reader-card navigable grid-item';
                card.tabIndex = 0;
                card.innerHTML = `<h3>${reader.name}</h3><img src="${reader.image}" alt="${reader.name}" onerror="this.onerror=null;this.src='https://placehold.co/64x64';">`;
                
                // UPDATED: This listener now checks for Tarteel by name to perform a direct search.
                card.addEventListener('click', () => {
                    const specialReciters = [
                        'ترتيل-@TarteelArabic',
                        'محفوف -BYMAHFOOF',
                        'اذاعة مختلف', 'الرقية' ,
                        'Mohamed abubakr',
                        'قناة اخضر' , 'Qtratel' ,'مزامير الفرقان - ياسر الدوسري','عبدالله الشحري','بودكاست'
                    ];

                    if (specialReciters.includes(reader.name)) {
                        searchYouTubeVideos(reader.name);
                    } else if (searchMode === 'reciter_only') {
                        youtubeSearchInput.value = reader.name;
                        searchYouTubeVideos(reader.name);
                        searchMode = 'reciter_surah'; // Reset mode after search
                    } else {
                        handleReaderOrToolClick(reader.name, tabContainer, tabsContentContainer);
                    }
                });
                readerButtonsContainer.appendChild(card);
            });
            
            const channList = youtubeReaderSuggestions2;
            channList.forEach(reader => {
                const card = document.createElement('div');
                card.className = 'youtube-reader-card navigable grid-item';
                card.tabIndex = 0;
                card.innerHTML = `<h3>${reader.name}</h3><img src="${reader.image}" alt="${reader.name}" onerror="this.onerror=null;this.src='https://placehold.co/64x64';">`;
                
                card.addEventListener('click', () => {
                    const specialReciters = [
                        'ترتيل-@TarteelArabic',
                        'محفوف -BYMAHFOOF',
                        'اذاعة مختلف', 'الرقية' ,
                        'Mohamed abubakr',
                        'قناة اخضر' , 'Qtratel' ,'مزامير الفرقان - ياسر الدوسري','عبدالله الشحري','بودكاست'
                    ];

                    if (specialReciters.includes(reader.name)) {
                        searchYouTubeVideos(reader.name);
                    } else if (searchMode === 'reciter_only') {
                        youtubeSearchInput.value = reader.name;
                        searchYouTubeVideos(reader.name);
                        searchMode = 'reciter_surah'; // Reset mode after search
                    } else {
                        handleReaderOrToolClick(reader.name, tabContainer, tabsContentContainer);
                    }
                });
                channButtonsContainer.appendChild(card);
            });

            // MOVED: Add "السورة" button to the Reciters tab at the end
            const surahCard = document.createElement('div');
            surahCard.className = 'youtube-reader-card navigable grid-item';
            surahCard.tabIndex = 3;
            surahCard.innerHTML = `<h3>السورة فقط</h3><div class="w-[100px] h-[100px] rounded-full border-2 border-white/30 flex items-center justify-center bg-black/20"><i data-lucide="book-open" class="w-12 h-12"></i></div>`;
            surahCard.addEventListener('click', () => handleReaderOrToolClick("JUST_SURAH", tabContainer, tabsContentContainer));
            readerButtonsContainer.appendChild(surahCard);

            // MOVED: Add "القارئ فقط" to the Reciters tab at the end
            const reciterOnlyCard = document.createElement('div');
            reciterOnlyCard.className = 'youtube-reader-card navigable grid-item';
            reciterOnlyCard.tabIndex = 0;
            reciterOnlyCard.innerHTML = `<h3>القارئ فقط</h3><div class="w-[100px] h-[100px] rounded-full border-2 border-white/30 flex items-center justify-center bg-black/20"><i data-lucide="mic" class="w-12 h-12"></i></div>`;
            reciterOnlyCard.addEventListener('click', () => {
                searchMode = 'reciter_only';
                showMessageBox('اختر قارئاً للبحث عنه مباشرة.');
                const firstReciter = recitersContent.querySelector('.grid-item');
                if (firstReciter) setFocus(firstReciter);
            });
            readerButtonsContainer.appendChild(reciterOnlyCard);


            const rabtAlAyat = youtubeReaderSuggestions.find(r => r.name === "ربط الآيات");
            if (rabtAlAyat) {
                const card = document.createElement('div');
                card.className = 'youtube-reader-card navigable grid-item';
                card.tabIndex = 0;
                card.innerHTML = `<h3>${rabtAlAyat.name}</h3><img src="${rabtAlAyat.image}" alt="${rabtAlAyat.name}" onerror="this.onerror=null;this.src='https://placehold.co/64x64';">`;
                card.addEventListener('click', () => handleReaderOrToolClick(rabtAlAyat.name, tabContainer, tabsContentContainer));
                toolsButtonsContainer.appendChild(card);
            }

            const difficultWordsCard = document.createElement('div');
            difficultWordsCard.className = 'youtube-reader-card navigable grid-item';
            difficultWordsCard.tabIndex = 0;
            difficultWordsCard.innerHTML = `<h3>الكلمات الصعبة</h3><div class="w-[100px] h-[100px] rounded-full border-2 border-white/30 flex items-center justify-center bg-black/20"><i data-lucide="book-check" class="w-12 h-12"></i></div>`;
            difficultWordsCard.addEventListener('click', () => handleReaderOrToolClick("الكلمات الصعبة في", tabContainer, tabsContentContainer));
            toolsButtonsContainer.appendChild(difficultWordsCard);

            const repeatCard = document.createElement('div');
            repeatCard.className = 'youtube-reader-card navigable grid-item';
            repeatCard.tabIndex = 0;
            repeatCard.innerHTML = `<h3>تكرار</h3><div class="w-[100px] h-[100px] rounded-full border-2 border-white/30 flex items-center justify-center bg-black/20"><i data-lucide="repeat" class="w-12 h-12"></i></div>`;
            repeatCard.addEventListener('click', () => handleReaderOrToolClick("تكرار", tabContainer, tabsContentContainer));
            toolsButtonsContainer.appendChild(repeatCard);

            const saveCard = document.createElement('div');
            saveCard.className = 'youtube-reader-card navigable grid-item';
            saveCard.tabIndex = 0;
            saveCard.innerHTML = `<h3>حفظ</h3><div class="w-[100px] h-[100px] rounded-full border-2 border-white/30 flex items-center justify-center bg-black/20"><i data-lucide="save" class="w-12 h-12"></i></div>`;
            saveCard.addEventListener('click', () => handleReaderOrToolClick("حفظ", tabContainer, tabsContentContainer));
            toolsButtonsContainer.appendChild(saveCard);

            // 4. Tab Switching Logic
            recitersTabButton.addEventListener('click', () => {
                recitersTabButton.classList.add('active');
                channTabButton.classList.remove('active');
                tarteelTabButton.classList.remove('active');
                toolsTabButton.classList.remove('active');
                savedTabButton.classList.remove('active');
                recitersContent.classList.remove('hidden');
                channContent.classList.add('hidden');
                tarteelContent.classList.add('hidden');
                toolsContent.classList.add('hidden');
                savedContent.classList.add('hidden');
                displayLastWatchedVideo();
                const firstItem = recitersContent.querySelector('.grid-item');
                if (firstItem) setFocus(firstItem);
            });

            channTabButton.addEventListener('click', () => {
                recitersTabButton.classList.remove('active');
                channTabButton.classList.add('active');
                tarteelTabButton.classList.remove('active');
                toolsTabButton.classList.remove('active');
                savedTabButton.classList.remove('active');
                recitersContent.classList.add('hidden');
                channContent.classList.remove('hidden');
                tarteelContent.classList.add('hidden');
                toolsContent.classList.add('hidden');
                savedContent.classList.add('hidden');
                displayLastWatchedVideo();
                const firstItem = channContent.querySelector('.grid-item');
                if (firstItem) setFocus(firstItem);
            });

            toolsTabButton.addEventListener('click', () => {
                recitersTabButton.classList.remove('active');
                channTabButton.classList.remove('active');
                tarteelTabButton.classList.remove('active');
                toolsTabButton.classList.add('active');
                savedTabButton.classList.remove('active');
                recitersContent.classList.add('hidden');
                channContent.classList.add('hidden');
                tarteelContent.classList.add('hidden');
                toolsContent.classList.remove('hidden');
                savedContent.classList.add('hidden');
                displayLastWatchedVideo();
                const firstItem = toolsContent.querySelector('.grid-item');
                if (firstItem) setFocus(firstItem);
            });
            
            savedTabButton.addEventListener('click', () => {
                recitersTabButton.classList.remove('active');
                channTabButton.classList.remove('active');
                tarteelTabButton.classList.remove('active');
                toolsTabButton.classList.remove('active');
                savedTabButton.classList.add('active');

                recitersContent.classList.add('hidden');
                channContent.classList.add('hidden');
                tarteelContent.classList.add('hidden');
                toolsContent.classList.add('hidden');
                savedContent.classList.remove('hidden');

                document.getElementById('last-watched-container').classList.add('hidden');
                loadSavedVideos(); // Load the videos when tab is clicked
                
                // --- NEW: Inner tab logic for saved videos ---
                const tabSavedD = savedContent.querySelector('#tab-saved-d');
                const tabSavedM = savedContent.querySelector('#tab-saved-m');
                const contentSavedD = savedContent.querySelector('#tab-content-saved-d');
                const contentSavedM = savedContent.querySelector('#tab-content-saved-m');

                if (tabSavedD && tabSavedM && contentSavedD && contentSavedM) {
                    tabSavedD.addEventListener('click', () => {
                        tabSavedD.classList.add('active');
                        tabSavedM.classList.remove('active');
                        contentSavedD.classList.remove('hidden');
                        contentSavedM.classList.add('hidden');
                        setFocus(tabSavedD);
                    });

                    tabSavedM.addEventListener('click', () => {
                        tabSavedM.classList.add('active');
                        tabSavedD.classList.remove('active');
                        contentSavedM.classList.remove('hidden');
                        contentSavedD.classList.add('hidden');
                        setFocus(tabSavedM);
                    });
                }
                
                const firstItem = savedContent.querySelector('.grid-item');
                if (firstItem) setFocus(firstItem);
            });

            // 5. Append everything
            suggestionsContent.appendChild(tabContainer);
            tabsContentContainer.appendChild(recitersContent);
            tabsContentContainer.appendChild(channContent);
            tabsContentContainer.appendChild(tarteelContent); // Append Tarteel AI content
            tabsContentContainer.appendChild(toolsContent);
            tabsContentContainer.appendChild(savedContent);
            suggestionsContent.appendChild(tabsContentContainer);

            // Set initial active tab
            channTabButton.classList.add('active');
            channContent.classList.remove('hidden');
            recitersTabButton.classList.remove('active');
            recitersContent.classList.add('hidden');


            lucide.createIcons();
            }

         // NEW: Function to fetch and display Tarteel AI videos
            async function fetchTarteelVideos() {
            if (YOUTUBE_API_KEY.startsWith('YOUR_')) return showMessageBox('خطأ: لم يتم تعيين مفتاح YouTube API.');
            const tarteelVideosContainer = document.getElementById('tarteel-videos-container');
            if (!tarteelVideosContainer) return;

            tarteelVideosContainer.innerHTML = '<p class="text-center col-span-full">جاري تحميل أحدث فيديوهات ترتيل...</p>';
            
            try {
                // CHANGED: Increased maxResults to 50 to fetch more videos
                const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${TARTEEL_CHANNEL_ID}&type=video&order=date&key=${YOUTUBE_API_KEY}&maxResults=50`);
                const data = await res.json();
                
                if (data.items && data.items.length > 0) {
                    const videoIds = data.items.map(item => item.id.videoId);
                    const videoDetails = await fetchVideosDetails(videoIds); // Re-use existing detail fetcher
                    
                    tarteelVideosContainer.innerHTML = ''; // Clear loading message
                    videoDetails.forEach(video => {
                        const durationSeconds = video.contentDetails.duration.match(/\d+/g).map(Number).reduce((acc, time, i, arr) => acc + time * (arr.length === 3 ? [3600, 60, 1][i] : (arr.length === 2 ? [60, 1][i] : 1)), 0);
                        if (durationSeconds <= 61) return; // Filter out very short videos

                        const videoData = {
                            id: video.id,
                            title: video.snippet.title,
                            thumbnail: video.snippet.thumbnails.medium.url,
                            channelTitle: video.snippet.channelTitle,
                            viewCount: formatViewCount(video.statistics.viewCount),
                            publishedAt: formatTimeAgo(video.snippet.publishedAt),
                            duration: formatDuration(video.contentDetails.duration)
                        };
                        tarteelVideosContainer.appendChild(createVideoCard(videoData));
                    });
                } else {
                    tarteelVideosContainer.innerHTML = '<p class="text-center col-span-full">لا توجد فيديوهات حديثة لقناة ترتيل.</p>';
                }
            } catch (err) {
                console.error('Error fetching Tarteel AI videos:', err);
                tarteelVideosContainer.innerHTML = '<p class="text-center col-span-full text-red-400">حدث خطأ أثناء تحميل فيديوهات ترتيل.</p>';
            }
            lucide.createIcons();
            updateNavigableElements();
        }


        function showSurahSuggestions() {
            const existing = document.getElementById('youtube-surah-section');
            if (existing) existing.remove();

            const lastWatchedContainer = document.getElementById('last-watched-container');
            if (lastWatchedContainer) lastWatchedContainer.classList.add('hidden');

            // Hide the main suggestions content container to remove the top gap
            const suggestionsContent = document.getElementById('suggestions-content');
            if (suggestionsContent) suggestionsContent.classList.add('hidden');

            const surahSection = document.createElement('div');
            surahSection.id = 'youtube-surah-section';
            surahSection.className = 'flex flex-col gap-2 p-3 rounded-xl glass-surface glass-surface--svg w-full flex-grow';

            // 1. Create Tab Structure
            const tabContainer = document.createElement('div');
            tabContainer.className = 'tabs-container flex p-1 rounded-full bg-black/20 self-center mb-2';

            const surahTabButton = document.createElement('button');
            surahTabButton.id = 'tab-surah';
            surahTabButton.className = 'tab-button active navigable grid-item';
            surahTabButton.tabIndex = 0;
            surahTabButton.textContent = 'السورة';

            const juzTabButton = document.createElement('button');
            juzTabButton.id = 'tab-juz';
            juzTabButton.className = 'tab-button navigable grid-item';
            juzTabButton.tabIndex = 0;
            juzTabButton.textContent = 'الجزء';

            tabContainer.appendChild(surahTabButton);
            tabContainer.appendChild(juzTabButton);

            const tabsContentContainer = document.createElement('div');
            tabsContentContainer.id = 'tabs-content-container-surah';
            tabsContentContainer.className = 'flex-grow w-full overflow-hidden'; // Let inner container scroll

            // 2. Create Surah content panel
            const surahContent = document.createElement('div');
            surahContent.id = 'tab-content-surah';
            surahContent.className = 'tab-content h-full';
            
              const scrollableSurahContainer = document.createElement('div');
            scrollableSurahContainer.className = 'surah-buttons-scrollable h-full';
            const surahButtonsContainer = document.createElement('div');
            surahButtonsContainer.className = 'flex flex-wrap justify-center gap-2 w-full';
            
            youtubeSurahSuggestions.forEach(name => {
                const button = document.createElement('button');
                button.className = 'youtube-suggestion-button navigable grid-item';
                button.tabIndex = 0;
                button.innerHTML = `<span class="surah-name-text">${name}</span> <span class="juz-badge">${surahToJuzMap[name] || '?'}</span>`;
                button.style.backgroundColor = juzColors[(surahToJuzMap[name] || 1) - 1];
                button.addEventListener('click', () => {
                    let query = '';
                    const currentInput = youtubeSearchInput.value.trim();
                    if (youtubeSearchInput.value.startsWith('الكلمات الصعبة في')) {
                        query = 'الكلمات الصعبة في سورة ' + name;
                    } else if (currentInput === '') {
                        query = 'سورة ' + name;
                    } else {
                        query = selectedReaderName + ' سورة ' + name;
                    }
                    youtubeSearchInput.value = query;
                    searchYouTubeVideos(query);
                });
                surahButtonsContainer.appendChild(button);
            });
            scrollableSurahContainer.appendChild(surahButtonsContainer);
            surahContent.appendChild(scrollableSurahContainer);

            // 3. Create Juz content panel
            const juzContent = document.createElement('div');
            juzContent.id = 'tab-content-juz';
            juzContent.className = 'tab-content hidden h-full';

            const scrollableJuzContainer = document.createElement('div');
            scrollableJuzContainer.className = 'surah-buttons-scrollable h-full';
            const juzButtonsContainer = document.createElement('div');
            juzButtonsContainer.className = 'flex flex-wrap justify-center gap-2 w-full';

            for (let i = 1; i <= 30; i++) {
                const button = document.createElement('button');
                button.className = 'youtube-suggestion-button navigable grid-item';
                button.tabIndex = 0;
                button.style.backgroundColor = juzColors[(i % juzColors.length)];
                button.innerHTML = `الجزء ${i}`;
                button.addEventListener('click', () => {
                    const juzName = juzArabicNames[i - 1];
                    let query = '';
                    const currentSearch = youtubeSearchInput.value;
                    if (currentSearch.trim() && !currentSearch.startsWith('الكلمات الصعبة في')) {
                        query = currentSearch + `الجزء ${juzName}`;
                    } else {
                        query = `الجزء ${juzName}`;
                    }
                    youtubeSearchInput.value = query;
                    searchYouTubeVideos(query);
                });
                juzButtonsContainer.appendChild(button);
            }
            scrollableJuzContainer.appendChild(juzButtonsContainer);
            juzContent.appendChild(scrollableJuzContainer);

            // 4. Tab Switching Logic
            surahTabButton.addEventListener('click', () => {
                surahTabButton.classList.add('active');
                juzTabButton.classList.remove('active');
                surahContent.classList.remove('hidden');
                juzContent.classList.add('hidden');
                const firstItem = surahContent.querySelector('.grid-item');
                if (firstItem) setFocus(firstItem);
            });
            juzTabButton.addEventListener('click', () => {
                juzTabButton.classList.add('active');
                surahTabButton.classList.remove('active');
                juzContent.classList.remove('hidden');
                surahContent.classList.add('hidden');
                const firstItem = juzContent.querySelector('.grid-item');
                if (firstItem) setFocus(firstItem);
            });

            // 5. Append everything
            surahSection.appendChild(tabContainer);
            tabsContentContainer.appendChild(surahContent);
            tabsContentContainer.appendChild(juzContent);
            surahSection.appendChild(tabsContentContainer);
            youtubeSuggestionsDiv.appendChild(surahSection);
        }

        function navigateBackToMainSearch() { 
            youtubeVideoListView.classList.add('hidden'); 
            youtubeSearchResultsView.classList.add('hidden'); 
            youtubeSuggestionsDiv.style.display = 'flex'; 
            activeMediaView = 'suggestions'; 
            currentPlayingPlaylistId = ''; 
            backToPlaylistsBottomButton.style.display = 'none'; 
            backToPlaylistsBottomButtonSearch.style.display = 'none'; 
            
            // إصلاح: إزالة قسم السور بشكل صريح عند العودة
            const existingSurahSection = document.getElementById('youtube-surah-section');
            if (existingSurahSection) {
                existingSurahSection.remove();
            }
            
            resetYoutubeSearchUI(); 
            setTimeout(() => { const firstReader = youtubeSuggestionsDiv.querySelector('.grid-item'); if (firstReader) setFocus(firstReader); }, 100); 
        }

        // --- Google Map and Geolocation (REFACTORED FOR RELIABILITY) ---
        let mapsInitialized = false;
        
        function showGeolocationErrorOnMap(message) {
            const overlay = document.getElementById('geolocation-error-overlay');
            const mapControls = document.querySelector('#dashboard-google-map ~ .absolute'); 

            if (overlay) {
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
                if (message) {
                    const p = overlay.querySelector('p');
                    if (p) p.textContent = message;
                }
                lucide.createIcons();
            }
            if (mapControls) {
                mapControls.style.display = 'none';
            }
        }

        // --- Favorites (Bookmark) Functions ---
        function closeFavoritesMenu() {
            const existingMenu = document.querySelector('.favorites-menu');
            if (existingMenu) {
                existingMenu.remove();
            }
            // Remove the global click listener that was added to close the menu
             document.body.removeEventListener('click', closeFavoritesMenu);
        }

        function showFavoritesMenu(button, video) {
            closeFavoritesMenu(); // Close any existing menu first

            const menu = document.createElement('div');
            menu.className = 'favorites-menu';
            const rect = button.getBoundingClientRect();

            menu.style.top = `${rect.bottom + 5}px`;
            menu.style.left = `${rect.left}px`;
            
            menu.innerHTML = `
                <button data-type="D" class="navigable grid-item" tabindex="0">
                     <i data-lucide="folder-plus" class="w-4 h-4 text-blue-400"></i> المفضلة D
                </button>
                <button data-type="M" class="navigable grid-item" tabindex="0">
                    <i data-lucide="folder-plus" class="w-4 h-4 text-pink-400"></i> المفضلة M
                </button>
            `;

            document.body.appendChild(menu);
            menu.classList.add('show');

            menu.addEventListener('click', e => e.stopPropagation());

            menu.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const type = btn.dataset.type;
                    await saveVideoToFavorites(video, type);
                    closeFavoritesMenu();
                });
            });

            lucide.createIcons();
            setFocus(menu.querySelector('button'));

            setTimeout(() => {
                document.body.addEventListener('click', closeFavoritesMenu, { once: true });
            }, 0);
        }

        async function fetchFavorites(type) {
            const binId = type === 'D' ? JSONBIN_BIN_ID_FAV_D : JSONBIN_BIN_ID_FAV_M;
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
                    headers: { 'X-Access-Key': JSONBIN_ACCESS_KEY_REMINDERS }
                });
                if (res.status === 404) return []; // Bin is new/empty
                if (!res.ok) throw new Error(`HTTP error ${res.status}`);
                const data = await res.json();
                return Array.isArray(data.record) ? data.record : [];
            } catch (error) {
                console.error(`Error fetching favorites ${type}:`, error);
                return [];
            }
        }

        async function updateFavorites(type, newFavoritesList) {
            const binId = type === 'D' ? JSONBIN_BIN_ID_FAV_D : JSONBIN_BIN_ID_FAV_M;
            
            // If the list is empty, send a placeholder object to avoid API errors.
            const dataToSend = (Array.isArray(newFavoritesList) && newFavoritesList.length === 0)
                ? { _init: true } 
                : newFavoritesList;

            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_API_KEY
                    },
                    body: JSON.stringify(dataToSend)
                });
                if (!res.ok) throw new Error(`Failed to update favorites: ${res.status}`);
                return true;
            } catch (error) {
                console.error(`Error updating favorites ${type}:`, error);
                showMessageBox(`حدث خطأ أثناء تحديث المفضلة ${type}`);
                return false;
            }
        }

        async function saveVideoToFavorites(video, type) {
            const favoritesList = type === 'D' ? favoritesD : favoritesM;
            if (favoritesList.some(fav => fav.id === video.id)) {
                showMessageBox(`الفيديو موجود بالفعل في المفضلة ${type}`);
                return;
            }
            const videoToSave = { id: video.id, title: video.title, thumbnail: video.thumbnail, channelTitle: video.channelTitle, duration: video.duration };
            const updatedList = [...favoritesList, videoToSave];
            const success = await updateFavorites(type, updatedList);

            if (success) {
                if (type === 'D') favoritesD = updatedList; else favoritesM = updatedList;
                showMessageBox(`تم حفظ الفيديو في المفضلة ${type}`);
                const bookmarkBtn = document.querySelector(`.bookmark-button[data-video-id="${video.id}"]`);
                if(bookmarkBtn) {
                    bookmarkBtn.classList.remove('saved-d', 'saved-m', 'saved-both');
                    if (favoritesD.some(fav => fav.id === video.id) && favoritesM.some(fav => fav.id === video.id)) bookmarkBtn.classList.add('saved-both');
                    else if (favoritesD.some(fav => fav.id === video.id)) bookmarkBtn.classList.add('saved-d');
                    else if (favoritesM.some(fav => fav.id === video.id)) bookmarkBtn.classList.add('saved-m');
                }
            }
        }

        async function removeVideoFromFavorites(videoId, type) {
            const favoritesList = type === 'D' ? favoritesD : favoritesM;
            const updatedList = favoritesList.filter(fav => fav.id !== videoId);
            const success = await updateFavorites(type, updatedList);
            if (success) {
                if (type === 'D') favoritesD = updatedList; else favoritesM = updatedList;
                showMessageBox(`تمت إزالة الفيديو من المفضلة ${type}`);
                loadSavedVideos(); 
            }
        }

        async function loadSavedVideos() {
            const gridD = document.getElementById('favorites-d-grid');
            const gridM = document.getElementById('favorites-m-grid');
            if (!gridD || !gridM) return;

            gridD.innerHTML = '<p>جاري التحميل...</p>';
            gridM.innerHTML = '<p>جاري التحميل...</p>';

            [favoritesD, favoritesM] = await Promise.all([fetchFavorites('D'), fetchFavorites('M')]);

            gridD.innerHTML = '';
            if (favoritesD.length > 0) {
                favoritesD.forEach(video => gridD.appendChild(createFavoriteVideoCard(video, 'D')));
            } else {
                gridD.innerHTML = '<p>لا توجد فيديوهات محفوظة هنا.</p>';
            }
            gridM.innerHTML = '';
            if (favoritesM.length > 0) {
                favoritesM.forEach(video => gridM.appendChild(createFavoriteVideoCard(video, 'M')));
            } else {
                gridM.innerHTML = '<p>لا توجد فيديوهات محفوظة هنا.</p>';
            }
            lucide.createIcons();
            updateNavigableElements();
        }

        function createFavoriteVideoCard(video, type) {
            const card = document.createElement('div');
            card.className = 'glass-surface glass-surface--svg youtube-video-card navigable grid-item';
            card.tabIndex = 0;
            card.dataset.videoId = video.id;

            card.innerHTML = `
                <div class="video-details">
                    <h3 class="video-title">${video.title}</h3>
                    <div class="video-meta">
                        <span>${video.channelTitle || ''}</span>
                    </div>
                </div>
                <div class="thumbnail-container relative">
                     <img src="${video.thumbnail}" alt="${video.title}" class="w-[180px] h-[101.25px] object-cover rounded-md ml-4 flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/180x101';">
                     <span class="video-duration">${video.duration || ''}</span>
                     <button class="remove-favorite-button" title="إزالة من المفضلة"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </div>
            `;
            card.addEventListener('click', () => showVideoPopup(video.id));
            card.querySelector('.remove-favorite-button').addEventListener('click', (e) => {
                e.stopPropagation();
                removeVideoFromFavorites(video.id, type);
            });
            return card;
        }

        // --- Google Map and Geolocation (REFACTORED FOR RELIABILITY) ---
        function loadGoogleMaps() {
            if (googleMapsPromise) return googleMapsPromise;

            googleMapsPromise = new Promise((resolve, reject) => {
                if (typeof google !== 'undefined' && google.maps) {
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=geometry,places`;
                script.async = true;
                script.defer = true;
                script.onload = () => resolve();
                script.onerror = () => reject('Failed to load Google Maps script.');
                document.head.appendChild(script);
            });

            return googleMapsPromise;
        }

        async function initMap() {
             if (mapsInitialized) return;
             mapsInitialized = true;
            try {
                const mapElement = document.getElementById('dashboard-google-map');
                if (!mapElement) {
                    console.error("Map container 'dashboard-google-map' not found.");
                    return;
                }
                dashboardGoogleMap = new google.maps.Map(mapElement, {
                    center: { lat: appState.mapLocation.lat, lng: appState.mapLocation.lon },
                    zoom: appState.mapLocation.zoom,
                    disableDefaultUI: true,
                    mapTypeId: 'satellite',
                });

                dashboardGoogleMarker = new google.maps.Marker({
                    position: { lat: appState.mapLocation.lat, lng: appState.mapLocation.lon },
                    map: dashboardGoogleMap,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 7,
                        fillColor: "#4285F4",
                        fillOpacity: 1,
                        strokeColor: "white",
                        strokeWeight: 2,
                    },
                });

                // Initialize Directions Service and Renderer
                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer({
                    map: dashboardGoogleMap,
                    suppressMarkers: true // We use our custom marker
                });

                dashboardGoogleMap.addListener('zoom_changed', () => { if (dashboardGoogleMap.getZoom() !== appState.mapLocation.zoom) appState.mapZoomChangedByUser = true; }); 
                startContinuousLocationTracking();
            } catch (error) {
                console.error("Failed to initialize map due to API load error:", error);
                showGeolocationErrorOnMap("تعذر تحميل خرائط جوجل. يرجى التحقق من اتصالك بالإنترنت ومفتاح API.");
            }
        }

        // Helper function to calculate distance between two lat/lng points
        function haversineDistance(coords1, coords2) {
            function toRad(x) { return x * Math.PI / 180; }
            const R = 6371; // km
            const dLat = toRad(coords2.lat - coords1.lat);
            const dLon = toRad(coords2.lng - coords1.lng);
            const lat1 = toRad(coords1.lat);
            const lat2 = toRad(coords2.lat);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.sin(dLon / 2) * Math.sin(dLon / 2) * Math.cos(lat1) * Math.cos(lat2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c * 1000; // in meters
        }
        
        // NEW: Helper function to convert bearing to direction
        function bearingToDirection(bearing) {
            if (typeof bearing !== 'number' || isNaN(bearing)) return '--';
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            const index = Math.round((bearing % 360) / 45) % 8;
            return directions[index];
        }

        function updateGoogleMapLocation(pos) {
            const { latitude: lat, longitude: lng, heading } = pos.coords;
            appState.currentLocation = { lat, lng };
            const newLatLng = { lat, lng };

            // Logic for speed, gear, and direction based on movement
            if (appState.previousLocation) {
                const distance = haversineDistance(appState.previousLocation, newLatLng);
                if (distance > 2) {
                    appState.car.gear = 'D';
                    appState.car.speed = (Math.random() * 60 + 40).toFixed(0);
                } else {
                    appState.car.gear = 'P';
                    appState.car.speed = 0;
                }
            } else {
                appState.car.gear = 'P';
                appState.car.speed = 0;
            }
            appState.previousLocation = newLatLng;
            appState.car.direction = bearingToDirection(heading); // Update direction
            update3dScreenWidgets(); // Update UI immediately

            if (dashboardGoogleMap && dashboardGoogleMarker) {
                dashboardGoogleMarker.setPosition(newLatLng);
                if (!appState.mapZoomChangedByUser) {
                    dashboardGoogleMap.setCenter(newLatLng);
                    dashboardGoogleMap.setZoom(appState.mapLocation.zoom);
                }
            }
            if (typeof heading === 'number' && !isNaN(heading)) {
                if (dashboardGoogleMap) dashboardGoogleMap.setHeading(heading);
            }
        }
        function startContinuousLocationTracking() {
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    (pos) => { 
                        const overlay = document.getElementById('geolocation-error-overlay');
                        if (overlay) overlay.classList.add('hidden');
                        const mapControls = document.querySelector('#dashboard-google-map ~ .absolute');
                        if (mapControls) mapControls.style.display = 'flex';
                        
                        updateGoogleMapLocation(pos); 
                        appState.hasShownGeolocationError = false; 

                        // Fetch weather for the first time with accurate location
                        if (!initialLocationFetched) {
                            fetchWeatherData();
                            initialLocationFetched = true;
                        }
                    }, 
                    (err) => { 
                        if (err.code === 1) { // PERMISSION_DENIED
                            showGeolocationErrorOnMap('تم رفض إذن تحديد الموقع. يرجى تمكينه في إعدادات المتصفح.');
                        } else if (!appState.hasShownGeolocationError) {
                            let msg = 'تعذر تتبع موقعك. يرجى التحقق من أذونات الموقع.';
                            showMessageBox(msg); 
                            appState.hasShownGeolocationError = true; 
                        }
                    }, 
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                showGeolocationErrorOnMap('خدمة تحديد المواقع غير مدعومة في هذا المتصفح.');
            }
        }
        function centerMapOnUserLocation() { 
            if (navigator.geolocation) { 
                navigator.geolocation.getCurrentPosition(
                    (pos) => { 
                        updateGoogleMapLocation(pos); 
                        showMessageBox(`تم تحديث الخريطة.`); 
                    }, 
                    () => {
                        showGeolocationErrorOnMap('تعذر الحصول على موقعك الحالي. يرجى التحقق من الأذونات.');
                    }, 
                    { enableHighAccuracy: true }
                ); 
            } 
        }
        
        async function calculateAndDisplayRouteTo(destinationCoords) {
            if (!appState.currentLocation) {
                showMessageBox('لم يتم تحديد موقعك الحالي بعد. يرجى الانتظار أو تحديث الموقع.');
                return;
            }
            if (!directionsService || !directionsRenderer) {
                showMessageBox('خدمة التوجيهات غير جاهزة.');
                return;
            }
            
            const request = {
                origin: appState.currentLocation,
                destination: destinationCoords,
                travelMode: 'DRIVING'
            };

            try {
                const response = await directionsService.route(request);
                if (response.status === 'OK') {
                    directionsRenderer.setDirections(response);
                    const route = response.routes[0].legs[0];
                   
                    showMessageBox(`الطريق إلى وجهتك: ${route.distance.text}, الوقت المقدر: ${route.duration.text}`);
                } else {
                    showMessageBox('تعذر العثور على اتجاهات: ' + response.status);
                }
            } catch (err) {
                console.error('Error calculating directions:', err);
                showMessageBox('حدث خطأ أثناء حساب الاتجاهات.');
            }
        }

        // --- Weather API Integration ---
        async function fetchWeatherData() {
            if (WEATHER_API_KEY.startsWith('YOUR_')) return showMessageBox('خطأ: لم يتم تعيين مفتاح WeatherAPI.');
            try {
                const locationQuery = appState.currentLocation ? `${appState.currentLocation.lat},${appState.currentLocation.lng}` : appState.weather.location.split(',')[0].trim();
                const res = await fetch(`https://api.weatherapi.com/v1/forecast.json?key=${WEATHER_API_KEY}&q=${locationQuery}&days=2&aqi=yes&alerts=no&lang=ar`);
                if (!res.ok) throw new Error(`خطأ HTTP! الحالة: ${res.status}`);
                const data = await res.json();
                
                // Update main state for Salalah
                appState.weather.temperature = data.current.temp_c;
                appState.weather.description = data.current.condition.text;
                appState.weather.uvIndex = data.current.uv;
                appState.weather.iconUrl = `https:${data.current.condition.icon}`;
                appState.weather.location = `${data.location.name}, ${data.location.country}`;
                
                // --- NEW: Handle hourly forecast ---
                const hourlyData = [...data.forecast.forecastday[0].hour, ...data.forecast.forecastday[1]?.hour || []];
                const now = new Date();
                const currentHourData = {
                    time: "الآن",
                    temp_c: data.current.temp_c,
                    condition: { icon: data.current.condition.icon }
                };
                const upcomingHours = hourlyData.filter(h => new Date(h.time_epoch * 1000) > now).slice(0, 6);
                const forecastToRender = [currentHourData, ...upcomingHours];
                renderHourlyForecast(forecastToRender);
                
                // --- NEW: Fetch other locations ---
                renderAdvancedWeatherCards(data);

                updateUI(); // Update other UI elements
            } catch (err) {
                console.error('Error fetching weather data:', err);
            
            }
        }

        function renderHourlyForecast(forecastData) {
            const container = document.getElementById('hourly-forecast-container');
            if (!container) return;
            container.innerHTML = '';
            forecastData.forEach(hour => {
                  const timeLabel = hour.time === "الآن"
                    ? "الآن"
                    : new Date(hour.time_epoch * 1000).toLocaleTimeString('ar-SA', { hour: 'numeric', hour12: true });

                const card = document.createElement('div');
                card.className = 'flex flex-col items-center justify-center p-1 rounded-lg';
                card.innerHTML = `
                    <span class="text-base font-medium text-white/80">${timeLabel}</span>
                    <img src="https:${hour.condition.icon}" alt="weather" class="w-8 h-8 my-1">
                    <span class="text-xl font-bold">${Math.round(hour.temp_c)}°</span>
                `;
                container.appendChild(card);
            });
        }

        function renderAdvancedWeatherCards(data) {
            const container = document.getElementById('location-temps-container');
            if (!container) return;
            container.innerHTML = '';
             // Change layout to a flex column to stack the cards vertically
            container.className = 'flex flex-col gap-4 w-full flex-grow';

            // Create a container for the top two cards (Humidity and Best Time)
            const topCardsContainer = document.createElement('div');
            topCardsContainer.className = 'grid grid-cols-2 gap-4 w-full flex-grow';
            container.appendChild(topCardsContainer); // Append this container first

            // Card 1: Humidity
            const humidity = data.current.humidity;
            let humidityColor = 'text-green-400';
            let humidityDesc = 'منخفضة';
            if (humidity >= 60 && humidity < 75) {
                humidityColor = 'text-yellow-400';
                humidityDesc = 'معتدلة';
            } else if (humidity >= 75 && humidity < 85) {
                humidityColor = 'text-orange-400';
                humidityDesc = 'مرتفعة';
            } else if (humidity >= 85) {
                humidityColor = 'text-red-400';
                humidityDesc = 'مرتفعة جداً';
            }

            const humidityCard = document.createElement('div');
            humidityCard.className = 'glass-surface glass-surface--svg p-4 rounded-3xl flex flex-col items-center justify-center text-center navigable grid-item';
            humidityCard.tabIndex = 0;
            humidityCard.innerHTML = `
                <div class="flex items-center gap-3 mb-2">
                    <i data-lucide="droplets" class="w-8 h-8 ${humidityColor}"></i>
                    <h3 class="text-xl font-bold">مستوى الرطوبة</h3>
                </div>
                <div class="text-6xl font-extrabold ${humidityColor}">${humidity}%</div>
                <div class="text-lg text-white/80 mt-2">${humidityDesc}</div>
            `;
            topCardsContainer.appendChild(humidityCard);

            // Card 2: Best Time to Go Out (with 30-min intervals for next 6 hours)
            const hourlyData = [...data.forecast.forecastday[0].hour, ...data.forecast.forecastday[1]?.hour || []];
            const now = new Date();
            const sixHoursFromNowEpoch = (now.getTime() / 1000) + (6 * 3600);

            // Get the next 7 hours to have enough data for interpolation
            const upcomingRawHours = hourlyData.filter(h => new Date(h.time_epoch * 1000) > now).slice(0, 7);
            
            const interpolatedSlots = [];
            // Create slots for every 30 mins over the next 6 hours
            if (upcomingRawHours.length > 1) {
                for (let i = 0; i < upcomingRawHours.length - 1; i++) {
                    const currentHour = upcomingRawHours[i];
                    const nextHour = upcomingRawHours[i+1];

                    // Add the current full hour
                    interpolatedSlots.push(currentHour);

                    // Create the half-hour slot
                    const halfHourSlot = {
                        time_epoch: currentHour.time_epoch + 1800,
                        temp_c: (currentHour.temp_c + nextHour.temp_c) / 2,
                        uv: (currentHour.uv + nextHour.uv) / 2,
                        humidity: (currentHour.humidity + nextHour.humidity) / 2
                    };
                    interpolatedSlots.push(halfHourSlot);
                }
            } else if (upcomingRawHours.length === 1) {
                interpolatedSlots.push(upcomingRawHours[0]);
            }

            // Filter the final list to be strictly within the next 6 hours
            const next6HourSlots = interpolatedSlots.filter(slot => slot.time_epoch <= sixHoursFromNowEpoch);

            let bestHour = null;
            let bestScore = Infinity;

            if (next6HourSlots.length > 0) {
                next6HourSlots.forEach(hour => {
                    // تحديث منطق حساب النقاط: الأولوية للرطوبة الأقل، ثم الحرارة الأقل، ثم الأشعة فوق البنفسجية الأقل
                    const score = (hour.humidity * 1000) + (hour.temp_c * 100) + hour.uv;
                    if (score < bestScore) {
                        bestScore = score;
                        bestHour = hour;
                    }
                });
            } else {
                 // Fallback if no data is available
                 bestHour = { time_epoch: Date.now()/1000 + 3600, temp_c: data.current.temp_c, uv: data.current.uv, humidity: data.current.humidity };
            }


            const bestTime = new Date(bestHour.time_epoch * 1000).toLocaleTimeString('ar-OM', { hour: 'numeric', minute: '2-digit', hour12: true });

            const bestTimeCard = document.createElement('div');
            bestTimeCard.className = 'glass-surface glass-surface--svg p-4 rounded-3xl flex flex-col items-center justify-center text-center navigable grid-item';
            bestTimeCard.tabIndex = 0;
            bestTimeCard.innerHTML = `
                <div class="flex items-center gap-3 mb-3">
                     <i data-lucide="walk" class="w-8 h-8 text-green-300"></i>
                    <h3 class="text-xl font-bold">أفضل وقت للخروج</h3>
                </div>
                <div class="text-4xl font-extrabold text-green-300 mb-3">${bestTime}</div>
                <div class="grid grid-cols-3 gap-2 text-sm w-full">
                    <div class="bg-black/20 p-2 rounded-lg text-center">
                        <div class="font-bold text-lg ${getTempTextColor(bestHour.temp_c)}">${Math.round(bestHour.temp_c)}°C</div>
                        <div class="text-xs opacity-90">الحرارة</div>
                    </div>
                    <div class="bg-black/20 p-2 rounded-lg text-center">
                        <div class="font-bold text-lg ${getUvTextColor(bestHour.uv)}">${Math.round(bestHour.uv)}</div>
                        <div class="text-xs opacity-90">UV</div>
                    </div>
                    <div class="bg-black/20 p-2 rounded-lg text-center">
                        <div class="font-bold text-lg ${getHumidityTextColor(bestHour.humidity)}">${bestHour.humidity}%</div>
                        <div class="text-xs opacity-90">الرطوبة</div>
                    </div>
                </div>
            `;
            topCardsContainer.appendChild(bestTimeCard);
            
            // NOW, create and append the horizontal card LAST to the main container
            const currentConditions = data.current;
            const aqi = currentConditions.air_quality ? currentConditions.air_quality['us-epa-index'] : null;

            const nowCard = document.createElement('div');
            nowCard.className = 'glass-surface glass-surface--svg p-4 rounded-3xl w-full flex justify-around items-center text-center navigable grid-item';
            nowCard.tabIndex = 0;
            nowCard.innerHTML = `
                <div class="flex flex-col items-center gap-2">
                    <h4 class="text-sm font-bold text-white/70">مؤشر UV</h4>
                    <div class="text-2xl font-bold px-4 py-1 rounded-lg ${getUvColor(currentConditions.uv)}">
                        ${currentConditions.uv || '--'}
                  </div>
                </div>
                <div class="flex flex-col items-center gap-2">
                    <h4 class="text-sm font-bold text-white/70">الحرارة الآن</h4>
                    <div class="text-2xl font-bold px-4 py-1 rounded-lg ${getTempColor(currentConditions.temp_c)}">
                        ${Math.round(currentConditions.temp_c)}°C
                    </div>
                </div>
                <div class="flex flex-col items-center gap-2">
                    <h4 class="text-sm font-bold text-white/70">جودة الهواء</h4>
                    <div class="text-2xl font-bold px-4 py-1 rounded-lg ${getAqiColor(aqi)}">
                        ${aqi || '--'}
                    </div>
                </div>
            `;
            container.appendChild(nowCard);

            lucide.createIcons();
        }

        function getUvIndexColor(uv) { if (uv <= 2) return '#4ade80'; if (uv <= 5) return '#facc15'; if (uv <= 7) return '#fb923c'; if (uv <= 10) return '#f87171'; return '#c084fc'; }

        // --- NEW COLORING FUNCTIONS ---
        const getTempColor = (temp) => {
            const tempValue = parseFloat(temp);
            if (tempValue < 25) return 'bg-blue-500 text-white';
            if (tempValue <= 30) return 'bg-green-500 text-white';
            if (tempValue <= 35) return 'bg-yellow-400 text-black';
            return 'bg-red-500 text-white';
        };

        const getHumidityColorBestTime = (humidity) => {
            const humidityValue = parseInt(humidity);
            if (humidityValue < 60) return 'bg-cyan-500/90 text-white';
            if (humidityValue < 75) return 'bg-yellow-400/90 text-black';
            return 'bg-orange-500/90 text-white';
        };

        const getAqiColor = (aqi) => {
            const aqiValue = parseInt(aqi);
            if (aqiValue <= 1) return 'bg-green-500 text-white'; // US EPA Index 1-50 is 1
            if (aqiValue <= 2) return 'bg-yellow-400 text-black'; // 51-100 is 2
            if (aqiValue <= 3) return 'bg-orange-500 text-white'; // 101-150 is 3
            if (aqiValue <= 4) return 'bg-red-500 text-white'; // 151-200 is 4
            if (aqiValue <= 5) return 'bg-purple-500 text-white'; // 201-300 is 5
            return 'bg-red-800 text-white'; // > 300
        };

        const getUvColor = (uv) => {
            const uvValue = Math.round(uv);
            if (uvValue <= 2) return 'bg-green-500 text-white';
            if (uvValue <= 5) return 'bg-yellow-400 text-black';
            if (uvValue <= 7) return 'bg-orange-500 text-white';
            if (uvValue <= 10) return 'bg-red-500 text-white';
            return 'bg-purple-500 text-white';
        };

        // --- NEW TEXT COLORING FUNCTIONS ---
        const getTempTextColor = (temp) => {
            const tempValue = parseFloat(temp);
            if (tempValue < 25) return 'text-blue-400';
            if (tempValue <= 30) return 'text-green-400';
            if (tempValue <= 35) return 'text-yellow-400';
            return 'text-red-400';
        };

        const getHumidityTextColor = (humidity) => {
            const humidityValue = parseInt(humidity);
            if (humidityValue < 60) return 'text-cyan-400';
            if (humidityValue < 75) return 'text-yellow-400';
            return 'text-orange-400';
        };
        
        const getUvTextColor = (uv) => {
            const uvValue = Math.round(uv);
            if (uvValue <= 2) return 'text-green-400';
            if (uvValue <= 5) return 'text-yellow-400';
            if (uvValue <= 7) return 'text-orange-400';
            if (uvValue <= 10) return 'text-red-400';
            return 'text-purple-400';
        };


        // --- Simulated Car Data ---
        function simulateOtherCarData() { 
            appState.car.rpm = (Math.random() * 4200 + 800).toFixed(0); 
            appState.car.fuel = (Math.random() * 100).toFixed(0); 
            appState.car.temp = (Math.random() * 30 + 70).toFixed(1); 
            update3dScreenWidgets(); 
        }

        // --- Prayer Times Integration ---
        const prayerTimes = [{"date":"2025-10-13","fajr":"05:04","sunrise":"06:16","dhuhr":"12:15","asr":"15:36","maghrib":"18:09","isha":"19:16"},{"date":"2025-10-14","fajr":"05:04","sunrise":"06:16","dhuhr":"12:15","asr":"15:36","maghrib":"18:08","isha":"19:15"},{"date":"2025-10-15","fajr":"05:04","sunrise":"06:16","dhuhr":"12:14","asr":"15:36","maghrib":"18:07","isha":"19:15"},{"date":"2025-10-16","fajr":"05:04","sunrise":"06:17","dhuhr":"12:14","asr":"15:35","maghrib":"18:07","isha":"19:14"},{"date":"2025-10-17","fajr":"05:05","sunrise":"06:17","dhuhr":"12:14","asr":"15:35","maghrib":"18:06","isha":"19:14"},{"date":"2025-10-18","fajr":"05:05","sunrise":"06:17","dhuhr":"12:14","asr":"15:35","maghrib":"18:05","isha":"19:13"},{"date":"2025-10-19","fajr":"05:05","sunrise":"06:18","dhuhr":"12:14","asr":"15:34","maghrib":"18:05","isha":"19:12"},{"date":"2025-10-20","fajr":"05:05","sunrise":"06:18","dhuhr":"12:13","asr":"15:34","maghrib":"18:04","isha":"19:12"},{"date":"2025-10-21","fajr":"05:05","sunrise":"06:18","dhuhr":"12:13","asr":"15:34","maghrib":"18:04","isha":"19:11"},{"date":"2025-10-22","fajr":"05:06","sunrise":"06:18","dhuhr":"12:13","asr":"15:33","maghrib":"18:03","isha":"19:11"},{"date":"2025-10-23","fajr":"05:06","sunrise":"06:19","dhuhr":"12:13","asr":"15:33","maghrib":"18:02","isha":"19:10"},{"date":"2025-10-24","fajr":"05:06","sunrise":"06:19","dhuhr":"12:13","asr":"15:33","maghrib":"18:02","isha":"19:10"},{"date":"2025-10-25","fajr":"05:06","sunrise":"06:19","dhuhr":"12:13","asr":"15:33","maghrib":"18:01","isha":"19:09"},{"date":"2025-10-26","fajr":"05:07","sunrise":"06:20","dhuhr":"12:13","asr":"15:32","maghrib":"18:01","isha":"19:09"},{"date":"2025-10-27","fajr":"05:07","sunrise":"06:20","dhuhr":"12:13","asr":"15:32","maghrib":"18:00","isha":"19:08"},{"date":"2025-10-28","fajr":"05:07","sunrise":"06:20","dhuhr":"12:12","asr":"15:32","maghrib":"18:00","isha":"19:08"},{"date":"2025-10-29","fajr":"05:07","sunrise":"06:21","dhuhr":"12:12","asr":"15:31","maghrib":"17:59","isha":"19:07"},{"date":"2025-10-30","fajr":"05:08","sunrise":"06:21","dhuhr":"12:12","asr":"15:31","maghrib":"17:59","isha":"19:07"},{"date":"2025-10-31","fajr":"05:08","sunrise":"06:21","dhuhr":"12:12","asr":"15:31","maghrib":"17:58","isha":"19:07"}];

        function loadPrayerTimes() {
            const today = new Date().toISOString().split('T')[0];
            const data = prayerTimes.find(p => p.date === today);
            if (data) {
                appState.prayerTimes = { ...appState.prayerTimes, Fajr: data.fajr, Dhuhr: data.dhuhr, Asr: data.asr, Maghrib: data.maghrib, Isha: data.isha };
                prayerTimesContainer.innerHTML = '';
                const prayerOrder = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
                const prayerNames = { Fajr: 'الفجر', Dhuhr: 'الظهر', Asr: 'العصر', Maghrib: 'المغرب', Isha: 'العشاء' };
                const iqamaOffsets = { Fajr: 25, Dhuhr: 20, Asr: 20, Maghrib: 5, Isha: 20 };
                prayerOrder.forEach(key => {
                    const item = document.createElement('div');
                    item.className = 'prayer-time-item navigable grid-item';
                    item.tabIndex = 0;
                    const time = data[key.toLowerCase()];
                    item.innerHTML = `<span class="prayer-name">${prayerNames[key]}</span><span class="prayer-time">${time}</span><span class="prayer-iqama text-xs text-white/50">الإقامة: ${addMinutes(time, iqamaOffsets[key])}</span>`;
                    prayerTimesContainer.appendChild(item);
                });

                // Create a container for the action buttons
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex gap-2 mt-2 homebtn';

                // Ruqyah Button
                const ruqyahButton = document.createElement('button');
                ruqyahButton.id = 'ruqyah-tv-button';
                ruqyahButton.className = 'navigable grid-item w-1/2 bg-teal-500/50 hover:bg-teal-400/50 text-white font-bold p-2 rounded-lg shadow-lg text-lg transition-all duration-300 ease-in-out flex items-center justify-center gap-2';
                ruqyahButton.innerHTML = `<i data-lucide="shield-check" class="w-6 h-6"></i><span>الرقية الشرعية</span>`;
                ruqyahButton.tabIndex = 0;
                ruqyahButton.addEventListener('click', () => {
                setTimeout(() => searchYouTubeVideos('الرقية الشرعية النفيس'), 100);
                switchApp('Media');
                });
                
                // Adhkar Button
                const adhkarButton = document.createElement('button');
                adhkarButton.id = 'adhkar-tv-button';
                adhkarButton.className = 'navigable grid-item w-1/2 bg-sky-500/50 hover:bg-sky-400/50 text-white font-bold p-2 rounded-lg shadow-lg text-lg transition-all duration-300 ease-in-out flex items-center justify-center gap-2';
                adhkarButton.innerHTML = `<i data-lucide="sunrise" class="w-6 h-6"></i><span>الأذكار</span>`;
                adhkarButton.tabIndex = 0;
                adhkarButton.addEventListener('click', () => {
                    setTimeout(() => searchYouTubeVideos('أذكار الصباح والمساء'), 100);
                     switchApp('Media');
                });
                
                // Add buttons to their container, then add the container to the main prayer times area
                buttonContainer.appendChild(ruqyahButton);
                buttonContainer.appendChild(adhkarButton);
                prayerTimesContainer.appendChild(buttonContainer);

                lucide.createIcons();
                determineNextPrayer();
                updateDigitalClock();
            } else {
                prayerTimesContainer.innerHTML = `<p class="text-white/70 col-span-full">لا توجد أوقات صلاة لهذا اليوم.</p>`;
            }
        }
        function addMinutes(time, min) { const [h, m] = time.split(':').map(Number); const d = new Date(); d.setHours(h, m + min, 0, 0); return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }); }
        function timeToDate(time) { const [h, m] = time.split(':').map(Number); const d = new Date(); d.setHours(h, m, 0, 0); return d; }
        function determineNextPrayer() {
            const now = new Date();
            const todayTimings = appState.prayerTimes;
            if (!todayTimings.Fajr || todayTimings.Fajr === '--:--') return;

            // Get tomorrow's Fajr time to define the end of Isha's period
            const fajrTomorrowTime = timeToDate(todayTimings.Fajr);
            fajrTomorrowTime.setDate(fajrTomorrowTime.getDate() + 1);

            const prayers = [
                { n: "الفجر", t: todayTimings.Fajr, o: 25, g: 5 },
                { n: "الظهر", t: todayTimings.Dhuhr, o: 20, g: 5 },
                { n: "العصر", t: todayTimings.Asr, o: 20, g: 10 },
                { n: "المغرب", t: todayTimings.Maghrib, o: 5, g: 5 },
                { n: "العشاء", t: todayTimings.Isha, o: 20, g: 5 }
            ];

            appState.prayerTimes.currentPrayer = null;
            appState.prayerTimes.nextPrayer = null;
            appState.prayerTimes.nextPrayerIqamaTime = null;

            let currentPrayerData = null;
            let nextPrayerData = null;
            
            // Check yesterday's Isha for post-midnight times before today's Fajr
            const fajrTimeToday = timeToDate(todayTimings.Fajr);
            if (now < fajrTimeToday) {
                 const ishaTimeYesterday = timeToDate(todayTimings.Isha); // Assuming same time as today for simplicity
                 ishaTimeYesterday.setDate(ishaTimeYesterday.getDate() - 1);
                 
                 if (now > ishaTimeYesterday) {
                     const iqamaTimeYesterday = new Date(ishaTimeYesterday.getTime() + 20 * 60000);
                     currentPrayerData = { n: "العشاء", t: todayTimings.Isha, iqamaTime: iqamaTimeYesterday };
                     nextPrayerData = { n: "الفجر", pTime: fajrTimeToday };
                 }
            }

            // If not in the overnight period, run the normal logic for today.
            if (!currentPrayerData) {
                for (const p of prayers) {
                    const pTime = timeToDate(p.t);
                    const iqamaTime = timeToDate(addMinutes(p.t, p.o));
                    const graceEnd = new Date(iqamaTime.getTime() + p.g * 60000);
                    
                    if (now >= pTime && now < graceEnd) {
                        currentPrayerData = {...p, iqamaTime};
                    }
                    if (now < pTime && !nextPrayerData) {
                        nextPrayerData = {...p, pTime};
                    }
                }
            }

            // Now, set the state based on what was found.
            if (currentPrayerData) {
                appState.prayerTimes.currentPrayer = currentPrayerData.n;
                if (now < currentPrayerData.iqamaTime) { // Countdown to Iqama
                    appState.prayerTimes.nextPrayer = currentPrayerData.n;
                    appState.prayerTimes.nextPrayerIqamaTime = currentPrayerData.iqamaTime;
                } else { // Count up from Iqama
                    appState.prayerTimes.nextPrayer = nextPrayerData ? nextPrayerData.n : "الفجر (غدًا)";
                }
            } else if (nextPrayerData) { // Countdown to next Azan
                appState.prayerTimes.nextPrayer = nextPrayerData.n;
                appState.prayerTimes.nextPrayerIqamaTime = nextPrayerData.pTime;
            } else { // After Isha, before midnight
                 // Set current prayer to Isha to trigger count-up
                appState.prayerTimes.currentPrayer = "العشاء";
                appState.prayerTimes.nextPrayer = "الفجر (غدًا)";
            }
            renderPrayerTimesHighlights();
        }
        function renderPrayerTimesHighlights() { if (!prayerTimesContainer) return; document.querySelectorAll('.prayer-time-item').forEach(i => i.classList.remove('current-prayer', 'next-prayer')); if (appState.prayerTimes.currentPrayer) { const item = Array.from(prayerTimesContainer.querySelectorAll('.prayer-name')).find(s => s.textContent === appState.prayerTimes.currentPrayer)?.parentElement; if (item) item.classList.add('current-prayer'); } if (appState.prayerTimes.nextPrayer && appState.prayerTimes.nextPrayer !== appState.prayerTimes.currentPrayer) { const nextPrayerName = appState.prayerTimes.nextPrayer.replace(' (غدًا)', ''); const item = Array.from(prayerTimesContainer.querySelectorAll('.prayer-name')).find(s => s.textContent === nextPrayerName)?.parentElement; if (item && !item.classList.contains('current-prayer')) item.classList.add('next-prayer'); } }
        
        // --- Digital Clock ---
        function updateDigitalClock() { const now = new Date(); const h = now.getHours(); const m = now.getMinutes(); const s = now.getSeconds(); digitalHoursSpan.textContent = h.toString().padStart(2, '0'); digitalMinutesSpan.textContent = m.toString().padStart(2, '0'); digitalSecondsSpan.textContent = s.toString().padStart(2, '0'); digitalDateLine1.classList.remove('countdown-azan', 'countdown-iqama', 'countdown-up'); digitalDateLine2.classList.remove('countdown-azan', 'countdown-iqama', 'countdown-up'); if (appState.prayerTimes.nextPrayerIqamaTime) { const diff = appState.prayerTimes.nextPrayerIqamaTime - now; const totalSecs = Math.floor(diff / 1000); const secs = totalSecs % 60; const mins = Math.floor((totalSecs / 60) % 60); const hrs = Math.floor(totalSecs / 3600); const currentPrayerData = appState.prayerTimes.currentPrayer ? [{ n: "الفجر", t: appState.prayerTimes.Fajr, o: 25 }, { n: "الظهر", t: appState.prayerTimes.Dhuhr, o: 20 }, { n: "العصر", t: appState.prayerTimes.Asr, o: 20 }, { n: "المغرب", t: appState.prayerTimes.Maghrib, o: 5 }, { n: "العشاء", t: appState.prayerTimes.Isha, o: 20 }].find(p => p.n === appState.prayerTimes.currentPrayer) : null; const isAfterAzan = currentPrayerData && now >= timeToDate(currentPrayerData.t) && now < timeToDate(addMinutes(currentPrayerData.t, currentPrayerData.o)); if (isAfterAzan) { digitalDateLine1.textContent = `إقامة صلاة ${appState.prayerTimes.currentPrayer} في:`; digitalDateLine2.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`; digitalDateLine1.classList.add('countdown-iqama'); digitalDateLine2.classList.add('countdown-iqama'); } else { digitalDateLine1.textContent = `الأذان القادم: ${appState.prayerTimes.nextPrayer}`; digitalDateLine2.textContent = hrs > 0 ? `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}` : `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`; digitalDateLine1.classList.add('countdown-azan'); digitalDateLine2.classList.add('countdown-azan'); } } else if (appState.prayerTimes.currentPrayer) { const prayerTimeStr = appState.prayerTimes[appState.prayerTimes.currentPrayer]; const iqamaOffset = { "الفجر": 25, "الظهر": 20, "العصر": 20, "المغرب": 5, "العشاء": 20 }[appState.prayerTimes.currentPrayer] || 20; let iqamaTime = timeToDate(addMinutes(prayerTimeStr, iqamaOffset)); if (appState.prayerTimes.currentPrayer === 'العشاء' && now < iqamaTime) { iqamaTime.setDate(iqamaTime.getDate() - 1); } const diff = now - iqamaTime; const totalSecs = Math.floor(diff / 1000); const secs = totalSecs % 60; const mins = Math.floor(totalSecs / 60); digitalDateLine1.textContent = `انتهت الصلاة منذ:`; digitalDateLine2.textContent = `+${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`; digitalDateLine1.classList.add('countdown-up'); digitalDateLine2.classList.add('countdown-up'); } else if (appState.prayerTimes.nextPrayer) { digitalDateLine1.textContent = `الأذان القادم: ${appState.prayerTimes.nextPrayer}`; digitalDateLine2.textContent = ''; } else { digitalDateLine1.textContent = 'جاري تحميل أوقات الصلاة...'; digitalDateLine2.textContent = ''; } }

        // --- 360 Camera ---
        function handleImageUpload(e) { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (ev) => { appState.custom360Image = ev.target.result; localStorage.setItem('custom360Image', ev.target.result); updateUI(); }; reader.readAsDataURL(file); } }
        function resetImageToDefault() { appState.custom360Image = null; localStorage.removeItem('custom360Image'); updateUI(); }

        // --- NEW: 3D Screen Widgets Update ---
        function update3dScreenWidgets() {
            const nextPrayerEl = document.getElementById('3d-screen-next-prayer');
            const speedEl = document.getElementById('3d-screen-speed');
            const gearEl = document.getElementById('3d-screen-gear');
            const dirEl = document.getElementById('3d-screen-dir');

            if (nextPrayerEl) nextPrayerEl.textContent = appState.prayerTimes.nextPrayer || '--';
            if (speedEl) speedEl.textContent = `${appState.car.speed} km/h`;
            if (gearEl) gearEl.textContent = appState.car.gear;
            if (dirEl) dirEl.textContent = appState.car.direction;
        }

        // --- Draggable/Resizable Popup Logic ---
        let isDragging = false;
        let offsetX, offsetY;
        videoPopupContainer.addEventListener('mousedown', (e) => {
            if (e.target === videoPopupContainer || e.target.closest('.video-popup-controls')) {
                isDragging = true;
                offsetX = e.clientX - videoPopupContainer.offsetLeft;
                offsetY = e.clientY - videoPopupContainer.offsetTop;
                videoPopupContainer.style.cursor = 'grabbing';
                videoPopupPlayerContainer.style.pointerEvents = 'none';
            }
        });
        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                videoPopupContainer.style.left = `${e.clientX - offsetX}px`;
                videoPopupContainer.style.top = `${e.clientY - offsetY}px`;
                videoPopupContainer.style.bottom = 'auto';
                videoPopupContainer.style.right = 'auto';
            }
        });
        document.addEventListener('mouseup', () => {
            isDragging = false;
            videoPopupContainer.style.cursor = 'grab';
            videoPopupPlayerContainer.style.pointerEvents = 'auto';
        });

        // --- Swipe Gesture Handling (NEW) ---
    

        // --- TV Remote / Keyboard Navigation ---
        let currentFocus = null;
        function setFocus(el) { if (currentFocus) currentFocus.classList.remove('tv-focus'); if (el) { el.classList.add('tv-focus'); el.focus({ preventScroll: true }); currentFocus = el; el.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' }); } else { if (currentFocus) currentFocus.classList.remove('tv-focus'); currentFocus = null; } }
        
        // --- MASTER KEY HANDLER (REFACTORED) ---
        function handleRemoteControlInput(e) {
            const key = e.key.toLowerCase();
            const activeEl = document.activeElement;

            // --- NEW GLOBAL SHORTCUTS for 1 and 2 ---
            if (key === '1') {
                e.preventDefault();
                switchApp('Media');
                youtubeSearchInput.value = "الكلمات الصعبة في";
                youtubeSearchInput.readOnly = false;
                youtubeSearchInput.focus();
                floatingKeyboardButton.classList.add('active-keyboard');
                floatingKeyboardButton.classList.remove('inactive-keyboard');
                return; // Handled
            }

            if (key === '2') {
                e.preventDefault();
                switchApp('Media');
                selectedReaderName = ""; // No specific reader
                youtubeSearchInput.value = "";
                
                // Ensure suggestions are ready by resetting the view
                if (youtubeSuggestionsDiv.style.display === 'none' || !document.getElementById('youtube-readers-section')) {
                    resetYoutubeSearchUI();
                }
                
                // Use timeout to allow the UI to render before manipulating it
                setTimeout(() => {
                    const readersSection = document.getElementById('youtube-readers-section');
                    if (readersSection) {
                        readersSection.style.display = 'none';
                    }
                    showSurahSuggestions();
                    setTimeout(() => {
                        const firstSurah = document.querySelector('#youtube-surah-section .grid-item');
                        if (firstSurah) setFocus(firstSurah);
                    }, 100);
                }, 50);
                return; // Handled
            }

            // --- Priority 1: Video Player is Active ---
            if (videoPopupContainer.classList.contains('active') || appState.isVideoPlayerMinimized) {
                const customHandledKeys = [
                    'arrowup', 'arrowdown', 'arrowleft', 'arrowright',
                    'enter', 'ok', 'p',
                    'b', 'stop', 'red', 'colorf0red', 'x',
                    'yellow', 'colorf2yellow', '8',
                    '9' // Added for fullscreen
                ];

                if (customHandledKeys.includes(key)) {
                    e.preventDefault();

                    if (key === 'yellow' || key === 'colorf2yellow' || key === '8') {
                        if (appState.isVideoPlayerMinimized) restoreVideoPopup();
                        else minimizeVideoPopup();
                        return;
                    }
                    if (key === 'b' || key === 'stop' || key === 'red' || key === 'colorf0red' || key === 'x') {
                        hideVideoPopup();
                        return;
                    }
                    if (key === 'enter' || key === 'ok' || key === 'p') {
                        const playerState = popupPlayer.getPlayerState();
                        if (playerState === YT.PlayerState.PLAYING) popupPlayer.pauseVideo();
                        else popupPlayer.playVideo();
                        return;
                    }
                    if (key === '9') {
                        toggleFullScreen();
                        return;
                    }
                    
                    const currentTime = popupPlayer.getCurrentTime();
                    const currentVolume = popupPlayer.getVolume();
                    switch (key) {
                        case 'arrowright':
                            popupPlayer.seekTo(currentTime + 10, true);
                            break;
                        case 'arrowleft':
                            popupPlayer.seekTo(currentTime - 10, true);
                            break;
                        case 'arrowup':
                            const newVolUp = Math.min(currentVolume + 10, 100);
                            popupPlayer.setVolume(newVolUp);
                            showMessageBox(`الصوت: ${newVolUp}%`);
                            break;
                        case 'arrowdown':
                            const newVolDown = Math.max(currentVolume - 10, 0);
                            popupPlayer.setVolume(newVolDown);
                            showMessageBox(`الصوت: ${newVolDown}%`);
                            break;
                    }
                }
                // For other keys (like 'f', 'm', spacebar), do nothing and let the event bubble up.
                return;
            }

            // --- Priority 2: Typing in Search Bar ---
            const isTyping = !youtubeSearchInput.readOnly && activeEl === youtubeSearchInput;
            if (isTyping) {
                if (key === 'enter' || key === 'ok') {
                    e.preventDefault();
                    youtubeSearchButton.click();
                } else if (key.length === 1 && (key.match(/[a-z0-9\s]/i) || key.match(/[\u0600-\u06FF]/))) {
                    // Allow default typing
                } else if (key === 'backspace') {
                    // Allow default backspace
                } else {
                    handleNavigation(e);
                }
                return;
            }

            // --- Priority 3: Standard Arrow/OK Navigation ---
            handleNavigation(e);
        }

        function handleNavigation(e) {
            const key = e.key.toLowerCase();
            if (!['arrowup', 'arrowdown', 'arrowleft', 'arrowright', 'enter', 'ok'].includes(key)) return;
            
            e.preventDefault(); // Prevent default scroll for navigation keys

            const activeEl = document.activeElement;
            if (!activeEl || activeEl === document.body) {
                const firstIcon = document.querySelector('nav .app-icon');
                if (firstIcon) setFocus(firstIcon);
                return;
            }

            const inNav = activeEl.closest('nav');
            const inMediaScreen = activeEl.closest('#screen-Media');

            if (inNav) {
                handleNavSidebarNavigation(e, activeEl);
            } else if (inMediaScreen) {
                handleMediaScreenNavigation(e, activeEl);
            } else {
                const container = activeEl.closest('.grid-container');
                if (container) {
                    handleGenericGridNavigation(e, activeEl, container);
                }
            }
        }

        function handleNavSidebarNavigation(e, activeEl) {
            const icons = Array.from(document.querySelectorAll('nav .app-icon'));
            const idx = icons.indexOf(activeEl);
            let nextIdx = -1;
            switch (e.key.toLowerCase()) {
                case 'arrowup':
                    nextIdx = idx > 0 ? idx - 1 : icons.length - 1;
                    break;
                case 'arrowdown':
                    nextIdx = idx < icons.length - 1 ? idx + 1 : 0;
                    break;
                case 'arrowright': // In RTL, right arrow should go to main content
                    const screen = document.querySelector('.app-screen.active');
                    if (screen) {
                        const firstItem = screen.querySelector('.grid-item');
                        if (firstItem) setFocus(firstItem);
                    }
                    return;
                case 'enter': case 'ok':
                    activeEl.click();
                    return;
            }
            if (nextIdx !== -1) setFocus(icons[nextIdx]);
        }
        
        function handleMediaScreenNavigation(e, activeEl) {
            const searchRow = document.querySelector('#screen-Media .flex.flex-row.items-center.gap-2.grid-container');
            const readersContainer = document.querySelector('.reader-container');
            const surahContainer = document.querySelector('#youtube-surah-section');
            const videoListContainer = document.querySelector('#video-list-container');
            const searchResultsContainer = document.querySelector('#search-results-container');
            const inSearchRow = activeEl.closest('.flex.flex-row.items-center.gap-2.grid-container');
            const inReaders = activeEl.closest('.reader-container');

            if (e.key.toLowerCase() === 'arrowdown') {
                if (inSearchRow) {
                    const nextVisibleContainer = [readersContainer, surahContainer, videoListContainer, searchResultsContainer].find(c => c && c.offsetParent !== null);
                    if (nextVisibleContainer) {
                        const firstItem = nextVisibleContainer.querySelector('.grid-item');
                        if (firstItem) { setFocus(firstItem); return; }
                    }
                }
                if (inReaders) {
                    if (surahContainer && surahContainer.offsetParent !== null) {
                        const firstItem = surahContainer.querySelector('.grid-item');
                        if (firstItem) { setFocus(firstItem); return; }
                    }
                }
            }

            if (e.key.toLowerCase() === 'arrowup') {
                const currentContainer = activeEl.closest('.grid-container, .reader-container');
                if (currentContainer && currentContainer !== searchRow) {
                    const items = Array.from(currentContainer.querySelectorAll('.grid-item:not([style*="display: none"])')).filter(el => el.offsetParent !== null);
                    const idx = items.indexOf(activeEl);
                    if (idx !== -1) {
                        const firstItemTop = items[0].getBoundingClientRect().top;
                        let cols = items.filter(item => Math.abs(item.getBoundingClientRect().top - firstItemTop) < 20).length;
                        if (cols === 0) cols = 1;
                        if (idx < cols) { setFocus(youtubeSearchInput); return; }
                    }
                }
            }
            if (inReaders) {
                const items = Array.from(readersContainer.querySelectorAll('.grid-item'));
                const idx = items.indexOf(activeEl);
                if (e.key.toLowerCase() === 'arrowleft') { if (idx > 0) setFocus(items[idx - 1]); } 
                else if (e.key.toLowerCase() === 'arrowright') { if (idx < items.length - 1) setFocus(items[idx + 1]); } 
                else if (e.key.toLowerCase() === 'enter' || e.key.toLowerCase() === 'ok') { activeEl.click(); } 
                else if (e.key.toLowerCase() === 'arrowleft' && idx === 0) { const navIcon = document.querySelector('nav .app-icon.active'); if (navIcon) setFocus(navIcon); }
                return;
            }
            const container = activeEl.closest('.grid-container');
            if (container) { handleGenericGridNavigation(e, activeEl, container); }
        }

        function handleGenericGridNavigation(e, activeEl, container) {
            const items = Array.from(container.querySelectorAll('.grid-item:not([style*="display: none"])')).filter(el => el.offsetParent !== null);
            if (items.length === 0) return;
            const idx = items.indexOf(activeEl);
            if (idx === -1) return;
            const firstItemTop = items[0].getBoundingClientRect().top;
            let cols = items.filter(item => Math.abs(item.getBoundingClientRect().top - firstItemTop) < 20).length;
            if (cols === 0) cols = 1;
            const isTopRow = idx < cols;
            let nextIdx = -1;
            switch (e.key.toLowerCase()) {
                case 'arrowup': if (!isTopRow) { nextIdx = idx - cols; } break;
                case 'arrowdown': nextIdx = idx + cols; break;
                case 'arrowright': if (idx % cols !== 0) { nextIdx = idx - 1; } break;
                case 'arrowleft':
                    if ((idx + 1) % cols === 0 || idx === items.length - 1) {
                        const navIcon = document.querySelector('nav .app-icon.active');
                        if (navIcon) setFocus(navIcon);
                        return;
                    } else { nextIdx = idx + 1; }
                    break;
                case 'enter': case 'ok': activeEl.click(); return;
            }
            if (nextIdx >= 0 && nextIdx < items.length) { setFocus(items[nextIdx]); }
        }
        
        // --- Welcome Voice Message ---
        function playWelcomeMessage() {
            const today = new Date();
            today.setFullYear(2025);
            const gregorianDate = new Intl.DateTimeFormat('en-UK', {  year: 'numeric', month: 'long', day: 'numeric' }).format(today);
            const hijriDate = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', { weekday: 'long'}).format(today);

            let welcomeText = '';
            let weatherText = '';

            const speak = (textToSpeak) => {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(textToSpeak);
                    const voices = window.speechSynthesis.getVoices();
                    // Try to find a male Arabic voice, fallback to any Arabic voice
                    let arabicVoice = voices.find(voice => voice.lang.startsWith('ar') && voice.name.includes('Male'));
                    if (!arabicVoice) {
                        arabicVoice = voices.find(voice => voice.lang.startsWith('ar'));
                    }
                    if (arabicVoice) {
                        utterance.voice = arabicVoice;
                    }
                    utterance.lang = 'ar-SA';
                    utterance.rate = 0.9;
                    window.speechSynthesis.speak(utterance);
                } else {
                    console.log('Text-to-speech not supported in this browser.');
                }
            };

            const speakWithVoicesReady = (text) => {
                 if (window.speechSynthesis.getVoices().length === 0) {
                    window.speechSynthesis.onvoiceschanged = () => {
                        speak(text);
                    };
                } else {
                    speak(text);
                }
            }

            // Check if weather data is ready before proceeding
            const checkWeatherAndSpeak = () => {
                if (appState.weather.temperature !== null) {
                    welcomeText = `مرحبا تاريخ اليوم ${hijriDate} الموافق ${gregorianDate}    `;
                    speakWithVoicesReady(welcomeText);

                    setTimeout(() => {
                        weatherText = `حالة الطقس الان ${appState.weather.temperature} ${appState.weather.temperature} درجة مئوية`;
                        speakWithVoicesReady(weatherText);
                    }, 8000); 
                } else {
                    // If weather data isn't ready, wait and try again.
                    setTimeout(checkWeatherAndSpeak, 500);
                }
            };

            checkWeatherAndSpeak();
        }

        // --- Fullscreen Toggle ---
        function toggleFullScreen() {
            let elem;
            if (videoPopupContainer.classList.contains('active')) {
                elem = popupPlayer.getIframe();
            } else {
                elem = document.documentElement;
            }

            if (!document.fullscreenElement) {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) { /* Safari */
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) { /* IE11 */
                    elem.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => { 
            // Standard Listeners
            getMyLocationButtonDashboard?.addEventListener('click', centerMapOnUserLocation);
            goToHome1Button?.addEventListener('click', () => calculateAndDisplayRouteTo(HOME1_COORDS));
            goToHome2Button?.addEventListener('click', () => calculateAndDisplayRouteTo(HOME2_COORDS));
            floatingMediaButton?.addEventListener('click', () => switchApp('Media')); 
            floatingMinimizedVideoButton?.addEventListener('click', restoreVideoPopup); // NEW listener
            

    // ... (الكود الموجود لديك)

    // Initial Calls
   
    Promise.all([fetchFavorites('D'), fetchFavorites('M')]).then(([d, m]) => {
        favoritesD = d;
        favoritesM = m;
    });

    loadGoogleMaps().then(initMap);
    fetchWeatherData(); 
    loadPrayerTimes();
    updateFullDateWidget(); // <-- أضف هذا السطر (استدعاء أولي)

    // Play welcome message once after a short delay
    setTimeout(playWelcomeMessage, 1500);

    setInterval(fetchWeatherData, 300000); 
    setInterval(updateDigitalClock, 1000); 
    setInterval(determineNextPrayer, 60000);
    setInterval(updateFullDateWidget, 60000); // <-- أضف هذا السطر (تحديث دوري)
    setInterval(simulateOtherCarData, 2000);

    // ... (بقية الكود)


            
            // NEW/UPDATED: Event listener for the floating back button
            backToSearchFloatingButton.addEventListener('click', () => {
                // If we are on the suggestions screen AND we have a previous search to go back to...
                if (activeMediaView === 'suggestions' && lastSuccessfulSearchQuery) {
                    searchYouTubeVideos(lastSuccessfulSearchQuery); // ...then re-run that search.
                } else {
                    // Otherwise (i.e., we are on the search results screen), perform the original "back" action.
                    navigateBackToMainSearch();
                }
            });

            startTripFloatingButton?.addEventListener('click', () => { if (appState.destinationSet) calculateAndDisplayRoute(); else showMessageBox('الرجاء تحديد وجهة أولاً.'); }); 
            upload360ImageButton?.addEventListener('click', () => upload360ImageInput.click()); 
            upload360ImageInput?.addEventListener('change', handleImageUpload); 
            reset360ImageButton?.addEventListener('click', resetImageToDefault); 
            document.addEventListener('keydown', handleRemoteControlInput);
            document.addEventListener('fullscreenchange', handleFullScreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullScreenChange); // For Safari
            
            videoPopupCloseButton.addEventListener('click', hideVideoPopup);
            backToPlaylistsFromVideosButton.addEventListener('click', navigateBackToMainSearch);
            backToPlaylistsBottomButton.addEventListener('click', navigateBackToMainSearch);
            backToPlaylistsBottomButtonSearch.addEventListener('click', navigateBackToMainSearch);
            floatingKeyboardButton.addEventListener('click', () => { 
                youtubeSearchInput.readOnly = !youtubeSearchInput.readOnly; 
                if (!youtubeSearchInput.readOnly) {
                    youtubeSearchInput.focus(); 
                } else {
                    youtubeSearchInput.blur();
                    // Return focus to the search button after disabling keyboard
                    setFocus(youtubeSearchButton);
                }
                floatingKeyboardButton.classList.toggle('active-keyboard', !youtubeSearchInput.readOnly); 
                floatingKeyboardButton.classList.toggle('inactive-keyboard', youtubeSearchInput.readOnly); 
            });
            
            // UPDATED: Clear button logic
            clearSearchButton.addEventListener('click', () => {
                youtubeSearchInput.value = ''; // Clear input immediately
                lastSuccessfulSearchQuery = null; // NEW: Clear the last search memory
                navigateBackToMainSearch();
            });

            youtubeSearchInput.addEventListener('focus', () => { if (youtubeSearchInput.value.trim() === '') { resetYoutubeSearchUI(); } });
            youtubeSearchButton.addEventListener('click', () => { const query = youtubeSearchInput.value.trim(); if (query) searchYouTubeVideos(query); else showMessageBox('الرجاء إدخال كلمة للبحث.'); });
            
            // UPDATED: Auto-search for Tarteel channel with pre-click effect
            youtubeSearchInput.addEventListener('input', () => {
                const targetText = 'ترتيل-@TarteelArabic';
                const currentText = youtubeSearchInput.value;

                if (currentText.includes(targetText + ' ')) {
                    // If text with space is present, visually confirm and trigger the click
                    youtubeSearchButton.classList.add('tv-focus'); 
                    setTimeout(() => {
                        youtubeSearchButton.click();
                        // Optional: remove focus style after click to reset state
                        setTimeout(() => youtubeSearchButton.classList.remove('tv-focus'), 100);
                    }, 50);
                } else if (currentText.includes(targetText)) {
                    // If only the text (no space) is present, show pre-click effect
                    youtubeSearchButton.classList.add('tv-focus');
                } else {
                    // If the text is not present, remove the effect
                    youtubeSearchButton.classList.remove('tv-focus');
                }
            });

            // NEW Listeners for Animation and Zoom Controls
            pauseAnimationButton.addEventListener('click', () => {
                document.body.classList.toggle('animation-paused');
                const isPaused = document.body.classList.contains('animation-paused');
                const playIcon = pauseAnimationButton.querySelector('[data-lucide="play"]');
                const pauseIcon = pauseAnimationButton.querySelector('[data-lucide="pause"]');
                playIcon.classList.toggle('hidden', !isPaused);
                pauseIcon.classList.toggle('hidden', isPaused);
            });

            removeCacheButton.addEventListener('click', () => {
                localStorage.clear();
                showMessageBox('تم مسح ذاكرة التخزين المؤقت بنجاح. سيتم إعادة تحميل التطبيق.');
                setTimeout(() => {
                    location.reload();
                }, 2000);
            });

            zoomInButton.addEventListener('click', () => {
                if (currentFontSize < maxFontSize) {
                    currentFontSize += fontSizeStep;
                    document.documentElement.style.fontSize = `${currentFontSize}px`;
                }
            });

            zoomOutButton.addEventListener('click', () => {
                if (currentFontSize > minFontSize) {
                    currentFontSize -= fontSizeStep;
                    document.documentElement.style.fontSize = `${currentFontSize}px`;
                }
            });

            // Initial Calls
           
            loadGoogleMaps().then(initMap);
            fetchWeatherData(); 
            loadPrayerTimes();
            setInterval(fetchWeatherData, 300000); 
            setInterval(updateDigitalClock, 1000); 
            setInterval(determineNextPrayer, 60000);
            setInterval(simulateOtherCarData, 2000); // Call the modified simulation
            switchApp('Dashboard'); 
            
            // Play welcome message once after a short delay
            setTimeout(playWelcomeMessage, 1500);

            // --- START: Islamic Daily Reminders Logic ---
            // NEW: Helper functions for managing manual states
            // --- دوال جديدة للتعامل مع الحالات بشكل محلي ---

// --- NEW & CORRECTED: Helper functions for managing manual states via Server ---

async function getManualReminderStates() {
    try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID_REMINDERS}/latest`, {
            headers: {
                'X-Access-Key': JSONBIN_ACCESS_KEY_REMINDERS
            }
        });
        if (!response.ok) {
            console.error('Failed to fetch reminder states:', response.statusText);
            return {};
        }
        const data = await response.json();
        const states = data.record || {};
        
        // If the only thing in the bin is our placeholder, return an empty object
        if (Object.keys(states).length === 1 && states._init) {
            return {};
        }
        return states;

    } catch (error) {
        if (error instanceof SyntaxError) {
             console.log("Bin is likely empty or invalid. Returning default state.");
             return {};
        }
        console.error('Error in getManualReminderStates:', error);
        return {};
    }
}

async function setManualReminderState(reminderId, state) {
    let currentStates = await getManualReminderStates();
    
    if (state === 'auto') {
        delete currentStates[reminderId];
    } else {
        currentStates[reminderId] = state;
    }

    // ✅ THE FIX: If the object becomes empty, add a placeholder
    if (Object.keys(currentStates).length === 0) {
        currentStates = { "_init": true };
    }

    try {
        await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID_REMINDERS}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-Master-Key': JSONBIN_API_KEY
            },
            body: JSON.stringify(currentStates)
        });
    } catch (error) {
        console.error('Error writing to JSONBin:', error);
        showMessageBox('حدث خطأ أثناء حفظ الحالة.');
    }
    
    // We pass the *real* state (without the placeholder) to the renderer
    if (currentStates._init) {
        renderDailyReminders({});
    } else {
        renderDailyReminders(currentStates);
    }
    closeAllDropdowns();
}

            // NEW: Function to create and manage the dropdown
            function createReminderDropdown(reminderId, parentElement) {
                closeAllDropdowns(); // Close any other open dropdowns first

                const dropdown = document.createElement('div');
                dropdown.className = 'reminder-status-dropdown show';
                dropdown.innerHTML = `
                    <button data-state="active" class="navigable grid-item" tabindex="0">حالي</button>
                    <button data-state="completed" class="navigable grid-item" tabindex="0">منتهي</button>
                    <button data-state="missed" class="navigable grid-item" tabindex="0">فائت</button>
                    <hr class="border-white/10 my-1">
                    <button data-state="auto" class="navigable grid-item" tabindex="0">تلقائي</button>
                `;
                parentElement.appendChild(dropdown);

                dropdown.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent the main click listener from firing again
                        const state = button.dataset.state;
                        setManualReminderState(reminderId, state);
                    });
                });
                 // Focus the first button in the dropdown
                const firstButton = dropdown.querySelector('button');
                if (firstButton) setFocus(firstButton);
            }

            function closeAllDropdowns() {
                document.querySelectorAll('.reminder-status-dropdown').forEach(d => d.remove());
            }

            // 1. تعريف قائمة الأذكار والعبادات مع الشروط الخاصة بها
            const dailyReminders = [
    { id: 'adhkar_morning', name: 'أذكار الصباح', icon: 'sunrise', isActive: (now, times) => now >= times.Fajr && now < times.Dhuhr, getStartTime: (now, times) => times.Fajr, getEndTime: (now, times) => times.Dhuhr, action: () => { switchApp('Media'); searchYouTubeVideos('أذكار الصباح كاملة'); } },
    { id: 'salat_duha', name: 'صلاة الضحى', icon: 'sun', isActive: (now, times) => { if (!times.Sunrise || !times.Dhuhr) return false; const sunriseTime = new Date(times.Sunrise.getTime() + 20 * 60000); const dhuhrTime = new Date(times.Dhuhr.getTime() - 10 * 60000); return now >= sunriseTime && now < dhuhrTime; }, getStartTime: (now, times) => { if (!times.Sunrise) return null; return new Date(times.Sunrise.getTime() + 20 * 60000); }, getEndTime: (now, times) => { if (!times.Dhuhr) return null; return new Date(times.Dhuhr.getTime() - 10 * 60000); }, action: () => showMessageBox('صلاة الضحى سنة مؤكدة، ووقتها من بعد شروق الشمس وارتفاعها قدر رمح إلى قبيل وقت صلاة الظهر.') },
    { id: 'sunan_rawatib', name: 'السنن الرواتب', icon: 'calendar-check', isActive: (now, times) => { if (!times.Fajr || !times.Dhuhr || !times.Maghrib || !times.Isha) return false; const tenMinutes = 10 * 60 * 1000; if (now < times.Fajr && (times.Fajr.getTime() - now.getTime()) <= tenMinutes) return true; if (now < times.Dhuhr && (times.Dhuhr.getTime() - now.getTime()) <= tenMinutes) return true; if (now > times.Dhuhr && (now.getTime() - times.Dhuhr.getTime()) <= tenMinutes) return true; if (now > times.Maghrib && (now.getTime() - times.Maghrib.getTime()) <= tenMinutes) return true; if (now > times.Isha && (now.getTime() - times.Isha.getTime()) <= tenMinutes) return true; return false; }, getStartTime: null, getEndTime: null, action: () => showMessageBox('السنن الرواتب: ركعتان قبل الفجر، أربع قبل الظهر، ركعتان بعده، ركعتان بعد المغرب، وركعتان بعد العشاء.') },
    { id: 'adhkar_evening', name: 'أذكار المساء', icon: 'sunset', isActive: (now, times) => now >= times.Asr && now.getHours() < 23, getStartTime: (now, times) => times.Asr, getEndTime: (now, times) => { const d = new Date(now); d.setHours(22, 59, 59, 999); return d; }, action: () => { switchApp('Media'); searchYouTubeVideos('أذكار المساء كاملة'); } },
    { id: 'wird_daily', name: 'الورد اليومي', icon: 'book-marked', isActive: (now, times) => true, getStartTime: null, getEndTime: null, action: () => switchApp('Quran') },
    { id: 'surah_mulk', name: 'سورة الملك', icon: 'moon', isActive: (now, times) => now >= times.Isha || now < times.Fajr, getStartTime: (now, times) => times.Isha, getEndTime: (now, times) => { if (now < times.Fajr) return times.Fajr; return new Date(times.Fajr.getTime() + 24 * 60 * 60 * 1000); }, action: () => { switchApp('Media'); searchYouTubeVideos('سورة الملك كاملة'); } },
                { id: 'salat_witr', name: 'صلاة الوتر', icon: 'star', isActive: (now, times) => now >= times.Isha || now < times.Fajr, getStartTime: (now, times) => times.Isha, getEndTime: (now, times) => { if (now < times.Fajr) return times.Fajr; return new Date(times.Fajr.getTime() + 24 * 60 * 60 * 1000); }, action: () => showMessageBox('صلاة الوتر سنة مؤكدة، وأقلها ركعة واحدة، ووقتها من بعد صلاة العشاء إلى طلوع الفجر.') },
                { id: 'adhkar_sleep', name: 'قيام الليل ', icon: 'bed', isActive: (now, times) => now.getHours() >= 23, getStartTime: (now, times) => { const d = new Date(now); d.setHours(23, 0, 0, 0); return d; }, getEndTime: (now, times) => { const d = new Date(now); d.setHours(23, 59, 59, 999); return d; }, action: () => { switchApp('Media'); searchYouTubeVideos('أذكار النوم'); } }
            ];

            // 2. دالة لإنشاء وعرض القائمة (MODIFIED)
         // ✅ Corrected Version of the function
async function renderDailyReminders(states) { // We added 'async' and 'states' here
    const container = document.getElementById('tv');
    if (!container || !appState.prayerTimes.Fajr || appState.prayerTimes.Fajr === '--:--') return;

    // If no states are passed in, fetch them. Otherwise, use the states that were passed.
    const manualStates = states || await getManualReminderStates(); // We added 'await' here

    const now = new Date();
    const prayerDateTimes = {
        Fajr: timeToDate(appState.prayerTimes.Fajr),
        Sunrise: timeToDate(appState.prayerTimes.Sunrise || '06:15'),
        Dhuhr: timeToDate(appState.prayerTimes.Dhuhr),
        Asr: timeToDate(appState.prayerTimes.Asr),
        Maghrib: timeToDate(appState.prayerTimes.Maghrib),
        Isha: timeToDate(appState.prayerTimes.Isha)
    };

    container.innerHTML = '';
    const grid = document.createElement('div');
    grid.className = 'reminders-grid grid-container'; // Added grid-container for navigation
    grid.id = 'reminders-grid-container';

    dailyReminders.forEach(reminder => {
        const manualState = manualStates[reminder.id];
        let classList = 'reminder-item navigable grid-item';
        let iconName = '';

        if (manualState) {
            classList += ` ${manualState}`;
            switch (manualState) {
                case 'active':    iconName = 'clock'; break;
                case 'completed': iconName = 'check-check'; break;
                case 'missed':    iconName = 'x-circle'; break;
            }
        } else {
            const isActive = reminder.isActive(now, prayerDateTimes);
            let isUpcoming = false;
            if (reminder.getStartTime && !isActive) {
                const startTime = reminder.getStartTime(now, prayerDateTimes);
                if (startTime && startTime > now) { isUpcoming = true; }
            }
            let isCompleted = false;
            if (!isActive && !isUpcoming && reminder.getEndTime) {
                const endTime = reminder.getEndTime(now, prayerDateTimes);
                if (endTime && now > endTime) { isCompleted = true; }
            }

            if (isActive) { classList += ' active'; iconName = 'play-circle'; } 
            else if (isUpcoming) { classList += ' upcoming'; iconName = 'bell'; } 
            else if (isCompleted) { classList += ' completed'; iconName = 'check-check'; } 
            else { iconName = 'circle'; }
        }

        const item = document.createElement('div');
        item.className = classList;
        item.dataset.reminderId = reminder.id;
        item.tabIndex = 0;

        item.innerHTML = `
            <div class="icon-wrapper relative">
                <i data-lucide="${iconName || 'circle'}" class="icon w-12 h-12"></i>
            </div>
            <span class="text">${reminder.name}</span>
        `;
        grid.appendChild(item);
    });

    container.appendChild(grid);
    lucide.createIcons();
}

            // 3. إضافة مستمع نقر واحد للتعامل مع كل الأزرار (MODIFIED)
            document.addEventListener('click', (e) => {
                const reminderItem = e.target.closest('.reminder-item');
                
                // If clicking outside a reminder item AND not on a dropdown button, close dropdowns
                if (!reminderItem && !e.target.closest('.reminder-status-dropdown')) {
                    closeAllDropdowns();
                    return;
                }

                if (!reminderItem) return;

                const reminderId = reminderItem.dataset.reminderId;
                const reminder = dailyReminders.find(r => r.id === reminderId);

                // If the icon is clicked, toggle the dropdown
                if (e.target.closest('.icon-wrapper')) {
                    e.stopPropagation();
                    const existingDropdown = reminderItem.querySelector('.reminder-status-dropdown');
                    if (existingDropdown) {
                        existingDropdown.remove();
                    } else {
                        createReminderDropdown(reminderId, e.target.closest('.icon-wrapper'));
                    }
                    return;
                }

                // If the text area (or any other part of the item) is clicked, perform the action
                if (reminder && reminder.action) {
                    closeAllDropdowns();
                    if (reminder.id.includes('adhkar') || reminder.id.includes('surah')) {
                        switchApp('Media');
                        setTimeout(() => reminder.action(), 100);
                    } else {
                        reminder.action();
                    }
                }
            });
            
            renderDailyReminders(); // الاستدعاء الأول
            setInterval(renderDailyReminders, 60000); // تحديث كل 60 ثانية
        });

        // --- Athkar App Logic ---
        const tabSabah = document.getElementById('tab-sabah');
        const tabMasaa = document.getElementById('tab-masaa');
        const athkarSabahContent = document.getElementById('athkar-sabah-content');
        const athkarMasaaContent = document.getElementById('athkar-masaa-content');
        const tabMonthly = document.getElementById('tab-monthly');
        const athkarMonthlyContent = document.getElementById('athkar-monthly-content');

        if (tabSabah && tabMasaa && athkarSabahContent && athkarMasaaContent && tabMonthly && athkarMonthlyContent) {
            tabSabah.addEventListener('click', () => {
                tabSabah.classList.add('active');
                tabMasaa.classList.remove('active');
                tabMonthly.classList.remove('active');
                athkarSabahContent.classList.remove('hidden');
                athkarMasaaContent.classList.add('hidden');
                athkarMonthlyContent.classList.add('hidden');
                setFocus(tabSabah); // Keep focus on the active tab
            });

            tabMasaa.addEventListener('click', () => {
                tabMasaa.classList.add('active');
                tabSabah.classList.remove('active');
                tabMonthly.classList.remove('active');
                athkarMasaaContent.classList.remove('hidden');
                athkarSabahContent.classList.add('hidden');
                athkarMonthlyContent.classList.add('hidden');
                setFocus(tabMasaa); // Keep focus on the active tab
            });

            tabMonthly.addEventListener('click', () => {
                tabMonthly.classList.add('active');
                tabSabah.classList.remove('active');
                tabMasaa.classList.remove('active');
                athkarMonthlyContent.classList.remove('hidden');
                athkarSabahContent.classList.add('hidden');
                athkarMasaaContent.classList.add('hidden');
                setFocus(tabMonthly);
            });
        }
    </script>
</body> 
</html>
