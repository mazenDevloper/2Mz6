<!DOCTYPE html>
<html lang="ar" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ÿàÿßÿ¨Ÿáÿ© CarPlay - ÿ™ÿµŸÖŸäŸÖ ÿ≤ÿ¨ÿßÿ¨Ÿä ŸÖŸÜÿ≥ÿØŸÑ ÿ™ŸÅÿßÿπŸÑŸä</title>
    <!-- Tailwind CSS CDN for utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons for modern, customizable SVG icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Font Awesome for additional icons (e.g., Trip log) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <!-- ADDED Google Maps API script -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBRqAHJ2elbE_Z7NXXYC50XZpqi6HbG6Rk&libraries=places&callback=initMap"></script>
    <!-- Chart.js for potential future charts in Trip tab (currently not used but included) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Import Inter font for a modern, clean look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Default background gradient - UPDATED: black parts are wider, animation is 3x slower */
            background: linear-gradient(-45deg, #000000 0%, #000000 30%, #00FFFF 35%, #000000 60%, #4B0082 65%, #8A2BE2 70%, #FF00FF 75%, #000000 100%);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite; /* Animation duration decreased to 15s */
            transition: background-image 0.5s ease; /* Smooth transition for background changes */
            font-size: var(--base-font-size, 16px); /* Default font size, controlled by settings */
            min-height: 100vh; /* Ensure body takes full viewport height */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* Prevent body scroll */
        }
        /* Removed flex-direction: row-reverse from dashboard-main-grid as it's now a CSS Grid */
        /* .flex-grow.flex.flex-col.lg\:flex-row.gap-4.md\:gap-6.h-full.dashboard-main-grid {
            flex-direction: row-reverse;
        } */
        /* Ensure RTL direction for specific elements if needed */
        div#youtube-playlist-view, div#youtube-video-list-view, div#youtube-search-results-view {
            direction: rtl;
        }

        /* Define different background themes for customization */
        body.theme-gradient-1 {
            background: linear-gradient(-45deg, #000000 0%, #000000 30%, #00FFFF 35%, #000000 60%, #4B0082 65%, #8A2BE2 70%, #FF00FF 75%, #000000 100%);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        body.theme-gradient-2 {
            background: linear-gradient(-45deg, #4CAF50, #8BC34A, #FFEB3B, #FFC107);
            background-size: 400% 400%;
            animation: gradient 25s ease infinite reverse;
        }
        body.theme-dark-blue {
            background-color: #1a202c; /* Dark blue-gray */
            background-image: none;
            animation: none;
        }
        body.theme-purple-haze {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: 100% 100%;
            animation: none;
        }

div#quran-quick-access {
    display: none !important;
}

.h-full {
    height: 97% !important;
}

        /* NEW GLASS SURFACE CSS - Enhanced for liquid 3D effect and "drop glass" */
        .glass-surface {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            transition: opacity 0.26s ease-out;
            border-radius: 1.5rem; /* Ensure rounded corners */
        }
        .glass-surface__filter {
            width: 100%;
            height: 100%;
            pointer-events: none;
            position: absolute;
            inset: 0;
            opacity: 0;
            z-index: -1;
        }
        .glass-surface__content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: inherit;
            position: relative;
            z-index: 1;
        }
        .glass-surface--svg {
            /* Adjusted background for a more pronounced "drop" effect */
            background: light-dark(hsl(0 0% 100% / var(--glass-frost, 0.1)), /* Slightly more opaque background */
                hsl(0 0% 0% / var(--glass-frost, 0.2))); /* Darker opaque background for dark mode */
            
            /* Enhanced backdrop-filter for stronger blur and saturation */
            backdrop-filter: var(--filter-id, url(#glass-filter)) blur(10px) saturate(2.0) brightness(1.1); /* Reduced blur, saturation, and brightness for sharper effect */
            -webkit-backdrop-filter: blur(10px) saturate(2.0) brightness(1.1); /* Webkit prefix */

            /* More pronounced box-shadow for a "dropped" effect */
            box-shadow:
                0 0 5px 2px rgba(255, 255, 255, 0.1) inset, /* Inner light glow */
                0 0 15px 6px rgba(0, 255, 255, 0.15) inset, /* Inner cyan glow */
                0px 8px 30px rgba(17, 17, 26, 0.1), /* Stronger outer shadow */
                0px 16px 60px rgba(17, 17, 26, 0.15), /* Even stronger outer shadow */
                0px 24px 80px rgba(17, 17, 26, 0.2), /* Deepest outer shadow */
                inset 0 0 20px 8px rgba(0,0,0,0.3), /* Deeper inner shadow for depth */
                inset 0 0 25px 10px rgba(0,0,0,0.2); /* Even deeper inner shadow */
        }
        div#video-popup-container {
    cursor: grab;
    width: 46%;
    height: 37%;
}

        /* Fallback for browsers not supporting backdrop-filter - also enhanced */
        .glass-surface--fallback {
            background: rgba(255, 255, 255, 0.35); /* More opaque fallback */
            backdrop-filter: blur(15px) saturate(2.0) brightness(1.2); /* Stronger fallback blur/saturate */
            -webkit-backdrop-filter: blur(15px) saturate(2.0) brightness(1.2);
            border: 1px solid rgba(255, 255, 255, 0.4); /* Stronger border */
            box-shadow:
                0 10px 40px 0 rgba(31, 38, 135, 0.3), /* Stronger fallback shadow */
                0 4px 20px 0 rgba(31, 38, 135, 0.2),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.5),
                inset 0 -1px 0 0 rgba(255, 255, 255, 0.3);
        }
        @media (prefers-color-scheme: dark) {
            .glass-surface--fallback {
                background: rgba(255, 255, 255, 0.15); /* Dark mode fallback */
                backdrop-filter: blur(15px) saturate(2.0) brightness(1.3);
                -webkit-backdrop-filter: blur(15px) saturate(2.0) brightness(1.3);
                border: 1px solid rgba(255, 255, 255, 0.3);
                box-shadow:
                    inset 0 1px 0 0 rgba(255, 255, 255, 0.3),
                    inset 0 -1px 0 0 rgba(255, 255, 255, 0.2);
            }
        }
        @supports not (backdrop-filter: blur(10px)) {
            .glass-surface--fallback {
                background: rgba(255, 255, 255, 0.5); /* Strongest fallback for no backdrop-filter */
                box-shadow:
                    inset 0 1px 0 0 rgba(255, 255, 255, 0.6),
                    inset 0 -1px 0 0 rgba(255, 255, 255, 0.4);
            }
            .glass-surface--fallback::before {
                content: '';
                position: absolute;
                inset: 0;
                background: rgba(255, 255, 255, 0.2); /* More opaque overlay */
                border-radius: inherit;
                z-index: -1;
            }
        }
        .glass-surface:focus-visible {
            outline: 2px solid light-dark(#007AFF, #0A84FF);
            outline-offset: 2px;
        }
        /* END NEW GLASS SURFACE CSS */

        /* Keyframe animation for the background gradient */
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Styles for individual app screens */
        .app-screen {
            display: none; /* Hidden by default */
            animation: fadeIn 0.5s ease-in-out; /* Fade-in transition */
            width: 100%;
            height: 100%;
            flex-direction: column;
            border-radius: 1.5rem; /* Ensure app screens have rounded corners */
        }
        .app-screen.active {
            display: flex; /* Display when active */
        }
        
        /* Fade-in animation for screen transitions */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Styling for iframes to fit their containers */
        .full-iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 1.5rem;
        }

        /* Floating Button Styles - Positioned and styled for glass effect */
        #floating-fullscreen-button,
        #floating-media-button,
        #back-to-playlists-bottom-button,
        #back-to-playlists-bottom-button-search,
        #floating-keyboard-button, /* Added keyboard button */
        #clear-search-button { /* Added clear search button */
            position: fixed;
            background-color: #8A0806; /* Purple glass */
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 9999px; /* Pill shape */
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            z-index: 100; /* Above everything else */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        #floating-fullscreen-button:hover,
        #floating-media-button:hover,
        #back-to-playlists-bottom-button:hover,
        #back-to-playlists-bottom-button-search:hover,
        #floating-keyboard-button:hover, /* Added keyboard button */
        #clear-search-button:hover { /* Added clear search button */
            transform: scale(1.05); /* Only scale, no translate */
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        /* Specific positioning for floating buttons */
        #floating-fullscreen-button { bottom: 1rem; left: 6rem; right: auto; }
        #floating-media-button { bottom: 1rem; right: 1rem; }
        #floating-keyboard-button { /* New keyboard button position */
            bottom: 1rem;
            right: 8rem; /* Adjusted to be next to media button */
            display: none; /* Hidden by default */
        }
        #floating-keyboard-button.active-keyboard {
            background-color: #90EE90; /* Chrome Green */
            color: black; /* Black icon */
        }
        #floating-keyboard-button.inactive-keyboard {
            background-color: #FF0000; /* Red */
            color: white; /* White icon */
        }
        #clear-search-button { /* New clear search button position */
            top: 3rem; /* Adjusted to be at search bar level */
            right: 1rem; /* Aligned with the right side of the screen */
            padding: 0.75rem 1rem; /* Smaller padding for a cleaner look */
            font-size: 0.8rem; /* Smaller font size */
            display: none; /* Hidden by default, will be controlled by JS */
        }
        @media (max-width: 768px) { /* Mobile adjustments for clear search button */
            #clear-search-button {
                top: 10rem; /* Adjust for mobile layout */
                right: 1rem;
            }
        }

        #back-to-playlists-bottom-button, #back-to-playlists-bottom-button-search {
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            display: none; /* Hidden by default */
        }

        /* Top bar positioning and transition */
        .top-bar {
            top: 1rem;
            transition: opacity 0.3s ease;
        }

        /* Main CarPlay interface container adjustments */
        #carplay-main-interface {
            position: fixed; /* Changed to fixed for default 90% fullscreen */
            top: 4%; /* Centered vertically */
            left: 4%; /* Centered horizontally */
            width: 98vw; /* 90% of viewport width */
            height: 98vh; /* 90% of viewport height */
            /* Removed margin-top and margin-bottom as position: fixed handles positioning */
            transition: all 0.5s ease-in-out; /* Smooth transition for pseudo-fullscreen */
            max-width: 1280px; /* Max width for desktop */
            border-radius: 2rem; /* Increased rounded corners for main interface */
        }

        /* Pseudo-fullscreen class for the CarPlay interface */
        #carplay-main-interface.carplay-pseudo-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            margin: 0;
            border-radius: 0;
            z-index: 99; /* Ensure it's above other content but below the floating button */
            max-width: 100vw; /* When fullscreen, it should take full width */
        }

        /* Shrink content when in pseudo-fullscreen mode for better fit */
        #carplay-main-interface.carplay-pseudo-fullscreen #digital-time {
            font-size: 2.2rem !important;
        }
        #carplay-main-interface.carplay-pseudo-fullscreen #weather-temp-main {
            font-size: 4rem !important;
        }

        /* Scrollbar styling for better aesthetics */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }

        /* Active app icon styling */
        .app-icon.active {
            background-color: #6b22ff; /* Chrome Green */
            color: white; /* Black icon */
            transform: scale(1.1);
        }

        /* Gemini-like Chat Styling */
        .chat-message {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 1.5rem; /* More rounded */
            margin-bottom: 0.75rem;
            word-wrap: break-word;
            font-size: 0.9rem; /* Slightly smaller font for chat */
        }

        .chat-message.user {
            background-color: #4f46e5; /* Blue */
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.5rem; /* Pointy bottom right */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .chat-message.ai {
            background-color: #2d3748; /* Darker gray */
            color: white;
            margin-right: auto;
            border-bottom-left-radius: 0.5rem; /* Pointy bottom left */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        #ai-input {
            border-radius: 2rem; /* Fully rounded pill shape */
            padding: 0.75rem 1.25rem;
            background-color: rgba(255, 255, 255, 0.15); /* Lighter glass */
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }
        #ai-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        #ai-input:focus {
            background-color: rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.4), 0 0 0 2px rgba(147, 51, 234, 0.5);
        }

        /* YouTube Channel Card Styling (Playlist View) - Smaller and more responsive */
        .youtube-channel-card {
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.4rem; /* Reduced padding for smaller card */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            aspect-ratio: 1 / 1; /* Make the card square */
            width: 100%; /* Ensure it takes full grid cell width */
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }
        .youtube-channel-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .youtube-channel-card img {
            width: 85%; /* Reverted to 85% */
            height: 85%; /* Reverted to 85% */
            object-fit: cover;
            border-radius: 1rem; /* Slightly rounded corners for the image */
            margin-bottom: 0.4rem; /* Reduced margin-bottom for smaller card */
            border: 2px solid rgba(255,255,255,0.3);
        }
        .youtube-channel-card h2 {
            font-size: 0.8rem; /* Reduced font size for smaller card */
            font-weight: 600;
            color: white;
            text-align: center; /* Center text */
            white-space: nowrap; /* Prevent text wrapping */
            overflow: hidden; /* Hide overflow text */
            text-overflow: ellipsis; /* Add ellipsis for long titles */
            max-width: 95%; /* Limit width of text */
        }

        /* YouTube Video Card Styling (List View and Search Results) - Smaller and more responsive */
        .youtube-video-card, .youtube-search-card {
            cursor: pointer;
            display: flex;
            flex-direction: row; /* Horizontal layout for list */
            align-items: center;
            padding: 0.5rem; /* Reduced padding */
            border-radius: 0.75rem;
            background-color: rgba(255, 255, 255, 0.05);
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
            width: 100%; /* Take full width in list */
            box-sizing: border-box;
        }
        .youtube-video-card:hover, .youtube-search-card:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        .youtube-video-card img, .youtube-search-card img {
            width: 100px; /* Reduced thumbnail size for list view */
            height: 56.25px; /* 16:9 aspect ratio */
            object-fit: cover;
            border-radius: 0.5rem;
            margin-right: 0.5rem; /* Reduced margin */
            flex-shrink: 0; /* Prevent image from shrinking */
        }
        .youtube-video-card h3, .youtube-search-card h3 {
            font-size: 0.9rem; /* Reduced font size for list */
            font-weight: 500;
            color: white;
            line-height: 1.3;
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2; /* Limit to 2 lines */
            -webkit-box-orient: vertical;
        }

        /* YouTube Suggestion Buttons */
        .youtube-suggestion-button {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px; /* Pill shape */
            font-size: 0.85rem;
            transition: background-color 0.2s ease, transform 0.1s ease;
            white-space: nowrap; /* Prevent text wrapping */
            overflow: hidden;
            text-overflow: ellipsis;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: inline-flex; /* Use inline-flex for proper button layout */
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .youtube-suggestion-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        .youtube-suggestion-button:active {
            transform: translateY(0);
        }

        /* YouTube Suggestion Category Tag */
        .youtube-suggestion-category-tag {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
            margin-bottom: 0.5rem;
            align-self: flex-start; /* Align tag to the start of the column */
        }

        /* Dashboard Logo Effect */
        .metallic-logo-effect {
            width: 300px; /* Increased width for 3x size */
            height: auto;
            margin-bottom: 1rem;
            filter: grayscale(100%) brightness(30%); /* Dark gray metallic effect */
        }

        /* Car Dashboard Specific Styles */
        .car-dashboard-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .gauge-container.absolute-pos {
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .gauge-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 0.25rem;
        }

        .speed-display {
            font-size: 2.5rem;
            line-height: 1;
        }

        .rpm-display {
            font-size: 1.2rem;
            line-height: 1;
        }

        .gear-indicator {
            font-size: 4rem;
            font-weight: bold;
            color: #10b981;
        }

        /* Styles for 360 Camera View */
        .car-cam-360-container {
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.7);
            box-shadow: inset 0 0 15px rgba(0,0,0,0.7);
            overflow: hidden;
        }
        .car-cam-360-container img {
            height: 160%; /* Changed from 100% to 160% as requested */
            width: 100%; 
            object-fit: cover; /* Changed from contain to cover as requested */
        }

        /* Digital Clock Styles (Apple iOS 19 style) */
        #digital-time {
            font-size: 2.2rem;
            font-weight: 800;
            color: white;
            margin-bottom: 0.5rem;
            display: flex; /* Use flex to align hour/minute/second spans */
            align-items: baseline; /* Align numbers at baseline */
            gap: 0.2rem; /* Small gap between time parts */
        }
        #digital-time span {
            transition: opacity 0.3s ease; /* Smooth transition for opacity changes */
        }
        #digital-time .hours { opacity: 1; }
        #digital-time .minutes { opacity: 0.8; }
        #digital-time .seconds { opacity: 0.4; }

        /* Updated #digital-date styles based on user request */
        #digital-date {
            font-size: 1.2rem;
            color: rgb(255 255 255 / 99%);
            font-weight: bold;
            text-align: center;
            line-height: 1.4; /* Ensure good line spacing for two lines */
        }
        /* New class for highlight when less than 20 minutes */
        #digital-date.countdown-highlight {
            font-size: 1.7rem;
            color: #90EE90; /* Light Chrome Green */
            font-weight: bold;
        }
        /* New class for highlight when less than 1 hour but more than 20 minutes */
        #digital-date.countdown-medium-highlight {
            font-size: 1.7rem;
            color: #FFA07A; /* Light Orange */
            font-weight: bold;
        }

        /* Settings Range Input Styling */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]:hover { opacity: 1; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #9333ea; /* Purple thumb */
            cursor: pointer;
            box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.5);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #9333ea;
            cursor: pointer;
            box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.5);
        }

        /* Animated Weather Icon Styles */
        /* Keyframes for a subtle pulse and float animation */
        @keyframes pulse-float {
            0% { transform: scale(1) translateY(0px); opacity: 1; }
            50% { transform: scale(1.05) translateY(-2px); opacity: 0.9; }
            100% { transform: scale(1) translateY(0px); opacity: 1; }
        }
        /* Removed rotate-subtle animation as requested */
        /* @keyframes rotate-subtle {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        } */

        /* Apply animation to weather icons */
        #dashboard-weather-icon, #weather-icon {
            animation: pulse-float 3s ease-in-out infinite alternate; /* Removed rotate-subtle */
            transition: transform 0.3s ease-in-out; /* Smooth transition for scale changes if any */
        }

        /* Electronic Quran specific styles */
        .quran-text {
            font-family: 'Amiri Quran', serif; /* A common font for Quranic text */
            font-size: 2rem; /* Larger font size for readability */
            line-height: 2.5; /* Increased line height */
            text-align: center;
            direction: rtl; /* Ensure right-to-left text direction */
            padding: 1rem;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 1rem;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            overflow-y: auto;
            max-height: 80%; /* Limit height to allow scrolling */
        }

        /* Tajweed Colors (Example - these are simplified and not exhaustive) */
        .tajweed-ghunnah { color: #ff0000; } /* Red for Ghunnah */
        .tajweed-idgham { color: #00ff00; } /* Green for Idgham */
        .tajweed-ikhfaa { color: #0000ff; } /* Blue for Ikhfaa */
        .tajweed-qalqalah { color: #ffff00; } /* Yellow for Qalqalah */
        .tajweed-madd { color: #ffa500; } /* Orange for Madd */

        .quran-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            justify-content: center;
        }
        .quran-control-button {
            background-image: linear-gradient(to right, #6366f1, #8b5cf6);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: bold;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .quran-control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        /* Dashboard Grid Column Sizing (Desktop) */
        /* Removed old flex-direction and width classes as layout is now a CSS Grid */
        /* .dashboard-main-grid {
            flex-direction: row;
        }
        .dashboard-col-25-percent { width: 25%; }
        .dashboard-col-50-percent { width: 50%; }
        .dashboard-col-25-percent-right { width: 25%; } */

     

        /* Weather section content to take full width and height */
        #screen-Weather > div {
            width: 100%;
            height: 100%;
            max-width: none;
        }
        #screen-Weather .glass-surface {
            flex-grow: 1;
        }

        /* Video Pop-up Container Styles */
        #video-popup-container {
            position: fixed;
            bottom: 6rem;
            right: 1rem;
            width: 320px;
            height: 180px;
            background-color: rgba(0, 0, 0, 0.9);
            border-radius: 1rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 110;
            display: none;
            flex-direction: column;
            overflow: hidden;
            resize: both; /* Allow resizing */
            min-width: 200px;
            min-height: 112px;
        }
        #video-popup-container.active { display: flex; }
        #video-popup-iframe {
            width: 100%;
            height: 100%;
            border-radius: 1rem;
            overflow: hidden;
        }

        div#digital-date-line2 {
    font-size: 1.4em;
}

        .video-popup-controls {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
            z-index: 120;
        }
        .video-popup-controls button {
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .video-popup-controls button:hover { background-color: rgba(0, 0, 0, 0.8); }

        /* Responsive adjustments for smaller screens (mobile first) */
        @media (max-width: 768px) {
            body {
                overflow-y: auto; /* Allow scrolling on mobile body if content overflows */
            }
            .top-bar {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
                top: 0.5rem; /* Closer to top edge */
            }

            #carplay-main-interface {
                top: 2%; /* Adjusted for mobile to be slightly less than 5% */
                left: 2%;
                width: 96vw; /* Adjusted for mobile */
                height: 96vh; /* Adjusted for mobile */
                flex-direction: column; /* Stack main interface on smaller screens */
                border-radius: 1rem;
            }

            /* Navigation Dock (bottom on mobile) */
            nav {
                width: 100%; /* Full width for nav dock on mobile */
                height: auto;
                flex-direction: row; /* Horizontal icons on mobile */
                justify-content: space-around;
                padding: 0.5rem;
                border-r: none;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                order: 2; /* Move nav dock to bottom on mobile */
                border-radius: 0 0 1rem 1rem; /* Rounded bottom corners */
            }

            .app-icon {
                width: 48px; /* Smaller icons on mobile */
                height: 48px;
                border-radius: 0.75rem;
            }

            main {
                order: 1; /* Main content above nav dock on mobile */
                height: calc(100% - 64px); /* Adjust height for nav dock */
            }

            .app-screen {
                padding: 1rem;
            }

            /* Dashboard Grid Layout adjustments for mobile */
            .dashboard-main-grid {
                grid-template-columns: 1fr; /* Single column on mobile */
                grid-template-rows: auto; /* Auto height for rows on mobile */
                height: auto; /* Allow height to adjust */
            }

            /* Ensure children of the main grid stack correctly on mobile */
            .dashboard-main-grid > div { /* Targets the direct children which are the grid cells/columns */
                height: auto !important; /* Override fixed heights */
                width: 100%; /* Full width */
            }

            .car-cam-360-container {
                height: 200px; /* Fixed height for camera on mobile */
            }

        

            /* YouTube Channel Card (Playlist View) - Mobile adjustments */
            .youtube-channel-card {
                padding: 0.2rem;
                border-radius: 0.75rem;
            }
            .youtube-channel-card img {
                width: 70%;
                height: 70%;
                border-radius: 0.75rem;
            }
            .youtube-channel-card h2 {
                font-size: 0.7rem;
            }

            /* YouTube Video Card (List/Search) - Mobile adjustments */
            .youtube-video-card img, .youtube-search-card img {
                width: 90px;
                height: 50.625px; /* Maintain 16:9 aspect ratio */
                margin-right: 0.5rem;
            }
            .youtube-video-card h3, .youtube-search-card h3 {
                font-size: 0.85rem;
            }

            /* Floating Buttons - Mobile positioning */
            #floating-fullscreen-button,
            #floating-media-button,
            #back-to-playlists-bottom-button,
            #back-to-playlists-bottom-button-search,
            #floating-keyboard-button { /* Added keyboard button */
                padding: 0.75rem 1rem;
                font-size: 0.8rem;
                gap: 0.25rem;
            }
            #floating-fullscreen-button { left: 1rem !important; transform: none; }
            #floating-media-button { right: 1rem; }
            #floating-keyboard-button { /* New keyboard button position for mobile */
                right: 5.5rem; /* Adjusted for mobile */
            }
            #back-to-playlists-bottom-button, #back-to-playlists-bottom-button-search {
                left: 50%;
                transform: translateX(-50%);
                bottom: 5.5rem; /* Adjust position to not overlap with other buttons */
            }

            /* Video Pop-up Container - Mobile adjustments */
            #video-popup-container {
                width: 90%;
                height: auto;
                min-width: unset;
                min-height: unset;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                bottom: unset;
                right: unset;
            }
        }

        img.w-full.h-full.object-cover.rounded-lg.opacity-80 {
    position: fixed;
}
        /* Prayer Times Specific Styles */
        /* Changed from grid to flex for a single row display */
        .prayer-times-row {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            justify-content: center; /* Center items in the row */
            gap: 0.75rem; /* Spacing between prayer times */
            width: 100%;
            margin-top: 1rem;
        }
        .prayer-time-item {
            display: flex;
            flex-direction: column; /* Stack name and time vertically */
            align-items: center;
            padding: 0.5rem 0.75rem;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            font-size: 0.9rem;
            min-width: 80px; /* Ensure minimum width for each item */
            text-align: center;
        }
        .prayer-time-item.current-prayer {
            background-color: rgba(147, 51, 234, 0.3); /* Highlight current prayer */
            font-weight: bold;
            border: 1px solid #9333ea;
        }
        .prayer-name {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem; /* Smaller font for name */
            margin-bottom: 0.2rem;
        }
        .prayer-time {
            color: white;
            font-size: 1rem; /* Larger font for time */
        }

        /* OBD-II Specific Styles */
        .obd-data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            width: 100%;
        }
        .obd-data-card {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }
        .obd-data-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #10b981; /* Green for data */
            margin-bottom: 0.25rem;
        }
        .obd-data-card .label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }
    </style>
</head>
<body class="animated-bg text-white overflow-hidden theme-gradient-1">
    <!-- SVG Filter Definition for Liquid Glass Effect -->
    <svg style="position: absolute; width: 0; height: 0; overflow: hidden;">
        <defs>
            <filter id="glass-filter" colorInterpolationFilters="sRGB" x="0%" y="0%" width="100%" height="100%">
                <!-- feImage source for displacement map - this is a generic pattern -->
                <feImage x="0" y="0" width="100%" height="100%" preserveAspectRatio="none" result="map" 
                    href="data:image/svg+xml,%3Csvg viewBox='0 0 400 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3ClinearGradient id='red-grad' x1='100%25' y1='0%25' x2='0%25' y2='0%25'%3E%3Cstop offset='0%25' stop-color='%230000'/%3E%3Cstop offset='100%25' stop-color='red'/%3E%3C/linearGradient%3E%3ClinearGradient id='blue-grad' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%230000'/%3E%3Cstop offset='100%25' stop-color='blue'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x='0' y='0' width='400' height='200' fill='black'/%3E%3Crect x='0' y='0' width='400' height='200' rx='20' fill='url(%23red-grad)'/%3E%3Crect x='0' y='0' width='400' height='200' rx='20' fill='url(%23blue-grad)' style='mix-blend-mode: difference'/%3E%3Crect x='1.4' y='1.4' width='397.2' height='197.2' rx='20' fill='hsl(0 0% 50% / 0.93)' style='filter:blur(11px)'/%3E%3C/svg%3E"/>
                
                <!-- Displacement maps for RGB channels - adjusted scale for more distortion -->
                <feDisplacementMap in="SourceGraphic" in2="map" id="redchannel" scale="300" xChannelSelector="R" yChannelSelector="G" result="dispRed" />
                <feColorMatrix in="dispRed" type="matrix" values="1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0" result="red" />
                
                <feDisplacementMap in="SourceGraphic" in2="map" id="greenchannel" scale="310" xChannelSelector="R" yChannelSelector="G" result="dispGreen" />
                <feColorMatrix in="dispGreen" type="matrix" values="0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 1 0" result="green" />
                
                <feDisplacementMap in="SourceGraphic" in2="map" id="bluechannel" scale="320" xChannelSelector="R" yChannelSelector="G" result="dispBlue" />
                <!-- Corrected feColorMatrix for blue channel to ensure real colors are reflected -->
                <feColorMatrix in="blue" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0" result="blue" />
                
                <!-- Blending channels -->
                <feBlend in="red" in2="green" mode="screen" result="rg" />
                <feBlend in="rg" in2="blue" mode="screen" result="output" />
                
                <!-- Gaussian blur for liquid effect - increased stdDeviation -->
                <feGaussianBlur in="output" stdDeviation="5" />
            </filter>
        </defs>
    </svg>

    <div class="w-full h-screen flex flex-col items-center justify-center p-4 sm:p-6">
        
        <!-- Top Bar: Wifi, 5G, Current Time -->
        <div class="w-full max-w-7xl flex justify-between items-center text-white/80 text-sm px-4 py-2 absolute top-4 left-1/2 -translate-x-1/2 z-10 top-bar">
            <div class="flex items-center gap-2">
                <i data-lucide="wifi"></i>
                <span>5G</span>
            </div>
            <div id="current-time">9:35</div>
        </div>

        <!-- Lexus Logo Fixed at Top Center (color changed to white using filter) -->
        <img src="https://dmusera.netlify.app/Lexus-Logo.wine.svg" width="200px" alt="Lexus Logo" class="fixed top-2 left-1/2 -translate-x-1/2 h-12 z-[1000] opacity-80" style="filter: invert(1) grayscale(100%) brightness(200%);" />

        <!-- Main CarPlay Interface Container -->
        <div id="carplay-main-interface" class="flex flex-row shadow-2xl rounded-3xl overflow-hidden bg-black/20 border border-white/10">
            
            <!-- Navigation Dock (Left Sidebar) -->
            <nav class="w-20 sm:w-24 bg-black/20 flex flex-col items-center justify-start pt-8 p-2 space-y-4 border-r border-white/10 flex-shrink-0 transition-opacity 0.3s ease;">
                <button data-app="Dashboard" class="app-icon">
                    <i data-lucide="layout-grid"></i>
                </button>
                <button data-app="Media" class="app-icon">
                    <i data-lucide="play-circle"></i>
                </button>
                 <button data-app="Radio" class="app-icon">
                    <i data-lucide="radio"></i>
                </button>
                <button data-app="AIAssistant" class="app-icon"> 
                    <i data-lucide="sparkles"></i> 
                </button>
                <button data-app="Weather" class="app-icon"> 
                    <i data-lucide="cloud-sun"></i> 
                </button>
                <button data-app="Quran" class="app-icon">
                    <i data-lucide="book-open"></i>
                </button>
            </nav>

            <!-- Main content area for app screens -->
            <main class="flex-1 flex flex-col h-full">
                
                <!-- Dashboard Screen -->
                <section id="screen-Dashboard" class="app-screen p-4 md:p-6 flex-col h-full">
                 
                    <!-- Dashboard Grid Layout -->
                    <!-- The main grid container for the dashboard content -->
                    <div class="dashboard-main-grid grid grid-cols-1 md:grid-cols-3 grid-rows-[80%_20%] gap-4 md:gap-6 h-full w-full">
                        
                        <!-- Column 1: Weather & Clock (occupies 1st column, 1st row) -->
                        <div class="flex flex-col gap-4 md:gap-6 col-span-1 row-start-1">
                            <!-- Weather Widget -->
                            <div class="glass-surface glass-surface--svg p-4 flex-grow flex flex-col items-center justify-center text-center">
                                <h2 class="text-xl font-bold mb-1">ÿßŸÑÿ∑ŸÇÿ≥</h2>
                                <div id="weather-widget-container" class="w-full h-full flex flex-col items-center justify-center">
                                    <img id="dashboard-weather-icon" src="" alt="Weather Icon" class="w-16 h-16 text-white mb-2" />
                                    <p class="text-3xl font-extrabold mb-1" id="dashboard-weather-temp">--¬∞C</p>
                                    <p class="text-lg text-white/70 mb-2" id="dashboard-weather-desc">--</p>
                                    <p class="text-sm text-white/50" id="dashboard-weather-location">ÿµŸÑÿßŸÑÿ©ÿå ÿπŸÖÿßŸÜ</p>
                                </div>
                            </div>
                            <!-- Digital Clock Widget (Apple iOS 19 style) -->
                            <div class="glass-surface glass-surface--svg p-4 flex-grow flex flex-col items-center justify-center text-center">
                                <div id="digital-clock-widget" class="w-full h-full flex flex-col items-center justify-center text-center">
                                    <!-- Changed to spans for individual opacity control -->
                                    <div id="digital-time">
                                        <span class="hours">00</span>:<span class="minutes">00</span>:<span class="seconds">00</span>
                                    </div>
                                    <div id="digital-date">
                                        <div id="digital-date-line1">  </div>
                                        <div id="digital-date-line2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Column 2: 360 Camera View (occupies 2nd column, 1st row) -->
                        <div class="glass-surface glass-surface--svg p-2 flex flex-col items-center justify-center text-center car-cam-360-container col-span-1 row-start-1">
                            <img src="https://dmusera.netlify.app/es350gb.png" alt="ÿπÿ±ÿ∂ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß 360 ÿØÿ±ÿ¨ÿ© ŸÑŸÑÿ≥Ÿäÿßÿ±ÿ©" class="w-full h-full object-contain rounded-lg opacity-80">
                        </div>

                        <!-- Column 3: Map (occupies 3rd column, 1st row) -->
                        <div class="rounded-3xl relative overflow-hidden flex items-center justify-center glass-surface glass-surface--svg p-1 col-span-1 row-start-1">
                            <!-- Google Map container -->
                            <div id="dashboard-leaflet-map" class="full-iframe"></div>
                            <button id="get-my-location-button-dashboard" class="absolute bottom-4 left-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full transition-colors duration-200 flex items-center gap-2 text-sm">
                                <i data-lucide="map-pin" class="w-4 h-4"></i> ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàŸÇÿπ
                            </button>
                        </div>

                        <!-- Prayer Times Widget (occupies all 3 columns, 2nd row) -->
                        <div class="glass-surface glass-surface--svg p-4 flex flex-col items-center justify-center text-center col-span-full row-start-2">
                           
                            <!-- Prayer times will be dynamically loaded here -->
                            <div id="prayer-times-container" class="prayer-times-row">
                                <div class="prayer-time-item">
                                    <span class="prayer-name">ÿßŸÑŸÅÿ¨ÿ±</span>
                                    <span class="prayer-time" id="fajr-time">--:--</span>
                                    <span class="prayer-iqama" id="fajr-iqama"></span>
                                </div>
                                
                                <div class="prayer-time-item">
                                    <span class="prayer-name">ÿßŸÑÿ∏Ÿáÿ±</span>
                                    <span class="prayer-time" id="dhuhr-time">--:--</span>
                                    <span class="prayer-iqama" id="dhuhr-iqama"></span>
                                </div>
                                <div class="prayer-time-item">
                                    <span class="prayer-name">ÿßŸÑÿπÿµÿ±</span>
                                    <span class="prayer-time" id="asr-time">--:--</span>
                                    <span class="prayer-iqama" id="asr-iqama"></span>
                                </div>
                                <div class="prayer-time-item">
                                    <span class="prayer-name">ÿßŸÑŸÖÿ∫ÿ±ÿ®</span>
                                    <span class="prayer-time" id="maghrib-time">--:--</span>
                                    <span class="prayer-iqama" id="maghrib-iqama"></span>
                                </div>
                                <div class="prayer-time-item">
                                    <span class="prayer-name">ÿßŸÑÿπÿ¥ÿßÿ°</span>
                                    <span class="prayer-time" id="isha-time">--:--</span>
                                    <span class="prayer-iqama" id="isha-iqama"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                </section>

                <!-- Media (YouTube) Screen -->
                <section id="screen-Media" class="app-screen p-4 md:p-6 flex-col items-center justify-center h-full relative">
                    <h1 class="text-4xl font-bold mb-6 text-center">üé• ÿßŸÑŸàÿ≥ÿßÿ¶ÿ∑ ÿßŸÑŸÖÿ™ÿπÿØÿØÿ©</h1>
                    
                    <!-- YouTube Search Input -->
                    <div class="w-full flex gap-2 mb-6">
                        <input
                            type="text"
                            id="youtube-search-input"
                            placeholder="ÿßÿ®ÿ≠ÿ´ ŸÅŸä ŸäŸàÿ™ŸäŸàÿ®..."
                            class="flex-grow p-3 rounded-full bg-white/10 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500"
                            onkeypress="if(event.key === 'Enter') document.getElementById('youtube-search-button').click();"
                            readonly="true" <!-- Added readonly attribute -->
                        />
                        <button
                            id="youtube-search-button"
                            class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-full transition-colors duration-200 flex items-center justify-center"
                        >
                            <i data-lucide="search"></i>
                        </button>
                    </div>

                    <!-- YouTube Search Suggestions -->
                    <div id="youtube-suggestions" class="w-full mb-4 hidden">
                        <!-- Suggestions will be dynamically loaded here -->
                    </div>

                    <!-- YouTube Playlist View -->
                    <div id="youtube-playlist-view" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 w-full h-full flex-grow overflow-y-auto">
                        <h2 class="col-span-full text-3xl font-bold mb-4 text-center">ŸÇŸàÿßÿ¶ŸÖ ÿ™ÿ¥ÿ∫ŸäŸÑ ŸäŸàÿ™ŸäŸàÿ®</h2>
                        
                
                        
                        <!-- New YouTube Channels Added Below -->
                        <div class="glass-surface glass-surface--svg youtube-channel-card" data-playlist-id="UUlncV9OLPto_MinRzGfjr2g" data-channel-id="UClncV9OLPto_MinRzGfjr2g">
                            <img src="https://yt3.googleusercontent.com/ZpoYv5FstgResXDeuqEhkce079N0fM3UC5cmjGFBbKSPQI7tDXfl5W_vib_X2Q_hy5ipbZl4Fw=s160-c-k-c0x00ffffff-no-rj" alt="ÿµŸàÿ±ÿ© ÿßŸÑÿ¥ŸäÿÆ ÿπÿ®ÿØ ÿßŸÑÿ®ÿßÿ≥ÿ∑ ÿπÿ®ÿØ ÿßŸÑÿµŸÖÿØ" />
                            <h2>ÿ™ŸÑÿßŸàÿßÿ™ Ÿäÿßÿ≥ÿ± ÿßŸÑÿØŸàÿ≥ÿ±Ÿä</h2>
                        </div>
                        <div class="glass-surface glass-surface--svg youtube-channel-card" data-playlist-id="UUFPqvE8BYiiUeN1AUXa3lbA" data-channel-id="UCFPqvE8BYiiUeN1AUXa3lbA">
                            <img src="https://imgs.search.brave.com/-WtPBvI7AmvUdQ2X1oZpk6wlNV-PlUSktoA9JVVQL3o/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9zdGF0/aWMuc3VyYXRtcDMu/Y29tL3BpY3MvcmVj/aXRlcnMvdGh1bWJz/LzM3XzE2MF8xNjAu/anBn" alt="ÿµŸàÿ±ÿ© ÿßŸÑÿ¥ŸäÿÆ ŸÖÿ¥ÿßÿ±Ÿä ÿßŸÑÿπŸÅÿßÿ≥Ÿä" />
                            <h2>ÿßŸÑÿ¥ŸäÿÆ ŸÖÿ≠ŸÖÿØ ÿßŸäŸàÿ® </h2>
                        </div>
                        <div class="glass-surface glass-surface--svg youtube-channel-card" data-playlist-id="UUy0WYogELm9hEjulWPeYOJg" data-channel-id="UCy0WYogELm9hEjulWPeYOJg">
                            <img src="https://yt3.googleusercontent.com/jE4NSU3a46l5ZI5rTvaq2Jvk_TWWS3GtPhs4qchBQagGTeypLWC1V3ewrcE1xbMOgkZaHGGNWA=s160-c-k-c0x00ffffff-no-rj" alt="ÿµŸàÿ±ÿ© ÿßŸÑÿ¥ŸäÿÆ ŸÖÿßŸáÿ± ÿßŸÑŸÖÿπŸäŸÇŸÑŸä" />
                            <h2>ŸÖÿ≤ÿßŸÖŸäÿ± ÿßŸÑŸÇÿ±ÿ¢ŸÜ</h2>
                        </div>
                        <!-- End of New YouTube Channels -->
                    </div>

                    <!-- YouTube Video List View -->
                    <div id="youtube-video-list-view" class="hidden flex-col items-center justify-center h-full w-full relative p-4 overflow-y-auto gap-4 flex-grow">
                        <button id="back-to-playlists-from-videos" class="absolute top-4 left-4 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-full transition-colors duration-200 flex items-center gap-2 text-sm">
                            <i data-lucide="arrow-left" class="w-4 h-4"></i> ÿßŸÑÿπŸàÿØÿ© ŸÑŸÇŸàÿßÿ¶ŸÖ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ
                        </button>
                        <h2 class="text-3xl font-bold mb-4 text-center w-full">ŸÅŸäÿØŸäŸàŸáÿßÿ™ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ</h2>
                        <div id="video-list-container" class="flex flex-col gap-4 w-full">
                            <!-- Videos will be dynamically loaded here -->
                        </div>
                        <!-- Bottom "Back to Playlists" Button -->
                        <button id="back-to-playlists-bottom-button" class="mt-4 bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-full transition-colors duration-200 flex items-center justify-center gap-2 text-base">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i> ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ŸÇŸàÿßÿ¶ŸÖ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
                        </button>
                    </div>

                    <!-- YouTube Search Results View -->
                    <div id="youtube-search-results-view" class="hidden flex-col items-center justify-center h-full w-full relative p-4 overflow-y-auto gap-4 flex-grow">
                        <h2 class="text-3xl font-bold mb-4 text-center w-full">ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ®ÿ≠ÿ´</h2>
                        <div id="search-results-container" class="flex flex-col gap-4 w-full">
                            <!-- Search results will be dynamically loaded here -->
                        </div>
                        <!-- Bottom "Back to Playlists" Button for search results -->
                        <button id="back-to-playlists-bottom-button-search" class="mt-4 bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-full transition-colors duration-200 flex items-center justify-center gap-2 text-base">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i> ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ŸÇŸàÿßÿ¶ŸÖ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
                        </button>
                    </div>

                    <!-- YouTube Video Player View (This section will now be unused for initial playback from lists/search) -->
                    <div id="youtube-player-view" class="hidden flex-col items-center justify-center h-full w-full relative flex-grow">
                        <iframe
                            id="youtube-player-iframe"
                            class="full-iframe"
                            src="" 
                            title="YouTube video player"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen
                        ></iframe>
                        <!-- Minimize Video Button (now "Back to List") -->
                        <button id="minimize-video-button" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full transition-colors duration-200 flex items-center gap-2 text-sm">
                            <i data-lucide="arrow-left" class="w-4 h-4"></i> ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ÿßŸÑÿÆŸÑŸÅ
                        </button>
                    </div>
                </section>
                
                <!-- Radio Screen -->
                <section id="screen-Radio" class="app-screen items-center justify-center h-full w-full p-4 md:p-6">
                   <iframe class="full-iframe" title="Radio Garden" src="https://radio.garden/visit/salalah/A13sFegC"></iframe>
                </section>

                <!-- AI Assistant Screen -->
                <section id="screen-AIAssistant" class="app-screen p-4 md:p-6 flex-col justify-between h-full">
                    <h1 class="text-4xl font-bold mb-4 text-center">ŸÖÿ≥ÿßÿπÿØ Gemini ÿßŸÑÿ∞ŸÉŸä ‚ú®</h1>
                    <div id="chat-history" class="flex-grow overflow-y-auto p-4 rounded-xl glass-surface glass-surface--svg mb-4">
                        <div class="chat-message ai">ÿ£ŸáŸÑÿßŸã ÿ®ŸÉ! ŸÉŸäŸÅ ŸäŸÖŸÉŸÜŸÜŸä ŸÖÿ≥ÿßÿπÿØÿ™ŸÉ ÿßŸÑŸäŸàŸÖÿü ŸäŸÖŸÉŸÜŸÉ ÿ≥ÿ§ÿßŸÑŸä ÿπŸÜ ÿ≥ÿ±ÿπÿ© ÿßŸÑÿ≥Ÿäÿßÿ±ÿ©ÿå ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑŸàŸÇŸàÿØÿå RPMÿå ÿØÿ±ÿ¨ÿ© ÿßŸÑÿ≠ÿ±ÿßÿ±ÿ©ÿå ÿ£Ÿà ÿßŸÑÿ™ÿ±ÿ≥.</div>
                        <div id="listening-indicator" class="chat-message ai hidden">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ...</div>
                    </div>
                    <div class="flex gap-2">
                        <input
                            type="text"
                            id="ai-input"
                            placeholder="ÿßÿ≥ÿ£ŸÑŸÜŸä ÿ£Ÿä ÿ¥Ÿäÿ°..."
                            class="flex-grow p-3 rounded-full bg-white/10 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500"
                            onkeypress="if(event.key === 'Enter') document.getElementById('ai-send-button').click();"
                        />
                        <button
                            id="ai-mic-button" 
                            class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full transition-colors duration-200 flex items-center justify-center"
                        >
                            <i data-lucide="mic"></i>
                        </button>
                        <button
                            id="ai-send-button"
                            class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-full transition-colors duration-200 flex items-center justify-center"
                        >
                            <i data-lucide="send"></i>
                        </button>
                    </div>
                </section>

                <!-- Weather Screen -->
                <section id="screen-Weather" class="app-screen p-4 md:p-6 flex-col items-center justify-center h-full">
                    <h1 class="text-4xl font-bold mb-6">ÿßŸÑÿ∑ŸÇÿ≥ <i data-lucide="cloud-sun"></i></h1>
                    <div class="w-full h-full flex flex-col gap-4">
                        <!-- Main Weather Card (Top) -->
                        <div class="glass-surface glass-surface--svg p-6 rounded-3xl text-center flex flex-col items-center justify-center flex-grow">
                            <div class="text-3xl font-bold mb-2" id="weather-location">ÿµŸÑÿßŸÑÿ©ÿå ÿπŸÖÿßŸÜ</div>
                            <img id="weather-icon" src="" alt="Weather Icon" class="w-24 h-24 text-yellow-400 mb-4" />
                            <p class="text-6xl font-extrabold mb-2" id="weather-temp">--¬∞C</p>
                            <p class="text-xl text-white/70 mb-4" id="weather-desc">--</p>
                            <p class="text-sm text-white/50" id="weather-feels-like">ÿßŸÑÿ¥ÿπŸàÿ± ŸÉŸÄ: --¬∞C</p>
                            <p class="text-sm text-white/50" id="weather-last-updated">ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´: --</p>
                        </div>

                        <!-- Additional Details (Bottom Grid) -->
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 w-full">
                            <div class="glass-surface glass-surface--svg p-4 rounded-3xl text-center flex flex-col items-center justify-center">
                                <i data-lucide="droplet" class="w-10 h-10 text-blue-300 mb-2"></i>
                                <span class="text-2xl font-bold" id="weather-humidity">--%</span>
                                <span class="text-sm text-white/50">ÿßŸÑÿ±ÿ∑Ÿàÿ®ÿ©</span>
                            </div>
                            <div class="glass-surface glass-surface--svg p-4 rounded-3xl text-center flex flex-col items-center justify-center">
                                <i data-lucide="wind" class="w-10 h-10 text-gray-300 mb-2"></i>
                                <span class="text-2xl font-bold" id="weather-wind">-- ŸÉŸÖ/ÿ≥</span>
                                <span class="text-sm text-white/50">ÿßŸÑÿ±Ÿäÿßÿ≠</span>
                            </div>
                            <div class="glass-surface glass-surface--svg p-4 rounded-3xl text-center flex flex-col items-center justify-center">
                                <i data-lucide="gauge" class="w-10 h-10 text-green-300 mb-2"></i>
                                <span class="text-2xl font-bold" id="weather-pressure">-- mb</span>
                                <span class="text-sm text-white/50">ÿßŸÑÿ∂ÿ∫ÿ∑</span>
                            </div>
                            <div class="glass-surface glass-surface--svg p-4 rounded-3xl text-center flex flex-col items-center justify-center">
                                <i data-lucide="eye" class="w-10 h-10 text-purple-300 mb-2"></i>
                                <span class="text-2xl font-bold" id="weather-visibility">-- ŸÉŸÖ</span>
                                <span class="text-sm text-white/50">ÿßŸÑÿ±ÿ§Ÿäÿ©</span>
                            </div>
                            <div class="glass-surface glass-surface--svg p-4 rounded-3xl text-center flex flex-col items-center justify-center">
                                <i data-lucide="sun" class="w-10 h-10 text-orange-300 mb-2"></i>
                                <span class="text-2xl font-bold" id="weather-uv">--</span>
                                <span class="text-sm text-white/50">ŸÖÿ§ÿ¥ÿ± ÿßŸÑÿ£ÿ¥ÿπÿ© ŸÅŸàŸÇ ÿßŸÑÿ®ŸÜŸÅÿ≥ÿ¨Ÿäÿ©</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Electronic Quran App Screen -->
                <section id="screen-Quran" class="app-screen p-4 md:p-6 flex-col items-center justify-center h-full relative">
                   <div id="quran-quick-access" class="mt-4 bg-black/30 p-4 rounded-xl flex flex-col gap-3 items-end z-20 glass-surface glass-surface--svg w-full max-w-md">
                        
                        <button id="quran-go-button" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full transition-colors duration-200 flex items-center gap-2 text-sm self-center">
                            
                        </button>
                    </div>
                   
                    <div class="w-full h-full glass-surface glass-surface--svg p-4 rounded-xl flex flex-col items-center flex-grow" style="
    height: 100%!important;
">
                        <iframe
                            id="quran-iframe"
                            class="full-iframe"
                            src="https://quran.com/?lang=ar"
                            lang="ar"
                            title="ÿßŸÑŸÇÿ±ÿ¢ŸÜ ÿßŸÑŸÉÿ±ŸäŸÖ"
                            frameborder="0"
                            allowfullscreen
                        ></iframe>
                    </div>
                    <!-- Quran Quick Access Section -->
                    
                </section>

            </main>
        </div>
    </div>

    <!-- Floating Full-Screen Button -->
    <button id="floating-fullscreen-button" class="glass-surface glass-surface--svg rounded-full">
        <i data-lucide="maximize" class="w-6 h-6"></i>
        
    </button>

    <!-- Floating Media Button -->
    <button id="floating-media-button" class="glass-surface glass-surface--svg rounded-full">
        <i data-lucide="youtube" class="w-6 h-6"></i>
    </button>

    <!-- Floating Keyboard Button (New) -->
    <button id="floating-keyboard-button" class="glass-surface glass-surface--svg rounded-full">
        <i data-lucide="keyboard" class="w-6 h-6"></i>
    </button>

    <!-- Clear Search Button (New) -->
    <button id="clear-search-button" class="glass-surface glass-surface--svg rounded-full">
        <i data-lucide="x" class="w-4 h-4"></i>
    </button>

    <!-- Video Pop-up Container -->
    <div id="video-popup-container">
        <iframe
            id="video-popup-iframe"
            src=""
            title="YouTube video player pop-up"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
        ></iframe>
        <div class="video-popup-controls">
            <button id="video-popup-close-button" title="ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÅŸäÿØŸäŸà">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
    </div>

    <script>
        // Initialize Lucide icons after they are loaded
        lucide.createIcons();

        // --- API Keys ---
        // IMPORTANT: REPLACE WITH YOUR ACTUAL YOUTUBE API KEY FROM GOOGLE CLOUD CONSOLE
        // ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÇŸÖ ÿ®ÿ™ÿπŸäŸäŸÜ ŸÖŸÅÿ™ÿßÿ≠ YouTube API ÿßŸÑÿÆÿßÿµ ÿ®ŸÉÿå ŸÅŸÑŸÜ ÿ™ÿπŸÖŸÑ ŸÖŸäÿ≤ÿßÿ™ YouTube.
        // Ÿäÿ±ÿ¨Ÿâ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ 'YOUR_YOUTUBE_API_KEY' ÿ®ŸÖŸÅÿ™ÿßÿ≠ API ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ ŸÖŸÜ Google Cloud Console.
        const YOUTUBE_API_KEY = 'AIzaSyDj4w1H3Is_rmTLhl40zER7AgYhT_tKASo'; 
        // IMPORTANT: REPLACE WITH YOUR ACTUAL GEMINI API KEY FROM GOOGLE AI STUDIO
        const AI_ASSISTANT_API_KEY = 'AIzaSyBMmtON9ww4dJxMHrl1wKyWTvI0ipJXJws'; 
        // IMPORTANT: REPLACE WITH YOUR ACTUAL WEATHERAPI.COM KEY TO RESOLVE 401 ERROR
        const WEATHER_API_KEY = '7acefc26deee4904a2393917252207'; 
        // IMPORTANT: REPLACE WITH YOUR ACTUAL GOOGLE MAPS API KEY FOR MAP AND TRAFFIC TO WORK
        const GOOGLE_MAPS_API_KEY = 'AIzaSyBRqAHJ2elbE_Z7NXXYC50XZpqi6HbG6Rk';

        // --- Global App State Management ---
        // Centralized state for various app functionalities
        let appState = {
            currentTime: '',
            mapLocation: { lat: 17.0151, lon: 54.0924, zoom: 12 }, // Default Salalah coordinates
            weather: {
                temperature: null, 
                feelsLike: null,
                description: null, 
                humidity: null,    
                wind: null,        
                pressure: null,
                visibility: null,
                uvIndex: null,
                lastUpdated: null, 
                iconUrl: '',
                location: 'Salalah, Oman'
            },
            car: { // Simulated car data, no longer controlled by settings UI
                speed: 0, 
                rpm: 0,   
                fuel: 0,  
                temp: 0,
                gear: 'P'
            },
            prayerTimes: { // This will now hold the current day's prayer times from the array
                Fajr: '--:--',
                Dhuhr: '--:--',
                Asr: '--:--',
                Maghrib: '--:--',
                Isha: '--:--',
                nextPrayer: null, // Changed from currentPrayer to nextPrayer
                nextPrayerIqamaTime: null // Stores the Date object for the next prayer's iqama
            },
            hasShownGeolocationError: false // New flag to control geolocation error message
        };

        // --- DOM Element References ---
        // Cache frequently accessed DOM elements for performance
        const timeElement = document.getElementById('current-time');
        const appButtons = document.querySelectorAll('button[data-app]');
        const appScreens = document.querySelectorAll('.app-screen');
        const sidebarIcons = document.querySelectorAll('.app-icon');
        const quranQuickAccess = document.getElementById('quran-quick-access'); // Moved to global scope

        // YouTube/Media specific elements
        const youtubeSearchInput = document.getElementById('youtube-search-input');
        const youtubeSearchButton = document.getElementById('youtube-search-button');
        const youtubeSuggestionsDiv = document.getElementById('youtube-suggestions'); // New
        const youtubePlaylistView = document.getElementById('youtube-playlist-view');
        const youtubeVideoListView = document.getElementById('youtube-video-list-view'); 
        const videoListContainer = document.getElementById('video-list-container'); 
        const youtubeSearchResultsView = document.getElementById('youtube-search-results-view');
        const searchResultsContainer = document.getElementById('search-results-container');
        const youtubePlayerView = document.getElementById('youtube-player-view');
        const youtubePlayerIframe = document.getElementById('youtube-player-iframe');
        const backToPlaylistsFromVideosButton = document.getElementById('back-to-playlists-from-videos'); 
        const backToPlaylistsBottomButton = document.getElementById('back-to-playlists-bottom-button');
        const backToPlaylistsBottomButtonSearch = document.getElementById('back-to-playlists-bottom-button-search');
        const minimizeVideoButton = document.getElementById('minimize-video-button');

        // Quran specific elements
        const quranSurahSelect = document.getElementById('quran-surah-select');
        const quranReaderSelect = document.getElementById('quran-reader-select');
        const quranGoButton = document.getElementById('quran-go-button');
        const quranIframe = document.getElementById('quran-iframe');

        // Floating UI elements
        const floatingFullscreenButton = document.getElementById('floating-fullscreen-button'); // For CarPlay app fullscreen
        const floatingMediaButton = document.getElementById('floating-media-button');
        const floatingKeyboardButton = document.getElementById('floating-keyboard-button'); // New keyboard button
        const clearSearchButton = document.getElementById('clear-search-button'); // New clear search button
        const videoPopupContainer = document.getElementById('video-popup-container');
        const videoPopupIframe = document.getElementById('video-popup-iframe');
        const videoPopupCloseButton = document.getElementById('video-popup-close-button');

        // AI Assistant elements
        const chatHistoryDiv = document.getElementById('chat-history');
        const aiInput = document.getElementById('ai-input');
        const aiSendButton = document.getElementById('ai-send-button');
        const aiMicButton = document.getElementById('ai-mic-button');
        const listeningIndicator = document.getElementById('listening-indicator');

        // Prayer Times elements
        const prayerTimesContainer = document.getElementById('prayer-times-container');
        // New elements for prayer times display
        const fajrTimeElement = document.getElementById('fajr-time');
        const dhuhrTimeElement = document.getElementById('dhuhr-time');
        const asrTimeElement = document.getElementById('asr-time');
        const maghribTimeElement = document.getElementById('maghrib-time');
        const ishaTimeElement = document.getElementById('isha-time');
        const fajrIqamaElement = document.getElementById('fajr-iqama');
        const dhuhrIqamaElement = document.getElementById('dhuhr-iqama');
        const asrIqamaElement = document.getElementById('asr-iqama');
        const maghribIqamaElement = document.getElementById('maghrib-iqama');
        const ishaIqamaElement = document.getElementById('isha-iqama');
      
        // Digital Clock elements for opacity control
        const digitalHoursSpan = document.querySelector('#digital-time .hours');
        const digitalMinutesSpan = document.querySelector('#digital-time .minutes');
        const digitalSecondsSpan = document.querySelector('#digital-time .seconds');
        const digitalDateLine1 = document.getElementById('digital-date-line1');
        const digitalDateLine2 = document.getElementById('digital-date-line2');
      
        // Google Map variables
        let googleMap;
        let googleMarker;
        let trafficLayer; // For traffic
        let watchId; // To store the watchPosition ID for continuous tracking

        // --- Global Variables for Media State ---
        let currentPlayingPlaylistId = ''; // Tracks the currently active playlist
        let activeMediaView = 'playlist'; // 'playlist', 'videoList', 'player', 'searchResults'
        let currentPlayingVideoId = ''; // Stores the ID of the currently playing video
        let isVideoPlayingInPopup = false; // True if video is in the floating pop-up

        // --- Utility Functions ---

        /**
         * Updates the current time in the top bar.
         */
        function updateTopBarTime() {
            const now = new Date();
            let hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');

            // Convert to 12-hour format without AM/PM
            hours = hours % 12;
            hours = hours ? hours : 12; // The hour '0' (midnight) should be '12'

            const timeString = `${hours}:${minutes}`; // Only hours and minutes for top bar
            timeElement.textContent = timeString;
            appState.currentTime = timeString; // Update state
        }

        /**
         * Displays a custom message box instead of native alert/confirm.
         * @param {string} message - The message to display.
         */
        function showMessageBox(message) {
            const messageBox = document.createElement('div');
            messageBox.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
                z-index: 1000;
                text-align: center;
                max-width: 80%;
                font-size: 1.1rem;
            `;
            messageBox.innerHTML = `
                <p>${message}</p>
                <button style="margin-top: 15px; padding: 8px 15px; background-color: #9333ea; border: none; border-radius: 5px; color: white; cursor: pointer;">
                    ÿ•ÿ∫ŸÑÿßŸÇ
                </button>
            `;
            document.body.appendChild(messageBox);

            messageBox.querySelector('button').addEventListener('click', () => {
                document.body.removeChild(messageBox);
            });
        }

        /**
         * Toggles the main CarPlay interface between normal and pseudo-fullscreen.
         */
        function togglePseudoFullscreen() {
            const carplayMainInterface = document.getElementById('carplay-main-interface');
            const topBar = document.querySelector('.top-bar');

            const isFullscreen = carplayMainInterface.classList.toggle('carplay-pseudo-fullscreen');

            if (isFullscreen) {
                floatingFullscreenButton.innerHTML = '<i data-lucide="minimize" class="w-6 h-6"></i>'; // Only icon
                if (topBar) topBar.style.opacity = '0'; 
                document.body.style.overflow = 'hidden'; 
            } else {
                floatingFullscreenButton.innerHTML = '<i data-lucide="maximize" class="w-6 h-6"></i>'; // Only icon
                if (topBar) topBar.style.opacity = '1';
                document.body.style.overflow = ''; 
            }
            lucide.createIcons(); // Re-render Lucide icons after DOM changes
        }

        /**
         * Updates the UI elements based on the current appState.
         */
        function updateUI() {
            // Update Dashboard Weather Widget
            document.getElementById('dashboard-weather-temp').textContent = appState.weather.temperature !== null ? `${appState.weather.temperature}¬∞C` : '--¬∞C';
            document.getElementById('dashboard-weather-desc').textContent = appState.weather.description !== null ? appState.weather.description : '--';
            const dashboardWeatherIconElement = document.getElementById('dashboard-weather-icon');
            if (dashboardWeatherIconElement) {
                dashboardWeatherIconElement.src = appState.weather.iconUrl || 'https://placehold.co/64x64/000000/FFFFFF?text=No+Icon';
                dashboardWeatherIconElement.alt = appState.weather.description || 'Weather Icon';
            }
            document.getElementById('dashboard-weather-location').textContent = appState.weather.location;

            // Update Weather Tab
            document.getElementById('weather-location').textContent = appState.weather.location; 
            document.getElementById('weather-temp').textContent = appState.weather.temperature !== null ? `${appState.weather.temperature}¬∞C` : '--¬∞C';
            document.getElementById('weather-desc').textContent = appState.weather.description !== null ? appState.weather.description : '--';
            document.getElementById('weather-feels-like').textContent = appState.weather.feelsLike !== null ? `ÿßŸÑÿ¥ÿπŸàÿ± ŸÉŸÄ: ${appState.weather.feelsLike}¬∞C` : 'ÿßŸÑÿ¥ÿπŸàÿ± ŸÉŸÄ: --¬∞C';
            document.getElementById('weather-humidity').textContent = appState.weather.humidity !== null ? `${appState.weather.humidity}%` : '--%';
            document.getElementById('weather-wind').textContent = appState.weather.wind !== null ? `${appState.weather.wind} ŸÉŸÖ/ÿ≥` : '-- ŸÉŸÖ/ÿ≥';
            document.getElementById('weather-pressure').textContent = appState.weather.pressure !== null ? `${appState.weather.pressure} mb` : '-- mb';
            document.getElementById('weather-visibility').textContent = appState.weather.visibility !== null ? `${appState.weather.visibility} ŸÉŸÖ` : '-- ŸÉŸÖ';
            appState.weather.uvIndex = appState.weather.uvIndex !== null ? appState.weather.uvIndex : '--'; // Ensure UV index is updated
            document.getElementById('weather-uv').textContent = appState.weather.uvIndex;
            appState.weather.lastUpdated = `ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´: ${new Date().toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: false })}`;
            document.getElementById('weather-last-updated').textContent = appState.weather.lastUpdated !== null ? appState.weather.lastUpdated : '--';
            const weatherIconElement = document.getElementById('weather-icon');
            if (weatherIconElement) {
                weatherIconElement.src = appState.weather.iconUrl || 'https://placehold.co/96x96/000000/FFFFFF?text=No+Icon';
                weatherIconElement.alt = appState.weather.description || 'Weather Icon';
            }

            // Update Prayer Times
            loadPrayerTimes(); // Call loadPrayerTimes to update the display
            determineNextPrayer(); // Changed to determineNextPrayer
            renderPrayerTimes(); // Re-render to apply current prayer highlight
        }

        // --- App Switching Logic ---

        /**
         * Switches the active application screen.
         * @param {string} appName - The ID of the app screen to activate (e.g., 'Dashboard', 'Media').
         */
        function switchApp(appName) {
            // Deactivate all screens and sidebar icons
            appScreens.forEach(screen => screen.classList.remove('active'));
            sidebarIcons.forEach(icon => {
                if(icon.tagName === 'BUTTON'){
                    icon.classList.remove('active', 'bg-purple-600/80', 'scale-110');
                }
            });

            // Activate the target screen and its sidebar icon
            const targetScreen = document.getElementById(`screen-${appName}`);
            if (targetScreen) targetScreen.classList.add('active');

            const targetIcon = document.querySelector(`.app-icon[data-app="${appName}"]`);
            if (targetIcon) targetIcon.classList.add('active'); // Active class now handles the new styling

            // Handle Media (YouTube) view switching specifics
            handleMediaViewSwitch(appName);

            // Handle Quran app specific visibility
            if (appName === 'Quran') {
                // Ensure quranQuickAccess is defined before accessing its style property
                if (quranQuickAccess) {
                    quranQuickAccess.style.display = 'flex';
                }
            } else {
                if (quranQuickAccess) {
                    quranQuickAccess.style.display = 'none';
                }
            }

            updateUI(); // Update UI to reflect latest state
        }

        /**
         * Manages visibility and state for Media (YouTube) sub-views during app switching.
         * @param {string} currentAppName - The name of the app being switched to.
         */
        function handleMediaViewSwitch(currentAppName) {
            if (currentAppName === 'Media') {
                floatingMediaButton.style.display = 'none'; // Hide media button when already in media tab
                floatingKeyboardButton.style.display = 'flex'; // Show keyboard button
                clearSearchButton.style.display = 'flex'; // Always show clear search button in Media tab

                // Set initial keyboard button state based on search input readonly status
                if (youtubeSearchInput.readOnly) {
                    floatingKeyboardButton.classList.add('inactive-keyboard');
                    floatingKeyboardButton.classList.remove('active-keyboard');
                } else {
                    floatingKeyboardButton.classList.add('active-keyboard');
                    floatingKeyboardButton.classList.remove('inactive-keyboard');
                }

                // Hide all media sub-views initially
                youtubePlaylistView.classList.add('hidden');
                youtubePlaylistView.classList.remove('flex', 'flex-col');
                youtubeVideoListView.classList.add('hidden');
                youtubeVideoListView.classList.remove('flex', 'flex-col');
                youtubeSearchResultsView.classList.add('hidden'); 
                youtubeSearchResultsView.classList.remove('flex', 'flex-col'); 
                youtubePlayerView.classList.add('hidden');
                youtubePlayerView.classList.remove('flex', 'flex-col');
                youtubeSuggestionsDiv.classList.remove('hidden'); // Show suggestions

                if (isVideoPlayingInPopup && currentPlayingVideoId) {
                    // If video was playing in pop-up, keep it active
                    videoPopupContainer.classList.add('active'); 
                } else if (activeMediaView === 'videoList' && currentPlayingPlaylistId) {
                    youtubeVideoListView.classList.remove('hidden');
                    youtubeVideoListView.classList.add('flex', 'flex-col');
                    backToPlaylistsBottomButton.style.display = 'flex';
                    backToPlaylistsBottomButtonSearch.style.display = 'none';
                } else if (activeMediaView === 'searchResults') { 
                    youtubeSearchResultsView.classList.remove('hidden');
                    youtubeSearchResultsView.classList.add('flex', 'flex-col');
                    backToPlaylistsBottomButton.style.display = 'none';
                    backToPlaylistsBottomButtonSearch.style.display = 'flex';
                } else { // Default to playlist view
                    youtubePlaylistView.classList.remove('hidden');
                    youtubePlaylistView.classList.add('flex', 'flex-col');
                    backToPlaylistsBottomButton.style.display = 'none';
                    backToPlaylistsBottomButtonSearch.style.display = 'none';
                }
            } else {
                // If switching away from Media tab
                backToPlaylistsBottomButton.style.display = 'none';
                backToPlaylistsBottomButtonSearch.style.display = 'none';
                floatingMediaButton.style.display = 'flex'; // Show media button when not in media tab
                floatingKeyboardButton.style.display = 'none'; // Hide keyboard button
                clearSearchButton.style.display = 'none'; // Hide clear search button
                youtubeSuggestionsDiv.classList.add('hidden'); // Hide suggestions
                
                // If a video is playing in the main player, move it to pop-up
                if (activeMediaView === 'player' && currentPlayingVideoId && !isVideoPlayingInPopup) {
                    minimizeVideoToPopup(currentPlayingVideoId);
                } else if (isVideoPlayingInPopup && currentPlayingVideoId) {
                    // If video is already in pop-up, just ensure pop-up is active
                    videoPopupContainer.classList.add('active');
                } else {
                    // No video playing or pop-up not needed
                    videoPopupContainer.classList.remove('active');
                }
            }
        }

        // --- Event Listeners for App Buttons ---
        appButtons.forEach(button => {
            button.addEventListener('click', () => {
                const appName = button.dataset.app;
                switchApp(appName);
            });
        });
        
        // Apply common styles to sidebar app icons
        sidebarIcons.forEach(el => {
            el.classList.add('w-16', 'h-16', 'rounded-2xl', 'flex', 'items-center', 'justify-center', 'transition-all', 'duration-300', 'ease-in-out', 'focus:outline-none', 'focus:ring-4', 'focus:ring-purple-500/50', 'hover:bg-white/20', 'text-white');
            el.setAttribute('role', 'button');
        });
        
        // --- YouTube/Media Specific Functions and Event Handlers ---

        // YouTube playlist card click handler
        document.querySelectorAll('.youtube-channel-card').forEach(card => {
            card.addEventListener('click', () => {
                const playlistId = card.dataset.playlistId; 
                if (playlistId) {
                    currentPlayingPlaylistId = playlistId;
                    fetchPlaylistVideos(playlistId);
                }
            });
        });

        /**
         * Fetches videos for a given YouTube playlist and displays them.
         * @param {string} playlistId - The ID of the YouTube playlist.
         * @param {boolean} [updateActiveView=true] - Whether to update activeMediaView. Defaults to true.
         */
        async function fetchPlaylistVideos(playlistId, updateActiveView = true) {
            if (YOUTUBE_API_KEY === 'YOUR_YOUTUBE_API_KEY') {
                showMessageBox('ÿÆÿ∑ÿ£: ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿπŸäŸäŸÜ ŸÖŸÅÿ™ÿßÿ≠ YouTube API. Ÿäÿ±ÿ¨Ÿâ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ "YOUR_YOUTUBE_API_KEY" ÿ®ŸÖŸÅÿ™ÿßÿ≠ŸÉ ÿßŸÑÿÆÿßÿµ.');
                console.error('YouTube API Key is not set.');
                return;
            }

            const apiUrl = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${playlistId}&key=${YOUTUBE_API_KEY}&maxResults=20`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.items && data.items.length > 0) {
                    videoListContainer.innerHTML = ''; // Clear previous videos
                    videoListContainer.scrollTop = 0; // Scroll to top of the list
                    data.items.forEach(item => {
                        // Corrected path to videoId
                        const videoId = item.snippet.resourceId.videoId; 
                        const title = item.snippet.title;
                        const thumbnailUrl = item.snippet.thumbnails.medium ? item.snippet.thumbnails.medium.url : 'https://placehold.co/120x90/000000/FFFFFF?text=No+Thumbnail';

                        const videoCard = document.createElement('div');
                        videoCard.classList.add('glass-surface', 'glass-surface--svg', 'youtube-video-card');
                        videoCard.dataset.videoId = videoId;
                        videoCard.innerHTML = `
                            <img src="${thumbnailUrl}" alt="${title}" onerror="this.onerror=null;this.src='https://placehold.co/120x90/000000/FFFFFF?text=No+Thumbnail';" />
                            <h3>${title}</h3>
                        `;
                        // Always show video in popup
                        videoCard.addEventListener('click', () => showVideoPopup(videoId));
                        videoListContainer.appendChild(videoCard);
                    });

                    // Update view visibility
                    youtubePlaylistView.classList.add('hidden');
                    youtubePlaylistView.classList.remove('flex', 'flex-col');
                    youtubeVideoListView.classList.remove('hidden');
                    youtubeVideoListView.classList.add('flex', 'flex-col');
                    youtubePlayerView.classList.add('hidden');
                    youtubePlayerView.classList.remove('flex', 'flex-col');
                    youtubeSearchResultsView.classList.add('hidden');
                    youtubeSearchResultsView.classList.remove('flex', 'flex-col');
                    youtubeSuggestionsDiv.classList.add('hidden'); // Hide suggestions

                    if (updateActiveView) {
                        activeMediaView = 'videoList';
                    }
                    backToPlaylistsBottomButton.style.display = 'flex';
                    backToPlaylistsBottomButtonSearch.style.display = 'none';
                } else {
                    showMessageBox('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÅŸäÿØŸäŸàŸáÿßÿ™ ŸÅŸä ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ Ÿáÿ∞Ÿá.');
                    console.warn('No videos found for playlist:', playlistId, data);
                }
            } catch (error) {
                console.error('Error fetching YouTube playlist videos:', error);
                showMessageBox('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ¨ŸÑÿ® ŸÅŸäÿØŸäŸàŸáÿßÿ™ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ.');
            }
        }

        /**
         * Shows the video in the main player view.
         * This is called when maximizing from the pop-up or directly playing from main media tab.
         * @param {string} videoId - The ID of the YouTube video.
         */
        function playVideoInMainView(videoId) {
            // This function is now effectively unused for initial playback from lists/search.
            // It's kept for potential future use or if maximize from popup is desired to go to main view.
            youtubePlayerIframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
            currentPlayingVideoId = videoId;
            isVideoPlayingInPopup = false;

            // Update view visibility
            youtubeVideoListView.classList.add('hidden');
            youtubeVideoListView.classList.remove('flex', 'flex-col');
            youtubeSearchResultsView.classList.add('hidden');
            youtubeSearchResultsView.classList.remove('flex', 'flex-col');
            youtubePlayerView.classList.remove('hidden');
            youtubePlayerView.classList.add('flex', 'flex-col');
            youtubeSuggestionsDiv.classList.add('hidden'); // Hide suggestions
            
            videoPopupContainer.classList.remove('active'); // Hide pop-up if it was active
            videoPopupIframe.src = ''; // Stop pop-up video
            
            activeMediaView = 'player';
            backToPlaylistsBottomButton.style.display = 'none';
            backToPlaylistsBottomButtonSearch.style.display = 'none';
        }

        /**
         * Shows the video in a pop-up window.
         * @param {string} videoId - The ID of the YouTube video.
         */
        function showVideoPopup(videoId) {
            // The `enablejsapi=1` and `origin` parameters are crucial for the iframe API
            // to allow communication between the parent window and the iframe.
            // This enables YouTube's internal suggestions to function within the pop-up.
            videoPopupIframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&enablejsapi=1&origin=${window.location.protocol}//${window.location.host}`;
            currentPlayingVideoId = videoId;
            isVideoPlayingInPopup = true;

            videoPopupContainer.classList.add('active');
            // Hide main media content when pop-up is active
            youtubePlaylistView.classList.add('hidden');
            youtubeVideoListView.classList.add('hidden');
            youtubeSearchResultsView.classList.add('hidden');
            youtubePlayerView.classList.add('hidden'); // Ensure main player is hidden
            youtubeSuggestionsDiv.classList.add('hidden'); // Hide suggestions
            
            activeMediaView = 'player'; // Still consider it 'player' view for media logic
            backToPlaylistsBottomButton.style.display = 'none';
            backToPlaylistsBottomButtonSearch.style.display = 'none';
        }

        /**
         * Hides the video pop-up and stops the video.
         */
        function hideVideoPopup() {
            videoPopupContainer.classList.remove('active');
            videoPopupIframe.src = ''; // Stop the video
            currentPlayingVideoId = '';
            isVideoPlayingInPopup = false;
        }

        /**
         * Minimizes the video from the main media player view to the pop-up.
         */
        function minimizeVideoToPopup(videoId) {
            if (videoId) {
                youtubePlayerIframe.src = ''; // Stop video in main player
                youtubePlayerView.classList.add('hidden');
                youtubePlayerView.classList.remove('flex', 'flex-col');

                showVideoPopup(videoId); // Show in pop-up
            }
        }

        // Event listeners for video pop-up controls
        videoPopupCloseButton.addEventListener('click', hideVideoPopup);
        minimizeVideoButton.addEventListener('click', () => {
            if (activeMediaView === 'player' && !isVideoPlayingInPopup) {
                minimizeVideoToPopup(currentPlayingVideoId);
                // After minimizing, return to the appropriate list view
                if (currentPlayingPlaylistId) {
                    fetchPlaylistVideos(currentPlayingPlaylistId, false);
                } else if (youtubeSearchInput.value.trim() !== '') {
                    searchYouTubeVideos(youtubeSearchInput.value.trim());
                } else {
                    navigateBackToPlaylists();
                }
            }
        });

        // Make video pop-up draggable
        let isDragging = false;
        let offsetX, offsetY;

        videoPopupContainer.addEventListener('mousedown', (e) => {
            // Only allow dragging from the container itself, not the iframe or controls
            if (e.target === videoPopupContainer) {
                isDragging = true;
                offsetX = e.clientX - videoPopupContainer.getBoundingClientRect().left;
                offsetY = e.clientY - videoPopupContainer.getBoundingClientRect().top;
                videoPopupContainer.style.cursor = 'grabbing';
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            videoPopupContainer.style.left = `${e.clientX - offsetX}px`;
            videoPopupContainer.style.top = `${e.clientY - offsetY}px`;
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            videoPopupContainer.style.cursor = 'grab';
        });

        /**
         * Navigates back to the main YouTube playlists view.
         */
        function navigateBackToPlaylists() {
            youtubeVideoListView.classList.add('hidden');
            youtubeVideoListView.classList.remove('flex', 'flex-col');
            youtubeSearchResultsView.classList.add('hidden');
            youtubeSearchResultsView.classList.remove('flex', 'flex-col');

            youtubePlaylistView.classList.remove('hidden');
            youtubePlaylistView.classList.add('flex', 'flex-col');
            youtubeSuggestionsDiv.classList.remove('hidden'); // Show suggestions again
            
            currentPlayingPlaylistId = ''; // Reset selected playlist
            activeMediaView = 'playlist';
            backToPlaylistsBottomButton.style.display = 'none';
            backToPlayistsBottomButtonSearch.style.display = 'none'; 
        }

        // Event listeners for back buttons in Media tab
        backToPlaylistsFromVideosButton.addEventListener('click', navigateBackToPlaylists);
        backToPlaylistsBottomButton.addEventListener('click', navigateBackToPlaylists); 
        backToPlaylistsBottomButtonSearch.addEventListener('click', navigateBackToPlaylists); 

        // Keyboard button event listener
        floatingKeyboardButton.addEventListener('click', () => {
            youtubeSearchInput.readOnly = !youtubeSearchInput.readOnly; // Toggle readonly
            if (!youtubeSearchInput.readOnly) {
                youtubeSearchInput.focus();
                floatingKeyboardButton.classList.add('active-keyboard');
                floatingKeyboardButton.classList.remove('inactive-keyboard');
            } else {
                youtubeSearchInput.blur(); // Remove focus
                floatingKeyboardButton.classList.add('inactive-keyboard');
                floatingKeyboardButton.classList.remove('active-keyboard');
            }
        });

        // Clear search button event listener
        clearSearchButton.addEventListener('click', () => {
            youtubeSearchInput.value = ''; // Clear the input
            youtubeSearchInput.readOnly = true; // Set back to readonly
            floatingKeyboardButton.classList.add('inactive-keyboard'); // Set keyboard button to inactive
            floatingKeyboardButton.classList.remove('active-keyboard');
            navigateBackToPlaylists(); // Go back to playlists view
        });


        // YouTube Search Functionality
        const youtubeReaderSuggestions = ["ŸÅÿßÿ±ÿ≥ ÿπŸÜÿ™ÿ±","Ÿäÿßÿ≥ÿ± ÿßŸÑÿØŸàÿ≥ÿ±Ÿä", "ÿπŸÑŸä ÿ¨ÿßÿ®ÿ±", "ŸÖÿ≠ŸÖÿØ ÿßŸäŸàÿ®", "ÿπÿ®ÿØ ÿßŸÑÿ®ÿßÿ≥ÿ∑ ÿπÿ®ÿØ ÿßŸÑÿµŸÖÿØ", "ŸÖÿ¥ÿßÿ±Ÿä ÿßŸÑÿπŸÅÿßÿ≥Ÿä"];
        // Using the first 63 surahs for demonstration (9 rows x 7 columns)
        const youtubeSurahSuggestions = [
            "ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©", "ÿßŸÑÿ®ŸÇÿ±ÿ©", "ÿ¢ŸÑ ÿπŸÖÿ±ÿßŸÜ", "ÿßŸÑŸÜÿ≥ÿßÿ°", "ÿßŸÑŸÖÿßÿ¶ÿØÿ©", "ÿßŸÑÿ£ŸÜÿπÿßŸÖ", "ÿßŸÑÿ£ÿπÿ±ÿßŸÅ", "ÿßŸÑÿ£ŸÜŸÅÿßŸÑ", "ÿßŸÑÿ™Ÿàÿ®ÿ©", "ŸäŸàŸÜÿ≥",
            "ŸáŸàÿØ", "ŸäŸàÿ≥ŸÅ", "ÿßŸÑÿ±ÿπÿØ", "ÿ•ÿ®ÿ±ÿßŸáŸäŸÖ", "ÿßŸÑÿ≠ÿ¨ÿ±", "ÿßŸÑŸÜÿ≠ŸÑ", "ÿßŸÑÿ•ÿ≥ÿ±ÿßÿ°", "ÿßŸÑŸÉŸáŸÅ", "ŸÖÿ±ŸäŸÖ", "ÿ∑Ÿá",
            "ÿßŸÑÿ£ŸÜÿ®Ÿäÿßÿ°", "ÿßŸÑÿ≠ÿ¨", "ÿßŸÑŸÖÿ§ŸÖŸÜŸàŸÜ", "ÿßŸÑŸÜŸàÿ±", "ÿßŸÑŸÅÿ±ŸÇÿßŸÜ", "ÿßŸÑÿ¥ÿπÿ±ÿßÿ°", "ÿßŸÑŸÜŸÖŸÑ", "ÿßŸÑŸÇÿµÿµ", "ÿßŸÑÿπŸÜŸÉÿ®Ÿàÿ™", "ÿßŸÑÿ±ŸàŸÖ",
            "ŸÑŸÇŸÖÿßŸÜ", "ÿßŸÑÿ≥ÿ¨ÿØÿ©", "ÿßŸÑÿ£ÿ≠ÿ≤ÿßÿ®", "ÿ≥ÿ®ÿ£", "ŸÅÿßÿ∑ÿ±", "Ÿäÿ≥", "ÿßŸÑÿµÿßŸÅÿßÿ™", "ÿµ", "ÿßŸÑÿ≤ŸÖÿ±", "ÿ∫ÿßŸÅÿ±",
            "ŸÅÿµŸÑÿ™", "ÿßŸÑÿ¥Ÿàÿ±Ÿâ", "ÿßŸÑÿ≤ÿÆÿ±ŸÅ", "ÿßŸÑÿØÿÆÿßŸÜ", "ÿßŸÑÿ¨ÿßÿ´Ÿäÿ©", "ÿßŸÑÿ£ÿ≠ŸÇÿßŸÅ", "ŸÖÿ≠ŸÖÿØ", "ÿßŸÑŸÅÿ™ÿ≠", "ÿßŸÑÿ≠ÿ¨ÿ±ÿßÿ™", "ŸÇ",
            "ÿßŸÑÿ∞ÿßÿ±Ÿäÿßÿ™", "ÿßŸÑÿ∑Ÿàÿ±", "ÿßŸÑŸÜÿ¨ŸÖ", "ÿßŸÑŸÇŸÖÿ±", "ÿßŸÑÿ±ÿ≠ŸÖŸÜ", "ÿßŸÑŸàÿßŸÇÿπÿ©", "ÿßŸÑÿ≠ÿØŸäÿØ", "ÿßŸÑŸÖÿ¨ÿßÿØŸÑÿ©", "ÿßŸÑÿ≠ÿ¥ÿ±", "ÿßŸÑŸÖŸÖÿ™ÿ≠ŸÜÿ©",
            "ÿßŸÑÿµŸÅ", "ÿßŸÑÿ¨ŸÖÿπÿ©", "ÿßŸÑŸÖŸÜÿßŸÅŸÇŸàŸÜ"
        ];

        /**
         * Populates and displays YouTube search suggestions.
         */
        function populateYoutubeSuggestions() {
            youtubeSuggestionsDiv.innerHTML = ''; // Clear previous suggestions
            // Use flex-col for mobile stacking, and flex-row-reverse for desktop to put readers on the right
            youtubeSuggestionsDiv.classList.add('flex', 'flex-col', 'md:flex-row-reverse', 'gap-4', 'w-full'); 

            // Readers section (will appear on the right on desktop, top on mobile)
            const readersSection = document.createElement('div');
            // Adjusted classes for readers section to be a single column and take less width
            readersSection.classList.add('flex', 'flex-col', 'gap-2', 'p-3', 'rounded-xl', 'glass-surface', 'glass-surface--svg', 'md:w-1/5', 'flex-shrink-0'); 
            readersSection.innerHTML = '<span class="youtube-suggestion-category-tag bg-blue-600">ŸÑŸÑŸÇÿ±ÿßÿ°</span>';
            youtubeReaderSuggestions.forEach(suggestion => {
                const button = document.createElement('button');
                button.classList.add('youtube-suggestion-button');
                button.textContent = suggestion;
                button.addEventListener('click', () => {
                    youtubeSearchInput.value += suggestion + ' '; // Append text and a space
                    youtubeSearchInput.focus();
                });
                readersSection.appendChild(button);
            });
            youtubeSuggestionsDiv.appendChild(readersSection);

            // Surahs section (will appear on the left on desktop, bottom on mobile)
            const surahsSection = document.createElement('div');
            // Adjusted classes for surahs section to take remaining width
            surahsSection.classList.add('flex', 'flex-col', 'gap-2', 'p-3', 'rounded-xl', 'glass-surface', 'glass-surface--svg', 'flex-grow'); 
            surahsSection.innerHTML = '<span class="youtube-suggestion-category-tag bg-green-600">ŸÑŸÑÿ≥Ÿàÿ±</span>';
            const surahButtonsContainer = document.createElement('div');
            // Changed grid-cols-4 to md:grid-cols-9 for 9 columns on medium and larger screens
            surahButtonsContainer.classList.add('grid', 'grid-cols-4', 'md:grid-cols-9', 'gap-2', 'w-full'); 

            youtubeSurahSuggestions.forEach(name => {
                const button = document.createElement('button');
                button.classList.add('youtube-suggestion-button');
                button.textContent = name;
                button.addEventListener('click', () => {
                    youtubeSearchInput.value += name + ' ';
                    youtubeSearchInput.focus();
                });
                surahButtonsContainer.appendChild(button);
            });
            surahsSection.appendChild(surahButtonsContainer);
            youtubeSuggestionsDiv.appendChild(surahsSection);
        }

        youtubeSearchInput.addEventListener('focus', () => {
            if (youtubeSearchInput.value.trim() === '') {
                populateYoutubeSuggestions();
                youtubeSuggestionsDiv.classList.remove('hidden');
            }
        });

        // Removed the conditional display of clearSearchButton based on input.value
        // youtubeSearchInput.addEventListener('input', () => {
        //     if (youtubeSearchInput.value.trim() === '') {
        //         youtubeSuggestionsDiv.classList.remove('hidden');
        //         populateYoutubeSuggestions(); // Repopulate to ensure all are there
        //     } else {
        //         youtubeSuggestionsDiv.classList.add('hidden');
        //     }
        // });

        youtubeSearchButton.addEventListener('click', () => {
            const query = youtubeSearchInput.value.trim();
            if (query) {
                searchYouTubeVideos(query);
            } else {
                showMessageBox('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ŸÑŸÑÿ®ÿ≠ÿ´.');
            }
        });

        /**
         * Searches YouTube for videos based on a query and displays results.
         * @param {string} query - The search query.
         */
        async function searchYouTubeVideos(query) {
            if (YOUTUBE_API_KEY === 'YOUR_YOUTUBE_API_KEY') {
                showMessageBox('ÿÆÿ∑ÿ£: ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿπŸäŸäŸÜ ŸÖŸÅÿ™ÿßÿ≠ YouTube API. Ÿäÿ±ÿ¨Ÿâ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ "YOUR_YOUTUBE_API_KEY" ÿ®ŸÖŸÅÿ™ÿßÿ≠ŸÉ ÿßŸÑÿÆÿßÿµ.');
                console.error('YouTube API Key is not set.');
                return;
            }

            const apiUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&key=${YOUTUBE_API_KEY}&maxResults=20`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.items && data.items.length > 0) {
                    searchResultsContainer.innerHTML = ''; // Clear previous search results
                    searchResultsContainer.scrollTop = 0; // Scroll to top of the search results
                    data.items.forEach(item => {
                        const videoId = item.id.videoId;
                        const title = item.snippet.title;
                        const thumbnailUrl = item.snippet.thumbnails.medium ? item.snippet.thumbnails.medium.url : 'https://placehold.co/120x90/000000/FFFFFF?text=No+Thumbnail';

                        const videoCard = document.createElement('div');
                        videoCard.classList.add('glass-surface', 'glass-surface--svg', 'youtube-search-card');
                        videoCard.dataset.videoId = videoId;
                        videoCard.innerHTML = `
                            <img src="${thumbnailUrl}" alt="${title}" onerror="this.onerror=null;this.src='https://placehold.co/120x90/000000/FFFFFF?text=No+Thumbnail';" />
                            <h3>${title}</h3>
                        `;
                        // Always show video in popup
                        videoCard.addEventListener('click', () => showVideoPopup(videoId));
                        searchResultsContainer.appendChild(videoCard);
                    });

                    // Update view visibility
                    youtubePlaylistView.classList.add('hidden');
                    youtubePlaylistView.classList.remove('flex', 'flex-col');
                    youtubeVideoListView.classList.add('hidden');
                    youtubeVideoListView.classList.remove('flex', 'flex-col');
                    youtubePlayerView.classList.add('hidden');
                    youtubePlayerView.classList.remove('flex', 'flex-col');
                    youtubeSearchResultsView.classList.remove('hidden');
                    youtubeSearchResultsView.classList.add('flex', 'flex-col');
                    youtubeSuggestionsDiv.classList.add('hidden'); // Hide suggestions after search results are loaded
                    activeMediaView = 'searchResults';
                    backToPlaylistsBottomButton.style.display = 'none';
                    backToPlaylistsBottomButtonSearch.style.display = 'flex';
                } else {
                    showMessageBox('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÜÿ™ÿßÿ¶ÿ¨ ÿ®ÿ≠ÿ´ ŸÑŸÄ: ' + query);
                    searchResultsContainer.innerHTML = '<p class="text-center text-white/70 col-span-full">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ÿ®ÿ≠ÿ´.</p>';
                }
            } catch (error) {
                console.error('Error searching YouTube videos:', error);
                showMessageBox('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ŸäŸàÿ™ŸäŸàÿ®.');
            }
        }

        // --- AI Assistant Logic ---
        let recognition; // Speech recognition object
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false; // Listen for a single utterance
            recognition.interimResults = false; // Only return final results
            recognition.lang = 'ar-SA'; // Set language to Arabic (Saudi Arabia)

            recognition.onstart = function() {
                aiMicButton.classList.add('bg-red-500');
                listeningIndicator.classList.remove('hidden');
                aiInput.placeholder = 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ...';
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                aiInput.value = transcript;
                sendAIAssistantMessage(); // Send message after speech is recognized
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                listeningIndicator.classList.add('hidden');
                aiMicButton.classList.remove('bg-red-500');
                aiInput.placeholder = 'ÿßÿ≥ÿ£ŸÑŸÜŸä ÿ£Ÿä ÿ¥Ÿäÿ°...';
                const errorMessageDiv = document.createElement('div');
                errorMessageDiv.classList.add('chat-message', 'ai');
                errorMessageDiv.textContent = 'ÿπÿ∞ÿ±Ÿãÿßÿå ŸÑŸÖ ÿ£ÿ≥ÿ™ÿ∑ÿπ ŸÅŸáŸÖŸÉ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.';
                chatHistoryDiv.appendChild(errorMessageDiv);
                chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            };

            recognition.onend = function() {
                aiMicButton.classList.remove('bg-red-500');
                listeningIndicator.classList.add('hidden');
                aiInput.placeholder = 'ÿßÿ≥ÿ£ŸÑŸÜŸä ÿ£Ÿä ÿ¥Ÿäÿ°...';
            };
        } else {
            aiMicButton.style.display = 'none'; // Hide mic button if API not supported
            console.warn('Web Speech API is not supported in this browser.');
        }

        aiMicButton.addEventListener('click', () => {
            if (recognition) {
                recognition.start();
            }
        });

        let synth = window.speechSynthesis; // Speech synthesis object
        let arabicVoice = null; // Stores the preferred Arabic voice

        /**
         * Sets the preferred Arabic voice for speech synthesis.
         */
        function setArabicVoice() {
            if (synth) {
                const voices = synth.getVoices();
                arabicVoice = voices.find(voice => voice.lang.startsWith('ar'));
                if (arabicVoice) {
                    console.log('Arabic voice found:', arabicVoice.name);
                } else {
                    console.warn('Arabic voice not found. Speech synthesis for Arabic may use a default or not work as expected.');
                }
            }
        }
        if (synth) {
            synth.onvoiceschanged = setArabicVoice; // Listen for voice changes
            setArabicVoice(); // Call initially in case voices are already loaded
        }

        /**
         * Sends a message to the AI assistant and handles its response.
         * Includes simulated car data responses and actual Gemini API calls.
         */
        async function sendAIAssistantMessage() {
            const userMessageText = aiInput.value.trim();
            if (userMessageText === '') return;

            // Display user message in chat history
            const userMessageDiv = document.createElement('div');
            userMessageDiv.classList.add('chat-message', 'user');
            userMessageDiv.textContent = userMessageText;
            chatHistoryDiv.appendChild(userMessageDiv);
            aiInput.value = ''; // Clear input field

            // Display typing indicator for AI response
            const typingIndicatorDiv = document.createElement('div');
            typingIndicatorDiv.classList.add('chat-message', 'ai');
            typingIndicatorDiv.textContent = 'ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÉÿ™ÿßÿ®ÿ©...';
            typingIndicatorDiv.id = 'typing-indicator';
            chatHistoryDiv.appendChild(typingIndicatorDiv);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight; // Scroll to bottom

            let aiResponseText = '';

            // --- AI Customization for Car Screen (Simulated Responses) ---
            const lowerCaseMessage = userMessageText.toLowerCase();
            if (lowerCaseMessage.includes('ÿ≥ÿ±ÿπÿ©')) {
                aiResponseText = `ÿ≥ÿ±ÿπÿ© ÿßŸÑÿ≥Ÿäÿßÿ±ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸáŸä ${appState.car.speed !== null ? appState.car.speed : '--'} ŸÉŸÖ/ÿ≥.`;
            } else if (lowerCaseMessage.includes('ŸàŸÇŸàÿØ') || lowerCaseMessage.includes('ÿ®ŸÜÿ≤ŸäŸÜ')) {
                aiResponseText = `ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑŸàŸÇŸàÿØ ÿßŸÑÿ≠ÿßŸÑŸä ŸáŸà ${appState.car.fuel !== null ? appState.car.fuel : '--'}%.`;
            } else if (lowerCaseMessage.includes('rpm') || lowerCaseMessage.includes('ÿØŸàÿ±ÿßŸÜ ÿßŸÑŸÖÿ≠ÿ±ŸÉ')) {
                aiResponseText = `ÿπÿØÿØ ÿØŸàÿ±ÿßÿ™ ÿßŸÑŸÖÿ≠ÿ±ŸÉ (RPM) ŸáŸà ${appState.car.rpm !== null ? appState.car.rpm : '--'}.`;
            } else if (lowerCaseMessage.includes('ÿ≠ÿ±ÿßÿ±ÿ©') || lowerCaseMessage.includes('ÿØÿ±ÿ¨ÿ© ÿ≠ÿ±ÿßÿ±ÿ© ÿßŸÑŸÖÿ≠ÿ±ŸÉ')) {
                aiResponseText = `ÿØÿ±ÿ¨ÿ© ÿ≠ÿ±ÿßÿ±ÿ© ÿßŸÑŸÖÿ≠ÿ±ŸÉ ŸáŸä ${appState.car.temp !== null ? appState.car.temp : '--'}¬∞C.`;
            } else if (lowerCaseMessage.includes('ÿ™ÿ±ÿ≥') || lowerCaseMessage.includes('ÿ∫Ÿäÿßÿ±')) {
                aiResponseText = `ÿßŸÑÿ™ÿ±ÿ≥ ÿßŸÑÿ≠ÿßŸÑŸä ŸáŸà ${appState.car.gear !== null ? appState.car.gear : '--'}.`;
            } else {
                // Original Gemini API call for general questions
                try {
                    if (AI_ASSISTANT_API_KEY === 'YOUR_GEMINI_API_KEY') {
                        aiResponseText = 'ÿÆÿ∑ÿ£: ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿπŸäŸäŸÜ ŸÖŸÅÿ™ÿßÿ≠ Gemini API. Ÿäÿ±ÿ¨Ÿâ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ "YOUR_GEMINI_API_KEY" ÿ®ŸÖŸÅÿ™ÿßÿ≠ŸÉ ÿßŸÑÿÆÿßÿµ.';
                        console.error('Gemini API Key is not set.');
                    } else {
                        let chatHistory = [];
                        chatHistory.push({ role: "user", parts: [{ text: userMessageText }] });
                        const payload = { contents: chatHistory };
                        const apiKey = AI_ASSISTANT_API_KEY;
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`; 

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        const result = await response.json();

                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            aiResponseText = result.candidates[0].content.parts[0].text;
                        } else {
                            aiResponseText = 'ÿπÿ∞ÿ±Ÿãÿßÿå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ŸÖÿπÿßŸÑÿ¨ÿ© ÿ∑ŸÑÿ®ŸÉ ŸÖŸÜ Gemini. (ÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÇÿπÿ©)';
                            console.error('Unexpected Gemini API response structure:', result);
                        }
                    }
                } catch (error) {
                    console.error('Error calling Gemini API:', error);
                    aiResponseText = 'ÿπÿ∞ÿ±Ÿãÿßÿå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßÿ™ÿµÿßŸÑŸÉ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ÿ£Ÿà ŸÖŸÅÿ™ÿßÿ≠ API.';
                }
            }

            // Remove typing indicator and display AI response
            if (typingIndicatorDiv && typingIndicatorDiv.parentNode) {
                typingIndicatorDiv.parentNode.removeChild(typingIndicatorDiv);
            }

            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.classList.add('chat-message', 'ai');
            aiMessageDiv.textContent = aiResponseText;
            chatHistoryDiv.appendChild(aiMessageDiv);

            // Speak the AI response
            if (synth && aiResponseText) {
                const utterance = new SpeechSynthesisUtterance(aiResponseText);
                if (arabicVoice) {
                    utterance.voice = arabicVoice;
                }
                utterance.lang = 'ar-SA';
                synth.speak(utterance);
            }
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight; // Scroll to bottom again
        }

        aiSendButton.addEventListener('click', sendAIAssistantMessage);

        // --- Google Map and Geolocation Functions ---
        /**
         * Initializes the Google Map on the dashboard.
         * This function is called by the Google Maps API script once loaded.
         */
        function initMap() {
            const mapContainer = document.getElementById('dashboard-leaflet-map'); // Keep the same container ID
            if (!mapContainer) {
                console.error("Google Map container not found!");
                return;
            }

            if (googleMap) {
                // If map already exists, just update its view (shouldn't happen with callback)
                googleMap.setCenter({ lat: appState.mapLocation.lat, lng: appState.mapLocation.lon });
                // No need to set zoom here, it will be handled by updateGoogleMapLocation
                if (googleMarker) {
                    googleMarker.setPosition({ lat: appState.mapLocation.lat, lng: appState.mapLocation.lon });
                }
                return;
            }

            const mapOptions = {
                center: { lat: appState.mapLocation.lat, lng: appState.mapLocation.lon },
                zoom: appState.mapLocation.zoom,
                disableDefaultUI: true, // Hide default UI controls
                zoomControl: true, // Keep zoom controls
                fullscreenControl: false, // Disable fullscreen control
                streetViewControl: false, // Disable street view
                mapTypeControl: false, // Disable map type control
                // Custom marker icon for a circular appearance
                // Using a simple SVG circle for the marker
                markerOptions: {
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8, // Size of the circle
                        fillColor: '#4285F4', // Blue color
                        fillOpacity: 0.8,
                        strokeWeight: 0, // No border
                        anchor: new google.maps.Point(0, 0) // Center the circle
                    }
                },
                // Dark mode styles for the map
                styles: [
                    { elementType: 'geometry', stylers: [{ color: '#242f3e' }] },
                    { elementType: 'labels.text.stroke', stylers: [{ color: '#242f3e' }] },
                    { elementType: 'labels.text.fill', stylers: [{ color: '#746855' }] },
                    {
                        featureType: 'administrative.locality',
                        elementType: 'labels.text.fill',
                        stylers: [{ color: '#d59563' }]
                    },
                    {
                        featureType: 'poi',
                        elementType: 'labels.text.fill',
                        stylers: [{ color: '#d59563' }]
                    },
                    {
                        featureType: 'poi.park',
                        elementType: 'geometry',
                        stylers: [{ color: '#263c3f' }]
                    },
                    {
                        featureType: 'poi.park',
                        elementType: 'labels.text.fill',
                        stylers: [{ color: '#6b9a76' }]
                    },
                    {
                        featureType: 'road',
                        elementType: 'geometry',
                        stylers: [{ color: '#38414e' }]
                    },
                    {
                        featureType: 'road',
                        elementType: 'geometry.stroke',
                        stylers: [{ color: '#212a37' }]
                    },
                    {
                        featureType: 'road',
                        elementType: 'labels.text.fill',
                        stylers: [{ color: '#9ca5b3' }]
                    },
                    {
                        featureType: 'road.highway',
                        elementType: 'geometry',
                        stylers: [{ color: '#746855' }]
                    },
                    {
                        featureType: 'road.highway',
                        elementType: 'geometry.stroke',
                        stylers: [{ color: '#1f2835' }]
                    },
                    {
                        featureType: 'road.highway',
                        elementType: 'labels.text.fill',
                        stylers: [{ color: '#f3d19c' }]
                    },
                    {
                        featureType: 'transit',
                        elementType: 'geometry',
                        stylers: [{ color: '#2f3948' }]
                    },
                    {
                        featureType: 'transit.station',
                        elementType: 'labels.text.fill',
                        stylers: [{ color: '#d59563' }]
                    },
                    {
                        featureType: 'water',
                        elementType: 'geometry',
                        stylers: [{ color: '#17263c' }]
                    },
                    {
                        featureType: 'water',
                        elementType: 'labels.text.fill',
                        stylers: [{ color: '#515c6d' }]
                    },
                    {
                        featureType: 'water',
                        elementType: 'labels.text.stroke',
                        stylers: [{ color: '#17263c' }]
                    }
                ]
            };

            googleMap = new google.maps.Map(mapContainer, mapOptions);

            // Add a default marker at Salalah with circular style
            googleMarker = new google.maps.Marker({
                position: { lat: appState.mapLocation.lat, lng: appState.mapLocation.lon },
                map: googleMap,
                title: 'ŸÖŸàŸÇÿπ ÿµŸÑÿßŸÑÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä',
                icon: mapOptions.markerOptions.icon // Apply the circular icon
            });

            // Add traffic layer
            trafficLayer = new google.maps.TrafficLayer();
            trafficLayer.setMap(googleMap);

            console.log("Google Map initialized with traffic layer.");
            startContinuousLocationTracking(); // Start continuous tracking after map init
        }

        /**
         * Updates the Google Map with the user's current location.
         * @param {GeolocationPosition} position - The geolocation position object.
         */
        function updateGoogleMapLocation(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const heading = position.coords.heading; // Get heading (direction of travel)

            appState.mapLocation.lat = lat;
            appState.mapLocation.lon = lon;

            if (!googleMap) {
                console.warn("Google Map not initialized when updateGoogleMapLocation called. Attempting initMap...");
                initMap();
                if (!googleMap) {
                    console.error("Failed to initialize Google Map.");
                    return;
                }
            }

            const newLatLng = { lat: lat, lng: lon };

            if (googleMarker) {
                googleMarker.setPosition(newLatLng);
            } else {
                googleMarker = new google.maps.Marker({
                    position: newLatLng,
                    map: googleMap,
                    title: 'ŸÖŸàŸÇÿπŸÉ ÿßŸÑÿ≠ÿßŸÑŸä',
                    icon: { // Apply the circular icon for new marker
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: '#4285F4',
                        fillOpacity: 0.8,
                        strokeWeight: 0,
                        anchor: new google.maps.Point(0, 0)
                    }
                });
            }
            
            // Adjust map view to fit the new location and increase zoom by 4
            googleMap.setCenter(newLatLng);
            googleMap.setZoom(Math.min(googleMap.getZoom() + 4, 20)); // Increase zoom by 4, max 20

            // Auto-rotate map if heading is available and valid
            // Note: Geolocation API's `heading` is the direction of travel, not device orientation.
            // Map rotation based on device orientation is not directly supported by Google Maps JS API.
            if (typeof heading === 'number' && !isNaN(heading)) {
                googleMap.setHeading(heading);
                console.log("Map heading updated to:", heading);
            } else {
                console.warn("Geolocation heading not available or invalid for auto-rotation.");
            }
        }

        /**
         * Starts continuous geolocation tracking and updates the map.
         */
        function startContinuousLocationTracking() {
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        updateGoogleMapLocation(position);
                        // Reset the error flag if location is successfully obtained
                        appState.hasShownGeolocationError = false; 
                    },
                    (error) => {
                        console.error('Geolocation watch error:', error);
                        console.error('Geolocation error code:', error.code);
                        console.error('Geolocation error message:', error.message);
                        let errorMessage = 'ÿ™ÿπÿ∞ÿ± ÿ™ÿ™ÿ®ÿπ ŸÖŸàŸÇÿπŸÉ ÿßŸÑÿ≠ÿßŸÑŸä ÿ®ÿ¥ŸÉŸÑ ŸÖÿ≥ÿ™ŸÖÿ±.';
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += ' Ÿäÿ±ÿ¨Ÿâ ŸÖŸÜÿ≠ ÿßŸÑÿ•ÿ∞ŸÜ ŸÑŸÑŸÖŸàŸÇÿπ.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += ' ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸàŸÇÿπ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±ÿ©.';
                                break;
                            case error.TIMEOUT:
                                errorMessage += ' ÿßŸÜÿ™Ÿáÿ™ ŸÖŸáŸÑÿ© ÿ∑ŸÑÿ® ÿßŸÑŸÖŸàŸÇÿπ.';
                                break;
                            default:
                                errorMessage += ' ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ.';
                                break;
                        }
                        // Only show message box once for continuous errors
                        if (!appState.hasShownGeolocationError) {
                            showMessageBox(errorMessage);
                            appState.hasShownGeolocationError = true;
                        }
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 } // Shorter timeout for continuous
                );
                console.log("Continuous geolocation tracking started.");
            } else {
                showMessageBox('ÿßŸÑŸÖŸàŸÇÿπ ÿßŸÑÿ¨ÿ∫ÿ±ÿßŸÅŸä ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÖÿ™ÿµŸÅÿ≠.');
            }
        }

        /**
         * Centers the Google Map on the user's current location (one-time update).
         * This function is called when the "ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàŸÇÿπ" button is clicked.
         */
        function centerMapOnUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        updateGoogleMapLocation(position);
                        showMessageBox(`ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ÿ•ŸÑŸâ ŸÖŸàŸÇÿπŸÉ ÿßŸÑÿ≠ÿßŸÑŸä.`);
                        appState.hasShownGeolocationError = false; // Reset error flag on successful manual update
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        let errorMessage = 'ÿ™ÿπÿ∞ÿ± ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÖŸàŸÇÿπŸÉ ÿßŸÑÿ≠ÿßŸÑŸä.';
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += ' Ÿäÿ±ÿ¨Ÿâ ŸÖŸÜÿ≠ ÿßŸÑÿ•ÿ∞ŸÜ ŸÑŸÑŸÖŸàŸÇÿπ.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += ' ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸàŸÇÿπ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±ÿ©.';
                                break;
                            case error.TIMEOUT:
                                errorMessage += ' ÿßŸÜÿ™Ÿáÿ™ ŸÖŸáŸÑÿ© ÿ∑ŸÑÿ® ÿßŸÑŸÖŸàŸÇÿπ.';
                                break;
                            default:
                                errorMessage += ' ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ.';
                                break;
                        }
                        showMessageBox(errorMessage);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                showMessageBox('ÿßŸÑŸÖŸàŸÇÿπ ÿßŸÑÿ¨ÿ∫ÿ±ÿßŸÅŸä ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÖÿ™ÿµŸÅÿ≠.');
            }
        }
        
        // --- Weather API Integration ---

        /**
         * Fetches live weather data from WeatherAPI.com and updates appState.
         */
        async function fetchWeatherData() {
            if (WEATHER_API_KEY === 'YOUR_WEATHERAPI_KEY') {
                showMessageBox('ÿÆÿ∑ÿ£: ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿπŸäŸäŸÜ ŸÖŸÅÿ™ÿßÿ≠ WeatherAPI. Ÿäÿ±ÿ¨Ÿâ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ "YOUR_WEATHERAPI_KEY" ÿ®ŸÖŸÅÿ™ÿßÿ≠ŸÉ ÿßŸÑÿÆÿßÿµ.');
                console.error('WeatherAPI Key is not set.');
                // Fallback to default or clear data on API key error
                appState.weather.temperature = '--';
                appState.weather.feelsLike = '--';
                appState.weather.description = 'ÿÆÿ∑ÿ£ ŸÅŸä ŸÖŸÅÿ™ÿßÿ≠ API';
                appState.weather.humidity = '--';
                appState.weather.wind = '--';
                appState.weather.pressure = '--';
                appState.weather.visibility = '--';
                appState.weather.uvIndex = '--';
                appState.weather.iconUrl = '';
                appState.weather.lastUpdated = '--';
                updateUI();
                return;
            }

            const location = appState.weather.location.split(',')[0].trim();
            const apiUrl = `https://api.weatherapi.com/v1/current.json?key=${WEATHER_API_KEY}&q=${location}&lang=ar`; 

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    // Check for 401 specifically
                    if (response.status === 401) {
                        throw new Error(`ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿµÿßÿØŸÇÿ© API (401). Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÖŸÅÿ™ÿßÿ≠ WeatherAPI ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ.`);
                    }
                    throw new Error(`ÿÆÿ∑ÿ£ HTTP! ÿßŸÑÿ≠ÿßŸÑÿ©: ${response.status}`);
                }
                const data = await response.json();

                appState.weather.temperature = data.current.temp_c;
                appState.weather.feelsLike = data.current.feelslike_c;
                appState.weather.description = data.current.condition.text;
                appState.weather.humidity = data.current.humidity;
                appState.weather.wind = data.current.wind_kph;
                appState.weather.pressure = data.current.pressure_mb;
                appState.weather.visibility = data.current.vis_km; // Correctly assign here
                appState.weather.uvIndex = data.current.uv;
                // Correctly set the icon URL
                appState.weather.iconUrl = `https:${data.current.condition.icon}`; 
                
                const now = new Date();
                appState.weather.lastUpdated = `ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´: ${now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: false })}`;
                appState.weather.location = `${data.location.name}, ${data.location.country}`;

            } catch (error) {
                console.error('Error fetching weather data:', error);
                showMessageBox(`ÿ™ÿπÿ∞ÿ± ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ŸÇÿ≥: ${error.message}. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÖŸÅÿ™ÿßÿ≠ API ŸàÿßŸÑŸÖŸàŸÇÿπ.`);
                // Fallback to default or clear data on error
                appState.weather.temperature = '--';
                appState.weather.feelsLike = '--';
                appState.weather.description = 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ';
                appState.weather.humidity = '--';
                appState.weather.wind = '--';
                appState.weather.pressure = '--';
                appState.weather.visibility = '--';
                appState.weather.uvIndex = '--';
                appState.weather.iconUrl = '';
                appState.weather.lastUpdated = '--';
            } finally {
                updateUI(); // Always update UI, even on error
            }
        }

        // --- Simulated Car Data (for AI Assistant) ---
        /**
         * Generates random simulated car data.
         */
        function simulateCarData() {
            appState.car.speed = (Math.random() * 120).toFixed(0); // 0-120 km/h
            appState.car.rpm = (Math.random() * (5000 - 800) + 800).toFixed(0); // 800-5000 RPM
            appState.car.fuel = (Math.random() * 100).toFixed(0); // 0-100%
            appState.car.temp = (Math.random() * (100 - 70) + 70).toFixed(1); // 70-100 C
            const gears = ['P', 'R', 'N', 'D'];
            appState.car.gear = gears[Math.floor(Math.random() * gears.length)];
        }

        // --- Prayer Times Integration ---
        // Prayer times data provided by the user
        const prayerTimes = [
            {"date":"2025-07-27","fajr":"04:44","sunrise":"06:02","dhuhr":"12:35","asr":"15:49","maghrib":"19:03","isha":"20:17"},
            {"date":"2025-07-28","fajr":"04:44","sunrise":"06:02","dhuhr":"12:35","asr":"15:49","maghrib":"19:03","isha":"20:16"},
            {"date":"2025-07-29","fajr":"04:44","sunrise":"06:03","dhuhr":"12:35","asr":"15:48","maghrib":"19:03","isha":"20:16"},
            {"date":"2025-07-30","fajr":"04:45","sunrise":"06:03","dhuhr":"12:35","asr":"15:48","maghrib":"19:02","isha":"20:15"},
            {"date":"2025-07-31","fajr":"04:45","sunrise":"06:03","dhuhr":"12:35","asr":"15:47","maghrib":"19:02","isha":"20:15"},
            {"date":"2025-08-01","fajr":"04:46","sunrise":"06:04","dhuhr":"12:35","asr":"15:46","maghrib":"19:02","isha":"20:14"},
            {"date":"2025-08-02","fajr":"04:46","sunrise":"06:04","dhuhr":"12:35","asr":"15:46","maghrib":"19:01","isha":"20:14"},
            {"date":"2025-08-03","fajr":"04:47","sunrise":"06:04","dhuhr":"12:35","asr":"15:45","maghrib":"19:01","isha":"20:13"},
            {"date":"2025-08-04","fajr":"04:47","sunrise":"06:04","dhuhr":"12:35","asr":"15:44","maghrib":"19:00","isha":"20:13"},
            {"date":"2025-08-05","fajr":"04:48","sunrise":"06:05","dhuhr":"12:35","asr":"15:44","maghrib":"19:00","isha":"20:12"},
            {"date":"2025-08-06","fajr":"04:48","sunrise":"06:05","dhuhr":"12:35","asr":"15:44","maghrib":"18:59","isha":"20:11"},
            {"date":"2025-08-07","fajr":"04:48","sunrise":"06:05","dhuhr":"12:35","asr":"15:44","maghrib":"18:59","isha":"20:11"},
            {"date":"2025-08-08","fajr":"04:49","sunrise":"06:05","dhuhr":"12:34","asr":"15:45","maghrib":"18:58","isha":"20:10"},
            {"date":"2025-08-09","fajr":"04:49","sunrise":"06:06","dhuhr":"12:34","asr":"15:45","maghrib":"18:58","isha":"20:09"},
            {"date":"2025-08-10","fajr":"04:50","sunrise":"06:06","dhuhr":"12:34","asr":"15:45","maghrib":"18:57","isha":"20:09"},
            {"date":"2025-08-11","fajr":"04:50","sunrise":"06:06","dhuhr":"12:34","asr":"15:45","maghrib":"18:57","isha":"20:08"},
            {"date":"2025-08-12","fajr":"04:50","sunrise":"06:06","dhuhr":"12:34","asr":"15:46","maghrib":"18:56","isha":"20:07"},
            {"date":"2025-08-13","fajr":"04:51","sunrise":"06:07","dhuhr":"12:34","asr":"15:46","maghrib":"18:56","isha":"20:06"},
            {"date":"2025-08-14","fajr":"04:51","sunrise":"06:07","dhuhr":"12:33","asr":"15:46","maghrib":"18:55","isha":"20:06"},
            {"date":"2025-08-15","fajr":"04:51","sunrise":"06:07","dhuhr":"12:33","asr":"15:46","maghrib":"18:54","isha":"20:05"},
            {"date":"2025-08-16","fajr":"04:52","sunrise":"06:07","dhuhr":"12:33","asr":"15:46","maghrib":"18:54","isha":"20:04"},
            {"date":"2025-08-17","fajr":"04:52","sunrise":"06:07","dhuhr":"12:33","asr":"15:47","maghrib":"18:53","isha":"20:03"},
            {"date":"2025-08-18","fajr":"04:53","sunrise":"06:08","dhuhr":"12:33","asr":"15:47","maghrib":"18:53","isha":"20:03"},
            {"date":"2025-08-19","fajr":"04:53","sunrise":"06:08","dhuhr":"12:32","asr":"15:47","maghrib":"18:52","isha":"20:02"},
            {"date":"2025-08-20","fajr":"04:53","sunrise":"06:08","dhuhr":"12:32","asr":"15:47","maghrib":"18:51","isha":"20:01"},
            {"date":"2025-08-21","fajr":"04:54","sunrise":"06:08","dhuhr":"12:32","asr":"15:47","maghrib":"18:51","isha":"20:00"},
            {"date":"2025-08-22","fajr":"04:54","sunrise":"06:08","dhuhr":"12:32","asr":"15:47","maghrib":"18:50","isha":"19:59"},
            {"date":"2025-08-23","fajr":"04:54","sunrise":"06:09","dhuhr":"12:31","asr":"15:47","maghrib":"18:49","isha":"19:59"},
            {"date":"2025-08-24","fajr":"04:54","sunrise":"06:09","dhuhr":"12:31","asr":"15:47","maghrib":"18:48","isha":"19:58"},
            {"date":"2025-08-25","fajr":"04:55","sunrise":"06:09","dhuhr":"12:31","asr":"15:47","maghrib":"18:48","isha":"19:57"},
            {"date":"2025-08-26","fajr":"04:55","sunrise":"06:09","dhuhr":"12:31","asr":"15:47","maghrib":"18:47","isha":"19:56"},
            {"date":"2025-08-27","fajr":"04:55","sunrise":"06:09","dhuhr":"12:30","asr":"15:47","maghrib":"18:46","isha":"19:55"},
            {"date":"2025-08-28","fajr":"04:56","sunrise":"06:09","dhuhr":"12:30","asr":"15:47","maghrib":"18:46","isha":"19:54"},
            {"date":"2025-08-29","fajr":"04:56","sunrise":"06:10","dhuhr":"12:30","asr":"15:47","maghrib":"18:45","isha":"19:54"},
            {"date":"2025-08-30","fajr":"04:56","sunrise":"06:10","dhuhr":"12:29","asr":"15:47","maghrib":"18:44","isha":"19:53"},
            {"date":"2025-08-31","fajr":"04:56","sunrise":"06:10","dhuhr":"12:29","asr":"15:47","maghrib":"18:43","isha":"19:52"},
            {"date":"2025-09-01","fajr":"04:57","sunrise":"06:10","dhuhr":"12:29","asr":"15:47","maghrib":"18:42","isha":"19:51"},
            {"date":"2025-09-02","fajr":"04:57","sunrise":"06:10","dhuhr":"12:28","asr":"15:47","maghrib":"18:42","isha":"19:50"},
            {"date":"2025-09-03","fajr":"04:57","sunrise":"06:10","dhuhr":"12:28","asr":"15:47","maghrib":"18:41","isha":"19:49"},
            {"date":"2025-09-04","fajr":"04:57","sunrise":"06:10","dhuhr":"12:28","asr":"15:47","maghrib":"18:40","isha":"19:48"},
            {"date":"2025-09-05","fajr":"04:58","sunrise":"06:11","dhuhr":"12:27","asr":"15:47","maghrib":"18:39","isha":"19:47"},
            {"date":"2025-09-06","fajr":"04:58","sunrise":"06:11","dhuhr":"12:27","asr":"15:47","maghrib":"18:39","isha":"19:46"},
            {"date":"2025-09-07","fajr":"04:58","sunrise":"06:11","dhuhr":"12:27","asr":"15:47","maghrib":"18:38","isha":"19:46"},
            {"date":"2025-09-08","fajr":"04:58","sunrise":"06:11","dhuhr":"12:26","asr":"15:47","maghrib":"18:37","isha":"19:45"},
            {"date":"2025-09-09","fajr":"04:58","sunrise":"06:11","dhuhr":"12:26","asr":"15:46","maghrib":"18:36","isha":"19:44"},
            {"date":"2025-09-10","fajr":"04:59","sunrise":"06:11","dhuhr":"12:26","asr":"15:46","maghrib":"18:35","isha":"19:43"},
            {"date":"2025-09-11","fajr":"04:59","sunrise":"06:11","dhuhr":"12:25","asr":"15:46","maghrib":"18:34","isha":"19:42"},
            {"date":"2025-09-12","fajr":"04:59","sunrise":"06:11","dhuhr":"12:25","asr":"15:46","maghrib":"18:34","isha":"19:41"},
            {"date":"2025-09-13","fajr":"04:59","sunrise":"06:12","dhuhr":"12:25","asr":"15:46","maghrib":"18:33","isha":"19:40"},
            {"date":"2025-09-14","fajr":"04:59","sunrise":"06:12","dhuhr":"12:24","asr":"15:46","maghrib":"18:32","isha":"19:39"},
            {"date":"2025-09-15","fajr":"05:00","sunrise":"06:12","dhuhr":"12:24","asr":"15:45","maghrib":"18:31","isha":"19:38"},
            {"date":"2025-09-16","fajr":"05:00","sunrise":"06:12","dhuhr":"12:24","asr":"15:45","maghrib":"18:30","isha":"19:38"},
            {"date":"2025-09-17","fajr":"05:00","sunrise":"06:12","dhuhr":"12:23","asr":"15:45","maghrib":"18:29","isha":"19:37"},
            {"date":"2025-09-18","fajr":"05:00","sunrise":"06:12","dhuhr":"12:23","asr":"15:45","maghrib":"18:29","isha":"19:36"},
            {"date":"2025-09-19","fajr":"05:00","sunrise":"06:12","dhuhr":"12:23","asr":"15:44","maghrib":"18:28","isha":"19:35"},
            {"date":"2025-09-20","fajr":"05:00","sunrise":"06:12","dhuhr":"12:22","asr":"15:44","maghrib":"18:27","isha":"19:34"},
            {"date":"2025-09-21","fajr":"05:01","sunrise":"06:13","dhuhr":"12:22","asr":"15:44","maghrib":"18:26","isha":"19:33"},
            {"date":"2025-09-22","fajr":"05:01","sunrise":"06:13","dhuhr":"12:22","asr":"15:44","maghrib":"18:25","isha":"19:32"},
            {"date":"2025-09-23","fajr":"05:01","sunrise":"06:13","dhuhr":"12:21","asr":"15:43","maghrib":"18:25","isha":"19:31"},
            {"date":"2025-09-24","fajr":"05:01","sunrise":"06:13","dhuhr":"12:21","asr":"15:43","maghrib":"18:24","isha":"19:31"},
            {"date":"2025-09-25","fajr":"05:01","sunrise":"06:13","dhuhr":"12:20","asr":"15:43","maghrib":"18:23","isha":"19:30"},
            {"date":"2025-09-26","fajr":"05:01","sunrise":"06:13","dhuhr":"12:20","asr":"15:42","maghrib":"18:22","isha":"19:29"},
            {"date":"2025-09-27","fajr":"05:01","sunrise":"06:13","dhuhr":"12:20","asr":"15:42","maghrib":"18:21","isha":"19:28"},
        ];

        /**
         * Adds minutes to a given time string.
         * @param {string} timeStr - The time string in "HH:MM" format.
         * @param {number} minutesToAdd - The number of minutes to add.
         * @returns {string} The new time string in "HH:MM" format.
         */
        function addMinutes(timeStr, minutesToAdd) {
            const [hour, minute] = timeStr.split(':').map(Number);
            const date = new Date();
            date.setHours(hour);
            date.setMinutes(minute + minutesToAdd);
            date.setSeconds(0); // Ensure seconds are 0 for consistent iqama time
            date.setMilliseconds(0); // Ensure milliseconds are 0
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
        }

        /**
         * Converts a time string (HH:MM) to a Date object for the current day.
         * @param {string} timeStr - The time string in "HH:MM" format.
         * @returns {Date} A Date object representing the time on the current day.
         */
        function timeToDate(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            const now = new Date();
            const date = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes, 0, 0);
            return date;
        }

        /**
         * Loads prayer times for the current day from the local `prayerTimes` array.
         */
        function loadPrayerTimes() {
            const today = new Date().toISOString().split('T')[0]; // Get today's date in YYYY-MM-DD format
            const data = prayerTimes.find(p => p.date === today);

            if (data) {
                appState.prayerTimes.Fajr = data.fajr;
                appState.prayerTimes.Dhuhr = data.dhuhr;
                appState.prayerTimes.Asr = data.asr;
                appState.prayerTimes.Maghrib = data.maghrib;
                appState.prayerTimes.Isha = data.isha;

                // Update display elements
                fajrTimeElement.textContent = data.fajr;
                dhuhrTimeElement.textContent = data.dhuhr;
                asrTimeElement.textContent = data.asr;
                maghribTimeElement.textContent = data.maghrib;
                ishaTimeElement.textContent = data.isha;

                fajrIqamaElement.textContent = 'ÿßŸÑÿ•ŸÇÿßŸÖÿ©: ' + addMinutes(data.fajr, 25);
                dhuhrIqamaElement.textContent = 'ÿßŸÑÿ•ŸÇÿßŸÖÿ©: ' + addMinutes(data.dhuhr, 20);
                asrIqamaElement.textContent = 'ÿßŸÑÿ•ŸÇÿßŸÖÿ©: ' + addMinutes(data.asr, 20);
                maghribIqamaElement.textContent = 'ÿßŸÑÿ•ŸÇÿßŸÖÿ©: ' + addMinutes(data.maghrib, 5);
                ishaIqamaElement.textContent = 'ÿßŸÑÿ•ŸÇÿßŸÖÿ©: ' + addMinutes(data.isha, 20);

            } else {
                console.warn('No prayer times found for today in the local data.');
                // Clear display if no data for today
                fajrTimeElement.textContent = '--:--';
                dhuhrTimeElement.textContent = '--:--';
                asrTimeElement.textContent = '--:--';
                maghribTimeElement.textContent = '--:--';
                ishaTimeElement.textContent = '--:--';
                fajrIqamaElement.textContent = '';
                dhuhrIqamaElement.textContent = '';
                asrIqamaElement.textContent = '';
                maghribIqamaElement.textContent = '';
                ishaIqamaElement.textContent = '';
            }
            determineNextPrayer(); // Re-determine next prayer after loading new times
            renderPrayerTimes(); // Always re-render to apply current prayer highlight
        }

        /**
         * Determines the next prayer time and updates appState.
         */
        function determineNextPrayer() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const todayData = prayerTimes.find(p => p.date === today);

            if (!todayData) {
                appState.prayerTimes.nextPrayer = null;
                appState.prayerTimes.nextPrayerIqamaTime = null;
                return;
            }

            const prayers = [
                { name: "ÿßŸÑŸÅÿ¨ÿ±", time: todayData.fajr, iqamaOffset: 25 },
                { name: "ÿßŸÑÿ∏Ÿáÿ±", time: todayData.dhuhr, iqamaOffset: 20 },
                { name: "ÿßŸÑÿπÿµÿ±", time: todayData.asr, iqamaOffset: 20 },
                { name: "ÿßŸÑŸÖÿ∫ÿ±ÿ®", time: todayData.maghrib, iqamaOffset: 5 },
                { name: "ÿßŸÑÿπÿ¥ÿßÿ°", time: todayData.isha, iqamaOffset: 20 }
            ];

            let nextPrayerFound = false;
            for (let i = 0; i < prayers.length; i++) {
                const prayer = prayers[i];
                const iqamaTimeStr = addMinutes(prayer.time, prayer.iqamaOffset);
                const iqamaDate = timeToDate(iqamaTimeStr);

                if (iqamaDate > now) {
                    appState.prayerTimes.nextPrayer = prayer.name;
                    appState.prayerTimes.nextPrayerIqamaTime = iqamaDate;
                    nextPrayerFound = true;
                    break;
                }
            }

            // If no next prayer found for today (all passed), set next prayer to Fajr of next day
            if (!nextPrayerFound) {
                const nextDay = new Date(now);
                nextDay.setDate(now.getDate() + 1);
                const nextDayString = nextDay.toISOString().split('T')[0];
                const nextDayData = prayerTimes.find(p => p.date === nextDayString);

                if (nextDayData) {
                    const fajrIqamaTimeStr = addMinutes(nextDayData.fajr, 25);
                    const fajrIqamaDate = timeToDate(fajrIqamaTimeStr);
                    // Adjust Fajr Iqama date to be on the next day
                    fajrIqamaDate.setDate(nextDay.getDate());

                    appState.prayerTimes.nextPrayer = "ÿßŸÑŸÅÿ¨ÿ± (ÿ∫ÿØŸãÿß)";
                    appState.prayerTimes.nextPrayerIqamaTime = fajrIqamaDate;
                } else {
                    // Fallback if next day's data is also not found
                    appState.prayerTimes.nextPrayer = null;
                    appState.prayerTimes.nextPrayerIqamaTime = null;
                }
            }
            renderPrayerTimes(); // Re-render to update highlight
        }

        /**
         * Renders the prayer times in the dashboard.
         */
        function renderPrayerTimes() {
            if (!prayerTimesContainer) return;

            // Clear previous highlights
            document.querySelectorAll('.prayer-time-item').forEach(item => {
                item.classList.remove('current-prayer');
            });

            // Mapping from English prayer names (in appState) to Arabic display names (in HTML)
            const prayerNameMap = {
                Fajr: 'ÿßŸÑŸÅÿ¨ÿ±',
                Dhuhr: 'ÿßŸÑÿ∏Ÿáÿ±',
                Asr: 'ÿßŸÑÿπÿµÿ±',
                Maghrib: 'ÿßŸÑŸÖÿ∫ÿ±ÿ®',
                Isha: 'ÿßŸÑÿπÿ¥ÿßÿ°',
                "ÿßŸÑŸÅÿ¨ÿ± (ÿ∫ÿØŸãÿß)": 'ÿßŸÑŸÅÿ¨ÿ±' // Special case for next day's Fajr
            };

            // Apply highlight to next prayer
            if (appState.prayerTimes.nextPrayer) { 
                const nextPrayerArabicName = prayerNameMap[appState.prayerTimes.nextPrayer];
                if (nextPrayerArabicName) {
                    // Iterate through all prayer time items and find the one with the matching Arabic name
                    const prayerItems = document.querySelectorAll('.prayer-time-item');
                    prayerItems.forEach(item => {
                        const prayerNameSpan = item.querySelector('.prayer-name');
                        // Check if the text content matches, ignoring the "(ÿ∫ÿØŸãÿß)" part for highlighting
                        if (prayerNameSpan && prayerNameSpan.textContent.trim().startsWith(nextPrayerArabicName)) {
                            item.classList.add('current-prayer');
                        }
                    });
                }
            }
        }

        // --- Digital Clock JavaScript (Apple iOS 19 style) ---
        /**
         * Updates the digital clock and date display.
         */
        function updateDigitalClock() {
            const now = new Date();
            let hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');

            // Convert to 12-hour format without AM/PM
            hours = hours % 12;
            hours = hours ? hours : 12; // The hour '0' (midnight) should be '12'

            // Update digital time with opacity
            if (digitalHoursSpan && digitalMinutesSpan && digitalSecondsSpan) {
                digitalHoursSpan.textContent = hours.toString().padStart(2, '0');
                digitalMinutesSpan.textContent = minutes;
                digitalSecondsSpan.textContent = seconds;
            }

            // Update countdown for next prayer's Iqama
            if (digitalDateLine1 && digitalDateLine2) {
                if (appState.prayerTimes.nextPrayerIqamaTime) {
                    const timeDiff = appState.prayerTimes.nextPrayerIqamaTime.getTime() - now.getTime();
                    
                    digitalDateLine1.classList.remove('countdown-highlight', 'countdown-medium-highlight'); // Clear previous highlights
                    digitalDateLine2.classList.remove('countdown-highlight', 'countdown-medium-highlight');

                    if (timeDiff <= 0) {
                        // If countdown finished, check if within 5 minutes past iqama
                        const timeSinceIqama = now.getTime() - appState.prayerTimes.nextPrayerIqamaTime.getTime();
                        const fiveMinutes = 5 * 60 * 1000;

                        if (timeSinceIqama <= fiveMinutes) {
                            // Counting up for 5 minutes after Iqama
                            const totalSecondsPassed = Math.floor(timeSinceIqama / 1000);
                            const displayMinutesPassed = Math.floor(totalSecondsPassed / 60);
                            const displaySecondsPassed = totalSecondsPassed % 60;

                            digitalDateLine1.textContent = `ÿßŸÑÿµŸÑÿßÿ© ÿ®ÿØÿ£ÿ™ ŸÖŸÜÿ∞...`;
                            digitalDateLine2.textContent = `${displayMinutesPassed.toString().padStart(2, '0')}:${displaySecondsPassed.toString().padStart(2, '0')}`;
                            digitalDateLine1.classList.add('countdown-highlight'); // Keep highlight for active prayer
                            digitalDateLine2.classList.add('countdown-highlight');
                        } else {
                            // More than 5 minutes past iqama, find next prayer
                            determineNextPrayer();
                        }
                    } else {
                        // Counting down to Iqama
                        const totalSeconds = Math.floor(timeDiff / 1000);
                        const displayHours = Math.floor(totalSeconds / 3600);
                        const displayMinutes = Math.floor((totalSeconds % 3600) / 60);
                        const displaySeconds = totalSeconds % 60;

                        let countdownText = '';
                        if (displayHours > 0) {
                            countdownText = `${displayHours.toString().padStart(2, '0')}:${displayMinutes.toString().padStart(2, '0')}:${displaySeconds.toString().padStart(2, '0')}`;
                        } else {
                            countdownText = `${displayMinutes.toString().padStart(2, '0')}:${displaySeconds.toString().padStart(2, '0')}`;
                        }
                        
                        digitalDateLine1.textContent = `ÿ•ŸÇÿßŸÖÿ© ÿµŸÑÿßÿ© ${appState.prayerTimes.nextPrayer}`;
                        digitalDateLine2.textContent = `  ${countdownText}`;

                        // Apply/remove highlight class based on time remaining
                        if (totalSeconds < 20 * 60) { // Less than 20 minutes
                            digitalDateLine1.classList.add('countdown-highlight');
                            digitalDateLine2.classList.add('countdown-highlight');
                        } else if (totalSeconds < 60 * 60) { // Less than 1 hour (and >= 20 minutes)
                            digitalDateLine1.classList.add('countdown-medium-highlight');
                            digitalDateLine2.classList.add('countdown-medium-highlight');
                        }
                    }
                } else {
                    digitalDateLine1.textContent = 'ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿ£ŸàŸÇÿßÿ™ ÿßŸÑÿµŸÑÿßÿ©...';
                    digitalDateLine2.textContent = '';
                    digitalDateLine1.classList.remove('countdown-highlight', 'countdown-medium-highlight');
                    digitalDateLine2.classList.remove('countdown-highlight', 'countdown-medium-highlight');
                }
            }
        }

        // --- Initial Setup and Event Listeners on DOM Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Get DOM element references that are only available after DOMContentLoaded
            const getMyLocationButtonDashboard = document.getElementById('get-my-location-button-dashboard');
            
            // Attach event listeners
            if (getMyLocationButtonDashboard) {
                getMyLocationButtonDashboard.addEventListener('click', centerMapOnUserLocation);
            }
            if (floatingFullscreenButton) {
                floatingFullscreenButton.addEventListener('click', togglePseudoFullscreen);
            }
            if (floatingMediaButton) {
                floatingMediaButton.addEventListener('click', () => switchApp('Media'));
            }

            // Initial and periodic updates
            updateUI(); // This will call loadPrayerTimes etc.
            fetchWeatherData();
            setInterval(fetchWeatherData, 300000); // Update weather every 5 minutes (300,000 ms)
            setInterval(updateDigitalClock, 1000); // Update clock and countdown every second
            updateDigitalClock();
            loadPrayerTimes(); // Load prayer times from local array
            simulateCarData(); // Initial simulated car data
            setInterval(simulateCarData, 5000); // Update simulated car data every 5 seconds
            
            // Set initial app to Dashboard
            switchApp('Dashboard');

            // Google Map initialization is handled by the `callback=initMap` in the script tag
            // No need to call initMap() or startLocationTracking() here directly.
        });
    </script>
</body>
</html>
