<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Cache Control Meta Tags -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>واجهة CarPlay - تصميم زجاجي منسدل تفاعلي</title>
    <!-- Tailwind CSS CDN for utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons for modern, customizable SVG icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Font Awesome for additional icons (e.g., Trip log) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <!-- Google Maps API script -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBRqAHJ2elbE_Z7NXXYC50XZpqi6HbG6Rk&libraries=places&callback=initMap"></script>
    <!-- Chart.js for the new weekly forecast chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- YouTube Iframe API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        /* Import Inter font for a modern, clean look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Default background gradient - UPDATED: black parts are wider, animation is 3x slower */
            background: linear-gradient(-45deg, #000000 0%, #000000 30%, #00FFFF 35%, #000000 60%, #4B0082 65%, #8A2BE2 70%, #FF00FF 75%, #000000 100%);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite; /* Animation duration decreased to 15s */
            transition: background-image 0.5s ease; /* Smooth transition for background changes */
            font-size: var(--base-font-size, 16px); /* Default font size, controlled by settings */
            min-height: 100vh; /* Ensure body takes full viewport height */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* Prevent body scroll */
        }
        /* Ensure RTL direction for specific elements if needed */
        div#youtube-playlist-view, div#youtube-video-list-view, div#youtube-search-results-view {
            direction: rtl;
        }
        div#youtube-readers-section {
            direction: rtl;
        }
        /* Define different background themes for customization */
        body.theme-gradient-1 {
            background: linear-gradient(-45deg, #000000 0%, #000000 30%, #00FFFF 35%, #000000 60%, #4B0082 65%, #8A2BE2 70%, #FF00FF 75%, #000000 100%);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        body.theme-gradient-2 {
            background: linear-gradient(-45deg, #4CAF50, #8BC34A, #FFEB3B, #FFC107);
            background-size: 400% 400%;
            animation: gradient 25s ease infinite reverse;
        }
        body.theme-dark-blue {
            background-color: #1a202c; /* Dark blue-gray */
            background-image: none;
            animation: none;
        }
        body.theme-purple-haze {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: 100% 100%;
            animation: none;
        }

        div#quran-quick-access {
            display: none !important;
        }

        .h-full {
            height: 97% !important;
        }

        /* NEW GLASS SURFACE CSS - Enhanced for liquid 3D effect and "drop glass" */
        .glass-surface {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            transition: opacity 0.26s ease-out;
            border-radius: 1.5rem; /* Ensure rounded corners */
        }
        .glass-surface__filter {
            width: 100%;
            height: 100%;
            pointer-events: none;
            position: absolute;
            inset: 0;
            opacity: 0;
            z-index: -1;
        }
        .glass-surface__content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: inherit;
            position: relative;
            z-index: 1;
        }
        .glass-surface--svg {
            /* Adjusted background for a more pronounced "drop" effect */
            background: light-dark(hsl(0 0% 100% / var(--glass-frost, 0.1)), /* Slightly more opaque background */
                hsl(0 0% 0% / var(--glass-frost, 0.2))); /* Darker opaque background for dark mode */
            
            /* Enhanced backdrop-filter for stronger blur and saturation */
            backdrop-filter: var(--filter-id, url(#glass-filter)) blur(10px) saturate(2.0) brightness(1.1); /* Reduced blur, saturation, and brightness for sharper effect */
            -webkit-backdrop-filter: blur(10px) saturate(2.0) brightness(1.1); /* Webkit prefix */

            /* More pronounced box-shadow for a "dropped" effect */
            box-shadow:
                0 0 5px 2px rgba(255, 255, 255, 0.1) inset, /* Inner light glow */
                0 0 15px 6px rgba(0, 255, 255, 0.15) inset, /* Inner cyan glow */
                0px 8px 30px rgba(17, 17, 26, 0.1), /* Stronger outer shadow */
                0px 16px 60px rgba(17, 17, 26, 0.15), /* Even stronger outer shadow */
                0px 24px 80px rgba(17, 17, 26, 0.2), /* Deepest outer shadow */
                inset 0 0 20px 8px rgba(0,0,0,0.3), /* Deeper inner shadow for depth */
                inset 0 0 25px 10px rgba(0,0,0,0.2), /* Even deeper inner shadow */
                0 0 20px rgba(255, 255, 255, 0.15); /* Added subtle outer white glow for "shine" */
            border: 1px solid rgba(255, 255, 255, 0.3); /* Added a subtle white border */
        }
        div#video-popup-container {
            cursor: grab;
            width: 46%;
            height: 37%;
        }

        /* Fallback for browsers not supporting backdrop-filter - also enhanced */
        .glass-surface--fallback {
            background: rgba(255, 255, 255, 0.35); /* More opaque fallback */
            backdrop-filter: blur(15px) saturate(2.0) brightness(1.2); /* Stronger fallback blur/saturate */
            -webkit-backdrop-filter: blur(15px) saturate(2.0) brightness(1.2);
            border: 1px solid rgba(255, 255, 255, 0.4); /* Stronger border */
            box-shadow:
                0 10px 40px 0 rgba(31, 38, 135, 0.3), /* Stronger fallback shadow */
                0 4px 20px 0 rgba(31, 38, 135, 0.2),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.5),
                inset 0 -1px 0 0 rgba(255, 255, 255, 0.3);
        }
        @media (prefers-color-scheme: dark) {
            .glass-surface--fallback {
                background: rgba(255, 255, 255, 0.15); /* Dark mode fallback */
                backdrop-filter: blur(15px) saturate(2.0) brightness(1.3);
                -webkit-backdrop-filter: blur(15px) saturate(2.0) brightness(1.3);
                border: 1px solid rgba(255, 255, 255, 0.3);
                box-shadow:
                    inset 0 1px 0 0 rgba(255, 255, 255, 0.3),
                    inset 0 -1px 0 0 rgba(255, 255, 255, 0.2);
            }
        }
        @supports not (backdrop-filter: blur(10px)) {
            .glass-surface--fallback {
                background: rgba(255, 255, 255, 0.5); /* Strongest fallback for no backdrop-filter */
                box-shadow:
                    inset 0 1px 0 0 rgba(255, 255, 255, 0.6),
                    inset 0 -1px 0 0 rgba(255, 255, 255, 0.4);
            }
            .glass-surface--fallback::before {
                content: '';
                position: absolute;
                inset: 0;
                background: rgba(255, 255, 255, 0.2); /* More opaque overlay */
                border-radius: inherit;
                z-index: -1;
            }
        }
        
        /* TV Remote Focus Style */
        .navigable:focus, .navigable.tv-focus {
            outline: 3px solid #0A84FF !important; /* Use !important to override other outlines */
            box-shadow: 0 0 20px rgba(10, 132, 255, 0.7) !important; /* Use !important */
            transform: scale(1.03);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }



        /* Keyframe animation for the background gradient */
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Styles for individual app screens */
        .app-screen {
            display: none; /* Hidden by default */
            animation: fadeIn 0.5s ease-in-out; /* Fade-in transition */
            width: 100%;
            height: 100%;
            flex-direction: column;
            border-radius: 1.5rem; /* Ensure app screens have rounded corners */
        }
        .app-screen.active {
            display: flex; /* Display when active */
        }
        
        /* Fade-in animation for screen transitions */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Styling for iframes to fit their containers */
        .full-iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 1.5rem;
        }

        /* Floating Button Styles - Positioned and styled for glass effect */
        #floating-fullscreen-button,
        #floating-media-button,
        #back-to-playlists-bottom-button,
        #back-to-playlists-bottom-button-search,
        #floating-keyboard-button,
        #start-trip-floating-button { 
            position: fixed;
            background-color: rgba(138, 8, 6, 0.5); /* Purple glass */
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 9999px; /* Pill shape */
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            z-index: 100; /* Above everything else */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        /* UPDATED: Clear Search Button style */
        #clear-search-button {
            background-color: rgba(220, 38, 38, 0.6); /* Red glass */
            color: white;
            padding: 0.75rem;
            border-radius: 9999px; /* Pill shape */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        #floating-fullscreen-button:hover,
        #floating-media-button:hover,
        #back-to-playlists-bottom-button:hover,
        #back-to-playlists-bottom-button-search:hover,
        #floating-keyboard-button:hover,
        #clear-search-button:hover,
        #start-trip-floating-button:hover {
            transform: scale(1.05); /* Only scale, no translate */
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        /* Specific positioning for floating buttons */
        #floating-fullscreen-button { bottom: 1rem; left: 6rem; right: auto; }
        #floating-media-button { bottom: 1rem; right: 1rem; }
        #floating-keyboard-button {
            bottom: 1rem;
            right: 8rem; /* Adjusted to be next to media button */
            display: none; /* Hidden by default */
        }
        #floating-keyboard-button.active-keyboard {
            background-color: #90EE90; /* Chrome Green */
            color: black; /* Black icon */
        }
        #floating-keyboard-button.inactive-keyboard {
            background-color: #FF0000; /* Red */
            color: white; /* White icon */
        }

        #back-to-playlists-bottom-button, #back-to-playlists-bottom-button-search {
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            display: none; /* Hidden by default */
        }

        #start-trip-floating-button {
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #10B981; /* Green color */
            display: none; /* Hidden by default */
        }

        /* Top bar positioning and transition */
        .top-bar {
            top: 1rem;
            transition: opacity 0.3s ease;
        }

        /* Main CarPlay interface container adjustments */
        #carplay-main-interface {
            position: fixed; /* Changed to fixed for default 90% fullscreen */
            top: 4%; /* Centered vertically */
            left: 4%; /* Centered horizontally */
            width: 98vw; /* 90% of viewport width */
            height: 98vh; /* 90% of viewport height */
            transition: all 0.5s ease-in-out; /* Smooth transition for pseudo-fullscreen */
            max-width: 1280px; /* Max width for desktop */
            border-radius: 2rem; /* Increased rounded corners for main interface */
        }

        /* Pseudo-fullscreen class for the CarPlay interface */
        #carplay-main-interface.carplay-pseudo-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            margin: 0;
            border-radius: 0;
            z-index: 99; /* Ensure it's above other content but below the floating button */
            max-width: 100vw; /* When fullscreen, it should take full width */
        }

        /* Shrink content when in pseudo-fullscreen mode for better fit */
        #carplay-main-interface.carplay-pseudo-fullscreen #digital-time {
            font-size: 2.2rem !important;
        }
        #carplay-main-interface.carplay-pseudo-fullscreen #weather-temp-main {
            font-size: 4rem !important;
        }

        /* Scrollbar styling for better aesthetics */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }

        /* Active app icon styling */
        .app-icon.active {
            background-color: #6b22ff; /* Purple */
            color: white;
            transform: scale(1.1);
        }

        /* Gemini-like Chat Styling */
        .chat-message {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 1.5rem; /* More rounded */
            margin-bottom: 0.75rem;
            word-wrap: break-word;
            font-size: 0.9rem; /* Slightly smaller font for chat */
        }

        .chat-message.user {
            background-color: #4f46e5; /* Blue */
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.5rem; /* Pointy bottom right */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .chat-message.ai {
            background-color: #2d3748; /* Darker gray */
            color: white;
            margin-right: auto;
            border-bottom-left-radius: 0.5rem; /* Pointy bottom left */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        #ai-input {
            border-radius: 2rem; /* Fully rounded pill shape */
            padding: 0.75rem 1.25rem;
            background-color: rgba(255, 255, 255, 0.15); /* Lighter glass */
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }
        #ai-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        #ai-input:focus {
            background-color: rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.4), 0 0 0 2px rgba(147, 51, 234, 0.5);
        }

        /* YouTube Channel Card Styling (Playlist View) - Smaller and more responsive */
        .youtube-channel-card {
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.4rem; /* Reduced padding for smaller card */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            aspect-ratio: 1 / 1; /* Make the card square */
            width: 100%; /* Ensure it takes full grid cell width */
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }
        .youtube-channel-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .youtube-channel-card img {
            width: 85%;
            height: 85%;
            object-fit: cover;
            border-radius: 1rem;
            margin-bottom: 0.4rem;
            border: 2px solid rgba(255,255,255,0.3);
        }
        .youtube-channel-card h2 {
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 95%;
        }

        /* YouTube Video Card Styling (List View and Search Results) */
        .youtube-video-card, .youtube-search-card {
            display: flex;
            flex-direction: row;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.75rem;
            background-color: rgba(255, 255, 255, 0.05);
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
            width: 100%;
            box-sizing: border-box;
            position: relative;
        }
        .youtube-video-card:hover, .youtube-search-card:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        .video-card-clickable-area {
            display: flex;
            align-items: center;
            flex-grow: 1;
            cursor: pointer;
        }
        .youtube-video-card img, .youtube-search-card img {
            width: 100px;
            height: 56.25px;
            object-fit: cover;
            border-radius: 0.5rem;
            margin-left: 0.75rem; /* Margin left for RTL */
            flex-shrink: 0;
        }
        .youtube-video-card h3, .youtube-search-card h3 {
            font-size: 0.9rem;
            font-weight: 500;
            color: white;
            line-height: 1.3;
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .video-popup-button {
            background-color: rgba(0,0,0,0.4);
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            flex-shrink: 0;
            margin-right: 0.5rem; /* Margin right for RTL */
        }
        .video-popup-button:hover {
            background-color: rgba(0,0,0,0.7);
            transform: scale(1.1);
        }

        /* YouTube Reader Card Styling (Suggestions) */
        .youtube-reader-card {
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.2s ease-in-out;
            border-radius: 1rem;
            background-color: rgba(255, 255, 255, 0.05);
            flex-shrink: 0; /* Prevent shrinking in flex container */
        }
        .youtube-reader-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            background-color: rgba(255, 255, 255, 0.1);
        }
        .youtube-reader-card img {
            width: 64px;
            height: 64px;
            object-fit: cover;
            border-radius: 50%;
            margin-bottom: 0.5rem;
            border: 2px solid rgba(255,255,255,0.3);
        }
        .youtube-reader-card h3 {
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 95%;
        }
        .youtube-reader-card.selected {
            background-color: #9333ea !important;
            box-shadow: 0 0 15px rgba(147, 51, 234, 0.8);
            transform: translateY(-5px) scale(1.05);
        }
        /* NEW: Horizontal scroll container for readers */
        .reader-container {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding-bottom: 1rem;
            gap: 0.75rem;
            direction: ltr; /* Force LTR for intuitive arrow key navigation */
        }
        .reader-container::-webkit-scrollbar { display: none; }
        .reader-container { -ms-overflow-style: none; scrollbar-width: none; }


        /* YouTube Suggestion Buttons (for Surahs) */
        .youtube-suggestion-button {
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.85rem;
            font-weight: bold;
            transition: background-color 0.2s ease, transform 0.1s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .youtube-suggestion-button:hover {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .youtube-suggestion-button:active {
            transform: translateY(0);
        }

        /* YouTube Suggestion Category Tag */
        .youtube-suggestion-category-tag {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
            margin-bottom: 0.5rem;
            align-self: flex-start;
        }

        /* Dashboard Logo Effect */
        .metallic-logo-effect {
            width: 300px;
            height: auto;
            margin-bottom: 1rem;
            filter: grayscale(100%) brightness(30%);
        }

        /* Car Dashboard Specific Styles */
        .car-dashboard-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .gauge-container.absolute-pos {
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .gauge-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 0.25rem;
        }

        .speed-display {
            font-size: 2.5rem;
            line-height: 1;
        }

        .rpm-display {
            font-size: 1.2rem;
            line-height: 1;
        }

        .gear-indicator {
            font-size: 4rem;
            font-weight: bold;
            color: #10b981;
        }

        /* Styles for 360 Camera View */
        .car-cam-360-container {
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.7);
            box-shadow: inset 0 0 15px rgba(0,0,0,0.7);
            overflow: hidden;
            position: relative;
        }
        .car-cam-360-container img {
            height: 160%;
            width: 100%; 
            object-fit: cover;
        }
        .car-cam-360-controls {
            position: absolute;
            bottom: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 20;
        }
        .car-cam-360-controls button {
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .car-cam-360-controls button:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }


        /* Digital Clock Styles (Apple iOS 19 style) */
        #digital-time {
            font-size: 2.2rem;
            font-weight: 800;
            color: white;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: baseline;
            gap: 0.2rem;
        }
        #digital-time span {
            transition: opacity 0.3s ease;
        }
        #digital-time .hours { opacity: 1; }
        #digital-time .minutes { opacity: 0.8; }
        #digital-time .seconds { opacity: 0.4; }

        /* Updated #digital-date styles based on user request */
        #digital-date {
            font-size: 1.2rem;
            color: rgb(255 255 255 / 99%);
            font-weight: bold;
            text-align: center;
            line-height: 1.4;
        }
        /* New class for highlight when less than 20 minutes */
        #digital-date.countdown-highlight {
            font-size: 1.7rem;
            color: #90EE90;
            font-weight: bold;
        }
        /* New class for highlight when less than 1 hour but more than 20 minutes */
        #digital-date.countdown-medium-highlight {
            font-size: 1.7rem;
            color: #FFA07A;
            font-weight: bold;
        }

        /* Settings Range Input Styling */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]:hover { opacity: 1; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #9333ea;
            cursor: pointer;
            box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.5);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #9333ea;
            cursor: pointer;
            box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.5);
        }

        /* Animated Weather Icon Styles */
        @keyframes pulse-float {
            0% { transform: scale(1) translateY(0px); opacity: 1; }
            50% { transform: scale(1.05) translateY(-2px); opacity: 0.9; }
            100% { transform: scale(1) translateY(0px); opacity: 1; }
        }
        #dashboard-weather-icon, #weather-icon {
            animation: pulse-float 3s ease-in-out infinite alternate;
            transition: transform 0.3s ease-in-out;
        }

        /* Electronic Quran specific styles */
        .quran-text {
            font-family: 'Amiri Quran', serif;
            font-size: 2rem;
            line-height: 2.5;
            text-align: center;
            direction: rtl;
            padding: 1rem;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 1rem;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            overflow-y: auto;
            max-height: 80%;
        }

        .quran-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            justify-content: center;
        }
        .quran-control-button {
            background-image: linear-gradient(to right, #6366f1, #8b5cf6);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: bold;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .quran-control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        /* Weather section content to take full width and height */
        #screen-Weather > div {
            width: 100%;
            height: 100%;
            max-width: none;
        }
        #screen-Weather .glass-surface {
            flex-grow: 1;
        }

        /* Full-Screen Video Player Styles */
        #full-screen-video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: black;
            z-index: 200;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #full-screen-video-iframe-container {
            width: 100%;
            height: 100%;
        }
        #full-screen-video-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        #full-screen-video-close-button {
            position: absolute;
            top: 2rem;
            right: 2rem;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
            z-index: 210;
        }
        #full-screen-video-close-button:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }
        #full-screen-video-popup-button {
            position: absolute;
            top: 2rem;
            right: 6.5rem;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
            z-index: 210;
        }
        #full-screen-video-popup-button:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }

        /* Video Pop-up Container Styles */
        #video-popup-container {
            position: fixed;
            bottom: 6rem;
            right: 1rem;
            width: 320px;
            height: 180px;
            background-color: rgba(0, 0, 0, 0.9);
            border-radius: 1rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 110;
            display: none;
            flex-direction: column;
            overflow: hidden;
            resize: both;
            min-width: 200px;
            min-height: 112px;
        }
        #video-popup-container.active { display: flex; }
        #video-popup-iframe-container {
             width: 100%;
            height: 100%;
            border-radius: 1rem;
            overflow: hidden;
        }

        div#digital-date-line2 {
            font-size: 1.4em;
        }

        .video-popup-controls {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
            z-index: 120;
        }
        .video-popup-controls button {
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .video-popup-controls button:hover { background-color: rgba(0, 0, 0, 0.8); }

        /* Responsive adjustments for smaller screens (mobile first) */
        @media (max-width: 768px) {
            body {
                overflow-y: auto;
            }
            .top-bar {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
                top: 0.5rem;
            }

            #carplay-main-interface {
                top: 2%;
                left: 2%;
                width: 96vw;
                height: 96vh;
                flex-direction: column;
                border-radius: 1rem;
            }

            main {
                order: 1;
                height: calc(100% - 64px);
            }

            .app-screen {
                padding: 1rem;
            }

            .dashboard-main-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
                height: auto;
            }

            .dashboard-main-grid > div {
                height: auto !important;
                width: 100%;
            }

            .car-cam-360-container {
                height: 200px;
            }
        
            .youtube-channel-card {
                padding: 0.2rem;
                border-radius: 0.75rem;
            }
            .youtube-channel-card img {
                width: 70%;
                height: 70%;
                border-radius: 0.75rem;
            }
            .youtube-channel-card h2 {
                font-size: 0.7rem;
            }

            .youtube-video-card img, .youtube-search-card img {
                width: 90px;
                height: 50.625px;
                margin-right: 0.5rem;
            }
            .youtube-video-card h3, .youtube-search-card h3 {
                font-size: 0.85rem;
            }

            #floating-fullscreen-button,
            #floating-media-button,
            #back-to-playlists-bottom-button,
            #back-to-playlists-bottom-button-search,
            #floating-keyboard-button,
            #start-trip-floating-button {
                padding: 0.75rem 1rem;
                font-size: 0.8rem;
                gap: 0.25rem;
            }
            #floating-fullscreen-button { left: 1rem !important; transform: none; }
            #floating-media-button { right: 1rem; }
            #floating-keyboard-button {
                right: 5.5rem;
            }
            #back-to-playlists-bottom-button, #back-to-playlists-bottom-button-search {
                left: 50%;
                transform: translateX(-50%);
                bottom: 5.5rem;
            }
            #start-trip-floating-button {
                bottom: 5.5rem;
            }

            #video-popup-container {
                width: 90%;
                height: auto;
                min-width: unset;
                min-height: unset;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                bottom: unset;
                right: unset;
            }
        }

        img.w-full.h-full.object-cover.rounded-lg.opacity-80 {
            position: fixed;
        }
        /* Prayer Times Specific Styles */
        .prayer-times-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            margin-top: 1rem;
        }
        .prayer-time-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            font-size: 0.9rem;
            min-width: 80px;
            text-align: center;
            transition: background-color 0.3s ease;
        }
        /* UPDATED: Current prayer is green */
        .prayer-time-item.current-prayer {
            background-color: rgba(16, 185, 129, 0.4); /* Greenish */
            font-weight: bold;
            border: 1px solid #10B981;
        }
        /* UPDATED: Next prayer is orange */
        .prayer-time-item.next-prayer {
            background-color: rgba(251, 146, 60, 0.3); /* Orangey */
            border: 1px solid #fb923c;
        }
        .prayer-name {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            margin-bottom: 0.2rem;
        }
        .prayer-time {
            color: white;
            font-size: 1rem;
        }

        /* OBD-II Specific Styles */
        .obd-data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            width: 100%;
        }
        .obd-data-card {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }
        .obd-data-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #10b981;
            margin-bottom: 0.25rem;
        }
        .obd-data-card .label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }
    </style>
</head>
<body class="animated-bg text-white overflow-hidden theme-gradient-1">
    <!-- SVG Filter Definition for Liquid Glass Effect -->
    <svg style="position: absolute; width: 0; height: 0; overflow: hidden;">
        <defs>
            <filter id="glass-filter" colorInterpolationFilters="sRGB" x="0%" y="0%" width="100%" height="100%">
                <feImage x="0" y="0" width="100%" height="100%" preserveAspectRatio="none" result="map" 
                    href="data:image/svg+xml,%3Csvg viewBox='0 0 400 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3ClinearGradient id='red-grad' x1='100%25' y1='0%25' x2='0%25' y2='0%25'%3E%3Cstop offset='0%25' stop-color='%230000'/%3E%3Cstop offset='100%25' stop-color='red'/%3E%3C/linearGradient%3E%3ClinearGradient id='blue-grad' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%230000'/%3E%3Cstop offset='100%25' stop-color='blue'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x='0' y='0' width='400' height='200' fill='black'/%3E%3Crect x='0' y='0' width='400' height='200' rx='20' fill='url(%23red-grad)'/%3E%3Crect x='0' y='0' width='400' height='200' rx='20' fill='url(%23blue-grad)' style='mix-blend-mode: difference'/%3E%3Crect x='1.4' y='1.4' width='397.2' height='197.2' rx='20' fill='hsl(0 0% 50% / 0.93)' style='filter:blur(11px)'/%3E%3C/svg%3E"/>
                
                <feDisplacementMap in="SourceGraphic" in2="map" id="redchannel" scale="300" xChannelSelector="R" yChannelSelector="G" result="dispRed" />
                <feColorMatrix in="dispRed" type="matrix" values="1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0" result="red" />
                
                <feDisplacementMap in="SourceGraphic" in2="map" id="greenchannel" scale="310" xChannelSelector="R" yChannelSelector="G" result="dispGreen" />
                <feColorMatrix in="dispGreen" type="matrix" values="0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 1 0" result="green" />
                
                <feDisplacementMap in="SourceGraphic" in2="map" id="bluechannel" scale="320" xChannelSelector="R" yChannelSelector="G" result="dispBlue" />
                <feColorMatrix in="blue" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0" result="blue" />
                
                <feBlend in="red" in2="green" mode="screen" result="rg" />
                <feBlend in="rg" in2="blue" mode="screen" result="output" />
                
                <feGaussianBlur in="output" stdDeviation="5" />
            </filter>
        </defs>
    </svg>

    <div class="w-full h-screen flex flex-col items-center justify-center p-4 sm:p-6">
        
        <!-- Top Bar: Wifi, 5G, Current Time -->
        <div class="w-full max-w-7xl flex justify-between items-center text-white/80 text-sm px-4 py-2 absolute top-4 left-1/2 -translate-x-1/2 z-10 top-bar">
            <div class="flex items-center gap-2">
                <i data-lucide="wifi"></i>
                <span>5G</span>
            </div>
            <div id="current-time">9:35</div>
        </div>

        <!-- Lexus Logo Fixed at Top Center -->
        <img src="https://dmusera.netlify.app/Lexus-Logo.wine.svg" width="200px" alt="Lexus Logo" class="fixed top-2 left-1/2 -translate-x-1/2 h-12 z-[1000] opacity-80" style="filter: invert(1) grayscale(100%) brightness(200%);" />

        <!-- Main CarPlay Interface Container -->
        <div id="carplay-main-interface" class="flex flex-row shadow-2xl rounded-3xl overflow-hidden bg-black/20 border border-white/10">
            
            <!-- Main content area for app screens -->
            <main class="flex-1 flex flex-col h-full">
                
                <!-- Dashboard Screen -->
                <section id="screen-Dashboard" class="app-screen p-4 md:p-6 flex-col h-full">
                    <!-- UPDATED: Dashboard layout changed -->
                    <div class="dashboard-main-grid grid grid-cols-1 md:grid-cols-3 grid-rows-[80%_20%] gap-4 md:gap-6 h-full w-full grid-container">
                        <!-- Map Widget (Now first) -->
                        <div class="rounded-3xl relative overflow-hidden flex items-center justify-center glass-surface glass-surface--svg p-1 col-span-1 row-start-1 navigable grid-item" tabindex="0">
                            <div id="dashboard-google-map" class="full-iframe"></div>
                            <button id="get-my-location-button-dashboard" class="absolute bottom-4 left-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full transition-colors duration-200 flex items-center gap-2 text-sm navigable grid-item" tabindex="0">
                                <i data-lucide="map-pin" class="w-6 h-6"></i> تحديث الموقع
                            </button>
                        </div>

                        <!-- 360 Camera View (Stays in middle) -->
                        <div class="glass-surface glass-surface--svg p-2 flex flex-col items-center justify-center text-center car-cam-360-container col-span-1 row-start-1 navigable grid-item" tabindex="0">
                            <img id="car-360-image" src="https://dmusera.netlify.app/es350gb.png" alt="عرض الكاميرا 360 درجة للسيارة" class="w-full h-full object-contain rounded-lg opacity-80">
                            <div class="car-cam-360-controls grid-container">
                                <input type="file" id="upload-360-image-input" accept="image/*" class="hidden" />
                                <button id="upload-360-image-button" class="navigable grid-item" tabindex="0">
                                    <i data-lucide="upload" class="w-4 h-4"></i> تحميل صورة
                                </button>
                                <button id="reset-360-image-button" class="navigable grid-item" tabindex="0">
                                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i> إعادة تعيين
                                </button>
                            </div>
                        </div>
                        
                        <!-- Weather and Clock/Prayer Widgets (Now third) -->
                        <div class="flex flex-col gap-4 md:gap-6 col-span-1 row-start-1 grid-container">
                            <div class="glass-surface glass-surface--svg p-4 flex-grow flex flex-col items-center justify-center text-center navigable grid-item" tabindex="0">
                                <h2 class="text-xl font-bold mb-1">الطقس</h2>
                                <div id="weather-widget-container" class="w-full h-full flex flex-col items-center justify-center">
                                    <img id="dashboard-weather-icon" src="" alt="Weather Icon" class="w-16 h-16 text-white mb-2" />
                                    <p class="text-3xl font-extrabold mb-1" id="dashboard-weather-temp">--°C</p>
                                    <p class="text-lg text-white/70 mb-2" id="dashboard-weather-desc">--</p>
                                    <p class="text-sm text-white/50" id="dashboard-weather-location">صلالة، عمان</p>
                                </div>
                            </div>
                            <div class="glass-surface glass-surface--svg p-4 flex-grow flex flex-col items-center justify-center text-center navigable grid-item" tabindex="0">
                                <div id="digital-clock-widget" class="w-full h-full flex flex-col items-center justify-center text-center">
                                    <div id="digital-time">
                                        <span class="hours">00</span>:<span class="minutes">00</span>:<span class="seconds">00</span>
                                    </div>
                                    <div id="digital-date">
                                        <div id="digital-date-line1">  </div>
                                        <div id="digital-date-line2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Prayer Times Row (Stays at bottom) -->
                        <div class="glass-surface glass-surface--svg p-4 flex flex-col items-center justify-center text-center col-span-full row-start-2 navigable grid-item" tabindex="0">
                            <div id="prayer-times-container" class="prayer-times-row grid-container">
                                <div class="prayer-time-item navigable grid-item" tabindex="0">
                                    <span class="prayer-name">الفجر</span>
                                    <span class="prayer-time" id="fajr-time">--:--</span>
                                    <span class="prayer-iqama" id="fajr-iqama"></span>
                                </div>
                                <div class="prayer-time-item navigable grid-item" tabindex="0">
                                    <span class="prayer-name">الظهر</span>
                                    <span class="prayer-time" id="dhuhr-time">--:--</span>
                                    <span class="prayer-iqama" id="dhuhr-iqama"></span>
                                </div>
                                <div class="prayer-time-item navigable grid-item" tabindex="0">
                                    <span class="prayer-name">العصر</span>
                                    <span class="prayer-time" id="asr-time">--:--</span>
                                    <span class="prayer-iqama" id="asr-iqama"></span>
                                </div>
                                <div class="prayer-time-item navigable grid-item" tabindex="0">
                                    <span class="prayer-name">المغرب</span>
                                    <span class="prayer-time" id="maghrib-time">--:--</span>
                                    <span class="prayer-iqama" id="maghrib-iqama"></span>
                                </div>
                                <div class="prayer-time-item navigable grid-item" tabindex="0">
                                    <span class="prayer-name">العشاء</span>
                                    <span class="prayer-time" id="isha-time">--:--</span>
                                    <span class="prayer-iqama" id="isha-iqama"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Media (YouTube) Screen -->
                <section id="screen-Media" class="app-screen p-4 md:p-6 flex-col items-center h-full relative">
                    <div class="w-full flex flex-col gap-4">
                        <!-- Search Row -->
                        <div class="w-full flex flex-row items-center gap-2 grid-container">
                            <button id="youtube-search-button" class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-full transition-colors duration-200 flex items-center justify-center navigable grid-item" tabindex="0">
                                <i data-lucide="search"></i>
                            </button>
                            <button id="clear-search-button" class="navigable grid-item" tabindex="0">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                            <input type="text" id="youtube-search-input" placeholder="ابحث في يوتيوب..." class="flex-grow p-3 rounded-full bg-white/10 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500 navigable grid-item" tabindex="0" onkeypress="if(event.key === 'Enter') document.getElementById('youtube-search-button').click();" readonly="true" />
                        </div>
                        
                        <!-- Suggestions Container -->
                        <div id="youtube-suggestions" class="w-full hidden"></div>
                        
                        <!-- Playlist View -->
                        <div id="youtube-playlist-view" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 w-full flex-grow overflow-y-auto grid-container">
                            <div class="glass-surface glass-surface--svg youtube-channel-card navigable grid-item" tabindex="0" data-playlist-id="UUlncV9OLPto_MinRzGfjr2g" data-channel-id="UClncV9OLPto_MinRzGfjr2g">
                                <img src="https://yt3.googleusercontent.com/ZpoYv5FstgResXDeuqEhkce079N0fM3UC5cmjGFBbKSPQI7tDXfl5W_vib_X2Q_hy5ipbZl4Fw=s160-c-k-c0x00ffffff-no-rj" alt="صورة الشيخ ياسر الدوسري" />
                                <h2>تلاوات ياسر الدوسري</h2>
                            </div>
                            <div class="glass-surface glass-surface--svg youtube-channel-card navigable grid-item" tabindex="0" data-playlist-id="UUFPqvE8BYiiUeN1AUXa3lbA" data-channel-id="UCFPqvE8BYiiUeN1AUXa3lbA">
                                <img src="https://imgs.search.brave.com/-WtPBvI7AmvUdQ2X1oZpk6wlNV-PlUSktoA9JVVQL3o/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9zdGF0/aWMuc3VyYXRtcDMu/Y29tL3BpY3MvcmVj/aXRlcnMvdGh1bWJz/LzM3XzE2MF8xNjAu/anBn" alt="صورة الشيخ محمد ايوب" />
                                <h2>الشيخ محمد ايوب</h2>
                            </div>
                            <div class="glass-surface glass-surface--svg youtube-channel-card navigable grid-item" tabindex="0" data-playlist-id="UUy0WYogELm9hEjulWPeYOJg" data-channel-id="UCy0WYogELm9hEjulWPeYOJg">
                                <img src="https://yt3.googleusercontent.com/jE4NSU3a46l5ZI5rTvaq2Jvk_TWWS3GtPhs4qchBQagGTeypLWC1V3ewrcE1xbMOgkZaHGGNWA=s160-c-k-c0x00ffffff-no-rj" alt="صورة مزامير القرآن" />
                                <h2>مزامير القرآن</h2>
                            </div>
                        </div>
                    </div>

                    <div id="youtube-video-list-view" class="hidden flex-col items-center justify-center h-full w-full relative p-4 overflow-y-auto gap-4 flex-grow">
                        <button id="back-to-playlists-from-videos" class="absolute top-4 left-4 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-full transition-colors duration-200 flex items-center gap-2 text-sm navigable grid-item" tabindex="0">
                            <i data-lucide="arrow-left" class="w-4 h-4"></i> العودة لقوائم التشغيل
                        </button>
                        <h2 class="text-3xl font-bold mb-4 text-center w-full">فيديوهات قائمة التشغيل</h2>
                        <div id="video-list-container" class="flex flex-col gap-4 w-full grid-container"></div>
                        <button id="back-to-playlists-bottom-button" class="mt-4 bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-full transition-colors duration-200 flex items-center justify-center gap-2 text-base navigable grid-item" tabindex="0">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i> العودة إلى قوائم التشغيل الرئيسية
                        </button>
                    </div>

                    <div id="youtube-search-results-view" class="hidden flex-col items-center justify-center h-full w-full relative p-4 overflow-y-auto gap-4 flex-grow">
                        <h2 class="text-3xl font-bold mb-4 text-center w-full">نتائج البحث</h2>
                        <div id="search-results-container" class="flex flex-col gap-4 w-full grid-container"></div>
                        <button id="back-to-playlists-bottom-button-search" class="mt-4 bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-full transition-colors duration-200 flex items-center justify-center gap-2 text-base navigable grid-item" tabindex="0">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i> العودة إلى قوائم التشغيل الرئيسية
                        </button>
                    </div>
                </section>
                
                <!-- Radio Screen -->
                <section id="screen-Radio" class="app-screen items-center justify-center h-full w-full p-4 md:p-6">
                   <iframe class="full-iframe" title="Radio Garden" src="https://radio.garden/visit/salalah/A13sFegC" allow="geolocation"></iframe>
                </section>

                <!-- AI Assistant Screen -->
                <section id="screen-AIAssistant" class="app-screen p-4 md:p-6 flex-col justify-between h-full">
                    <h1 class="text-4xl font-bold mb-4 text-center">مساعد Gemini الذكي ✨</h1>
                    <div id="chat-history" class="flex-grow overflow-y-auto p-4 rounded-xl glass-surface glass-surface--svg mb-4">
                        <div class="chat-message ai">أهلاً بك! كيف يمكنني مساعدتك اليوم؟ يمكنك سؤالي عن سرعة السيارة، مستوى الوقود، RPM، درجة الحرارة، أو الترس.</div>
                        <div id="listening-indicator" class="chat-message ai hidden">جاري الاستماع...</div>
                    </div>
                    <div class="flex gap-2 grid-container">
                        <input type="text" id="ai-input" placeholder="اسألني أي شيء..." class="flex-grow p-3 rounded-full bg-white/10 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500 navigable grid-item" tabindex="0" onkeypress="if(event.key === 'Enter') document.getElementById('ai-send-button').click();" />
                        <button id="ai-mic-button" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full transition-colors duration-200 flex items-center justify-center navigable grid-item" tabindex="0">
                            <i data-lucide="mic"></i>
                        </button>
                        <button id="ai-send-button" class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-full transition-colors duration-200 flex items-center justify-center navigable grid-item" tabindex="0">
                            <i data-lucide="send"></i>
                        </button>
                    </div>
                </section>

                <!-- Weather Screen -->
                <section id="screen-Weather" class="app-screen p-4 md:p-6 flex-col items-center justify-center h-full">
                    <h1 class="text-4xl font-bold mb-6">الطقس <i data-lucide="cloud-sun"></i></h1>
                    <div class="w-full h-full flex flex-col gap-4">
                        <div class="grid grid-cols-2 sm:grid-cols-2 gap-4 w-full grid-container">
                            <div class="glass-surface glass-surface--svg p-4 rounded-3xl text-center flex flex-col items-center justify-center navigable grid-item" tabindex="0">
                                <i data-lucide="thermometer" class="w-10 h-10 text-red-400 mb-2"></i>
                                <span class="text-2xl font-bold" id="weather-temp-card">--°C</span>
                                <span class="text-sm text-white/50">الحرارة</span>
                            </div>
                            <div class="glass-surface glass-surface--svg p-4 rounded-3xl text-center flex flex-col items-center justify-center navigable grid-item" tabindex="0">
                                <i data-lucide="sun" class="w-10 h-10 text-orange-300 mb-2"></i>
                                <span class="text-2xl font-bold" id="weather-uv">--</span>
                                <span class="text-sm text-white/50">مؤشر الأشعة فوق البنفسجية</span>
                            </div>
                        </div>
                        <div class="glass-surface glass-surface--svg p-4 rounded-3xl mt-4 w-full col-span-full flex-grow navigable grid-item" tabindex="0">
                            <canvas id="hourly-forecast-chart"></canvas>
                        </div>
                    </div>
                </section>

                <!-- Map Screen -->
                <section id="screen-Map" class="app-screen p-4 md:p-6 flex-col h-full">
                    <h1 class="text-4xl font-bold mb-6 text-center">الخريطة والاتجاهات 🗺️</h1>
                    <div class="flex flex-col md:flex-row h-full w-full gap-4">
                        <div class="w-full md:w-1/4 flex flex-col gap-4 glass-surface glass-surface--svg p-4 rounded-3xl flex-shrink-0 grid-container">
                            <h2 class="text-xl font-bold text-center mb-2">تحديد الوجهة والبحث</h2>
                            <div class="flex flex-col gap-2">
                                <label for="destination-input" class="text-sm text-white/70">الوجهة:</label>
                                <input type="text" id="destination-input" placeholder="أدخل الوجهة أو رابط Google Maps..." class="p-2 rounded-lg bg-white/10 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-500 navigable grid-item" tabindex="0" />
                                <button id="start-directions-button" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 font-bold navigable grid-item" tabindex="0">
                                    <i data-lucide="navigation" class="w-5 h-5"></i> البحث عن الاتجاهات
                                </button>
                                <button id="toggle-traffic-button" class="bg-gray-700 hover:bg-gray-600 text-white p-3 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 font-bold mt-2 navigable grid-item" tabindex="0">
                                    <i data-lucide="traffic-cone" class="w-5 h-5"></i> إظهار حركة المرور
                                </button>
                            </div>
                            <div class="flex flex-col gap-2 mt-4 text-center">
                                <div class="flex items-center justify-center gap-2">
                                    <i data-lucide="clock" class="w-6 h-6 text-green-400"></i>
                                    <span class="text-lg font-semibold">الوقت المقدر:</span>
                                    <span id="eta-display" class="text-lg">--</span>
                                </div>
                                <div class="flex items-center justify-center gap-2">
                                    <i data-lucide="ruler" class="w-6 h-6 text-purple-400"></i>
                                    <span class="text-lg font-semibold">المسافة:</span>
                                    <span id="distance-display" class="text-lg">--</span>
                                </div>
                            </div>
                        </div>
                        <div class="w-full md:w-3/4 rounded-3xl relative overflow-hidden flex items-center justify-center glass-surface glass-surface--svg p-1 grid-container">
                            <div id="full-google-map" class="full-iframe"></div>
                            <button id="get-my-location-button-full-map" class="absolute bottom-4 left-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full transition-colors duration-200 flex items-center gap-2 text-sm navigable grid-item" tabindex="0">
                                <i data-lucide="map-pin" class="w-4 h-4"></i> تحديث الموقع
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Electronic Quran App Screen -->
                <section id="screen-Quran" class="app-screen p-4 md:p-6 flex-col items-center justify-center h-full relative">
                   <div id="quran-quick-access" class="mt-4 bg-black/30 p-4 rounded-xl flex flex-col gap-3 items-end z-20 glass-surface glass-surface--svg w-full max-w-md">
                        <button id="quran-go-button" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full transition-colors duration-200 flex items-center gap-2 text-sm self-center navigable grid-item" tabindex="0"></button>
                    </div>
                    <div class="w-full h-full glass-surface glass-surface--svg p-4 rounded-xl flex flex-col items-center flex-grow" style="height: 100%!important;">
                        <iframe id="quran-iframe" class="full-iframe" src="https://quran.com/?lang=ar" lang="ar" title="القرآن الكريم" frameborder="0" allow="fullscreen; picture-in-picture"></iframe>
                    </div>
                </section>

            </main>

            <!-- Navigation Dock (Left Sidebar) -->
            <nav class="w-20 sm:w-24 bg-black/20 flex flex-col items-center justify-start pt-8 p-2 space-y-4 border-l border-white/10 flex-shrink-0 transition-opacity 0.3s ease grid-container">
                <button data-app="Dashboard" class="app-icon navigable grid-item" tabindex="0">
                    <i data-lucide="layout-grid"></i>
                </button>
                <button data-app="Media" class="app-icon navigable grid-item" tabindex="0">
                    <i data-lucide="play-circle"></i>
                </button>
                 <button data-app="Radio" class="app-icon navigable grid-item" tabindex="0">
                    <i data-lucide="radio"></i>
                </button>
                <button data-app="AIAssistant" class="app-icon navigable grid-item" tabindex="0"> 
                    <i data-lucide="sparkles"></i> 
                </button>
                <button data-app="Weather" class="app-icon navigable grid-item" tabindex="0"> 
                    <i data-lucide="cloud-sun"></i> 
                </button>
                <button data-app="Map" class="app-icon navigable grid-item" tabindex="0">
                    <i data-lucide="map"></i> 
                </button>
                <button data-app="Quran" class="app-icon navigable grid-item" tabindex="0">
                    <i data-lucide="book-open"></i>
                </button>
            </nav>
        </div>
    </div>

    <!-- Floating UI Elements -->
    <button id="floating-fullscreen-button" class="glass-surface glass-surface--svg rounded-full navigable grid-item" tabindex="0">
        <i data-lucide="maximize" class="w-6 h-6"></i>
    </button>
    <button id="floating-media-button" class="glass-surface glass-surface--svg rounded-full navigable grid-item" tabindex="0">
        <i data-lucide="youtube" class="w-6 h-6"></i>
    </button>
    <button id="floating-keyboard-button" class="glass-surface glass-surface--svg rounded-full navigable grid-item" tabindex="0">
        <i data-lucide="keyboard" class="w-6 h-6"></i>
    </button>
    <button id="start-trip-floating-button" class="glass-surface glass-surface--svg rounded-full navigable grid-item" tabindex="0">
        <i data-lucide="map-pin" class="w-6 h-6"></i> بدء الرحلة
    </button>

    <!-- Full-Screen Video Player Container -->
    <div id="full-screen-video-container" class="grid-container">
        <div id="full-screen-video-iframe-container"></div>
        <button id="full-screen-video-popup-button" title="فتح في نافذة منبثقة" class="navigable grid-item" tabindex="0">
            <i data-lucide="square-arrow-up-right" class="w-7 h-7"></i>
        </button>
        <button id="full-screen-video-close-button" title="إغلاق ملء الشاشة" class="navigable grid-item" tabindex="0">
            <i data-lucide="x" class="w-8 h-8"></i>
        </button>
    </div>

    <!-- Video Pop-up Container -->
    <div id="video-popup-container">
        <div id="video-popup-iframe-container"></div>
        <div class="video-popup-controls grid-container">
            <button id="video-popup-close-button" title="إغلاق الفيديو" class="navigable grid-item" tabindex="0">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
    </div>

    <script>
        // Initialize Lucide icons after they are loaded
        lucide.createIcons();

        // --- API Keys ---
        const YOUTUBE_API_KEY = 'AIzaSyDj4w1H3Is_rmTLhl40zER7AgYhT_tKASo'; 
        const AI_ASSISTANT_API_KEY = 'AIzaSyBMmtON9ww4dJxMHrl1wKyWTvI0ipJXJws'; 
        const WEATHER_API_KEY = '7acefc26deee4904a2393917252207'; 
        const GOOGLE_MAPS_API_KEY = 'AIzaSyBRqAHJ2elbE_Z7NXXYC50XZpqi6HbG6Rk';

        // --- Global App State Management ---
        let appState = {
            currentTime: '',
            mapLocation: { lat: 17.0151, lon: 54.0924, zoom: 17 },
            weather: { temperature: null, description: null, uvIndex: null, iconUrl: '', location: 'Salalah, Oman' },
            car: { speed: 0, rpm: 0, fuel: 0, temp: 0, gear: 'P' },
            prayerTimes: { Fajr: '--:--', Dhuhr: '--:--', Asr: '--:--', Maghrib: '--:--', Isha: '--:--', nextPrayer: null, nextPrayerIqamaTime: null, currentPrayer: null },
            hasShownGeolocationError: false,
            mapZoomChangedByUser: false,
            dashboardReturnCounter: 0,
            custom360Image: localStorage.getItem('custom360Image') || null,
            currentLocation: null,
            destinationSet: false
        };

        // --- DOM Element References ---
        const timeElement = document.getElementById('current-time');
        const appButtons = document.querySelectorAll('button[data-app]');
        const appScreens = document.querySelectorAll('.app-screen');
        const sidebarIcons = document.querySelectorAll('.app-icon');
        const quranQuickAccess = document.getElementById('quran-quick-access');
        const youtubeSearchInput = document.getElementById('youtube-search-input');
        const youtubeSearchButton = document.getElementById('youtube-search-button');
        const youtubeSuggestionsDiv = document.getElementById('youtube-suggestions');
        const youtubePlaylistView = document.getElementById('youtube-playlist-view');
        const youtubeVideoListView = document.getElementById('youtube-video-list-view'); 
        const videoListContainer = document.getElementById('video-list-container'); 
        const youtubeSearchResultsView = document.getElementById('youtube-search-results-view');
        const searchResultsContainer = document.getElementById('search-results-container');
        const backToPlaylistsFromVideosButton = document.getElementById('back-to-playlists-from-videos'); 
        const backToPlaylistsBottomButton = document.getElementById('back-to-playlists-bottom-button');
        const backToPlaylistsBottomButtonSearch = document.getElementById('back-to-playlists-bottom-button-search');
        const fullScreenVideoContainer = document.getElementById('full-screen-video-container');
        const fullScreenVideoIframeContainer = document.getElementById('full-screen-video-iframe-container');
        const fullScreenVideoCloseButton = document.getElementById('full-screen-video-close-button');
        const fullScreenVideoPopupButton = document.getElementById('full-screen-video-popup-button');
        const videoPopupContainer = document.getElementById('video-popup-container');
        const videoPopupIframeContainer = document.getElementById('video-popup-iframe-container');
        const videoPopupCloseButton = document.getElementById('video-popup-close-button');
        const quranIframe = document.getElementById('quran-iframe');
        const floatingFullscreenButton = document.getElementById('floating-fullscreen-button');
        const floatingMediaButton = document.getElementById('floating-media-button');
        const floatingKeyboardButton = document.getElementById('floating-keyboard-button');
        const clearSearchButton = document.getElementById('clear-search-button');
        const startTripFloatingButton = document.getElementById('start-trip-floating-button');
        const chatHistoryDiv = document.getElementById('chat-history');
        const aiInput = document.getElementById('ai-input');
        const aiSendButton = document.getElementById('ai-send-button');
        const aiMicButton = document.getElementById('ai-mic-button');
        const listeningIndicator = document.getElementById('listening-indicator');
        const prayerTimesContainer = document.getElementById('prayer-times-container');
        const fajrTimeElement = document.getElementById('fajr-time');
        const dhuhrTimeElement = document.getElementById('dhuhr-time');
        const asrTimeElement = document.getElementById('asr-time');
        const maghribTimeElement = document.getElementById('maghrib-time');
        const ishaTimeElement = document.getElementById('isha-time');
        const fajrIqamaElement = document.getElementById('fajr-iqama');
        const dhuhrIqamaElement = document.getElementById('dhuhr-iqama');
        const asrIqamaElement = document.getElementById('asr-iqama');
        const maghribIqamaElement = document.getElementById('maghrib-iqama');
        const ishaIqamaElement = document.getElementById('isha-iqama');
        const digitalHoursSpan = document.querySelector('#digital-time .hours');
        const digitalMinutesSpan = document.querySelector('#digital-time .minutes');
        const digitalSecondsSpan = document.querySelector('#digital-time .seconds');
        const digitalDateLine1 = document.getElementById('digital-date-line1');
        const digitalDateLine2 = document.getElementById('digital-date-line2');
        let dashboardGoogleMap, fullGoogleMap, dashboardGoogleMarker, fullGoogleMarker;
        let trafficLayerDashboard, trafficLayerFullMap, directionsService, directionsRenderer, autocomplete, watchId;
        const destinationInput = document.getElementById('destination-input');
        const startDirectionsButton = document.getElementById('start-directions-button');
        const etaDisplay = document.getElementById('eta-display');
        const distanceDisplay = document.getElementById('distance-display');
        const getMyLocationButtonFullMap = document.getElementById('get-my-location-button-full-map');
        const toggleTrafficButton = document.getElementById('toggle-traffic-button');
        let isTrafficLayerEnabled = true;
        const car360Image = document.getElementById('car-360-image');
        const upload360ImageInput = document.getElementById('upload-360-image-input');
        const upload360ImageButton = document.getElementById('upload-360-image-button');
        const reset360ImageButton = document.getElementById('reset-360-image-button');
        const default360ImageSrc = "https://dmusera.netlify.app/es350gb.png";
        let currentPlayingPlaylistId = '', activeMediaView = 'playlist', currentPlayingVideoId = '', selectedReaderName = '', fullScreenPlayer, popupPlayer, isYouTubeApiReady = false;

        // --- Utility Functions ---
        // UPDATED: Simulating time for demo purposes
        function updateTopBarTime() { timeElement.textContent = '2:41'; appState.currentTime = '2:41'; }
        function showMessageBox(message) { const box = document.createElement('div'); box.style.cssText = `position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0, 0, 0, 0.8); color: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.5); z-index: 1000; text-align: center; max-width: 80%; font-size: 1.1rem;`; box.innerHTML = `<p>${message}</p><button style="margin-top: 15px; padding: 8px 15px; background-color: #9333ea; border: none; border-radius: 5px; color: white; cursor: pointer;">إغلاق</button>`; document.body.appendChild(box); box.querySelector('button').addEventListener('click', () => document.body.removeChild(box)); }
        function togglePseudoFullscreen() { const carplay = document.getElementById('carplay-main-interface'); const topBar = document.querySelector('.top-bar'); const isFull = carplay.classList.toggle('carplay-pseudo-fullscreen'); floatingFullscreenButton.innerHTML = isFull ? '<i data-lucide="minimize" class="w-6 h-6"></i>' : '<i data-lucide="maximize" class="w-6 h-6"></i>'; if (topBar) topBar.style.opacity = isFull ? '0' : '1'; document.body.style.overflow = isFull ? 'hidden' : ''; lucide.createIcons(); }
        function updateUI() { document.getElementById('dashboard-weather-temp').textContent = appState.weather.temperature !== null ? `${appState.weather.temperature}°C` : '--°C'; document.getElementById('dashboard-weather-desc').textContent = appState.weather.description || '--'; document.getElementById('dashboard-weather-icon').src = appState.weather.iconUrl || 'https://placehold.co/64x64/000000/FFFFFF?text=X'; document.getElementById('dashboard-weather-location').textContent = appState.weather.location; document.getElementById('weather-temp-card').textContent = appState.weather.temperature !== null ? `${appState.weather.temperature}°C` : '--°C'; const uvEl = document.getElementById('weather-uv'); if (uvEl) { uvEl.textContent = appState.weather.uvIndex !== null ? appState.weather.uvIndex : '--'; uvEl.style.color = getUvIndexColor(appState.weather.uvIndex); } loadPrayerTimes(); car360Image.src = appState.custom360Image || default360ImageSrc; startTripFloatingButton.style.display = appState.destinationSet ? 'flex' : 'none'; }

        // --- App Switching Logic ---
        function switchApp(appName) { appScreens.forEach(s => s.classList.remove('active')); sidebarIcons.forEach(i => i.classList.remove('active')); const screen = document.getElementById(`screen-${appName}`); if (screen) screen.classList.add('active'); const icon = document.querySelector(`.app-icon[data-app="${appName}"]`); if (icon) icon.classList.add('active'); if (appName === 'Dashboard' && appState.mapZoomChangedByUser) { appState.dashboardReturnCounter++; if (appState.dashboardReturnCounter >= 2 && dashboardGoogleMap) { dashboardGoogleMap.setZoom(appState.mapLocation.zoom); appState.mapZoomChangedByUser = false; appState.dashboardReturnCounter = 0; showMessageBox('تم إعادة تعيين تكبير الخريطة إلى الافتراضي.'); } } else if (appName !== 'Dashboard' && !appState.mapZoomChangedByUser) { appState.dashboardReturnCounter = 0; } handleMediaViewSwitch(appName); quranQuickAccess.style.display = (appName === 'Quran') ? 'flex' : 'none'; startTripFloatingButton.style.display = (appName === 'Map' && appState.destinationSet) ? 'flex' : 'none'; updateUI(); if (document.activeElement && document.activeElement.closest('nav')) { setTimeout(() => { const firstItem = screen.querySelector('.grid-item'); if (firstItem) setFocus(firstItem); }, 100); } }
        function handleMediaViewSwitch(appName) { floatingMediaButton.style.display = (appName === 'Media') ? 'none' : 'flex'; floatingKeyboardButton.style.display = (appName === 'Media') ? 'flex' : 'none'; clearSearchButton.style.display = (appName === 'Media') ? 'flex' : 'none'; youtubeSuggestionsDiv.style.display = (appName !== 'Media') ? 'none' : ''; if (appName === 'Media') { floatingKeyboardButton.classList.toggle('active-keyboard', !youtubeSearchInput.readOnly); floatingKeyboardButton.classList.toggle('inactive-keyboard', youtubeSearchInput.readOnly); youtubePlaylistView.classList.add('hidden'); youtubeVideoListView.classList.add('hidden'); youtubeSearchResultsView.classList.add('hidden'); youtubeSuggestionsDiv.classList.remove('hidden'); if (activeMediaView === 'videoList' && currentPlayingPlaylistId) youtubeVideoListView.classList.remove('hidden'); else if (activeMediaView === 'searchResults') youtubeSearchResultsView.classList.remove('hidden'); else { youtubePlaylistView.classList.remove('hidden'); resetYoutubeSearchUI(); } } }
        appButtons.forEach(b => b.addEventListener('click', () => switchApp(b.dataset.app)));
        sidebarIcons.forEach(el => el.classList.add('w-16', 'h-16', 'rounded-2xl', 'flex', 'items-center', 'justify-center', 'transition-all', 'duration-300', 'ease-in-out'));
        
        // --- YouTube/Media Functions ---
        // Note for WebView: The YouTube Iframe API is the standard for embedding. For best compatibility,
        // ensure the WebView has JavaScript enabled and allows loading content from 'https://www.youtube.com'.
        // The `allow` attribute on iframes is best practice but the YouTube API manages its own iframe creation.
        function onYouTubeIframeAPIReady() { isYouTubeApiReady = true; }
        document.querySelectorAll('.youtube-channel-card').forEach(c => c.addEventListener('click', () => { currentPlayingPlaylistId = c.dataset.playlistId; fetchPlaylistVideos(currentPlayingPlaylistId); }));
        async function fetchPlaylistVideos(playlistId, updateView = true) { if (YOUTUBE_API_KEY.startsWith('YOUR_')) return showMessageBox('خطأ: لم يتم تعيين مفتاح YouTube API.'); try { const res = await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${playlistId}&key=${YOUTUBE_API_KEY}&maxResults=20`); const data = await res.json(); if (data.items && data.items.length > 0) { videoListContainer.innerHTML = ''; data.items.forEach(item => { const { videoId } = item.snippet.resourceId; const { title } = item.snippet; const thumb = item.snippet.thumbnails.medium ? item.snippet.thumbnails.medium.url : 'https://placehold.co/120x90'; const card = document.createElement('div'); card.className = 'glass-surface glass-surface--svg youtube-video-card navigable grid-item'; card.tabIndex = 0; card.dataset.videoId = videoId; card.innerHTML = `<div class="video-card-clickable-area"><img src="${thumb}" alt="${title}" onerror="this.onerror=null;this.src='https://placehold.co/120x90';"><h3>${title}</h3></div><button class="video-popup-button navigable grid-item" tabindex="0" title="تشغيل في نافذة منبثقة"><i data-lucide="square-arrow-up-right" class="w-4 h-4"></i></button>`; card.querySelector('.video-card-clickable-area').addEventListener('click', () => playVideoInFullScreen(videoId)); card.querySelector('.video-popup-button').addEventListener('click', (e) => { e.stopPropagation(); showVideoPopup(videoId); }); videoListContainer.appendChild(card); }); lucide.createIcons(); youtubePlaylistView.classList.add('hidden'); youtubeVideoListView.classList.remove('hidden'); youtubeSearchResultsView.classList.add('hidden'); youtubeSuggestionsDiv.classList.add('hidden'); if (updateView) activeMediaView = 'videoList'; backToPlaylistsBottomButton.style.display = 'flex'; backToPlaylistsBottomButtonSearch.style.display = 'none'; } else { showMessageBox('لم يتم العثور على فيديوهات في قائمة التشغيل هذه.'); } } catch (err) { console.error('Error fetching YouTube playlist videos:', err); showMessageBox('حدث خطأ أثناء جلب فيديوهات قائمة التشغيل.'); } }
        function playVideoInFullScreen(videoId, start = 0) { if (!isYouTubeApiReady) return setTimeout(() => playVideoInFullScreen(videoId, start), 100); currentPlayingVideoId = videoId; fullScreenVideoContainer.style.display = 'flex'; document.getElementById('carplay-main-interface').style.display = 'none'; document.querySelectorAll('.fixed:not(#full-screen-video-container)').forEach(el => { if (!el.closest('#full-screen-video-container')) el.style.display = 'none'; }); if (fullScreenPlayer) { fullScreenPlayer.loadVideoById({ videoId, startSeconds: start }); } else { fullScreenVideoIframeContainer.innerHTML = '<div id="full-screen-video-iframe"></div>'; fullScreenPlayer = new YT.Player('full-screen-video-iframe', { height: '100%', width: '100%', videoId, playerVars: { 'autoplay': 1, 'controls': 1, 'start': start }, events: { 'onReady': (e) => e.target.playVideo() } }); } setTimeout(() => setFocus(fullScreenVideoCloseButton), 100); }
        function closeFullScreenPlayer() { if (fullScreenPlayer?.stopVideo) fullScreenPlayer.stopVideo(); currentPlayingVideoId = ''; fullScreenVideoContainer.style.display = 'none'; document.getElementById('carplay-main-interface').style.display = 'flex'; document.querySelectorAll('.fixed:not(#full-screen-video-container)').forEach(el => el.style.display = 'flex'); const app = document.querySelector('.app-screen.active')?.id.replace('screen-', '') || 'Dashboard'; switchApp(app); }
        function switchFullScreenToPopup() { if (currentPlayingVideoId && fullScreenPlayer?.getCurrentTime) { const time = fullScreenPlayer.getCurrentTime(); fullScreenPlayer.stopVideo(); fullScreenVideoContainer.style.display = 'none'; document.getElementById('carplay-main-interface').style.display = 'flex'; document.querySelectorAll('.fixed:not(#full-screen-video-container)').forEach(el => { if (!el.closest('#full-screen-video-container')) el.style.display = 'flex'; }); const app = document.querySelector('.app-screen.active')?.id.replace('screen-', '') || 'Dashboard'; if(app !== 'Media') floatingMediaButton.style.display = 'flex'; showVideoPopup(currentPlayingVideoId, time); } }
        function showVideoPopup(videoId, start = 0) { if (!isYouTubeApiReady) return setTimeout(() => showVideoPopup(videoId, start), 100); currentPlayingVideoId = videoId; videoPopupContainer.classList.add('active'); if (popupPlayer) { popupPlayer.loadVideoById({ videoId, startSeconds: start }); } else { videoPopupIframeContainer.innerHTML = '<div id="video-popup-iframe"></div>'; popupPlayer = new YT.Player('video-popup-iframe', { height: '100%', width: '100%', videoId, playerVars: { 'autoplay': 1, 'controls': 1, 'start': start }, events: { 'onReady': (e) => e.target.playVideo() } }); } setTimeout(() => setFocus(videoPopupCloseButton), 100); }
        function hideVideoPopup() { if (popupPlayer?.stopVideo) popupPlayer.stopVideo(); videoPopupContainer.classList.remove('active'); const screen = document.querySelector('.app-screen.active'); if(screen) { const item = screen.querySelector('.grid-item'); if (item) setFocus(item); } }
        fullScreenVideoCloseButton.addEventListener('click', closeFullScreenPlayer); fullScreenVideoPopupButton.addEventListener('click', switchFullScreenToPopup); videoPopupCloseButton.addEventListener('click', hideVideoPopup);
        function navigateBackToPlaylists() { youtubeVideoListView.classList.add('hidden'); youtubeSearchResultsView.classList.add('hidden'); youtubePlaylistView.classList.remove('hidden'); youtubeSuggestionsDiv.classList.remove('hidden'); currentPlayingPlaylistId = ''; activeMediaView = 'playlist'; backToPlaylistsBottomButton.style.display = 'none'; backToPlaylistsBottomButtonSearch.style.display = 'none'; resetYoutubeSearchUI(); setTimeout(() => { setFocus(youtubeSearchInput); }, 100); }
        backToPlaylistsFromVideosButton.addEventListener('click', navigateBackToPlaylists); backToPlaylistsBottomButton.addEventListener('click', navigateBackToPlaylists); backToPlaylistsBottomButtonSearch.addEventListener('click', navigateBackToPlaylists);
        floatingKeyboardButton.addEventListener('click', () => { youtubeSearchInput.readOnly = !youtubeSearchInput.readOnly; if (!youtubeSearchInput.readOnly) youtubeSearchInput.focus(); else youtubeSearchInput.blur(); floatingKeyboardButton.classList.toggle('active-keyboard', !youtubeSearchInput.readOnly); floatingKeyboardButton.classList.toggle('inactive-keyboard', youtubeSearchInput.readOnly); });
        clearSearchButton.addEventListener('click', () => { youtubeSearchInput.value = ''; youtubeSearchInput.readOnly = true; floatingKeyboardButton.classList.add('inactive-keyboard'); floatingKeyboardButton.classList.remove('active-keyboard'); navigateBackToPlaylists(); });
        const youtubeReaderSuggestions = [{"name":"محمد ايوب","image":"https://dmusera.netlify.app/512px-Muhammad_Ayyub.webp"},{"name":"فارس عنتر","image":"https://dmusera.netlify.app/faresantar.jpg"},{"name":"علي جابر","image":"https://dmusera.netlify.app/ali-jaber.webp"},{"name":"عبد الباسط عبد الصمد","image":"https://dmusera.netlify.app/abdulbaset-abdulsamad.jpeg"},{"name":"مشاري العفاسي","image":"https://dmusera.netlify.app/512px-%D0%9C%D0%B8%D1%88%D0%B0%D1%80%D0%B8_%D0%A0%D0%B0%D1%88%D0%B8%D0%B4.webp"},{"name":"احمد النفيس","image":"https://dmusera.netlify.app/ahmednafes.jpg"},{"name":"ياسر الدوسري","image":"https://dmusera.netlify.app/Yasser_Al-Dosari.jpg"}];
        const youtubeSurahSuggestions = ["الفاتحة","البقرة","آل عمران","النساء","المائدة","الأنعام","الأعراف","الأنفال","التوبة","يونس","هود","يوسف","الرعد","إبراهيم","الحجر","النحل","الإسراء","الكهف","مريم","طه","الأنبياء","الحج","المؤمنون","النور","الفرقان","الشعراء","النمل","القصص","العنكبوت","الروم","لقمان","السجدة","الأحزاب","سبأ","فاطر","يس","الصافات","ص","الزمر","غافر","فصلت","الشورى","الزخرف","الدخان","الجاثية","الأحقاف","محمد","الفتح","الحجرات","ق","الذاريات","الطور","النجم","القمر","الرحمن","الواقعة","الحديد","المجادلة","الحشر","الممتحنة","الصف","الجمعة","المنافقون","التغابن","الطلاق","التحريم","الملك","القلم","الحاقة","المعارج","نوح","الجن","المزمل","المدثر","القيامة","الإنسان","المرسلات","جزء عم"];
        const surahToJuzMap = {"الفاتحة":1,"البقرة":1,"آل عمران":3,"النساء":4,"المائدة":6,"الأنعام":7,"الأعراف":8,"الأنفال":9,"التوبة":10,"يونس":11,"هود":11,"يوسف":12,"الرعد":13,"إبراهيم":13,"الحجر":14,"النحل":14,"الإسراء":15,"الكهف":15,"مريم":16,"طه":16,"الأنبياء":17,"الحج":17,"المؤمنون":18,"النور":18,"الفرقان":18,"الشعراء":19,"النمل":19,"القصص":20,"العنكبوت":20,"الروم":21,"لقمان":21,"السجدة":21,"الأحزاب":21,"سبأ":22,"فاطر":22,"يس":22,"الصافات":23,"ص":23,"الزمر":23,"غافر":24,"فصلت":24,"الشورى":25,"الزخرف":25,"الدخان":25,"الجاثية":25,"الأحقاف":26,"محمد":26,"الفتح":26,"الحجرات":26,"ق":26,"الذاريات":27,"الطور":27,"النجم":27,"القمر":27,"الرحمن":27,"الواقعة":27,"الحديد":27,"المجادلة":28,"الحشر":28,"الممتحنة":28,"الصف":28,"الجمعة":28,"المنافقون":28,"التغابن":28,"الطلاق":28,"التحريم":28,"الملك":29,"القلم":29,"الحاقة":29,"المعارج":29,"نوح":29,"الجن":29,"المزمل":29,"المدثر":29,"القيامة":29,"الإنسان":29,"المرسلات":29,"جزء عم":30};
        const juzColors = Array.from({length:30},(_,i)=>`radial-gradient(circle, hsla(${(i*360/30)%360}, 80%, 60%, 0.4) 0%, hsla(${(i*360/30)%360}, 85%, 45%, 0.8) 100%)`);
        function resetYoutubeSearchUI() { youtubeSuggestionsDiv.innerHTML = ''; youtubeSuggestionsDiv.classList.remove('hidden'); selectedReaderName = ''; youtubeSearchInput.value = ''; populateYoutubeSuggestions(); }
        function populateYoutubeSuggestions() { youtubeSuggestionsDiv.innerHTML = ''; youtubeSuggestionsDiv.className = 'flex flex-col gap-4 w-full'; const readersSection = document.createElement('div'); readersSection.id = 'youtube-readers-section'; readersSection.className = 'flex flex-col gap-2 p-3 rounded-xl glass-surface glass-surface--svg w-full'; readersSection.innerHTML = '<span class="youtube-suggestion-category-tag bg-blue-600">اختر القارئ</span>'; const readerButtonsContainer = document.createElement('div'); readerButtonsContainer.className = 'reader-container'; youtubeReaderSuggestions.forEach(reader => { const card = document.createElement('div'); card.className = 'youtube-reader-card navigable grid-item'; card.tabIndex = 0; card.innerHTML = `<img src="${reader.image}" alt="${reader.name}" onerror="this.onerror=null;this.src='https://placehold.co/64x64';"><h3>${reader.name}</h3>`; card.addEventListener('click', (e) => { document.querySelectorAll('#youtube-readers-section .youtube-reader-card').forEach(c => c.classList.remove('selected')); e.currentTarget.classList.add('selected'); selectedReaderName = reader.name; youtubeSearchInput.value = reader.name + ' '; readersSection.style.display = 'none'; showSurahSuggestions(); setTimeout(() => { const firstSurahButton = document.querySelector('#youtube-surah-section .grid-item'); if (firstSurahButton) setFocus(firstSurahButton); }, 100); }); readerButtonsContainer.appendChild(card); }); readersSection.appendChild(readerButtonsContainer); youtubeSuggestionsDiv.appendChild(readersSection); }
        function showSurahSuggestions() { const existing = document.getElementById('youtube-surah-section'); if (existing) existing.remove(); const surahSection = document.createElement('div'); surahSection.id = 'youtube-surah-section'; surahSection.className = 'flex flex-col gap-2 p-3 rounded-xl glass-surface glass-surface--svg w-full mt-4 grid-container'; surahSection.innerHTML = '<span class="youtube-suggestion-category-tag bg-green-600">اختر السورة</span>'; const surahButtonsContainer = document.createElement('div'); surahButtonsContainer.className = 'grid grid-cols-9 gap-2 w-full'; youtubeSurahSuggestions.forEach(name => { const button = document.createElement('button'); button.className = 'youtube-suggestion-button navigable grid-item'; button.tabIndex = 0; button.textContent = name; button.style.backgroundImage = juzColors[(surahToJuzMap[name] || 1) - 1]; button.addEventListener('click', () => { const query = selectedReaderName + ' سورة ' + name; youtubeSearchInput.value = query; searchYouTubeVideos(query); }); surahButtonsContainer.appendChild(button); }); surahSection.appendChild(surahButtonsContainer); youtubeSuggestionsDiv.appendChild(surahSection); }
        youtubeSearchInput.addEventListener('focus', () => { if (youtubeSearchInput.value.trim() === '') { youtubeSuggestionsDiv.classList.remove('hidden'); resetYoutubeSearchUI(); } });
        youtubeSearchButton.addEventListener('click', () => { const query = youtubeSearchInput.value.trim(); if (query) searchYouTubeVideos(query); else showMessageBox('الرجاء إدخال كلمة للبحث.'); });
        async function searchYouTubeVideos(query) { if (YOUTUBE_API_KEY.startsWith('YOUR_')) return showMessageBox('خطأ: لم يتم تعيين مفتاح YouTube API.'); try { const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&key=${YOUTUBE_API_KEY}&maxResults=20`); const data = await res.json(); if (data.items && data.items.length > 0) { searchResultsContainer.innerHTML = ''; data.items.forEach(item => { const { videoId } = item.id; const { title } = item.snippet; const thumb = item.snippet.thumbnails.medium ? item.snippet.thumbnails.medium.url : 'https://placehold.co/120x90'; const card = document.createElement('div'); card.className = 'glass-surface glass-surface--svg youtube-search-card navigable grid-item'; card.tabIndex = 0; card.dataset.videoId = videoId; card.innerHTML = `<div class="video-card-clickable-area"><img src="${thumb}" alt="${title}" onerror="this.onerror=null;this.src='https://placehold.co/120x90';"><h3>${title}</h3></div><button class="video-popup-button navigable grid-item" tabindex="0" title="تشغيل في نافذة منبثقة"><i data-lucide="square-arrow-up-right" class="w-4 h-4"></i></button>`; card.querySelector('.video-card-clickable-area').addEventListener('click', () => playVideoInFullScreen(videoId)); card.querySelector('.video-popup-button').addEventListener('click', (e) => { e.stopPropagation(); showVideoPopup(videoId); }); searchResultsContainer.appendChild(card); }); lucide.createIcons(); youtubePlaylistView.classList.add('hidden'); youtubeVideoListView.classList.add('hidden'); youtubeSearchResultsView.classList.remove('hidden'); youtubeSuggestionsDiv.classList.add('hidden'); activeMediaView = 'searchResults'; backToPlaylistsBottomButton.style.display = 'none'; backToPlaylistsBottomButtonSearch.style.display = 'flex'; setTimeout(() => { const firstResult = searchResultsContainer.querySelector('.grid-item'); if (firstResult) setFocus(firstResult); }, 100); } else { showMessageBox('لم يتم العثور على نتائج بحث لـ: ' + query); } } catch (err) { console.error('Error searching YouTube videos:', err); showMessageBox('حدث خطأ أثناء البحث في يوتيوب.'); } }
        
        // --- AI Assistant Logic ---
        let recognition; if ('webkitSpeechRecognition' in window) { recognition = new webkitSpeechRecognition(); recognition.continuous = false; recognition.interimResults = false; recognition.lang = 'ar-SA'; recognition.onstart = () => { aiMicButton.classList.add('bg-red-500'); listeningIndicator.classList.remove('hidden'); aiInput.placeholder = 'جاري الاستماع...'; }; recognition.onresult = (e) => { aiInput.value = e.results[0][0].transcript; sendAIAssistantMessage(); }; recognition.onerror = (e) => { console.error('Speech recognition error:', e.error); showMessageBox('عذرًا، لم أستطع فهمك.'); }; recognition.onend = () => { aiMicButton.classList.remove('bg-red-500'); listeningIndicator.classList.add('hidden'); aiInput.placeholder = 'اسألني أي شيء...'; }; } else { aiMicButton.style.display = 'none'; }
        aiMicButton.addEventListener('click', () => recognition?.start());
        let synth = window.speechSynthesis, arabicVoice = null; function setArabicVoice() { if (synth) arabicVoice = synth.getVoices().find(v => v.lang.startsWith('ar')); } if (synth) { synth.onvoiceschanged = setArabicVoice; setArabicVoice(); }
        async function sendAIAssistantMessage() { const msg = aiInput.value.trim(); if (msg === '') return; const userDiv = document.createElement('div'); userDiv.className = 'chat-message user'; userDiv.textContent = msg; chatHistoryDiv.appendChild(userDiv); aiInput.value = ''; const typingDiv = document.createElement('div'); typingDiv.className = 'chat-message ai'; typingDiv.textContent = 'جاري الكتابة...'; chatHistoryDiv.appendChild(typingDiv); chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight; let aiRes = ''; const lowerMsg = msg.toLowerCase(); if (lowerMsg.includes('سرعة')) aiRes = `سرعة السيارة الحالية هي ${appState.car.speed} كم/س.`; else if (lowerMsg.includes('وقود')) aiRes = `مستوى الوقود الحالي هو ${appState.car.fuel}%.`; else if (lowerMsg.includes('rpm')) aiRes = `عدد دورات المحرك (RPM) هو ${appState.car.rpm}.`; else if (lowerMsg.includes('حرارة')) aiRes = `درجة حرارة المحرك هي ${appState.car.temp}°C.`; else if (lowerMsg.includes('ترس')) aiRes = `الترس الحالي هو ${appState.car.gear}.`; else { try { if (AI_ASSISTANT_API_KEY.startsWith('YOUR_')) { aiRes = 'خطأ: لم يتم تعيين مفتاح Gemini API.'; } else { const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${AI_ASSISTANT_API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: msg }] }] }) }); const result = await res.json(); aiRes = result.candidates?.[0]?.content?.parts?.[0]?.text || 'عذرًا، حدث خطأ.'; } } catch (err) { console.error('Error calling Gemini API:', err); aiRes = 'عذرًا، حدث خطأ في الاتصال بالذكاء الاصطناعي.'; } } typingDiv.remove(); const aiDiv = document.createElement('div'); aiDiv.className = 'chat-message ai'; aiDiv.textContent = aiRes; chatHistoryDiv.appendChild(aiDiv); if (synth && aiRes) { const utterance = new SpeechSynthesisUtterance(aiRes); if (arabicVoice) utterance.voice = arabicVoice; utterance.lang = 'ar-SA'; synth.speak(utterance); } chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight; }
        aiSendButton.addEventListener('click', sendAIAssistantMessage);

        // --- Google Map and Geolocation ---
        function initMap() { const mapOpts = { center: { lat: appState.mapLocation.lat, lng: appState.mapLocation.lon }, zoom: appState.mapLocation.zoom, disableDefaultUI: true, zoomControl: true }; dashboardGoogleMap = new google.maps.Map(document.getElementById('dashboard-google-map'), mapOpts); dashboardGoogleMarker = new google.maps.Marker({ position: mapOpts.center, map: dashboardGoogleMap, icon: { url: 'https://dmusera.netlify.app/3605.png', scaledSize: new google.maps.Size(90, 90) } }); trafficLayerDashboard = new google.maps.TrafficLayer(); trafficLayerDashboard.setMap(dashboardGoogleMap); dashboardGoogleMap.addListener('zoom_changed', () => { if (dashboardGoogleMap.getZoom() !== appState.mapLocation.zoom) appState.mapZoomChangedByUser = true; }); fullGoogleMap = new google.maps.Map(document.getElementById('full-google-map'), mapOpts); fullGoogleMarker = new google.maps.Marker({ position: mapOpts.center, map: fullGoogleMap, icon: { url: 'https://dmusera.netlify.app/3604.png', scaledSize: new google.maps.Size(60, 60) } }); trafficLayerFullMap = new google.maps.TrafficLayer(); trafficLayerFullMap.setMap(fullGoogleMap); directionsService = new google.maps.DirectionsService(); directionsRenderer = new google.maps.DirectionsRenderer({ map: fullGoogleMap }); autocomplete = new google.maps.places.Autocomplete(destinationInput); autocomplete.bindTo('bounds', fullGoogleMap); autocomplete.addListener('place_changed', () => { const place = autocomplete.getPlace(); if (!place.geometry) return showMessageBox("لم يتم العثور على تفاصيل للمدخل: '" + place.name + "'"); if (place.geometry.viewport) fullGoogleMap.fitBounds(place.geometry.viewport); else { fullGoogleMap.setCenter(place.geometry.location); fullGoogleMap.setZoom(17); } fullGoogleMarker.setPosition(place.geometry.location); fullGoogleMarker.setVisible(true); appState.destinationSet = true; updateUI(); }); destinationInput.addEventListener('input', () => { if (destinationInput.value.trim() === '') { appState.destinationSet = false; directionsRenderer.setDirections({ routes: [] }); etaDisplay.textContent = '--'; distanceDisplay.textContent = '--'; updateUI(); } }); startContinuousLocationTracking(); }
        function updateGoogleMapLocation(pos) { const { latitude: lat, longitude: lng, heading } = pos.coords; appState.currentLocation = { lat, lng }; const newLatLng = { lat, lng }; if (dashboardGoogleMap && dashboardGoogleMarker) { dashboardGoogleMarker.setPosition(newLatLng); if (!appState.mapZoomChangedByUser) { dashboardGoogleMap.setCenter(newLatLng); dashboardGoogleMap.setZoom(appState.mapLocation.zoom); } } if (fullGoogleMap && fullGoogleMarker) { fullGoogleMarker.setPosition(newLatLng); fullGoogleMap.setCenter(newLatLng); } if (typeof heading === 'number' && !isNaN(heading)) { if (dashboardGoogleMap) dashboardGoogleMap.setHeading(heading); if (fullGoogleMap) fullGoogleMap.setHeading(heading); } }
        function startContinuousLocationTracking() { if (navigator.geolocation) { watchId = navigator.geolocation.watchPosition((pos) => { updateGoogleMapLocation(pos); appState.hasShownGeolocationError = false; }, (err) => { console.error('Geolocation watch error:', err); if (!appState.hasShownGeolocationError) { let msg = 'تعذر تتبع موقعك. يرجى التحقق من أذونات الموقع.'; if (err.code === 1) msg += ' إذا كان التطبيق في iframe، تأكد من وجود `allow="geolocation"`.'; showMessageBox(msg); appState.hasShownGeolocationError = true; } }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }); } else { showMessageBox('الموقع الجغرافي غير مدعوم.'); } }
        function centerMapOnUserLocation() { if (navigator.geolocation) { navigator.geolocation.getCurrentPosition((pos) => { updateGoogleMapLocation(pos); showMessageBox(`تم تحديث الخريطة.`); }, () => showMessageBox('تعذر الحصول على موقعك الحالي.'), { enableHighAccuracy: true }); } }
        function parseGoogleMapsUrl(url) { try { const urlObj = new URL(url); const path = urlObj.pathname; const coordMatch = path.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/); if (coordMatch) return { lat: parseFloat(coordMatch[1]), lng: parseFloat(coordMatch[2]) }; if (path.startsWith('/search') && urlObj.searchParams.has('q')) return { query: urlObj.searchParams.get('q') }; } catch (e) {} return null; }
        async function calculateAndDisplayRoute() { const destVal = destinationInput.value.trim(); if (!destVal)  return showMessageBox('الرجاء إدخال وجهة.'); let destination = destVal; const parsed = parseGoogleMapsUrl(destVal); if (parsed) { if (parsed.lat && parsed.lng) destination = new google.maps.LatLng(parsed.lat, parsed.lng); else if (parsed.query) destination = parsed.query; destinationInput.value = destination.toString(); } let origin = appState.currentLocation || { lat: 17.0151, lng: 54.0924 }; try { const res = await directionsService.route({ origin, destination, travelMode: 'DRIVING' }); if (res.status === 'OK') { directionsRenderer.setDirections(res); appState.destinationSet = true; const route = res.routes[0].legs[0]; etaDisplay.textContent = route.duration.text; distanceDisplay.textContent = route.distance.text; } else { showMessageBox('تعذر العثور على اتجاهات: ' + res.status); appState.destinationSet = false; } updateUI(); } catch (err) { console.error('Error calculating directions:', err); showMessageBox('حدث خطأ أثناء حساب الاتجاهات.'); appState.destinationSet = false; updateUI(); } }
        function toggleTrafficLayer() { if (trafficLayerFullMap) { isTrafficLayerEnabled = !isTrafficLayerEnabled; trafficLayerFullMap.setMap(isTrafficLayerEnabled ? fullGoogleMap : null); toggleTrafficButton.innerHTML = `<i data-lucide="traffic-cone" class="w-5 h-5"></i> ${isTrafficLayerEnabled ? 'إخفاء' : 'إظهار'} حركة المرور`; lucide.createIcons(); } }
        
        // --- Weather API Integration ---
        let hourlyForecastChart = null;
        async function fetchWeatherData() { if (WEATHER_API_KEY.startsWith('YOUR_')) return showMessageBox('خطأ: لم يتم تعيين مفتاح WeatherAPI.'); try { const res = await fetch(`https://api.weatherapi.com/v1/forecast.json?key=${WEATHER_API_KEY}&q=${appState.weather.location.split(',')[0].trim()}&days=2&aqi=no&alerts=no&lang=ar`); if (!res.ok) throw new Error(`خطأ HTTP! الحالة: ${res.status}`); const data = await res.json(); appState.weather.temperature = data.current.temp_c; appState.weather.description = data.current.condition.text; appState.weather.uvIndex = data.current.uv; appState.weather.iconUrl = `https:${data.current.condition.icon}`; appState.weather.location = `${data.location.name}, ${data.location.country}`; const hourlyData = [...data.forecast.forecastday[0].hour, ...data.forecast.forecastday[1]?.hour || []]; const now = new Date(); const upcomingHours = hourlyData.filter(h => new Date(h.time_epoch * 1000) >= now).slice(0, 12); renderHourlyForecastChart(upcomingHours); } catch (err) { console.error('Error fetching weather data:', err); showMessageBox(`تعذر جلب بيانات الطقس: ${err.message}.`); } finally { updateUI(); } }
        const dataLabelsPlugin = { id: 'dataLabels', afterDatasetsDraw: (chart) => { const { ctx } = chart; ctx.save(); ctx.font = `bold 14px Inter`; ctx.fillStyle = 'white'; ctx.textAlign = 'center'; const meta = chart.getDatasetMeta(0); meta.data.forEach((bar, index) => { ctx.fillText(`${Math.round(chart.data.datasets[0].data[index])}°`, bar.x, bar.y - 5); }); ctx.restore(); } };
        async function renderHourlyForecastChart(upcomingHours) { const ctx = document.getElementById('hourly-forecast-chart')?.getContext('2d'); if (!ctx) return; const labels = upcomingHours.map(h => new Date(h.time_epoch * 1000).toLocaleTimeString('ar-SA', { hour: 'numeric', hour12: true })); const temps = upcomingHours.map(h => h.temp_c); const icons = upcomingHours.map(h => `https:${h.condition.icon}`); const iconImages = icons.map(url => { const img = new Image(32, 32); img.src = url; return img; }); await Promise.all(iconImages.filter(img => !img.complete).map(img => new Promise(resolve => { img.onload = img.onerror = resolve; }))); if (hourlyForecastChart) hourlyForecastChart.destroy(); const weatherIconPlugin = { id: 'weatherIconPlugin', afterDraw: (chart) => { const { ctx } = chart; const meta = chart.getDatasetMeta(0); meta.data.forEach((bar, index) => { const img = iconImages[index]; if (img.complete) { ctx.drawImage(img, bar.x - 16, bar.y - 45, 32, 32); } }); } }; hourlyForecastChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'درجة الحرارة', data: temps, backgroundColor: 'rgba(255, 255, 255, 0.3)', borderColor: 'rgba(255, 255, 255, 0.6)', borderWidth: 1, borderRadius: 5 }] }, plugins: [dataLabelsPlugin, weatherIconPlugin], options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } }, scales: { y: { beginAtZero: false, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: 'white', callback: (v) => v + '°C' }, grace: '25%' }, x: { grid: { display: false }, ticks: { color: 'white' } } } } }); }
        function getUvIndexColor(uv) { if (uv <= 2) return '#4ade80'; if (uv <= 5) return '#facc15'; if (uv <= 7) return '#fb923c'; if (uv <= 10) return '#f87171'; return '#c084fc'; }

        // --- Simulated Car Data ---
        function simulateCarData() { appState.car.speed = (Math.random() * 120).toFixed(0); appState.car.rpm = (Math.random() * 4200 + 800).toFixed(0); appState.car.fuel = (Math.random() * 100).toFixed(0); appState.car.temp = (Math.random() * 30 + 70).toFixed(1); appState.car.gear = ['P', 'R', 'N', 'D'][Math.floor(Math.random() * 4)]; }

        // --- Prayer Times Integration ---
        const prayerTimes = [{"date":"2025-07-27","fajr":"04:44","dhuhr":"12:35","asr":"15:49","maghrib":"19:03","isha":"20:17"},{"date":"2025-07-28","fajr":"04:44","dhuhr":"12:35","asr":"15:49","maghrib":"19:03","isha":"20:16"},{"date":"2025-07-29","fajr":"04:44","dhuhr":"12:35","asr":"15:48","maghrib":"19:03","isha":"20:16"},{"date":"2025-07-30","fajr":"04:45","dhuhr":"12:35","asr":"15:48","maghrib":"19:02","isha":"20:15"},{"date":"2025-07-31","fajr":"04:45","dhuhr":"12:35","asr":"15:47","maghrib":"19:02","isha":"20:15"},{"date":"2025-08-01","fajr":"04:46","dhuhr":"12:35","asr":"15:46","maghrib":"19:02","isha":"20:14"},{"date":"2025-08-02","fajr":"04:46","dhuhr":"12:35","asr":"15:46","maghrib":"19:01","isha":"20:14"},{"date":"2025-08-03","fajr":"04:47","dhuhr":"12:35","asr":"15:45","maghrib":"19:01","isha":"20:13"},{"date":"2025-08-04","fajr":"04:47","dhuhr":"12:35","asr":"15:44","maghrib":"19:00","isha":"20:13"},{"date":"2025-08-05","fajr":"04:48","dhuhr":"12:35","asr":"15:44","maghrib":"19:00","isha":"20:12"},{"date":"2025-08-06","fajr":"04:48","dhuhr":"12:35","asr":"15:44","maghrib":"18:59","isha":"20:11"},{"date":"2025-08-07","fajr":"04:48","dhuhr":"12:35","asr":"15:44","maghrib":"18:59","isha":"20:11"},{"date":"2025-08-08","fajr":"04:49","dhuhr":"12:34","asr":"15:45","maghrib":"18:58","isha":"20:10"},{"date":"2025-08-09","fajr":"04:49","dhuhr":"12:34","asr":"15:45","maghrib":"18:58","isha":"20:09"},{"date":"2025-08-10","fajr":"04:50","dhuhr":"12:34","asr":"15:45","maghrib":"18:57","isha":"20:09"},{"date":"2025-08-11","fajr":"04:50","dhuhr":"12:34","asr":"15:46","maghrib":"18:57","isha":"20:08"},{"date":"2025-08-12","fajr":"04:50","dhuhr":"12:34","asr":"15:46","maghrib":"18:56","isha":"20:07"}];
        function addMinutes(time, min) { const [h, m] = time.split(':').map(Number); const d = new Date(); d.setHours(h, m + min, 0, 0); return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }); }
        function timeToDate(time) { const [h, m] = time.split(':').map(Number); const d = new Date(); d.setHours(h, m, 0, 0); return d; }
        function loadPrayerTimes() { const today = new Date().toISOString().split('T')[0]; const data = prayerTimes.find(p => p.date === today); if (data) { appState.prayerTimes = { ...appState.prayerTimes, Fajr: data.fajr, Dhuhr: data.dhuhr, Asr: data.asr, Maghrib: data.maghrib, Isha: data.isha }; fajrTimeElement.textContent = data.fajr; dhuhrTimeElement.textContent = data.dhuhr; asrTimeElement.textContent = data.asr; maghribTimeElement.textContent = data.maghrib; ishaTimeElement.textContent = data.isha; fajrIqamaElement.textContent = 'الإقامة: ' + addMinutes(data.fajr, 25); dhuhrIqamaElement.textContent = 'الإقامة: ' + addMinutes(data.dhuhr, 20); asrIqamaElement.textContent = 'الإقامة: ' + addMinutes(data.asr, 20); maghribIqamaElement.textContent = 'الإقامة: ' + addMinutes(data.maghrib, 5); ishaIqamaElement.textContent = 'الإقامة: ' + addMinutes(data.isha, 20); } else { console.warn('No prayer times for today.'); } determineNextPrayer(); }
        function determineNextPrayer() { const now = new Date(); const todayData = prayerTimes.find(p => p.date === now.toISOString().split('T')[0]); if (!todayData) return; const prayers = [{n:"الفجر",t:todayData.fajr,o:25,g:5},{n:"الظهر",t:todayData.dhuhr,o:20,g:5},{n:"العصر",t:todayData.asr,o:20,g:10},{n:"المغرب",t:todayData.maghrib,o:5,g:5},{n:"العشاء",t:todayData.isha,o:20,g:25}]; let found = false; appState.prayerTimes.currentPrayer = null; for (const p of prayers) { const pTime = timeToDate(p.t); const iqamaTime = timeToDate(addMinutes(p.t, p.o)); const graceEnd = new Date(iqamaTime.getTime() + p.g * 60000); if (now >= pTime && now < graceEnd) { appState.prayerTimes.currentPrayer = p.n; appState.prayerTimes.nextPrayer = p.n; appState.prayerTimes.nextPrayerIqamaTime = (now < iqamaTime) ? iqamaTime : graceEnd; found = true; break; } if (now < pTime && !found) { appState.prayerTimes.nextPrayer = p.n; appState.prayerTimes.nextPrayerIqamaTime = pTime; found = true; break; } } if (!found) { const tomorrow = new Date(now); tomorrow.setDate(now.getDate() + 1); const tomorrowData = prayerTimes.find(p => p.date === tomorrow.toISOString().split('T')[0]); if (tomorrowData) { const fajrTomorrow = timeToDate(tomorrowData.fajr); fajrTomorrow.setDate(tomorrow.getDate()); appState.prayerTimes.nextPrayer = "الفجر (غدًا)"; appState.prayerTimes.nextPrayerIqamaTime = fajrTomorrow; } } renderPrayerTimes(); }
        function renderPrayerTimes() { if (!prayerTimesContainer) return; document.querySelectorAll('.prayer-time-item').forEach(i => i.classList.remove('current-prayer', 'next-prayer')); const map = {Fajr:'الفجر',Dhuhr:'الظهر',Asr:'العصر',Maghrib:'المغرب',Isha:'العشاء',"الفجر (غدًا)":'الفجر'}; if (appState.prayerTimes.currentPrayer) { const name = map[appState.prayerTimes.currentPrayer]; const item = Array.from(document.querySelectorAll('.prayer-time-item .prayer-name')).find(s => s.textContent === name)?.parentElement; if (item) item.classList.add('current-prayer'); } if (appState.prayerTimes.nextPrayer && appState.prayerTimes.nextPrayer !== appState.prayerTimes.currentPrayer) { const name = map[appState.prayerTimes.nextPrayer]; const item = Array.from(document.querySelectorAll('.prayer-time-item .prayer-name')).find(s => s.textContent.startsWith(name))?.parentElement; if (item && !item.classList.contains('current-prayer')) item.classList.add('next-prayer'); } }
        
        // --- Digital Clock ---
        function updateDigitalClock() { const now = new Date(); let h = now.getHours() % 12; h = h ? h : 12; digitalHoursSpan.textContent = h.toString().padStart(2, '0'); digitalMinutesSpan.textContent = now.getMinutes().toString().padStart(2, '0'); digitalSecondsSpan.textContent = now.getSeconds().toString().padStart(2, '0'); digitalDateLine1.style.color = 'white'; digitalDateLine2.style.color = 'white'; if (appState.prayerTimes.nextPrayerIqamaTime) { const diff = appState.prayerTimes.nextPrayerIqamaTime - now; if (diff <= 0) return determineNextPrayer(); const totalSecs = Math.floor(diff / 1000); const s = totalSecs % 60; const m = Math.floor((totalSecs / 60) % 60); const hr = Math.floor(totalSecs / 3600); const currentPrayerData = appState.prayerTimes.currentPrayer ? [{n:"الفجر",o:25},{n:"الظهر",o:20},{n:"العصر",o:20},{n:"المغرب",o:5},{n:"العشاء",o:20}].find(p=>p.n===appState.prayerTimes.currentPrayer) : null; const isAfterAzan = currentPrayerData && now >= timeToDate(appState.prayerTimes[currentPrayerData.n]) && now < timeToDate(addMinutes(appState.prayerTimes[currentPrayerData.n], currentPrayerData.o)); if (isAfterAzan) { digitalDateLine1.textContent = `إقامة صلاة ${appState.prayerTimes.currentPrayer} في:`; digitalDateLine2.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`; digitalDateLine1.style.color = '#7eff7e'; digitalDateLine2.style.color = '#7eff7e'; } else { digitalDateLine1.textContent = `الأذان القادم: ${appState.prayerTimes.nextPrayer}`; digitalDateLine2.textContent = hr > 0 ? `${hr}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}` : `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`; if (totalSecs < 3600) { digitalDateLine1.style.color = '#FFA07A'; digitalDateLine2.style.color = '#FFA07A'; } } } else { digitalDateLine1.textContent = 'جاري تحميل أوقات الصلاة...'; digitalDateLine2.textContent = ''; } }

        // --- 360 Camera ---
        function handleImageUpload(e) { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (ev) => { appState.custom360Image = ev.target.result; localStorage.setItem('custom360Image', ev.target.result); updateUI(); }; reader.readAsDataURL(file); } }
        function resetImageToDefault() { appState.custom360Image = null; localStorage.removeItem('custom360Image'); updateUI(); }

        // --- TV Remote / Keyboard Navigation (REBUILT) ---
        let currentFocus = null;
        function setFocus(el) { if (currentFocus) currentFocus.classList.remove('tv-focus'); if (el) { el.classList.add('tv-focus'); el.focus({ preventScroll: true }); currentFocus = el; el.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' }); } }
        
        function handleNavigation(e) {
            const key = e.key;
            if (!['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Enter', 'OK'].includes(key)) return;

            const activeEl = document.activeElement;
            if (!activeEl || activeEl === document.body) {
                const firstIcon = document.querySelector('nav .app-icon');
                if (firstIcon) {
                    e.preventDefault();
                    setFocus(firstIcon);
                }
                return;
            }

            const inNav = activeEl.closest('nav');
            const inMediaScreen = activeEl.closest('#screen-Media');

            if (inNav) {
                handleNavSidebarNavigation(e, activeEl);
            } else if (inMediaScreen) {
                handleMediaScreenNavigation(e, activeEl);
            } else {
                const container = activeEl.closest('.grid-container');
                if (container) {
                    handleGenericGridNavigation(e, activeEl, container);
                }
            }
        }

        function handleNavSidebarNavigation(e, activeEl) {
            e.preventDefault();
            const icons = Array.from(document.querySelectorAll('nav .app-icon'));
            const idx = icons.indexOf(activeEl);
            let nextIdx = -1;
            switch (e.key) {
                case 'ArrowUp':
                    nextIdx = idx > 0 ? idx - 1 : icons.length - 1;
                    break;
                case 'ArrowDown':
                    nextIdx = idx < icons.length - 1 ? idx + 1 : 0;
                    break;
                case 'ArrowRight': // In RTL, right arrow should go to main content
                    const screen = document.querySelector('.app-screen.active');
                    if (screen) {
                        const firstItem = screen.querySelector('.grid-item');
                        if (firstItem) setFocus(firstItem);
                    }
                    return;
                case 'Enter':
                case 'OK':
                    activeEl.click();
                    return;
            }
            if (nextIdx !== -1) setFocus(icons[nextIdx]);
        }
        
        // REBUILT: Specific navigation logic for the complex Media screen
        function handleMediaScreenNavigation(e, activeEl) {
            e.preventDefault();

            // Define all potential containers
            const searchRow = document.querySelector('#screen-Media .flex.flex-row.items-center.gap-2.grid-container');
            const readersContainer = document.querySelector('.reader-container');
            const surahContainer = document.querySelector('#youtube-surah-section');
            const playlistContainer = document.querySelector('#youtube-playlist-view');
            const videoListContainer = document.querySelector('#video-list-container');
            const searchResultsContainer = document.querySelector('#search-results-container');

            // Identify current section
            const inSearchRow = activeEl.closest('.flex.flex-row.items-center.gap-2.grid-container');
            const inReaders = activeEl.closest('.reader-container');
            const inSurahs = activeEl.closest('#youtube-surah-section');
            const inPlaylists = activeEl.closest('#youtube-playlist-view');
            const inVideoList = activeEl.closest('#video-list-container');
            const inSearchResults = activeEl.closest('#search-results-container');

            // Handle vertical transitions between sections
            if (e.key === 'ArrowDown') {
                if (inSearchRow) {
                    // From search, go to the first visible container below it
                    const nextVisibleContainer = [readersContainer, surahContainer, playlistContainer, videoListContainer, searchResultsContainer].find(c => c && c.offsetParent !== null);
                    if (nextVisibleContainer) {
                        const firstItem = nextVisibleContainer.querySelector('.grid-item');
                        if (firstItem) { setFocus(firstItem); return; }
                    }
                }
                if (inReaders) {
                    if (surahContainer && surahContainer.offsetParent !== null) {
                        const firstItem = surahContainer.querySelector('.grid-item');
                        if (firstItem) { setFocus(firstItem); return; }
                    }
                }
            }

            if (e.key === 'ArrowUp') {
                // If in any container's top row, go to search
                const currentContainer = activeEl.closest('.grid-container, .reader-container');
                if (currentContainer && currentContainer !== searchRow) {
                    const items = Array.from(currentContainer.querySelectorAll('.grid-item:not([style*="display: none"])')).filter(el => el.offsetParent !== null);
                    const idx = items.indexOf(activeEl);
                    if (idx !== -1) {
                        const firstItemTop = items[0].getBoundingClientRect().top;
                        let cols = items.filter(item => Math.abs(item.getBoundingClientRect().top - firstItemTop) < 20).length;
                        if (cols === 0) cols = 1;
                        if (idx < cols) { // Is in top row
                            setFocus(youtubeSearchInput);
                            return;
                        }
                    }
                }
            }

            // Handle navigation WITHIN a section
            if (inReaders) {
                const items = Array.from(readersContainer.querySelectorAll('.grid-item'));
                const idx = items.indexOf(activeEl);
                if (e.key === 'ArrowLeft') { // LTR scroll left
                    if (idx > 0) setFocus(items[idx - 1]);
                } else if (e.key === 'ArrowRight') { // LTR scroll right
                    if (idx < items.length - 1) setFocus(items[idx + 1]);
                } else if (e.key === 'Enter' || e.key === 'OK') {
                    activeEl.click();
                } else if (e.key === 'ArrowLeft' && idx === 0) { // Special case: From first reader, go to nav bar
                    const navIcon = document.querySelector('nav .app-icon.active');
                    if (navIcon) setFocus(navIcon);
                }
                return; // Stop further processing
            }

            // Default to generic grid navigation for all other cases
            const container = activeEl.closest('.grid-container');
            if (container) {
                handleGenericGridNavigation(e, activeEl, container);
            }
        }

        function handleGenericGridNavigation(e, activeEl, container) {
            e.preventDefault();
            const items = Array.from(container.querySelectorAll('.grid-item:not([style*="display: none"])')).filter(el => el.offsetParent !== null);
            if (items.length === 0) return;
        
            const idx = items.indexOf(activeEl);
            if (idx === -1) return;
        
            // Calculate columns based on layout
            const firstItemTop = items[0].getBoundingClientRect().top;
            let cols = items.filter(item => Math.abs(item.getBoundingClientRect().top - firstItemTop) < 20).length;
            if (cols === 0) cols = 1; // Fallback for single-item rows or vertical lists
        
            const isTopRow = idx < cols;
            let nextIdx = -1;
        
            switch (e.key) {
                case 'ArrowUp':
                    if (!isTopRow) {
                        nextIdx = idx - cols;
                    }
                    // Vertical transitions are handled by handleMediaScreenNavigation
                    break;
                case 'ArrowDown':
                     nextIdx = idx + cols;
                    // Vertical transitions are handled by handleMediaScreenNavigation
                    break;
                case 'ArrowRight': // RTL: Move visually RIGHT (DOM previous)
                    if (idx % cols !== 0) {
                        nextIdx = idx - 1;
                    }
                    break;
                case 'ArrowLeft': // RTL: Move visually LEFT (DOM next)
                    if ((idx + 1) % cols === 0 || idx === items.length - 1) {
                        // If at the leftmost edge, go to the nav bar
                        const navIcon = document.querySelector('nav .app-icon.active');
                        if (navIcon) setFocus(navIcon);
                        return;
                    } else {
                        nextIdx = idx + 1;
                    }
                    break;
                case 'Enter':
                case 'OK':
                    activeEl.click();
                    return;
            }
        
            if (nextIdx >= 0 && nextIdx < items.length) {
                setFocus(items[nextIdx]);
            }
        }
        
        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => { document.getElementById('get-my-location-button-dashboard')?.addEventListener('click', centerMapOnUserLocation); floatingFullscreenButton?.addEventListener('click', togglePseudoFullscreen); floatingMediaButton?.addEventListener('click', () => switchApp('Media')); startDirectionsButton?.addEventListener('click', calculateAndDisplayRoute); getMyLocationButtonFullMap?.addEventListener('click', centerMapOnUserLocation); toggleTrafficButton?.addEventListener('click', toggleTrafficLayer); startTripFloatingButton?.addEventListener('click', () => { if (appState.destinationSet) calculateAndDisplayRoute(); else showMessageBox('الرجاء تحديد وجهة أولاً.'); }); upload360ImageButton?.addEventListener('click', () => upload360ImageInput.click()); upload360ImageInput?.addEventListener('change', handleImageUpload); reset360ImageButton?.addEventListener('click', resetImageToDefault); document.addEventListener('keydown', handleNavigation); updateUI(); fetchWeatherData(); setInterval(fetchWeatherData, 300000); setInterval(updateDigitalClock, 1000); setInterval(simulateCarData, 5000); switchApp('Dashboard'); });
    </script>
</body>
</html>
