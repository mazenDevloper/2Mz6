<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مواقيت الصلاة - شاشة المسجد</title>
    
    <!-- استدعاء الخطوط العربية المطلوبة -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700;900&family=Tajawal:wght@700;900&display=swap" rel="stylesheet">
    
    <!-- مكتبات التعامل مع الوقت (Moment.js و Moment-Hijri) -->
    <!-- تم الاحتفاظ بالمكتبات لأنها ضرورية لبقية الدوال (العد التنازلي والصلوات) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-hijri/2.1.2/moment-hijri.min.js"></script>
    <!-- إضافة اللغة العربية لـ Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/ar-sa.min.js"></script>

    <style>
        /* --- المتغيرات الأساسية --- */
        :root {
            --bg-color: #000000;
            --border-gold: #d4af37; /* لون ذهبي */
            --text-white: #ffffff;
            --text-red: #ff3333;    /* لون الأذان (أحمر) */
            --text-green: #2ecc71;  /* لون الإقامة (أخضر) */
            /* تحديد حجم العرض الأصلي للقالب */
            --base-width: 500px;
            --base-height: 281px;
        }

        /* --- إعدادات الصفحة --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0; 
        }

        html, body {
            height: 100vh; 
            overflow: hidden;
        }

        body {
            /* الخلفية المطلوبة */
            background:black;
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center;

            color: var(--text-white);
            /* الخط الأساسي الآن يتضمن وزناً جريئاً */
            font-family: 'Tajawal', sans-serif;
            font-weight: 700; 
            
            padding: 10px; 
            
            /* توسيط الإطار الرئيسي في وسط الشاشة */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- الإطار الرئيسي (SVG) --- */
        .main-frame {
            width: 100%;
            max-width: calc(100vw - 20px);
            height: auto;
            max-height: calc(100vh - 20px);
            aspect-ratio: 500 / 281;
            display: block;
        }
        
        .content-box {
            width: 100%;
            height: 100%;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: 0;
        }
        
        /* --- R1: الساعة --- */
        .header-clock-section {
            justify-content: flex-start;
            padding-left: 4px;
        }

        #digital-clock {
            font-size: 28px;
            font-weight: 900; /* خط عريض جداً */
            color: var(--text-white);
            font-family: 'Tajawal', sans-serif;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            letter-spacing: 1px;
        }

        /* --- R2 + R3: التاريخ والشروق --- */
        .header-date-section {
            justify-content: space-between;
            font-size: 14px;
            font-weight: bold;
            padding: 0 5px;
        }
        
        .sunrise-box, .gregorian-date-box {
             font-weight: bold; /* ضمان الخط العريض */
             /* تحديد العرض كما كان في التصميم */
             width: 48px; text-align: center; 
        }

        /* --- R10: التاريخ الهجري (تم تحديثه) --- */
        
        /* الحاوية الرئيسية لتوزيع اليوم والشهر/السنة أفقياً */
        .hijri-date-container {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            direction: rtl; 
            width: 100%;
            height: 100%;
            padding: 0 5px; /* إضافة مسافة داخلية */
        }
        
        /* رقم اليوم (كبير وبارز) */
        #hijri-day { 
            font-size: 40px; 
            font-weight: 900;
            line-height: 1; 
            color: var(--text-white);
            width: 40%;
            text-align: center; 
        }

        /* مكدس النص للشهر والسنة (عمودي) */
        .hijri-text-stack {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center; 
            width: 60%;
            line-height: 1.2;
        }
        
        .hijri-month { 
            font-size: 14px; 
            color: var(--text-white); 
            font-weight: 900; 
            margin-bottom: 2px;
        }
        .hijri-year { 
            font-size: 14px; 
            color: var(--border-gold); 
            font-weight: 900; 
        }

        /* --- R11: العد التنازلي و R4: التسمية --- */
        .countdown-box {
            flex-direction: column;
            text-align: center;
            position: relative; 
        }

        #next-prayer-name {
            font-size: 12px;
            display: block;
            color: var(--border-gold);
            font-family: 'Tajawal', sans-serif;
            margin-bottom: 5px;
            font-weight: 900;
        }

        #countdown-display {
            font-size: 24px; 
            color: var(--text-white); 
            font-family: 'Tajawal', sans-serif;
            font-weight: 900; /* خط عريض جداً */
        }
        
        /* الحاوية الجديدة للأذكار النشطة (شبكة 2x2) */
        #active-reminders-box {
            display: flex;
            flex-wrap: wrap; 
            justify-content: space-around; 
            align-content: flex-start; 
            direction: rtl;
            padding: 0 2px;
        }

        .reminder-item {
            width: 50%; /* 2 عمود */
            height: 50%; /* 2 صفوف */
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 10px; /* أصغر كما طلب */
            color: var(--border-gold);
            padding: 1px 0;
            line-height: 1.1;
            font-weight: 700;
        }
        /* تصميم للعناصر غير النشطة لتكون أكثر خفوتاً */
        .reminder-item.inactive {
            color: #555;
            font-weight: 400;
        }


        /* --- R9-R5: جدول الصلوات (الحاوية الكلية) --- */
        .prayers-table-section {
            flex-direction: column;
            justify-content: flex-start; 
            align-items: stretch;
            padding: 0 2px; 
            position: relative;
        }

        /* رأس الجدول (يتم وضعه فوق أول صف) */
        .prayer-row.header {
            position: absolute;
            top: -20px; 
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            padding: 0 5px;
            height: 20px;
            font-weight: 700;
        }

        /* حاوية صفوف الصلوات */
        #prayers-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
        }

        /* صف الصلاة (كل صف يمثل أحد Rects R9-R5) */
        .prayer-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: transparent;
            padding: 2px 5px;
            width: 100%;
            height: 24px; 
            transition: all 0.3s ease;
        }

        /* --- تصميم خطوط الجدول --- */
        .prayer-name {
            font-family: 'Amiri', serif;
            font-size: 14px;
            color: var(--text-white);
            width: 30%;
            text-align: center;
            font-weight: 900; /* خط عريض جداً */
        }

        /* لون أحمر للأذان */
        .prayer-time-adhan {
            font-size: 18px;
            font-weight: 900; /* خط عريض جداً */
            color: var(--text-red);
            width: 35%;
            text-align: center;
            font-family: 'Tajawal', sans-serif;
        }

        /* لون أخضر للإقامة */
    
        .prayer-time-iqamah {
            font-size: 18px;
            color: #00c100!important;
            font-weight: 900; /* خط عريض جداً */
            width: 35%;
            text-align: center;
            font-family: 'Tajawal', sans-serif;
        }

        /* تظليل الصلاة القادمة */
        .next-prayer-highlight {
            background: rgba(212, 175, 55, 0.45); 
            border: 2.3px solid rgba(212, 175, 55); 
            transform: scale(1.02);
            animation: pulse 2s infinite;
            border-radius: 50px;
        }

        /* --- تأثير نبض لتمييز الصلاة القادمة --- */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); }
            70% { box-shadow: 0 0 0 5px rgba(212, 175, 55, 0); }
            100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
        }

    </style>
</head>
<body>

    <!-- الهيكل الأساسي للتطبيق يستخدم الآن SVG كـ main-frame -->
    <svg class="main-frame" viewBox="0 0 500 281" xmlns="http://www.w3.org/2000/svg">
    <!-- الصورة الخلفية للقالب (يجب استبدالها بصورة مناسبة للمسجد) -->
    <image width="500" height="281" xlink:href="https://dmusera.netlify.app/screen1.SVG"></image>

        <!-- 1. الساعة (R1) -->
        <!-- Rect: x="61.5" y="45.5" width="168" height="37" -->
        <foreignObject x="80" y="45.5" width="168" height="37">
            <div class="content-box header-clock-section">
                <div id="digital-clock">00:00:00</div>
            </div>
        </foreignObject>
        
        <!-- 2. التاريخ الميلادي والشروق (R2, R3) -->
        <!-- Total Rect: x="272" y="46" width="166" height="37" -->
        <foreignObject x="265" y="46" width="166" height="37">
            <div class="content-box header-date-section">
                
                <div class="sunrise-box">
                    <div style="font-size: 0.8em; color: #aaa;">الشروق</div>
                    <div id="sunrise-time" style="color: var(--text-white);">--:--</div>
                </div>
            <div class="gregorian-date-box">
                    <div id="gregorian-day-name" style="color: var(--border-gold);">اليوم</div>
                    <div id="gregorian-date" style="font-size: 0.8em;">YYYY-MM-DD</div>
                </div></div>
        </foreignObject>

        <!-- 3. جدول الصلاوات (R9-R5) -->
        <!-- Rect: x="54" y="113" width="184" height="126" -->
        <foreignObject x="54" y="113" width="184" height="126">
            <div class="content-box prayers-table-section">
                <!-- رأس الجدول يوضع كـ absolute فوق الصفوف -->
                <div class="prayer-row header">
                    <span style="width:35%; text-align:center">الإقامة</span>
                    <span style="width:30%; text-align:center">الصلاة</span>
                    <span style="width:35%; text-align:center">الأذان</span>
                </div>
                <!-- حاوية الصلوات (تتم تعبئتها بالـ JS) -->
                <div id="prayers-container">
                    <!-- سيتم تعبئة الصفوف هنا -->
                </div>
            </div>
        </foreignObject>

        <!-- 4. التاريخ الهجري (R10) -->
        <!-- Rect: x="280" y="92" width="154" height="49" -->
        <foreignObject x="280" y="92" width="154" height="49">
            <div class="content-box hijri-date-container">
                <!-- Day is now dominant (ID kept for JS) -->
                <div id="hijri-day" class="hijri-day">--</div> 
                <!-- Month and Year are stacked next to it -->
                <div class="hijri-text-stack">
                    <div id="hijri-month" class="hijri-month">الشهر الهجري</div>
                    <div id="hijri-year" class="hijri-year">----</div>
                </div>
            </div>
        </foreignObject>

        <!-- 5. العد التنازلي (R11) -->
        <!-- Rect: x="280" y="150" width="154" height="49" -->
        <foreignObject x="280" y="150" width="154" height="49">
            <div class="content-box countdown-box">
                <div class="countdown-timer-wrapper">
                    <span id="next-prayer-name">المتبقي لـ الصلاة</span>
                    <span id="countdown-display">--:--:--</span>
                </div>
            </div>
        </foreignObject>
        
        <!-- 6. الأذكار والسنن النشطة (R4) - Rect: x="272" y="205" width="166" height="31" -->
        <foreignObject x="272" y="205" width="166" height="31">
            <div class="content-box" id="active-reminders-box">
                <!-- سيتم ملؤها ديناميكياً بـ 4 عناصر بحد أقصى -->
            </div>
        </foreignObject>
        
    </svg>

    <script>
        // --- (1) البيانات التي أدخلتها ---
        const prayerTimesData = [
            {"date":"2025-11-01","fajr":"05:08","sunrise":"06:22","dhuhr":"12:12","asr":"15:31","maghrib":"17:58","isha":"19:06"},
            {"date":"2025-11-02","fajr":"05:08","sunrise":"06:22","dhuhr":"12:12","asr":"15:30","maghrib":"17:57","isha":"19:06"},
            {"date":"2025-11-03","fajr":"05:09","sunrise":"06:23","dhuhr":"12:12","asr":"15:30","maghrib":"17:57","isha":"19:06"},
            {"date":"2025-11-04","fajr":"05:09","sunrise":"06:23","dhuhr":"12:12","asr":"15:30","maghrib":"17:57","isha":"19:05"},
            {"date":"2025-11-05","fajr":"05:09","sunrise":"06:23","dhuhr":"12:12","asr":"15:30","maghrib":"17:56","isha":"19:05"},
            {"date":"2025-11-06","fajr":"05:10","sunrise":"06:24","dhuhr":"12:12","asr":"15:30","maghrib":"17:56","isha":"19:05"},
            {"date":"2025-11-07","fajr":"05:10","sunrise":"06:24","dhuhr":"12:12","asr":"15:29","maghrib":"17:55","isha":"19:04"},
            {"date":"2025-11-08","fajr":"05:10","sunrise":"06:25","dhuhr":"12:12","asr":"15:29","maghrib":"17:55","isha":"19:04"},
            {"date":"2025-11-09","fajr":"05:11","sunrise":"06:25","dhuhr":"12:12","asr":"15:29","maghrib":"17:55","isha":"19:04"},
            {"date":"2025-11-10","fajr":"05:11","sunrise":"06:26","dhuhr":"12:13","asr":"15:29","maghrib":"17:55","isha":"19:04"},
            {"date":"2025-11-11","fajr":"05:12","sunrise":"06:26","dhuhr":"12:13","asr":"15:29","maghrib":"17:54","isha":"19:04"},
            {"date":"2025-11-12","fajr":"05:12","sunrise":"06:27","dhuhr":"12:13","asr":"15:29","maghrib":"17:54","isha":"19:04"},
            {"date":"2025-11-13","fajr":"05:12","sunrise":"06:27","dhuhr":"12:13","asr":"15:29","maghrib":"17:54","isha":"19:03"},
            {"date":"2025-11-14","fajr":"05:13","sunrise":"06:28","dhuhr":"12:13","asr":"15:29","maghrib":"17:54","isha":"19:03"},
            {"date":"2025-11-15","fajr":"05:13","sunrise":"06:28","dhuhr":"12:13","asr":"15:29","maghrib":"17:53","isha":"19:03"},
            {"date":"2025-11-16","fajr":"05:13","sunrise":"06:29","dhuhr":"12:13","asr":"15:29","maghrib":"17:53","isha":"19:03"},
            {"date":"2025-11-17","fajr":"05:14","sunrise":"06:29","dhuhr":"12:14","asr":"15:28","maghrib":"17:53","isha":"19:03"},
            {"date":"2025-11-18","fajr":"05:14","sunrise":"06:30","dhuhr":"12:14","asr":"15:28","maghrib":"17:53","isha":"19:03"},
            {"date":"2025-11-19","fajr":"05:15","sunrise":"06:30","dhuhr":"12:14","asr":"15:28","maghrib":"17:53","isha":"19:03"},
            {"date":"2025-11-20","fajr":"05:15","sunrise":"06:31","dhuhr":"12:14","asr":"15:28","maghrib":"17:53","isha":"19:03"},
            {"date":"2025-11-21","fajr":"05:16","sunrise":"06:31","dhuhr":"12:14","asr":"15:29","maghrib":"17:53","isha":"19:03"},
            {"date":"2025-11-22","fajr":"05:16","sunrise":"06:32","dhuhr":"12:15","asr":"15:29","maghrib":"17:53","isha":"19:03"},
            {"date":"2025-11-23","fajr":"05:17","sunrise":"06:32","dhuhr":"12:15","asr":"15:29","maghrib":"17:53","isha":"19:03"},
            {"date":"2025-11-24","fajr":"05:17","sunrise":"06:33","dhuhr":"12:15","asr":"15:29","maghrib":"17:53","isha":"19:04"},
            {"date":"2025-11-25","fajr":"05:17","sunrise":"06:33","dhuhr":"12:16","asr":"15:29","maghrib":"17:53","isha":"19:04"},
            {"date":"2025-11-26","fajr":"05:18","sunrise":"06:34","dhuhr":"12:16","asr":"15:29","maghrib":"17:53","isha":"19:04"},
            {"date":"2025-11-27","fajr":"05:18","sunrise":"06:35","dhuhr":"12:16","asr":"15:29","maghrib":"17:53","isha":"19:04"},
            {"date":"2025-11-28","fajr":"05:19","sunrise":"06:35","dhuhr":"12:17","asr":"15:29","maghrib":"17:53","isha":"19:04"},
            {"date":"2025-11-29","fajr":"05:19","sunrise":"06:36","dhuhr":"12:17","asr":"15:29","maghrib":"17:53","isha":"19:04"},
            {"date":"2025-11-30","fajr":"05:20","sunrise":"06:36","dhuhr":"12:17","asr":"15:30","maghrib":"17:53","isha":"19:05"}
        ];

        // --- (2) إعدادات التطبيق ---
        
        // إعدادات وقت الإقامة (إضافة دقائق على وقت الأذان) - يمكنك تعديلها
        const iqamahOffsets = {
            fajr: 20,  // 20 دقيقة بعد أذان الفجر
            dhuhr: 20, // 20 دقيقة بعد أذان الظهر
            asr: 20,   // 20 دقيقة بعد أذان العصر
            maghrib: 10, // 10 دقائق بعد أذان المغرب
            isha: 20   // 20 دقيقة بعد أذان العشاء
        };

        // أسماء الصلوات للعرض (الأسماء الافتراضية)
        const prayerNames = {
            fajr: "الفجر",
            sunrise: "الشروق",
            dhuhr: "الظهر", // هذا هو الاسم الافتراضي
            asr: "العصر",
            maghrib: "المغرب",
            isha: "العشاء"
        };
        
        // قائمة الأذكار والسنن بترتيب الأولوية للعرض
        const REMINDER_LIST = [
            "أذكار الصباح", "صلاة الضحى", "السنن الرواتب", 
            "أذكار المساء", "الورد اليومي", "سورة الملك", 
            "صلاة الوتر", "قيام الليل"
        ];

        // متغير عالمي لتخزين أوقات الصلاة المعالجة لليوم الحالي
        let processedPrayerTimes = [];
        let reminderMoments = {}; // لتخزين لحظات الأذكار والسنن

        // --- (3) دوال النظام ---

        // دالة لحساب اللحظات الهامة للأذكار والسنن
        function calculateReminderMoments(data) {
            const today = data.date;
            const tomorrow = moment(today).add(1, 'days').format('YYYY-MM-DD');

            // الحصول على اللحظات الهامة لليوم الحالي
            const FajrAdhan = moment(today + ' ' + data.fajr, 'YYYY-MM-DD HH:mm');
            const FajrIqamah = FajrAdhan.clone().add(iqamahOffsets.fajr, 'minutes');
            const Sunrise = moment(today + ' ' + data.sunrise, 'YYYY-MM-DD HH:mm');
            const DhuhrAdhan = moment(today + ' ' + data.dhuhr, 'YYYY-MM-DD HH:mm');
            const DhuhrIqamah = DhuhrAdhan.clone().add(iqamahOffsets.dhuhr, 'minutes');
            const AsrIqamah = moment(today + ' ' + data.asr, 'YYYY-MM-DD HH:mm').add(iqamahOffsets.asr, 'minutes');
            const MaghribAdhan = moment(today + ' ' + data.maghrib, 'YYYY-MM-DD HH:mm');
            const MaghribIqamah = MaghribAdhan.clone().add(iqamahOffsets.maghrib, 'minutes');
            const IshaAdhan = moment(today + ' ' + data.isha, 'YYYY-MM-DD HH:mm');
            const IshaIqamah = IshaAdhan.clone().add(iqamahOffsets.isha, 'minutes');

            // الحصول على أذان فجر اليوم التالي لتحديد نهاية وقت الليل
            const tomorrowData = prayerTimesData.find(p => p.date === tomorrow);
            const NextDayFajrAdhan = tomorrowData ? moment(tomorrow + ' ' + tomorrowData.fajr, 'YYYY-MM-DD HH:mm') : null;

            // تحديد اللحظات الخاصة بالليل (22:00 و 00:00)
            const PM10Today = moment(today + ' 22:00', 'YYYY-MM-DD HH:mm');
            // بداية اليوم التالي (منتصف الليل)
            const MidnightToday = moment(today + ' 00:00', 'YYYY-MM-DD HH:mm').add(1, 'day'); 
            
            reminderMoments = {
                // أذكار الصباح: من إقامة الفجر حتى قبل أذان الظهر بـ 15 دقيقة
                MorningAzkarStart: FajrIqamah,
                MorningAzkarEnd: DhuhrAdhan.clone().subtract(15, 'minutes'), 

                // صلاة الضحى: من بعد شروق الشمس بـ 15 دقيقة حتى أذان الظهر
                DuhaStart: Sunrise.clone().add(15, 'minutes'),
                DuhaEnd: DhuhrAdhan, 

                // السنن الرواتب: تفعيلها قبل أذان كل صلاة فرض بـ 10 دقائق وبعد الإقامة بـ 10 دقائق 
                DhuhrRawatibStart: DhuhrAdhan.clone().subtract(10, 'minutes'),
                DhuhrRawatibEnd: DhuhrIqamah.clone().add(10, 'minutes'),
                MaghribRawatibStart: MaghribAdhan.clone().subtract(10, 'minutes'),
                MaghribRawatibEnd: MaghribIqamah.clone().add(10, 'minutes'),
                IshaRawatibStart: IshaAdhan.clone().subtract(10, 'minutes'),
                IshaRawatibEnd: IshaIqamah.clone().add(10, 'minutes'),

                // أذكار المساء: من إقامة العصر حتى أذان المغرب
                EveningAzkarStart: AsrIqamah,
                EveningAzkarEnd: MaghribAdhan, 
                
                // الأنشطة الليلية المخصصة (النهاية المشتركة هي أذان الفجر التالي)
                NightEnd: NextDayFajrAdhan,
                
                // سورة الملك: 10 مساءً حتى الفجر
                MulkStart: PM10Today,
                
                // صلاة الوتر: بعد إقامة العشاء حتى الفجر
                WitrStart: IshaIqamah,
                
                // قيام الليل: بعد 12 ص حتى الفجر
                QiyamStart: MidnightToday
            };
        }

        // الدالة الرئيسية التي تبدأ كل شيء
        function init() {
            // تحميل بيانات الصلاة والتاريخ لأول مرة
            loadDailyData();
            
            // تحديث الساعة والعد التنازلي والأذكار كل ثانية
            setInterval(updateClockAndCountdown, 1000);
            
            // تحقق من إعادة تحميل البيانات عند منتصف الليل
            checkMidnightReload();
        }

        // دالة للتحقق من منتصف الليل وإعادة تحميل البيانات
        function checkMidnightReload() {
            const now = moment();
            const midnight = moment().add(1, 'day').startOf('day');
            const diffTillMidnight = midnight.diff(now);
            
            // يتم إعادة جدولة الفحص عند منتصف الليل
            setTimeout(() => {
                loadDailyData();
                checkMidnightReload(); // إعداد للتحقق في منتصف ليلة اليوم التالي
            }, diffTillMidnight + 2000); // +2000ms لضمان تخطي منتصف الليل
        }


        // دالة لتحديث الساعة والعد التنازلي والأذكار
        function updateClockAndCountdown() {
            const now = moment();
            // استخدام locale('en') لضمان ظهور الأرقام الإنجليزية في الساعة
            document.getElementById('digital-clock').innerText = now.clone().locale('en').format('HH:mm:ss');
            
            // تحديث العد التنازلي
            updateNextPrayerCountdown(now);

            // تحديث قائمة الأذكار
            updateOptionalReminders(now);
        }

        // دالة تحديث قائمة الأذكار والسنن النشطة
        function updateOptionalReminders(now) {
            if (!reminderMoments.MorningAzkarStart) return;

            const reminders = [];
            
            // Helper to check if now is between start and end moments
            const isActive = (start, end) => start && end && now.isSameOrAfter(start) && now.isBefore(end);
            
            // 1. الورد اليومي (طول اليوم)
            reminders.push("الورد اليومي"); 

            // 2. أذكار الصباح: إقامة الفجر حتى قبل الظهر بـ 15 دقيقة
            if (isActive(reminderMoments.MorningAzkarStart, reminderMoments.MorningAzkarEnd)) {
                reminders.push("أذكار الصباح");
            }

            // 3. صلاة الضحى: بعد شروق الشمس بـ 15 دقيقة حتى أذان الظهر
            if (isActive(reminderMoments.DuhaStart, reminderMoments.DuhaEnd)) {
                reminders.push("صلاة الضحى");
            }

            // 4. أذكار المساء: من إقامة العصر حتى أذان المغرب
            if (isActive(reminderMoments.EveningAzkarStart, reminderMoments.EveningAzkarEnd)) {
                reminders.push("أذكار المساء");
            }
            
            // 5. السنن الرواتب (حول الصلوات)
            if (isActive(reminderMoments.DhuhrRawatibStart, reminderMoments.DhuhrRawatibEnd) ||
                isActive(reminderMoments.MaghribRawatibStart, reminderMoments.MaghribRawatibEnd) ||
                isActive(reminderMoments.IshaRawatibStart, reminderMoments.IshaRawatibEnd)) {
                reminders.push("السنن الرواتب");
            }

            // 6. سورة الملك: 10 مساءً حتى الفجر
            if (isActive(reminderMoments.MulkStart, reminderMoments.NightEnd)) {
                reminders.push("سورة الملك");
            }

            // 7. صلاة الوتر: بعد العشاء حتى الفجر
            if (isActive(reminderMoments.WitrStart, reminderMoments.NightEnd)) {
                reminders.push("صلاة الوتر");
            }

            // 8. قيام الليل: بعد 12 ص حتى الفجر
            if (isActive(reminderMoments.QiyamStart, reminderMoments.NightEnd)) {
                reminders.push("قيام الليل");
            }


            // ----------------------------------------------------
            // إخراج المهام النشطة (4 عناصر كحد أقصى)
            // ----------------------------------------------------
            const remindersContainer = document.getElementById('active-reminders-box');
            
            // قائمة الأذكار بترتيب الأولوية
            const priorityList = REMINDER_LIST.slice(); 
            const activeRemindersSet = new Set(reminders);
            
            const activeRemindersToShow = [];

            // تجميع العناصر النشطة حسب الترتيب المحدد، بحد أقصى 4
            for (const item of priorityList) {
                if (activeRemindersSet.has(item)) {
                    activeRemindersToShow.push(item);
                }
                if (activeRemindersToShow.length >= 4) {
                    break;
                }
            }

            remindersContainer.innerHTML = ''; // إفراغ الحاوية

            if (activeRemindersToShow.length > 0) {
                activeRemindersToShow.forEach(item => {
                    // نستخدم نفس فئة التصميم للـ 2x2
                    const div = document.createElement('div');
                    div.className = 'reminder-item';
                    div.innerText = item;
                    remindersContainer.appendChild(div);
                });
            } else {
                // رسالة عامة عند عدم وجود مهام نشطة
                remindersContainer.style.justifyContent = 'center';
                remindersContainer.style.alignItems = 'center';
                remindersContainer.innerHTML = '<div style="font-size: 11px; color: #aaa;">اللهم تقبل طاعتنا</div>';
            }
        }


        // دالة لتحميل بيانات اليوم وعرضها
        function loadDailyData() {
            console.log('تحميل بيانات اليوم الجديد...');
            
            // نستخدم 'ar-sa' لتهيئة أسماء الأيام والشهور العربية
            moment.locale('ar-sa');
            const now = moment();
            
            // نحصل على التاريخ بالأرقام الإنجليزية للمقارنة
            const todayStr = now.clone().locale('en').format('YYYY-MM-DD');

            // --- منطق تحديد يوم الجمعة وتحديث اسم الصلاة ---
            const isFriday = now.day() === 5; // 5 يمثل يوم الجمعة في Moment.js
            
            // إنشاء نسخة جديدة من أسماء الصلوات
            const prayerNamesToday = { ...prayerNames };
            if (isFriday) {
                prayerNamesToday.dhuhr = "الجمعة";
            }
            // ------------------------------------------------

            // البحث عن بيانات اليوم في المصفوفة
            const todayData = prayerTimesData.find(p => p.date === todayStr);

            if (!todayData) {
                console.error("لا توجد بيانات صلاة لهذا اليوم: ", todayStr);
                document.getElementById('prayers-container').innerHTML = `<div style="color:var(--text-red); text-align:center; padding: 20px; font-size: 14px;">لا توجد بيانات مواقيت لهذا اليوم</div>`;
                return;
            }

            // حساب لحظات الأذكار والسنن
            calculateReminderMoments(todayData);

            // عرض التاريخ (الميلادي والهجري)
            renderDates(now, todayData.sunrise); 
            
            // عرض جدول الصلوات
            renderPrayerTable(todayData, prayerNamesToday); // تمرير الأسماء المحدثة
            
            // معالجة الأوقات لتجهيزها للعد التنازلي (الآن تشمل الأذان والإقامة)
            processPrayerTimesForCountdown(todayData, prayerNamesToday); // تمرير الأسماء المحدثة
        }

        // دالة عرض التواريخ (الميلادي، الهجري، الشروق)
        function renderDates(now, sunriseTime) {
            
            // نستخدم نسخة locale('en') للأرقام الإنجليزية
            const enNow = now.clone().locale('en');
            const todayDate = now.toDate(); // كائن التاريخ الأصلي لواجهة Intl

            // التاريخ الميلادي (أعلى اليمين)
            document.getElementById('gregorian-day-name').innerText = now.format('dddd');
            document.getElementById('gregorian-date').innerText = enNow.format('YYYY-MM-DD'); // أرقام إنجليزية
            document.getElementById('sunrise-time').innerText = sunriseTime; // أرقام إنجليزية (تأتي من البيانات)

            // ------------------------------------------------------------------
            // التاريخ الهجري (الوسط اليمين) - باستخدام Intl.DateTimeFormat
            
            // 1. استخلاص اسم الشهر الهجري باللغة العربية (مهمة منفصلة للنص)
            const hijriMonthFormatter = new Intl.DateTimeFormat('ar-SA', {
                calendar: 'islamic-umalqura',
                month: 'long',
            });
            const formattedMonth = hijriMonthFormatter.format(todayDate);

            // 2. استخلاص اليوم والسنة بأرقام إنجليزية (مهمة منفصلة للأرقام)
            const hijriPartsFormatter = new Intl.DateTimeFormat('en-US', {
                calendar: 'islamic-umalqura',
                day: 'numeric',
                year: 'numeric'
            });
            
            const hijriParts = hijriPartsFormatter.formatToParts(todayDate);

            let hijriDay = '';
            let hijriYear = '';

            hijriParts.forEach(part => {
                if (part.type === 'day') hijriDay = part.value;
                if (part.type === 'year') hijriYear = part.value.replace(' AH', ''); // إزالة ' AH'
            });

            // تحديث العناصر
            document.getElementById('hijri-month').innerText = formattedMonth; 
            document.getElementById('hijri-day').innerText = hijriDay; 
            document.getElementById('hijri-year').innerText = hijriYear; 
            // ------------------------------------------------------------------
        }

        // دالة عرض جدول الصلوات
        function renderPrayerTable(data, currentPrayerNames) {
            const container = document.getElementById('prayers-container');
            container.innerHTML = ''; // إفراغ الحاوية قبل التعبئة

            const order = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'];

            order.forEach(key => {
                const adhanTime = data[key];
                // حساب وقت الإقامة
                const adhanMoment = moment(data.date + ' ' + adhanTime, 'YYYY-MM-DD HH:mm');
                const iqamahMoment = adhanMoment.clone().add(iqamahOffsets[key], 'minutes');
                
                // تنسيق وقت الإقامة باستخدام locale('en') للحصول على أرقام إنجليزية
                const iqamahTimeFormatted = iqamahMoment.clone().locale('en').format('HH:mm');
                
                const row = document.createElement('div');
                row.className = 'prayer-row';
                row.id = `row-${key}`; // إضافة ID لتمييز الصف

                row.innerHTML = `
                    <div class="prayer-time-iqamah">${iqamahTimeFormatted}</div>
                    <div class="prayer-name">${currentPrayerNames[key]}</div>
                    <div class="prayer-time-adhan">${adhanTime}</div>
                `;
                container.appendChild(row);
            });
        }
        
        // دالة تجهيز مصفوفة أوقات الأذان والإقامة للعد التنازلي
        function processPrayerTimesForCountdown(data, currentPrayerNames) {
            processedPrayerTimes = []; // إفراغ المصفوفة
            const order = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'];
            
            order.forEach(key => {
                const adhanTime = data[key];
                const adhanMoment = moment(data.date + ' ' + adhanTime, 'YYYY-MM-DD HH:mm');
                
                // 1. إضافة وقت الأذان
                processedPrayerTimes.push({
                    type: 'adhan',
                    name: currentPrayerNames[key],
                    key: key,
                    time: adhanMoment
                });
                
                // 2. إضافة وقت الإقامة
                const iqamahMoment = adhanMoment.clone().add(iqamahOffsets[key], 'minutes');
                processedPrayerTimes.push({
                    type: 'iqamah',
                    name: currentPrayerNames[key],
                    key: key,
                    time: iqamahMoment
                });
            });
            
            // إضافة أذان وإقامة فجر اليوم التالي لتغطية الفترة ما بعد العشاء
            const tomorrowData = prayerTimesData.find(p => p.date === moment(data.date).add(1, 'days').format('YYYY-MM-DD'));
            if (tomorrowData) {
                const nextDayFajrAdhan = moment(tomorrowData.date + ' ' + tomorrowData.fajr, 'YYYY-MM-DD HH:mm'); 
                
                // إضافة أذان فجر اليوم التالي
                 processedPrayerTimes.push({
                    type: 'adhan',
                    name: prayerNames['fajr'], 
                    key: 'fajr',
                    time: nextDayFajrAdhan
                });
                
                const nextDayFajrIqamah = nextDayFajrAdhan.clone().add(iqamahOffsets['fajr'], 'minutes');
                 processedPrayerTimes.push({
                    type: 'iqamah',
                    name: prayerNames['fajr'], // نستخدم الاسم الافتراضي للفجر
                    key: 'fajr',
                    time: nextDayFajrIqamah
                });
            }
            
            // ترتيب الأوقات للتأكد من تسلسلها الصحيح 
            processedPrayerTimes.sort((a, b) => a.time.valueOf() - b.time.valueOf());
        }

        // دالة تحديث العد التنازلي (تُستدعى كل ثانية)
        function updateNextPrayerCountdown(now) {
            if (processedPrayerTimes.length === 0) return;

            // إزالة التظليل من جميع الصفوف أولاً
            document.querySelectorAll('.prayer-row').forEach(r => r.classList.remove('next-prayer-highlight'));

            // البحث عن أول حدث (أذان أو إقامة) وقته "بعد" الوقت الحالي
            let nextEvent = processedPrayerTimes.find(p => p.time.isAfter(now));

            if (!nextEvent) {
                // هذا يعني أننا في نهاية اليوم (بعد إقامة العشاء)
                document.getElementById('next-prayer-name').innerText = "انتهت صلوات اليوم";
                document.getElementById('countdown-display').innerText = "--:--:--";
                return;
            }

            // 1. حساب الفرق
            const diff = nextEvent.time.diff(now);
            const duration = moment.duration(diff);
            
            // استخدام الأرقام الإنجليزية في العد التنازلي 
            const hours = String(Math.floor(duration.asHours())).padStart(2, '0');
            const minutes = String(duration.minutes()).padStart(2, '0');
            const seconds = String(duration.seconds()).padStart(2, '0');
            
            // تحديد نوع الحدث للعرض (ديناميكي بين أذان وإقامة)
            const eventLabel = nextEvent.type === 'adhan' ? 'أذان' : 'إقامة'; 

            // 2. عرض العد التنازلي
            document.getElementById('next-prayer-name').innerText = `المتبقي لـ ${eventLabel} ${nextEvent.name}`;
            document.getElementById('countdown-display').innerText = `${hours}:${minutes}:${seconds}`;

            // 3. تظليل الصف (هايلايت)
            // إضافة التظليل للصف الذي يحتوي على الصلاة القادمة (الإقامة أو الأذان)
            const activeRow = document.getElementById(`row-${nextEvent.key}`);
            if(activeRow) {
                activeRow.classList.add('next-prayer-highlight');
            }
        }

        // --- (4) تشغيل التطبيق ---
        // نبدأ كل شيء عندما يتم تحميل الصفحة بالكامل
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
